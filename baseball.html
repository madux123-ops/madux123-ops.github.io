<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦æ³é‡çƒ - å‚³å¥‡é‡æ‰‹é¤Šæˆ Ver.2</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --highlight: #f1c40f;
            --bg-color: #ecf0f1;
            --panel-bg: #ffffff;
            --stadium-green: #27ae60;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary);
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .game-container {
            width: 900px;
            background: var(--bg-color);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            overflow: hidden;
            display: grid;
            grid-template-rows: 60px 1fr 180px; /* Increased footer height for new stats */
            position: relative;
        }
        
        /* Start Screen Overlay */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        #start-screen input {
            padding: 15px;
            font-size: 1.5em;
            margin: 20px 0;
            border-radius: 5px;
            border: none;
            text-align: center;
        }
        #start-screen button {
            background: var(--highlight);
            color: #333;
            font-size: 1.2em;
        }

        /* Header */
        header {
            background: var(--primary);
            color: white;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            border-bottom: 4px solid var(--highlight);
        }
        .player-name { font-size: 1.2em; color: var(--highlight); margin-right: 10px; }
        .status-badge {
            background: var(--accent);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        /* Main Content */
        main {
            padding: 20px;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
        }
        
        /* Stats Panel */
        .stats-panel {
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .stat-row { margin-bottom: 5px; }
        .stat-label {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 0.9em;
        }
        .stat-bar-bg {
            background: #ddd;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .stat-bar-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
        .fill-power { background: #e74c3c; }
        .fill-contact { background: #f39c12; }
        .fill-defense { background: #3498db; }
        .fill-run { background: #9b59b6; }

        /* Game Screen */
        .game-screen {
            background: var(--panel-bg);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .dialog-box {
            flex-grow: 1;
            border: 2px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            background: #fff;
            margin-bottom: 10px;
            overflow-y: auto;
            height: 250px;
            font-size: 0.95em;
            line-height: 1.6;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .log-highlight { color: var(--accent); font-weight: bold; }
        .log-success { color: var(--stadium-green); font-weight: bold; }
        .log-detail { font-size: 0.85em; color: #666; font-style: italic; }
        
        /* Detailed Season Stats View */
        .season-stats-grid {
            background: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.85em;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            text-align: center;
            margin-top: auto;
        }
        .stat-box { display: flex; flex-direction: column; }
        .stat-title { color: #aaa; font-size: 0.8em; }
        .stat-val { font-size: 1.1em; font-weight: bold; }

        /* Controls */
        .controls {
            background: #dcdcdc;
            padding: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            border-top: 1px solid #bbb;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            font-size: 1em;
            min-width: 100px;
        }
        button:active { transform: scale(0.95); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-train { background: var(--primary); color: white; }
        .btn-train:hover { background: #34495e; }
        
        .btn-rest { background: var(--stadium-green); color: white; }
        .btn-rest:hover { background: #219150; }

        .btn-next { background: var(--highlight); color: #333; width: 100%; font-size: 1.2em;}

        /* Warning Modal */
        #warning-msg {
            color: red;
            font-weight: bold;
            text-align: center;
            margin-top: 5px;
            height: 20px;
            visibility: hidden;
        }

    </style>
</head>
<body>

<div class="game-container">
    
    <div id="start-screen">
        <h1>âš¾ å‚³å¥‡é‡çƒé¤Šæˆ</h1>
        <p>è«‹è¼¸å…¥çƒå“¡åç¨± (æœ€å¤š6å­—)</p>
        <input type="text" id="input-name" maxlength="6" value="é‡çƒå›">
        <button onclick="startGame()">é–‹å§‹éŠæˆ²</button>
    </div>

    <header>
        <div>
            <span class="player-name" id="display-name"></span>
            <span id="round-display">ç¬¬ 1 è¼ª</span>
        </div>
        <div id="day-display">ç¬¬ 1 å¤© / 90</div>
        <div class="status-badge" id="phase-display">è¨“ç·´æœŸ</div>
    </header>

    <main>
        <div class="stats-panel">
            <h3 style="margin:0;">çƒå“¡èƒ½åŠ›</h3>
            <div class="stat-row">
                <div class="stat-label"><span>Power (åŠ›é‡)</span> <span id="val-power">10</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill fill-power" id="bar-power"></div></div>
            </div>
            <div class="stat-row">
                <div class="stat-label"><span>Contact (æŠ€å·§)</span> <span id="val-contact">10</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill fill-contact" id="bar-contact"></div></div>
            </div>
            <div class="stat-row">
                <div class="stat-label"><span>Defense (å®ˆå‚™)</span> <span id="val-defense">10</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill fill-defense" id="bar-defense"></div></div>
            </div>
            <div class="stat-row">
                <div class="stat-label"><span>Run (è·‘å£˜)</span> <span id="val-run">10</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill fill-run" id="bar-run"></div></div>
            </div>
            
            <hr style="width:100%; margin: 5px 0;">
            
            <h3 style="margin:0;">æœ¬å­£æˆç¸¾</h3>
            <div class="season-stats-grid">
                <div class="stat-box"><span class="stat-title">æ‰“æ“Šç‡</span><span class="stat-val" id="stat-avg">.000</span></div>
                <div class="stat-box"><span class="stat-title">å…¨å£˜æ‰“</span><span class="stat-val" id="stat-hr">0</span></div>
                <div class="stat-box"><span class="stat-title">æ‰“é»</span><span class="stat-val" id="stat-rbi">0</span></div>
                <div class="stat-box"><span class="stat-title">OPS</span><span class="stat-val" id="stat-ops">.000</span></div>
                
                <div class="stat-box"><span class="stat-title">ä¸Šå£˜ç‡</span><span class="stat-val" id="stat-obp">.000</span></div>
                <div class="stat-box"><span class="stat-title">é•·æ‰“ç‡</span><span class="stat-val" id="stat-slg">.000</span></div>
                <div class="stat-box"><span class="stat-title">å®‰æ‰“</span><span class="stat-val" id="stat-h">0</span></div>
                <div class="stat-box"><span class="stat-title">ä¿é€</span><span class="stat-val" id="stat-bb">0</span></div>
                
                <div class="stat-box"><span class="stat-title">ä¸‰æŒ¯</span><span class="stat-val" id="stat-so">0</span></div>
                <div class="stat-box"><span class="stat-title">ç¸½å®‰æ‰“</span><span class="stat-val" id="stat-tb">0</span></div> </div>
        </div>

        <div class="game-screen">
            <div class="dialog-box" id="game-log">
                </div>
            <div id="warning-msg">âš  è­¦å‘Šï¼šé€£çºŒè¨“ç·´åŒä¸€é …ç›®æ•ˆç‡æœƒå¤§å¹…é™ä½ï¼</div>
        </div>
    </main>

    <div class="controls" id="control-panel">
        </div>
</div>

<script>
    // Game State
    const GameState = {
        playerName: "Player",
        round: 1, // 1, 2, 3
        day: 1,
        totalDaysPerRound: 90,
        phase: 'training', // 'training', 'rest', 'match', 'end'
        subCycleDay: 1, // Tracks the 20 train / 10 rest cycle
        
        stats: {
            power: 10,
            contact: 10,
            defense: 10,
            run: 10
        },
        
        records: {
            gamesPlayed: 0,
            ab: 0, // At Bats (æ‰“æ•¸)
            h: 0,  // Hits (å®‰æ‰“)
            hr: 0, // Home Runs
            tb: 0, // Total Bases (å£˜æ‰“æ•¸)
            rbi: 0,
            bb: 0, // Walks (å››å£)
            so: 0  // Strike Outs (ä¸‰æŒ¯)
        },

        lastTraining: null,
        warningActive: false,
        
        matchConfig: {
            1: 20,
            2: 20,
            3: 80
        },
        matchesLeft: 0
    };

    // Constants
    const MAX_STAT = 255; 

    // UI Elements
    const elLog = document.getElementById('game-log');
    const elControls = document.getElementById('control-panel');
    const elRound = document.getElementById('round-display');
    const elDay = document.getElementById('day-display');
    const elPhase = document.getElementById('phase-display');
    const elWarning = document.getElementById('warning-msg');
    const elDisplayName = document.getElementById('display-name');

    // --- Core Functions ---

    function startGame() {
        const input = document.getElementById('input-name');
        let name = input.value.trim();
        if(!name) name = "é‡çƒå›";
        GameState.playerName = name;
        elDisplayName.textContent = name;
        
        document.getElementById('start-screen').style.display = 'none';
        
        updateStatsUI();
        setPhase('training');
        log(`æ­¡è¿ ${name} åŠ å…¥è·æ£’é¤Šæˆè¨ˆç•«ï¼ç›®æ¨™æ˜¯æˆç‚ºå‚³å¥‡é‡æ‰‹ã€‚`, "log-highlight");
        log("å‰90å¤©è«‹å°ˆæ³¨æ–¼åŸºç¤è¨“ç·´ã€‚", "");
    }

    function log(msg, type='') {
        const div = document.createElement('div');
        div.className = 'log-entry ' + type;
        div.innerHTML = msg;
        elLog.prepend(div);
    }

    function updateStatsUI() {
        // Update Bars
        document.getElementById('val-power').textContent = GameState.stats.power;
        document.getElementById('val-contact').textContent = GameState.stats.contact;
        document.getElementById('val-defense').textContent = GameState.stats.defense;
        document.getElementById('val-run').textContent = GameState.stats.run;

        document.getElementById('bar-power').style.width = (GameState.stats.power / MAX_STAT * 100) + '%';
        document.getElementById('bar-contact').style.width = (GameState.stats.contact / MAX_STAT * 100) + '%';
        document.getElementById('bar-defense').style.width = (GameState.stats.defense / MAX_STAT * 100) + '%';
        document.getElementById('bar-run').style.width = (GameState.stats.run / MAX_STAT * 100) + '%';
        
        // Calculate Advanced Stats
        // AVG = H / AB
        // OBP = (H + BB) / (AB + BB) (Ignoring SF/HBP for simplicity)
        // SLG = TB / AB
        
        let ab = GameState.records.ab;
        let h = GameState.records.h;
        let bb = GameState.records.bb;
        let tb = GameState.records.tb;

        let avg = ab === 0 ? 0 : h / ab;
        let obp = (ab + bb) === 0 ? 0 : (h + bb) / (ab + bb);
        let slg = ab === 0 ? 0 : tb / ab;
        let ops = obp + slg;

        // Render Stats
        document.getElementById('stat-avg').textContent = avg.toFixed(3).replace(/^0+/, '');
        document.getElementById('stat-hr').textContent = GameState.records.hr;
        document.getElementById('stat-rbi').textContent = GameState.records.rbi;
        document.getElementById('stat-ops').textContent = ops.toFixed(3).replace(/^0+/, '');
        
        document.getElementById('stat-obp').textContent = obp.toFixed(3).replace(/^0+/, '');
        document.getElementById('stat-slg').textContent = slg.toFixed(3).replace(/^0+/, '');
        document.getElementById('stat-h').textContent = h;
        document.getElementById('stat-bb').textContent = bb;
        document.getElementById('stat-so').textContent = GameState.records.so;
        document.getElementById('stat-tb').textContent = tb;
    }

    function setPhase(phase) {
        GameState.phase = phase;
        elPhase.textContent = phase === 'training' ? 'è¨“ç·´æœŸ' : (phase === 'rest' ? 'ä¼‘æ¯é€±' : 'è³½å­£ä¸­');
        elRound.textContent = `ç¬¬ ${GameState.round} è¼ª`;
        
        if (phase === 'match') {
            elDay.textContent = `å‰©é¤˜å ´æ¬¡: ${GameState.matchesLeft}`;
        } else {
            elDay.textContent = `ç¬¬ ${GameState.day} å¤© / 90`;
        }
        
        renderControls();
    }

    function renderControls() {
        elControls.innerHTML = '';
        elWarning.style.visibility = 'hidden';

        if (GameState.phase === 'training') {
            const trainings = [
                { id: 'power', label: 'é‡è¨“ (Power)', color: '#e74c3c' },
                { id: 'contact', label: 'æ‰“æ“Š (Contact)', color: '#f39c12' },
                { id: 'defense', label: 'å®ˆå‚™ (Defense)', color: '#3498db' },
                { id: 'run', label: 'è¡åˆº (Run)', color: '#9b59b6' }
            ];

            trainings.forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'btn-train';
                btn.textContent = t.label;
                btn.style.borderLeft = `5px solid ${t.color}`;
                btn.onclick = () => handleTraining(t.id);
                elControls.appendChild(btn);
            });
        } else if (GameState.phase === 'rest') {
            const rests = [
                { id: 'shop', label: 'é€›è¡—' },
                { id: 'movie', label: 'çœ‹é›»å½±' },
                { id: 'date', label: 'äº¤å‹' },
                { id: 'book', label: 'çœ‹æ›¸' },
                { id: 'eat', label: 'åƒå¤§é¤' }
            ];
            rests.forEach(r => {
                const btn = document.createElement('button');
                btn.className = 'btn-rest';
                btn.textContent = r.label;
                btn.onclick = () => handleRest(r.id);
                elControls.appendChild(btn);
            });
        } else if (GameState.phase === 'match') {
            const btn = document.createElement('button');
            btn.className = 'btn-next';
            btn.textContent = 'é€²è¡Œä¸‹ä¸€å ´æ¯”è³½';
            btn.onclick = () => playMatch();
            elControls.appendChild(btn);
        } else if (GameState.phase === 'post-season') {
            const btn = document.createElement('button');
            btn.className = 'btn-next';
            btn.textContent = 'é€²å…¥ 10 å¤©å­£å¾Œä¼‘æ¯';
            btn.onclick = () => endSeasonRest();
            elControls.appendChild(btn);
        } else if (GameState.phase === 'game-over') {
            const btn = document.createElement('button');
            btn.className = 'btn-next';
            btn.textContent = 'é‡æ–°é–‹å§‹';
            btn.onclick = () => location.reload();
            elControls.appendChild(btn);
        }
    }

    // --- Actions ---

    function handleTraining(type) {
        // Warning Check
        if (GameState.lastTraining === type) {
            if (!GameState.warningActive) {
                GameState.warningActive = true;
                elWarning.style.visibility = 'visible';
                log("æ•™ç·´ï¼šæ•ˆç‡åœ¨é™ä½ï¼Œå»ºè­°æ›å€‹é …ç›®è¨“ç·´ï¼(å†æ¬¡é»æ“Šå°‡å¼·åˆ¶è¨“ç·´ä¸¦æ‰£æ•¸å€¼)", "log-highlight");
                return;
            } else {
                // Punishment
                GameState.stats[type] = Math.max(0, GameState.stats[type] - 5);
                log(`ä½ ç„¡è¦–è­¦å‘Šå¼·è¡Œè¨“ç·´...èº«é«”å—å‚·äº†ï¼ ${type} -5`, "log-highlight");
                GameState.warningActive = false;
                advanceDay();
                updateStatsUI();
                return;
            }
        }

        // Normal Training
        GameState.lastTraining = type;
        GameState.warningActive = false;
        
        // Changed gain to 2-4
        let gain = Math.floor(Math.random() * 3) + 2; // 2, 3, 4
        
        // Crit Chance
        if (Math.random() < 0.1) {
            gain += 4;
            log(`ç‹€æ…‹çµ•ä½³ï¼è¨“ç·´æ•ˆæœè¶…ç¾¤ï¼ ${type} +${gain}`, "log-success");
        } else {
            log(`é€²è¡Œäº†${type}è¨“ç·´ã€‚ ${type} +${gain}`);
        }

        GameState.stats[type] = Math.min(MAX_STAT, GameState.stats[type] + gain);
        
        updateStatsUI();
        advanceDay();
    }

    function handleRest(type) {
        GameState.lastTraining = null; // Reset streak
        let msg = "";
        let bonus = "";

        const rand = Math.random();
        
        switch(type) {
            case 'shop':
                msg = "å»å•†åº—è¡—é€›äº†ä¸€æ•´å¤©ã€‚";
                if (rand < 0.3) { GameState.stats.run += 2; bonus = "è²·åˆ°äº†å¥½é‹å­ (Run+2)"; }
                break;
            case 'movie':
                msg = "çœ‹äº†ä¸€å ´æ„Ÿäººçš„æ£’çƒé›»å½±ã€‚";
                if (rand < 0.3) { GameState.stats.power += 2; bonus = "ç†±è¡€æ²¸é¨° (Power+2)"; }
                break;
            case 'date':
                msg = "å’Œæœ‹å‹å‡ºå»ç©ã€‚";
                if (rand < 0.2) { GameState.stats.contact += 3; bonus = "èŠåˆ°äº†æ‰“æ“ŠæŠ€å·§ (Contact+3)"; }
                break;
            case 'book':
                msg = "åœ¨åœ–æ›¸é¤¨å®‰éœåœ°çœ‹æ›¸ã€‚";
                if (rand < 0.4) { GameState.stats.defense += 2; bonus = "å­¸ç¿’äº†æˆ°è¡“ (Defense+2)"; }
                break;
            case 'eat':
                msg = "å»åƒäº†ä¸€é “é«˜ç´šç‡’è‚‰ï¼";
                if (rand < 0.5) { GameState.stats.power += 1; GameState.stats.contact += 1; bonus = "é«”åŠ›æ¢å¾© (All+1)"; }
                break;
        }

        log(bonus ? `${msg} <b>${bonus}</b>` : msg, bonus ? "log-success" : "");
        advanceDay();
        updateStatsUI();
    }

    function advanceDay() {
        GameState.day++;
        GameState.subCycleDay++;
        const dayInCycle = (GameState.day - 1) % 30;

        if (GameState.day > 90) {
            startMatchPhase();
            return;
        }

        if (dayInCycle < 20) {
            // Training Phase
            if (GameState.phase !== 'training') {
                log("---- å‡æœŸçµæŸï¼Œé–‹å§‹è¨“ç·´ï¼ ----");
                setPhase('training');
            }
        } else {
            // Rest Phase
            if (GameState.phase !== 'rest') {
                log("---- 20å¤©è¨“ç·´çµæŸï¼Œæ¥ä¸‹ä¾†10å¤©ä¼‘æ¯èª¿æ•´ã€‚ ----", "log-success");
                setPhase('rest');
            }
        }
        
        elDay.textContent = `ç¬¬ ${GameState.day} å¤© / 90`;
    }

    // --- Match Logic (UPDATED) ---

    function startMatchPhase() {
        GameState.matchesLeft = GameState.matchConfig[GameState.round];
        setPhase('match');
        log(`== ç¬¬ ${GameState.round} è¼ªè¨“ç·´çµæŸï¼Œé–‹å§‹ ${GameState.matchesLeft} å ´æ¯”è³½ ==`, "log-highlight");
    }

    function playMatch() {
        if (GameState.matchesLeft <= 0) return;

        log(`--- ç¬¬ ${GameState.matchConfig[GameState.round] - GameState.matchesLeft + 1} å ´æ¯”è³½ ---`);
        
        for (let i = 0; i < 3; i++) {
            simulateAtBat();
        }

        GameState.records.gamesPlayed++;
        GameState.matchesLeft--;
        updateStatsUI();

        if (GameState.matchesLeft === 0) {
            if (GameState.round < 3) {
                setPhase('post-season');
                log("æœ¬å­£è³½ç¨‹çµæŸï¼è«‹é€²è¡Œå­£å¾Œä¼‘æ¯èª¿æ•´ã€‚", "log-success");
            } else {
                endGame();
            }
        } else {
             elDay.textContent = `å‰©é¤˜å ´æ¬¡: ${GameState.matchesLeft}`;
        }
    }

    function simulateAtBat() {
        // --- PROBABILITY ADJUSTMENTS ---
        // 1. Walk Rate (Fixed around 10%)
        const walkThreshold = 10; // 0-10 on a d100
        
        // 2. Batting Average Logic (0.200 to 0.450)
        // Formula: 0.20 + (Contact / MAX_STAT) * 0.25
        // This is the probability of a HIT occurring given a non-walk.
        // To simplify, we map this to d100.
        // Total Hit Chance = (100 - walkThreshold) * (calculatedAvg)
        
        const rawHitProb = 0.20 + (GameState.stats.contact / MAX_STAT) * 0.25;
        const hitThreshold = walkThreshold + (90 * rawHitProb); 
        
        // 3. Strikeout Logic (Affected by Contact)
        // High contact reduces SO rate within the "Out" pool
        const soRateInOuts = Math.max(0.1, 0.5 - (GameState.stats.contact / 500));

        const roll = Math.random() * 100;
        
        if (roll < walkThreshold) {
            // WALK
            GameState.records.bb++;
            log("é¸çƒçœ¼ï¼ç²å¾—ä¿é€ä¸Šå£˜ã€‚", "log-success");
        } else if (roll < hitThreshold) {
            // HIT
            GameState.records.ab++;
            GameState.records.h++;
            determineHitType();
        } else {
            // OUT
            GameState.records.ab++;
            if (Math.random() < soRateInOuts) {
                GameState.records.so++;
                log("æ®æ£’è½ç©ºï¼Œä¸‰æŒ¯å‡ºå±€ã€‚");
            } else {
                log("æ‰“æ“Šå‡ºå»ï¼Œè¢«æ¥æ®ºå‡ºå±€ã€‚");
            }
        }
    }

    function determineHitType() {
        // --- HIT TYPE DISTRIBUTION ---
        // Constraint: Reduce HR rate by 30%, give to 2B.
        
        // Base Weights
        let wSingle = 60;
        let wDouble = 15;
        let wTriple = 2; // Very rare base
        let wHR = 5;     // Rare base
        
        // Stat Modifiers
        wHR += (GameState.stats.power / MAX_STAT) * 25; // Max power adds heavy weight to HR
        wTriple += (GameState.stats.run / MAX_STAT) * 15; // Speed adds weight to Triple
        wDouble += (GameState.stats.power / MAX_STAT) * 10; // Power also helps doubles (gaps)
        
        // --- APPLY CONSTRAINT ---
        // Reduce calculated HR weight by 30% and move it to Double
        const reducedAmount = wHR * 0.30;
        wHR = wHR * 0.70;
        wDouble += reducedAmount;

        // Normalize
        const totalWeight = wSingle + wDouble + wTriple + wHR;
        const typeRoll = Math.random() * totalWeight;
        
        let rbiGain = 0;

        if (typeRoll < wHR) {
            // Home Run
            GameState.records.hr++;
            GameState.records.tb += 4;
            rbiGain = 1 + Math.floor(Math.random() * 3); // 1-4 RBI
            log(`ğŸ”¥ å…¨å£˜æ‰“ï¼å°ç™½çƒé£›å‡ºäº†å ´å¤–ï¼ (+${rbiGain}æ‰“é»)`, "log-highlight");
        } else if (typeRoll < wHR + wTriple) {
            // Triple
            GameState.records.tb += 3;
            rbiGain = Math.floor(Math.random() * 2);
            log("æ·±é å®‰æ‰“ï¼é è‘—é£›å¿«çš„è…³ç¨‹æ»‘ä¸Šä¸‰å£˜ï¼", "log-success");
        } else if (typeRoll < wHR + wTriple + wDouble) {
            // Double
            GameState.records.tb += 2;
            rbiGain = Math.floor(Math.random() * 2);
            log("æ“Šä¸­å…¨å£˜æ‰“ç‰†çš„æ·±é äºŒå£˜å®‰æ‰“ï¼"); // More common now due to redistributed stats
        } else {
            // Single
            GameState.records.tb += 1;
            log("å·§å¦™åœ°ç©¿è¶Šå…§é‡é˜²ç·šçš„ä¸€å£˜å®‰æ‰“ã€‚");
        }
        
        GameState.records.rbi += rbiGain;
    }

    function endSeasonRest() {
        log("ç¶“éäº†10å¤©çš„ä¼‘é¤Šï¼Œèº«é«”ç‹€æ³æ¢å¾©äº†ã€‚", "log-success");
        GameState.round++;
        GameState.day = 1;
        setPhase('training');
    }

    function endGame() {
        setPhase('game-over');
        elRound.textContent = "å‚³å¥‡èª•ç”Ÿ";
        elDay.textContent = "ç”Ÿæ¶¯çµæŸ";

        let totalScore = GameState.stats.power + GameState.stats.contact + GameState.stats.defense + GameState.stats.run;
        
        // Calculate Rank
        let rank = "D";
        if (totalScore > 800) rank = "S";
        else if (totalScore > 650) rank = "A";
        else if (totalScore > 500) rank = "B";
        else if (totalScore > 350) rank = "C";

        // Display Final
        const html = `
            <div style="text-align:center; padding: 20px;">
                <h2 style="color:var(--stadium-green)">é¤ŠæˆçµæŸï¼</h2>
                <p>çƒå“¡: ${GameState.playerName}</p>
                <div style="font-size: 5em; font-weight: bold; color: var(--accent);">${rank}</div>
                <hr>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; padding: 0 20px;">
                    <div>æ‰“æ“Šç‡: ${document.getElementById('stat-avg').textContent}</div>
                    <div>OPS: ${document.getElementById('stat-ops').textContent}</div>
                    <div>å…¨å£˜æ‰“: ${GameState.records.hr}</div>
                    <div>å®‰æ‰“æ•¸: ${GameState.records.h}</div>
                    <div>ç¸½èƒ½åŠ›: ${totalScore}</div>
                    <div>ä¿é€: ${GameState.records.bb}</div>
                </div>
            </div>
        `;
        
        elLog.innerHTML = html;
    }

</script>

</body>
</html>