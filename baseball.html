<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦æ³é‡çƒé¢¨æ ¼ - å‚³å¥‡é‡æ‰‹é¤Šæˆ Ver.5.0 (å­˜æª”ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --highlight: #f1c40f;
            --bg-color: #ecf0f1;
            --panel-bg: #ffffff;
            --stadium-green: #27ae60;
            --dirt: #d35400;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary);
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }
        .game-container {
            width: 900px;
            background: var(--bg-color);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            overflow: hidden;
            display: grid;
            grid-template-rows: 60px 1fr 180px;
            position: relative;
        }
        
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.98); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .hidden { display: none !important; }

        #input-name { padding: 15px; font-size: 1.5em; margin: 20px 0; border-radius: 5px; border: none; text-align: center; width: 200px;}
        
        .start-btn-group { display: flex; gap: 20px; }
        .btn-start { background: var(--highlight); color: #333; padding: 15px 30px; font-size: 1.2em; border:none; border-radius:5px; cursor:pointer; font-weight:bold;}
        .btn-load { background: #3498db; color: white; padding: 15px 30px; font-size: 1.2em; border:none; border-radius:5px; cursor:pointer; font-weight:bold;}

        /* Interactive Stadium Overlay */
        #stadium-screen {
            background: radial-gradient(circle at 50% 100%, var(--dirt) 20%, var(--stadium-green) 21%);
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; display: none; flex-direction: column; align-items: center; justify-content: flex-start;
        }
        
        .match-info-bar {
            background: rgba(0,0,0,0.7); color: #fff; width: 100%; padding: 10px;
            display: flex; justify-content: space-around; font-size: 1.2em; font-weight: bold;
        }

        .field-area {
            position: relative; width: 400px; height: 500px; margin-top: 20px;
            border: 2px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.1);
            overflow: hidden; 
        }
        
        .mound {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 40px; background: white; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 5;
        }

        /* The Strike Zone */
        .home-plate-area {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 100px; height: 120px; 
            border: 4px solid rgba(255, 255, 255, 0.8); 
            background: rgba(255,255,255,0.1);
            z-index: 5;
        }
        .home-plate-area::after {
            content: "å¥½çƒå¸¶"; color: rgba(255,255,255,0.7);
            position: absolute; width: 100%; text-align: center; top: 40%; font-size: 0.9em; font-weight: bold;
        }
        
        #baseball {
            width: 24px; height: 24px; background: white; border-radius: 50%;
            position: absolute; left: 50%; top: 40px; transform: translate(-50%, -50%);
            box-shadow: 0 0 8px rgba(0,0,0,0.6); border: 1px solid #ccc;
            display: none; z-index: 10;
        }
        /* Red stitches simulation */
        #baseball::before {
            content: ''; position: absolute; left: 4px; top: 0; width: 16px; height: 24px;
            border-left: 2px dashed #c0392b; border-right: 2px dashed #c0392b; border-radius: 50%; opacity: 0.7;
        }

        #match-result-text {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3em; font-weight: bold; text-shadow: 0 0 10px black;
            color: #fff; display: none; z-index: 20; white-space: nowrap;
        }
        
        #speed-indicator {
            position: absolute; top: 10px; right: 10px;
            font-size: 1.2em; color: #f1c40f; font-weight: bold; 
            text-shadow: 1px 1px 2px black; display: none;
        }

        #ball-type-indicator {
            position: absolute; top: 10px; left: 10px;
            font-size: 1.2em; color: #e74c3c; font-weight: bold; 
            text-shadow: 1px 1px 2px black; display: none;
        }

        #btn-swing {
            margin-top: 20px; padding: 20px 80px; font-size: 2em;
            background: var(--accent); color: white; border: 5px solid white;
            border-radius: 50px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        #btn-swing:active { transform: scale(0.95); background: #c0392b; }
        #btn-swing:disabled { background: #7f8c8d; opacity: 0.5; cursor: default; }

        /* General Layout */
        header {
            background: var(--primary); color: white; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; border-bottom: 4px solid var(--highlight);
        }
        .player-name { font-size: 1.2em; color: var(--highlight); margin-right: 10px; }
        .status-badge { background: var(--accent); padding: 5px 10px; border-radius: 5px; font-size: 0.9em; }

        main { padding: 20px; display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        
        .stats-panel {
            background: var(--panel-bg); padding: 15px; border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 10px;
        }
        .stat-row { margin-bottom: 5px; }
        .stat-label { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 3px; font-size: 0.9em; }
        .stat-bar-bg { background: #ddd; height: 8px; border-radius: 4px; overflow: hidden; }
        .stat-bar-fill { height: 100%; width: 0%; transition: width 0.3s; }
        .fill-power { background: #e74c3c; } .fill-contact { background: #f39c12; }
        .fill-defense { background: #3498db; } .fill-run { background: #9b59b6; }

        .game-screen {
            background: var(--panel-bg); border-radius: 10px; padding: 15px;
            display: flex; flex-direction: column; position: relative;
        }
        .dialog-box {
            flex-grow: 1; border: 2px solid #ccc; border-radius: 5px;
            padding: 15px; background: #fff; margin-bottom: 10px;
            overflow-y: auto; height: 250px; font-size: 0.95em; line-height: 1.6;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .log-highlight { color: var(--accent); font-weight: bold; }
        .log-success { color: var(--stadium-green); font-weight: bold; }
        .log-fail { color: #7f8c8d; }
        
        .season-stats-grid {
            background: #333; color: #fff; padding: 10px; border-radius: 5px;
            font-family: monospace; font-size: 0.85em; display: grid;
            grid-template-columns: repeat(4, 1fr); gap: 8px; text-align: center; margin-top: auto;
        }
        .stat-box { display: flex; flex-direction: column; }
        .stat-title { color: #aaa; font-size: 0.8em; }
        .stat-val { font-size: 1.1em; font-weight: bold; }

        .controls {
            background: #dcdcdc; padding: 15px; display: flex; gap: 10px;
            justify-content: center; align-items: center; border-top: 1px solid #bbb; flex-wrap: wrap;
        }
        button {
            padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;
            transition: transform 0.1s, background 0.2s; font-size: 1em; min-width: 100px;
        }
        button:active { transform: scale(0.95); }
        .btn-train { background: var(--primary); color: white; }
        .btn-train:hover { background: #34495e; }
        .btn-rest { background: var(--stadium-green); color: white; }
        .btn-rest:hover { background: #219150; }
        .btn-next { background: var(--highlight); color: #333; width: 100%; font-size: 1.2em;}
        .btn-save { background: #95a5a6; color: white; font-size: 0.9em; min-width: 80px;}
        #warning-msg { color: red; font-weight: bold; text-align: center; visibility: hidden; }

    </style>
</head>
<body>

<div class="game-container">
    
    <div id="start-screen" class="overlay">
        <h1>âš¾ å‚³å¥‡é‡çƒé¤Šæˆ</h1>
        <p>è«‹è¼¸å…¥çƒå“¡åç¨± (æœ€å¤š6å­—)</p>
        <input type="text" id="input-name" maxlength="6" value="é‡çƒå›">
        <div class="start-btn-group">
            <button class="btn-start" onclick="startGame()">é–‹å§‹æ–°éŠæˆ²</button>
            <button class="btn-load" onclick="document.getElementById('file-input').click()">ğŸ“‚ è®€å–ç´€éŒ„</button>
        </div>
        <input type="file" id="file-input" class="hidden" accept=".json" onchange="handleFileSelect(event)">
    </div>

    <div id="stadium-screen">
        <div class="match-info-bar">
            <span id="match-counter">ç¬¬ 1 å ´</span>
            <span id="ab-counter">ç¬¬ 1 æ‰“å¸­</span>
            <span id="match-stats-display">H: 0 / HR: 0</span>
        </div>
        
        <div class="field-area">
            <div id="ball-type-indicator"></div>
            <div id="speed-indicator"></div>
            <div class="mound"></div>
            <div id="baseball"></div>
            <div class="home-plate-area" id="strike-zone"></div>
            <div id="match-result-text">å®‰æ‰“!</div>
        </div>

        <button id="btn-swing" onmousedown="attemptSwing()">æ® æ£’ !</button>
        <div style="margin-top:10px; color: white; font-size:0.8em;">(çœ‹åˆ°å£çƒè«‹å‹¿æ®æ£’ï¼Œå¯ç²å¾—ä¿é€)</div>
        
        <button id="btn-next-ab" class="hidden" style="margin-top:20px; background:var(--highlight); color:#333;" onclick="nextAtBat()">ä¸‹ä¸€æ‰“å¸­</button>
        <button id="btn-end-match" class="hidden" style="margin-top:20px; background:var(--accent); color:white;" onclick="endMatch()">çµæŸæ¯”è³½</button>
    </div>

    <header>
        <div>
            <span class="player-name" id="display-name"></span>
            <span id="round-display">ç¬¬ 1 è¼ª</span>
        </div>
        <div id="day-display">ç¬¬ 1 å¤© / 90</div>
        <div class="status-badge" id="phase-display">è¨“ç·´æœŸ</div>
    </header>

    <main>
        <div class="stats-panel">
            <h3 style="margin:0;">çƒå“¡èƒ½åŠ›</h3>
            <div class="stat-row"><div class="stat-label"><span>Power</span> <span id="val-power">10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill fill-power" id="bar-power"></div></div></div>
            <div class="stat-row"><div class="stat-label"><span>Contact</span> <span id="val-contact">10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill fill-contact" id="bar-contact"></div></div></div>
            <div class="stat-row"><div class="stat-label"><span>Defense</span> <span id="val-defense">10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill fill-defense" id="bar-defense"></div></div></div>
            <div class="stat-row"><div class="stat-label"><span>Run</span> <span id="val-run">10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill fill-run" id="bar-run"></div></div></div>
            <hr style="width:100%; margin: 5px 0;">
            <h3 style="margin:0;">æœ¬å­£æˆç¸¾</h3>
            <div class="season-stats-grid">
                <div class="stat-box"><span class="stat-title">æ‰“æ“Šç‡</span><span class="stat-val" id="stat-avg">.000</span></div>
                <div class="stat-box"><span class="stat-title">å…¨å£˜æ‰“</span><span class="stat-val" id="stat-hr">0</span></div>
                <div class="stat-box"><span class="stat-title">æ‰“é»</span><span class="stat-val" id="stat-rbi">0</span></div>
                <div class="stat-box"><span class="stat-title">OPS</span><span class="stat-val" id="stat-ops">.000</span></div>
                <div class="stat-box"><span class="stat-title">ä¸Šå£˜ç‡</span><span class="stat-val" id="stat-obp">.000</span></div>
                <div class="stat-box"><span class="stat-title">é•·æ‰“ç‡</span><span class="stat-val" id="stat-slg">.000</span></div>
                <div class="stat-box"><span class="stat-title">å®‰æ‰“</span><span class="stat-val" id="stat-h">0</span></div>
                <div class="stat-box"><span class="stat-title">ä¿é€</span><span class="stat-val" id="stat-bb">0</span></div>
                <div class="stat-box"><span class="stat-title">ä¸‰æŒ¯</span><span class="stat-val" id="stat-so">0</span></div>
                <div class="stat-box"><span class="stat-title">ç¸½å®‰æ‰“</span><span class="stat-val" id="stat-tb">0</span></div>
            </div>
        </div>

        <div class="game-screen">
            <div class="dialog-box" id="game-log"></div>
            <div id="warning-msg">âš  è­¦å‘Šï¼šé€£çºŒè¨“ç·´åŒä¸€é …ç›®æ•ˆç‡æœƒå¤§å¹…é™ä½ï¼</div>
        </div>
    </main>

    <div class="controls" id="control-panel"></div>
</div>

<script>
    const MAX_STAT = 255;
    const ZONE_CENTER_X = 200; 
    const ZONE_WIDTH = 100;
    const MOUND_Y = 40;
    
    // Core Game Object
    let GameState = {
        playerName: "Player", round: 1, day: 1, phase: 'training', subCycleDay: 1,
        stats: { power: 10, contact: 10, defense: 10, run: 10 },
        records: { gamesPlayed: 0, ab: 0, h: 0, hr: 0, tb: 0, rbi: 0, bb: 0, so: 0 },
        lastTraining: null, warningActive: false,
        matchConfig: { 1: 20, 2: 30, 3: 60 }, matchesLeft: 0,
        batting: { 
            active: false, ballY: 0, ballX: 0, startX: 0, targetX: 0,
            ballSpeed: 0, isPitched: false, swung: false, atBatCount: 0, 
            currentPitchType: '', isBall: false
        }
    };

    const elLog = document.getElementById('game-log');
    const elControls = document.getElementById('control-panel');
    const elStadium = document.getElementById('stadium-screen');
    const elBall = document.getElementById('baseball');
    const elResultText = document.getElementById('match-result-text');
    const elBtnSwing = document.getElementById('btn-swing');
    const elSpeedInd = document.getElementById('speed-indicator');
    const elBallTypeInd = document.getElementById('ball-type-indicator');

    // --- Save / Load Logic ---
    function saveGame() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(GameState));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `${GameState.playerName}_save_R${GameState.round}_D${GameState.day}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        log("é€²åº¦å·²ä¿å­˜åˆ°æ‚¨çš„é›»è…¦ã€‚", "log-success");
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const savedState = JSON.parse(e.target.result);
                // Simple validation check
                if (!savedState.stats || !savedState.phase) throw new Error("Invalid Save File");
                
                GameState = savedState;
                document.getElementById('input-name').value = GameState.playerName; // Sync name input just in case
                
                // Restore UI
                document.getElementById('display-name').textContent = GameState.playerName;
                document.getElementById('start-screen').classList.add('hidden');
                updateStatsUI();
                setPhase(GameState.phase);
                
                // Clear log and welcome back
                elLog.innerHTML = '';
                log(`æ­¡è¿å›ä¾†ï¼Œ${GameState.playerName}ï¼`, "log-highlight");
                log(`å·²è®€å–é€²åº¦ï¼šç¬¬ ${GameState.round} è¼ªï¼Œç¬¬ ${GameState.day} å¤©ã€‚`, "");

                // If loaded into match state but not batting, ensure match controls
                if(GameState.phase === 'match' && elStadium.style.display !== 'flex') {
                    renderControls();
                }

            } catch (err) {
                alert("è®€å–å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                console.error(err);
            }
        };
        reader.readAsText(file);
    }

    // --- Game Logic ---

    function startGame() {
        const input = document.getElementById('input-name');
        let name = input.value.trim() || "é‡çƒå›";
        
        // Reset State for New Game
        GameState = {
            playerName: name, round: 1, day: 1, phase: 'training', subCycleDay: 1,
            stats: { power: 10, contact: 10, defense: 10, run: 10 },
            records: { gamesPlayed: 0, ab: 0, h: 0, hr: 0, tb: 0, rbi: 0, bb: 0, so: 0 },
            lastTraining: null, warningActive: false,
            matchConfig: { 1: 20, 2: 30, 3: 60 }, matchesLeft: 0,
            batting: { active: false, ballY: 0, ballX: 0, startX: 0, targetX: 0, ballSpeed: 0, isPitched: false, swung: false, atBatCount: 0, currentPitchType: '', isBall: false }
        };

        document.getElementById('display-name').textContent = name;
        document.getElementById('start-screen').classList.add('hidden');
        updateStatsUI();
        setPhase('training');
        log(`æ­¡è¿ ${name} åŠ å…¥è·æ£’é¤Šæˆè¨ˆç•«ï¼`, "log-highlight");
        log("æ–°å¢ï¼šå£çƒå°‡å¾æŠ•æ‰‹ä¸˜æŠ•å‡ºï¼Œè«‹æ³¨æ„é£›è¡Œè»Œè·¡ã€‚", "");
    }

    function log(msg, type='') {
        const div = document.createElement('div');
        div.className = 'log-entry ' + type;
        div.innerHTML = msg;
        elLog.prepend(div);
    }

    function updateStatsUI() {
        ['power','contact','defense','run'].forEach(s => {
            document.getElementById(`val-${s}`).textContent = GameState.stats[s];
            document.getElementById(`bar-${s}`).style.width = (GameState.stats[s] / MAX_STAT * 100) + '%';
        });
        
        let { ab, h, bb, tb, hr, rbi, so } = GameState.records;
        let avg = ab === 0 ? 0 : h / ab;
        let obp = (ab + bb) === 0 ? 0 : (h + bb) / (ab + bb);
        let slg = ab === 0 ? 0 : tb / ab;
        let ops = obp + slg;

        document.getElementById('stat-avg').textContent = avg.toFixed(3).replace(/^0+/, '');
        document.getElementById('stat-ops').textContent = ops.toFixed(3).replace(/^0+/, '');
        document.getElementById('stat-obp').textContent = obp.toFixed(3).replace(/^0+/, '');
        document.getElementById('stat-slg').textContent = slg.toFixed(3).replace(/^0+/, '');
        document.getElementById('stat-hr').textContent = hr;
        document.getElementById('stat-rbi').textContent = rbi;
        document.getElementById('stat-h').textContent = h;
        document.getElementById('stat-bb').textContent = bb;
        document.getElementById('stat-so').textContent = so;
        document.getElementById('stat-tb').textContent = tb;
    }

    function setPhase(phase) {
        GameState.phase = phase;
        document.getElementById('phase-display').textContent = phase === 'training' ? 'è¨“ç·´æœŸ' : (phase === 'rest' ? 'ä¼‘æ¯é€±' : 'è³½å­£ä¸­');
        document.getElementById('round-display').textContent = `ç¬¬ ${GameState.round} è¼ª`;
        document.getElementById('day-display').textContent = phase === 'match' ? `å‰©é¤˜å ´æ¬¡: ${GameState.matchesLeft}` : `ç¬¬ ${GameState.day} å¤© / 90`;
        renderControls();
    }

    function renderControls() {
        elControls.innerHTML = '';
        document.getElementById('warning-msg').style.visibility = 'hidden';

        // Add Save Button for Training/Rest phases
        const addSaveBtn = () => {
            const btn = document.createElement('button');
            btn.className = 'btn-save';
            btn.textContent = 'ğŸ’¾ ä¿å­˜é€²åº¦';
            btn.onclick = () => saveGame();
            btn.style.marginLeft = 'auto'; // push to right
            elControls.appendChild(btn);
        };

        if (GameState.phase === 'training') {
            const trainings = [
                { id: 'power', label: 'é‡è¨“ (Power)', color: '#e74c3c' },
                { id: 'contact', label: 'æ‰“æ“Š (Contact)', color: '#f39c12' },
                { id: 'defense', label: 'å®ˆå‚™ (Defense)', color: '#3498db' },
                { id: 'run', label: 'è¡åˆº (Run)', color: '#9b59b6' }
            ];
            trainings.forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'btn-train';
                btn.textContent = t.label;
                btn.style.borderLeft = `5px solid ${t.color}`;
                btn.onclick = () => handleTraining(t.id);
                elControls.appendChild(btn);
            });
            addSaveBtn();
        } else if (GameState.phase === 'rest') {
            const rests = [ {id:'shop',l:'é€›è¡—'}, {id:'movie',l:'çœ‹é›»å½±'}, {id:'date',l:'äº¤å‹'}, {id:'book',l:'çœ‹æ›¸'}, {id:'eat',l:'åƒå¤§é¤'} ];
            rests.forEach(r => {
                const btn = document.createElement('button');
                btn.className = 'btn-rest';
                btn.textContent = r.l;
                btn.onclick = () => handleRest(r.id);
                elControls.appendChild(btn);
            });
            addSaveBtn();
        } else if (GameState.phase === 'match') {
            const btn = document.createElement('button');
            btn.className = 'btn-next';
            btn.textContent = 'é€²å…¥æ¯”è³½ç¾å ´ (ä¸€çƒæ±ºå‹)';
            btn.onclick = () => startMatchMode();
            elControls.appendChild(btn);
        } else if (GameState.phase === 'post-season') {
            const btn = document.createElement('button');
            btn.className = 'btn-next';
            btn.textContent = 'é€²å…¥ 10 å¤©å­£å¾Œä¼‘æ¯';
            btn.onclick = () => endSeasonRest();
            elControls.appendChild(btn);
            addSaveBtn();
        } else if (GameState.phase === 'game-over') {
            const btn = document.createElement('button');
            btn.className = 'btn-next';
            btn.textContent = 'é‡æ–°é–‹å§‹';
            btn.onclick = () => location.reload();
            elControls.appendChild(btn);
        }
    }

    function handleTraining(type) {
        if (GameState.lastTraining === type) {
            if (!GameState.warningActive) {
                GameState.warningActive = true;
                document.getElementById('warning-msg').style.visibility = 'visible';
                log("æ•™ç·´ï¼šæ•ˆç‡åœ¨é™ä½ï¼Œå»ºè­°æ›å€‹é …ç›®è¨“ç·´ï¼", "log-highlight");
                return;
            } else {
                GameState.stats[type] = Math.max(0, GameState.stats[type] - 5);
                log(`ä½ ç„¡è¦–è­¦å‘Šå¼·è¡Œè¨“ç·´...èº«é«”å—å‚·äº†ï¼ ${type} -5`, "log-highlight");
                GameState.warningActive = false;
                advanceDay();
                updateStatsUI();
                return;
            }
        }
        GameState.lastTraining = type;
        GameState.warningActive = false;
        
        let gain = Math.floor(Math.random() * 3) + 1; // 1-3
        if (Math.random() < 0.1) {
            gain += 3;
            log(`ç‹€æ…‹çµ•ä½³ï¼è¨“ç·´æ•ˆæœè¶…ç¾¤ï¼ ${type} +${gain}`, "log-success");
        } else {
            log(`é€²è¡Œäº†${type}è¨“ç·´ã€‚ ${type} +${gain}`);
        }
        GameState.stats[type] = Math.min(MAX_STAT, GameState.stats[type] + gain);
        updateStatsUI();
        advanceDay();
    }

    function handleRest(type) {
        GameState.lastTraining = null;
        let msg = "", bonus = "";
        const rand = Math.random();
        if(type==='shop'){ msg="å»é€›è¡—ã€‚"; if(rand<0.3){GameState.stats.run+=2; bonus="è²·äº†å¥½é‹(Run+2)";} }
        else if(type==='movie'){ msg="çœ‹é›»å½±ã€‚"; if(rand<0.3){GameState.stats.power+=2; bonus="ç†±è¡€(Power+2)";} }
        else if(type==='date'){ msg="äº¤å‹ã€‚"; if(rand<0.2){GameState.stats.contact+=3; bonus="äº¤æµæŠ€å·§(Contact+3)";} }
        else if(type==='book'){ msg="çœ‹æ›¸ã€‚"; if(rand<0.4){GameState.stats.defense+=2; bonus="å­¸ç¿’æˆ°è¡“(Defense+2)";} }
        else if(type==='eat'){ msg="åƒå¤§é¤ã€‚"; if(rand<0.5){GameState.stats.power+=1;GameState.stats.contact+=1; bonus="é«”åŠ›æ¢å¾©(All+1)";} }
        log(bonus ? `${msg} <b>${bonus}</b>` : msg, bonus ? "log-success" : "");
        advanceDay();
        updateStatsUI();
    }

    function advanceDay() {
        GameState.day++;
        GameState.subCycleDay++;
        const dayInCycle = (GameState.day - 1) % 30;
        if (GameState.day > 90) { startMatchPhase(); return; }
        if (dayInCycle < 20) { if (GameState.phase !== 'training') setPhase('training'); }
        else { if (GameState.phase !== 'rest') setPhase('rest'); }
        document.getElementById('day-display').textContent = `ç¬¬ ${GameState.day} å¤© / 90`;
    }

    function startMatchPhase() {
        GameState.matchesLeft = GameState.matchConfig[GameState.round];
        setPhase('match');
        log(`== ç¬¬ ${GameState.round} è¼ªè¨“ç·´çµæŸï¼Œé–‹å§‹ ${GameState.matchesLeft} å ´æ¯”è³½ ==`, "log-highlight");
    }

    // --- Interactive Batting Logic ---

    function startMatchMode() {
        if (GameState.matchesLeft <= 0) return;
        elStadium.style.display = 'flex';
        GameState.batting.atBatCount = 0;
        updateStadiumStats();
        nextAtBat();
    }

    function updateStadiumStats() {
        document.getElementById('match-counter').textContent = `å‰©é¤˜å ´æ¬¡: ${GameState.matchesLeft}`;
        document.getElementById('match-stats-display').textContent = `æœ¬å­£æ‰“æ“Šç‡: ${document.getElementById('stat-avg').textContent}`;
    }

    function nextAtBat() {
        GameState.batting.atBatCount++;
        if (GameState.batting.atBatCount > 3) { endMatchLogic(); return; }

        document.getElementById('ab-counter').textContent = `ç¬¬ ${GameState.batting.atBatCount} æ‰“å¸­`;
        elResultText.style.display = 'none';
        elSpeedInd.style.display = 'none';
        elBallTypeInd.style.display = 'none';
        document.getElementById('btn-next-ab').classList.add('hidden');
        elBtnSwing.classList.remove('hidden');
        elBtnSwing.disabled = false;
        
        preparePitch();
    }

    function preparePitch() {
        GameState.batting.active = true;
        GameState.batting.isPitched = false;
        GameState.batting.swung = false;
        GameState.batting.ballY = MOUND_Y;
        
        // --- 1. Ball / Strike Logic ---
        const badBallChance = 0.25; // 25% Chance for Ball
        GameState.batting.isBall = Math.random() < badBallChance;
        
        // --- 2. Trajectory Logic ---
        GameState.batting.startX = ZONE_CENTER_X;
        GameState.batting.ballX = ZONE_CENTER_X;
        
        if (GameState.batting.isBall) {
            // Bad Ball Target
            const dir = Math.random();
            if (dir < 0.5) {
                // Left Ball
                GameState.batting.targetX = ZONE_CENTER_X - (ZONE_WIDTH/2) - 40 - Math.random() * 60;
            } else {
                // Right Ball
                GameState.batting.targetX = ZONE_CENTER_X + (ZONE_WIDTH/2) + 40 + Math.random() * 60;
            }
        } else {
            // Strike Target
            GameState.batting.targetX = ZONE_CENTER_X + (Math.random() * 40 - 20); 
        }

        elBall.style.top = MOUND_Y + 'px';
        elBall.style.left = ZONE_CENTER_X + 'px';
        elBall.style.display = 'block';
        elBall.style.opacity = '1';

        setTimeout(pitchBall, 1000 + Math.random() * 1000);
    }

    function pitchBall() {
        if (!GameState.batting.active) return;
        GameState.batting.isPitched = true;
        
        // --- Speed Variation (High Difficulty) ---
        const r = Math.random();
        let speed = 5;
        let label = "ç›´çƒ";
        let color = "#f1c40f";

        if (r < 0.15) {
            speed = 5 + Math.random(); label = "ç›´çƒ";
        } else if (r < 0.40) {
            speed = 9 + Math.random() * 2; label = "å¿«é€Ÿçƒ"; color = "#e67e22";
        } else if (r < 0.75) {
            speed = 13 + Math.random() * 2; label = "å‰›é€Ÿçƒ"; color = "#e74c3c";
        } else {
            speed = 22; label = "å…‰é€Ÿçƒ"; color = "#8e44ad";
        }
        
        GameState.batting.ballSpeed = speed;
        GameState.batting.currentPitchType = label;
        
        elSpeedInd.style.color = color;

        requestAnimationFrame(gameLoop);
    }

    function gameLoop() {
        if (!GameState.batting.active || !GameState.batting.isPitched || GameState.batting.swung) return;
        
        GameState.batting.ballY += GameState.batting.ballSpeed;
        
        const startY = MOUND_Y;
        const endY = 500;
        const progress = Math.min(1, (GameState.batting.ballY - startY) / (endY - startY));
        GameState.batting.ballX = GameState.batting.startX + (GameState.batting.targetX - GameState.batting.startX) * progress;

        elBall.style.top = GameState.batting.ballY + 'px';
        elBall.style.left = GameState.batting.ballX + 'px';

        if (GameState.batting.ballY > 520) { 
            handleNoSwingResult();
        } else { 
            requestAnimationFrame(gameLoop); 
        }
    }

    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && elStadium.style.display === 'flex' && !elBtnSwing.disabled) {
            attemptSwing();
        }
    });

    function attemptSwing() {
        if (!GameState.batting.isPitched || GameState.batting.swung) return;
        GameState.batting.swung = true;
        elBtnSwing.disabled = true;
        
        if (GameState.batting.isBall) {
            handleSwingResult("CHASE");
            return;
        }

        const ballPos = GameState.batting.ballY;
        const contactBonus = (GameState.stats.contact / MAX_STAT) * 30;
        const sweetCenter = 430;
        const sweetRadius = 25 + contactBonus; 
        const dist = Math.abs(ballPos - sweetCenter);

        if (dist <= sweetRadius) { handleSwingResult("HIT"); }
        else if (dist <= sweetRadius + 40) { handleSwingResult(ballPos < sweetCenter ? "EARLY" : "LATE"); }
        else { handleSwingResult("MISS"); }
    }

    function handleNoSwingResult() {
        GameState.batting.active = false;
        let text = "", color = "white", logText = "";
        
        if (GameState.batting.isBall) {
            GameState.records.bb++; text = "é¸çƒæˆåŠŸ!"; color = "#2ecc71";
            logText = `å†·éœé¸æ‰äº†åé›¢å¥½çƒå¸¶çš„<b>${GameState.batting.currentPitchType}</b>ï¼Œç²å¾—ä¿é€ã€‚`;
        } else {
            GameState.records.ab++; GameState.records.so++; text = "è¦‹é€ƒä¸‰æŒ¯"; color = "#7f8c8d";
            logText = `é¢å°å¥½çƒå¸¶çš„<b>${GameState.batting.currentPitchType}</b>æ²’æœ‰æ®æ£’ï¼Œä¸‰æŒ¯å‡ºå±€ã€‚`;
        }
        
        finalizeResult(text, color, logText, GameState.batting.isBall);
    }

    function handleSwingResult(resultType) {
        GameState.batting.active = false;
        GameState.records.ab++;
        let text = "", color = "white", logText = "";
        const pitchName = GameState.batting.currentPitchType;
        let isSuccess = false;

        if (resultType === "CHASE") {
            GameState.records.so++; text = "è¿½æ‰“å£çƒ"; color = "#95a5a6";
            logText = `è¢«é¨™äº†ï¼è¿½æ‰“å¥½çƒå¸¶å¤–çš„<b>${pitchName}</b>ï¼Œæ®ç©ºä¸‰æŒ¯ã€‚`;
        } else if (resultType === "MISS") {
            GameState.records.so++; text = "æ®æ£’è½ç©º"; color = "#bdc3c7";
            logText = `é¢å°<b>${pitchName}</b>æ®æ£’è½ç©ºï¼Œä¸‰æŒ¯å‡ºå±€ã€‚`;
        } else if (resultType === "EARLY") {
            text = "æ»¾åœ°å‡ºå±€"; color = "#f39c12";
            logText = `é¢å°<b>${pitchName}</b>å¤ªæ—©å‡ºæ£’ï¼Œæ»¾åœ°çƒå‡ºå±€ã€‚`;
        } else if (resultType === "LATE") {
            text = "æ¥æ®ºå‡ºå±€"; color = "#f39c12";
            logText = `é¢å°<b>${pitchName}</b>å¤ªæ™šå‡ºæ£’ï¼Œç„¡åŠ›é£›çƒè¢«æ¥æ®ºã€‚`;
        } else if (resultType === "HIT") {
            GameState.records.h++; color = "#e74c3c";
            const outcome = calculateHitOutcome();
            text = outcome.label; logText = `é¢å°<b>${pitchName}</b>ï¼Œ${outcome.logMsg}`;
            isSuccess = true;
        }

        finalizeResult(text, color, logText, isSuccess);
    }

    function finalizeResult(text, color, logText, isSuccess) {
        elResultText.textContent = text;
        elResultText.style.color = color;
        elResultText.style.display = 'block';
        elBall.style.display = 'none';
        
        elSpeedInd.textContent = GameState.batting.currentPitchType;
        elSpeedInd.style.display = 'block';
        elBallTypeInd.textContent = GameState.batting.isBall ? "å£çƒ" : "å¥½çƒ";
        elBallTypeInd.style.display = 'block';

        log(logText, isSuccess ? "log-success" : (text.includes("ä¸‰æŒ¯") || text.includes("å‡ºå±€") ? "log-fail" : ""));

        elBtnSwing.classList.add('hidden');
        if (GameState.batting.atBatCount < 3) document.getElementById('btn-next-ab').classList.remove('hidden');
        else document.getElementById('btn-end-match').classList.remove('hidden');
    }

    function calculateHitOutcome() {
        let wSingle = 60, wDouble = 15, wTriple = 2, wHR = 5;
        wHR += (GameState.stats.power / MAX_STAT) * 30; 
        wTriple += (GameState.stats.run / MAX_STAT) * 20; 
        wDouble += (GameState.stats.power / MAX_STAT) * 10; 
        const reducedAmount = wHR * 0.30; wHR = wHR * 0.70; wDouble += reducedAmount;

        const totalWeight = wSingle + wDouble + wTriple + wHR;
        const roll = Math.random() * totalWeight;
        let rbi = 0;
        
        if (roll < wHR) {
            GameState.records.hr++; GameState.records.tb += 4;
            rbi = 1 + Math.floor(Math.random() * 3); GameState.records.rbi += rbi;
            return { label: "å…¨å£˜æ‰“!!!", logMsg: `æ“Šå‡ºäº†å…¨å£˜æ‰“ï¼ (+${rbi}æ‰“é»)` };
        } else if (roll < wHR + wTriple) {
            GameState.records.tb += 3; rbi = Math.floor(Math.random() * 2); GameState.records.rbi += rbi;
            return { label: "ä¸‰å£˜å®‰æ‰“!", logMsg: "æƒå‡ºæ·±é ä¸‰å£˜å®‰æ‰“ï¼" };
        } else if (roll < wHR + wTriple + wDouble) {
            GameState.records.tb += 2; rbi = Math.floor(Math.random() * 2); GameState.records.rbi += rbi;
            return { label: "äºŒå£˜å®‰æ‰“!", logMsg: "æ“Šå‡ºäºŒå£˜å®‰æ‰“ï¼" };
        } else {
            GameState.records.tb += 1;
            return { label: "ä¸€å£˜å®‰æ‰“", logMsg: "æ•²å‡ºä¸€å£˜å®‰æ‰“ã€‚" };
        }
    }

    function endMatchLogic() {
        elStadium.style.display = 'none';
        document.getElementById('btn-end-match').classList.add('hidden');
        GameState.records.gamesPlayed++;
        GameState.matchesLeft--;
        updateStatsUI();

        if (GameState.matchesLeft === 0) {
            if (GameState.round < 3) {
                setPhase('post-season');
                log("æœ¬å­£è³½ç¨‹çµæŸï¼è«‹é€²è¡Œå­£å¾Œä¼‘æ¯èª¿æ•´ã€‚", "log-success");
            } else {
                endGame();
            }
        } else {
             document.getElementById('day-display').textContent = `å‰©é¤˜å ´æ¬¡: ${GameState.matchesLeft}`;
        }
    }
    
    function endMatch() { endMatchLogic(); }
    function endSeasonRest() {
        log("ç¶“éäº†10å¤©çš„ä¼‘é¤Šï¼Œèº«é«”ç‹€æ³æ¢å¾©äº†ã€‚", "log-success");
        GameState.round++; GameState.day = 1; setPhase('training');
    }

    function endGame() {
        setPhase('game-over');
        document.getElementById('round-display').textContent = "å‚³å¥‡èª•ç”Ÿ";
        document.getElementById('day-display').textContent = "ç”Ÿæ¶¯çµæŸ";
        let totalScore = GameState.stats.power + GameState.stats.contact + GameState.stats.defense + GameState.stats.run;
        let rank = "D";
        if (totalScore > 800) rank = "S"; else if (totalScore > 650) rank = "A"; else if (totalScore > 500) rank = "B"; else if (totalScore > 350) rank = "C";
        const html = `<div style="text-align:center; padding: 20px;"><h2 style="color:var(--stadium-green)">é¤ŠæˆçµæŸï¼</h2><p>çƒå“¡: ${GameState.playerName}</p><div style="font-size: 5em; font-weight: bold; color: var(--accent);">${rank}</div><hr><div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; padding: 0 20px;"><div>æ‰“æ“Šç‡: ${document.getElementById('stat-avg').textContent}</div><div>OPS: ${document.getElementById('stat-ops').textContent}</div><div>å…¨å£˜æ‰“: ${GameState.records.hr}</div><div>å®‰æ‰“æ•¸: ${GameState.records.h}</div><div>ç¸½èƒ½åŠ›: ${totalScore}</div></div></div>`;
        elLog.innerHTML = html;
    }
</script>
</body>
</html>
