<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鬼滅之刃：柱合會議・最終決戰</title>
    <style>
        body {
            margin: 0; padding: 0; background-color: #050505;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; font-family: "Microsoft JhengHei", sans-serif;
            overflow: hidden; user-select: none;
        }
        #game-container { position: relative; box-shadow: 0 0 80px rgba(138, 43, 226, 0.3); }
        canvas { background: linear-gradient(to bottom, #000000 0%, #1a0b2e 50%, #2d1b4e 100%); border: 2px solid #666; display: block; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: space-between;
        }
        .status-box { color: white; text-shadow: 2px 2px 0 #000; z-index: 10; }
        .bar-wrap { width: 280px; height: 14px; background: #222; border: 1px solid #777; margin-top: 4px; position: relative; }
        .bar-fill { height: 100%; transition: width 0.1s linear; }
        .skill-icons { display: flex; gap: 8px; margin-top: 10px; }
        .skill-box {
            width: 50px; height: 50px; background: rgba(0,0,0,0.6); border: 2px solid #aaa;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            color: white; font-size: 10px; position: relative;
        }
        .skill-key { font-size: 14px; font-weight: bold; color: #f1c40f; }
        .skill-cd { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(255, 0, 0, 0.6); height: 0%; transition: height 0.1s; }
        .v-skill { border-color: #e74c3c !important; box-shadow: 0 0 10px #e74c3c; }

        /* 狀態異常顯示 */
        .debuff-indicator {
            position: absolute; top: 150px; left: 20px; font-size: 20px; font-weight: bold;
            text-shadow: 2px 2px 0 #000; display: flex; flex-direction: column; gap: 5px;
        }

        /* 選單 */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 100; pointer-events: auto;
        }
        .diff-select { display: flex; gap: 20px; margin-bottom: 20px; }
        .diff-btn {
            padding: 10px 20px; border: 2px solid #555; background: #222; color: #aaa; cursor: pointer; font-size: 18px;
        }
        .diff-btn.active { border-color: #f1c40f; color: white; background: #444; box-shadow: 0 0 10px #f1c40f; }
        
        .grid-container { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; max-width: 900px;
        }
        .card {
            width: 130px; height: 100px; border: 1px solid #555; cursor: pointer; background: #222;
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            transition: 0.2s; padding: 5px; text-align: center;
        }
        .card:hover { transform: scale(1.1); border-color: #fff; background: #444; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .card h3 { margin: 2px; font-size: 16px; } .card p { margin: 0; font-size: 10px; color:#ccc; }

        .boss-warning {
            position: absolute; top: 35%; width: 100%; text-align: center; color: #ff0044; font-size: 80px; font-weight: 900;
            display: none; text-shadow: 0 0 30px #ff0044; letter-spacing: 10px; animation: pulse 0.3s infinite alternate;
        }
        @keyframes pulse { from {transform:scale(1);} to {transform:scale(1.1);} }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="canvas" width="960" height="540"></canvas>
    
    <div id="ui-layer" style="display:none;">
        <div style="display:flex; justify-content:space-between;">
            <div class="status-box">
                <div id="p-name" style="font-size: 22px; font-weight: bold;"></div>
                <div class="bar-wrap"><div id="hp-bar" class="bar-fill" style="background:#e74c3c;"></div></div>
                <div class="bar-wrap" style="height:6px; margin-top:2px;"><div id="mp-bar" class="bar-fill" style="background:#3498db;"></div></div>
                <div class="skill-icons">
                    <div class="skill-box"><span class="skill-key">Z</span><span id="n-z"></span><div id="cd-z" class="skill-cd"></div></div>
                    <div class="skill-box"><span class="skill-key">X</span><span id="n-x"></span><div id="cd-x" class="skill-cd"></div></div>
                    <div class="skill-box"><span class="skill-key">C</span><span id="n-c"></span><div id="cd-c" class="skill-cd"></div></div>
                    <div class="skill-box v-skill"><span class="skill-key" style="color:#ff7675">V</span><span id="n-v"></span><div id="cd-v" class="skill-cd"></div></div>
                </div>
            </div>
            <div class="status-box" style="text-align: right;">
                <div style="font-size: 24px;">KILL: <span id="score">0</span></div>
                <div id="boss-ui" style="display:none; margin-top:10px; width:300px;">
                    <div id="boss-name" style="color:#ff00ff; font-size:16px;"></div>
                    <div class="bar-wrap" style="width:100%; border-color:#ff00ff;"><div id="boss-hp" class="bar-fill" style="background:#800080;"></div></div>
                </div>
            </div>
        </div>
        <div id="debuffs" class="debuff-indicator"></div>
        <div id="msg-area" style="text-align:center; color:#ffff00; font-size:24px; font-weight:bold; height:30px; text-shadow: 2px 2px black;"></div>
    </div>

    <div id="menu-overlay" class="overlay">
        <h1 style="font-size: 32px; margin: 0 0 10px 0;">鬼滅之刃：全集中・最終決戰</h1>
        
        <div class="diff-select">
            <div class="diff-btn" onclick="setDiff('easy', this)">隊士 (簡單)</div>
            <div class="diff-btn active" onclick="setDiff('normal', this)">柱 (一般)</div>
            <div class="diff-btn" onclick="setDiff('hard', this)">繼子 (困難)</div>
        </div>

        <div class="grid-container">
            <div class="card" onclick="startGame('tanjiro')" style="border-bottom: 4px solid #27ae60"><h3>炭治郎</h3><p>水/火之神</p></div>
            <div class="card" onclick="startGame('zenitsu')" style="border-bottom: 4px solid #f1c40f"><h3>善逸</h3><p>雷之呼吸</p></div>
            <div class="card" onclick="startGame('inosuke')" style="border-bottom: 4px solid #7f8c8d"><h3>伊之助</h3><p>獸之呼吸</p></div>
            <div class="card" onclick="startGame('nezuko')" style="border-bottom: 4px solid #fd79a8"><h3>禰豆子</h3><p>血鬼術</p></div>
            <div class="card" onclick="startGame('rengoku')" style="border-bottom: 4px solid #e67e22"><h3>杏壽郎</h3><p>炎之呼吸</p></div>
            <div class="card" onclick="startGame('giyu')" style="border-bottom: 4px solid #34495e"><h3>義勇</h3><p>水之呼吸</p></div>
            <div class="card" onclick="startGame('shinobu')" style="border-bottom: 4px solid #8e44ad"><h3>胡蝶忍</h3><p>蟲之呼吸</p></div>
            <div class="card" onclick="startGame('tengen')" style="border-bottom: 4px solid #95a5a6"><h3>天元</h3><p>音之呼吸</p></div>
            <div class="card" onclick="startGame('muichiro')" style="border-bottom: 4px solid #a0e6e6"><h3>無一郎</h3><p>霞之呼吸<br>高速干擾</p></div>
            <div class="card" onclick="startGame('mitsuri')" style="border-bottom: 4px solid #ff69b4"><h3>蜜璃</h3><p>戀之呼吸<br>廣域鞭擊</p></div>
            <div class="card" onclick="startGame('obanai')" style="border-bottom: 4px solid #fff"><h3>小芭內</h3><p>蛇之呼吸<br>刁鑽路徑</p></div>
            <div class="card" onclick="startGame('sanemi')" style="border-bottom: 4px solid #2ecc71"><h3>實彌</h3><p>風之呼吸<br>大範圍擊退</p></div>
        </div>
    </div>

    <div id="end-overlay" class="overlay" style="display:none;">
        <h1 id="end-title" style="font-size: 60px;"></h1>
        <h3 id="end-score"></h3>
        <button onclick="location.reload()" style="padding:15px 40px; font-size:20px; cursor:pointer; margin-top:20px;">重新開始</button>
    </div>

    <div id="warning" class="boss-warning">BOSS WARNING</div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;
const GROUND = 200;

const keys = {};
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

const SKIN_COLOR = '#ffdbac';
const PALE_SKIN = '#f0e6d2';

// --- 難度設定 ---
let currentDiff = 'normal';
const DIFF_SETTINGS = {
    easy: { dmgMult: 0.5, bossHpMult: 0.7, bossSpdMult: 0.8 },
    normal: { dmgMult: 1.0, bossHpMult: 1.0, bossSpdMult: 1.0 },
    hard: { dmgMult: 1.5, bossHpMult: 1.3, bossSpdMult: 1.2 }
};

function setDiff(diff, btn) {
    currentDiff = diff;
    document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

// --- BOSS 資料庫 (10位, 含狀態異常) ---
const BOSS_DATA = [
    { name: "下弦之伍・累", color: "#c0392b", hp: 3000, speed: 1.5, visuals: { hair: '#fff', skin: PALE_SKIN, marks: 'dots' }, skills: [ { name: "刻線輪轉", type: 'circle_multi', range: 250, dmg: 30, cd: 150, color: '#fff' }, { name: "殺目籠", type: 'beam', range: 500, dmg: 40, cd: 200, color: '#eee', effect: 'paralysis' }, { name: "血鬼術・絲", type: 'projectile', dmg: 20, cd: 100, color: '#f00' } ] },
    { name: "下弦之壹・魘夢", color: "#8e44ad", hp: 4000, speed: 1.3, visuals: { hair: '#222', hairTip: '#c0392b', skin: PALE_SKIN, marks: 'dream' }, skills: [ { name: "強制昏睡", type: 'stun_circle', range: 220, dmg: 15, cd: 250, color: '#a29bfe', effect: 'sleep' }, { name: "夢境觸手", type: 'slash_multi', range: 130, dmg: 40, cd: 120, color: '#6c5ce7' }, { name: "夢話", type: 'projectile', dmg: 25, cd: 80, color: '#d1ccc0' } ] },
    { name: "上弦之陸・墮姬", color: "#fd79a8", hp: 5000, speed: 2.0, visuals: { hair: '#silver', hairTip: '#90ee90', skin: PALE_SKIN, marks: 'sash' }, skills: [ { name: "八重帶斬", type: 'slash_multi', range: 200, dmg: 50, cd: 120, color: '#e84393' }, { name: "蚯蚓帶", type: 'dash', range: 380, dmg: 60, cd: 180, color: '#ff7675' }, { name: "血鬼術・帶", type: 'beam', range: 380, dmg: 45, cd: 150, color: '#d63031' } ] },
    { name: "上弦之陸・妓夫太郎", color: "#2ecc71", hp: 5500, speed: 2.2, visuals: { hair: '#2ecc71', skin: '#aaa', marks: 'sickle' }, skills: [ { name: "圓斬旋迴", type: 'circle_multi', range: 180, dmg: 55, cd: 110, color: '#c0392b', effect: 'poison' }, { name: "跳梁跋扈", type: 'dash_knock', range: 300, dmg: 60, cd: 140, color: '#27ae60' }, { name: "血鐮", type: 'projectile', dmg: 35, cd: 90, color: '#e74c3c', effect: 'poison' } ] },
    { name: "上弦之伍・玉壺", color: "#9b59b6", hp: 6000, speed: 1.2, visuals: { hair: '#8e44ad', skin: '#ddd', marks: 'pot' }, skills: [ { name: "蛸壺地獄", type: 'stun_circle', range: 250, dmg: 40, cd: 220, color: '#8e44ad', effect: 'paralysis' }, { name: "血獄鉢", type: 'circle', range: 250, dmg: 50, cd: 160, color: '#3498db' }, { name: "千本針", type: 'projectile', dmg: 20, cd: 60, color: '#fff', effect: 'poison' } ] },
    { name: "上弦之肆・憎珀天", color: "#e67e22", hp: 6500, speed: 1.8, visuals: { hair: '#333', skin: PALE_SKIN, marks: 'drums' }, skills: [ { name: "狂鳴雷殺", type: 'beam', range: 500, dmg: 60, cd: 180, color: '#f1c40f', effect: 'paralysis' }, { name: "木龍召喚", type: 'dash', range: 400, dmg: 70, cd: 200, color: '#8b4513' }, { name: "激淚刺突", type: 'slash_multi', range: 200, dmg: 50, cd: 120, color: '#3498db' } ] },
    { name: "上弦之參・猗窩座", color: "#ff00ff", hp: 8000, speed: 2.5, visuals: { hair: '#ff69b4', skin: PALE_SKIN, marks: 'stripes' }, skills: [ { name: "破壞殺・亂式", type: 'dash_knock', range: 220, dmg: 70, cd: 130, color: '#00BFFF' }, { name: "破壞殺・腳式", type: 'circle', range: 280, dmg: 80, cd: 150, color: '#1e90ff' }, { name: "術式展開", type: 'buff_inv', range: 120, dmg: 30, cd: 280, color: '#87cefa' } ] },
    { name: "上弦之貳・童磨", color: "#fff", hp: 9000, speed: 2.0, visuals: { hair: '#f1e7fe', hairTip: '#e056fd', skin: PALE_SKIN, marks: 'fan' }, skills: [ { name: "蓮葉冰", type: 'triangle', range: 250, dmg: 60, cd: 120, color: '#0ff', effect: 'freeze' }, { name: "寒烈之白姬", type: 'beam', range: 550, dmg: 70, cd: 180, color: '#e0ffff', effect: 'freeze' }, { name: "霧冰・睡蓮", type: 'circle_multi', range: 300, dmg: 90, cd: 220, color: '#afeeee' } ] },
    { name: "上弦之壹・黑死牟", color: "#333", hp: 11000, speed: 2.2, visuals: { hair: '#000', skin: PALE_SKIN, marks: 'eyes' }, skills: [ { name: "月之呼吸", type: 'slash_multi', range: 450, dmg: 90, cd: 100, color: '#f1c40f' }, { name: "災禍月魄", type: 'circle_multi', range: 280, dmg: 110, cd: 200, color: '#e67e22' }, { name: "虛哭神去", type: 'beam', range: 650, dmg: 130, cd: 280, color: '#d35400' } ] },
    { name: "鬼王・鬼舞辻無慘", color: "#000", hp: 16000, speed: 2.6, visuals: { hair: '#000', skin: '#fff', marks: 'suit' }, skills: [ { name: "黑血枳棘", type: 'circle_multi', range: 550, dmg: 120, cd: 150, color: '#000', effect: 'poison' }, { name: "衝擊波", type: 'beam', range: 900, dmg: 150, cd: 250, color: '#800000', effect: 'paralysis' }, { name: "鬼鞭亂舞", type: 'slash_multi', range: 450, dmg: 100, cd: 100, color: '#444' } ] }
];

// 角色數據 (12人)
const CHAR_DATA = {
    tanjiro: { name: "竈門 炭治郎", color: "#27ae60", hair:'#7f3e3e', hp: 350, mp: 120, speed: 4.5, haori: 'checkered', skills: { z: {name:"水面斬",type:'slash',dmg:20,cost:0,cd:15,rangeX:180,color:'#00BFFF'}, x: {name:"水之車",type:'dash',dmg:40,cost:25,cd:60,rangeX:180,color:'#00BFFF'}, c: {name:"火之神",type:'circle',dmg:100,cost:60,cd:180,rangeX:140,color:'#FF4500'}, v: {name:"毀滅頭槌",type:'stun',dmg:180,cost:20,cd:100,rangeX:210,color:'#ddd'} } },
    zenitsu: { name: "我妻 善逸", color: "#f1c40f", hair:'#f1c40f', hp: 280, mp: 150, speed: 7, haori: 'triangle', skills: { z: {name:"一閃",type:'slash',dmg:18,cost:0,cd:12,rangeX:140,color:'#FFFFE0'}, x: {name:"六連",type:'dash_pierce',dmg:35,cost:20,cd:50,rangeX:350,color:'#FFD700'}, c: {name:"火雷神",type:'beam',dmg:140,cost:70,cd:220,rangeX:600,color:'#FFF'}, v: {name:"神速",type:'dash',dmg:110,cost:40,cd:150,rangeX:700,color:'#fffacd'} } },
    inosuke: { name: "嘴平 伊之助", color: "#7f8c8d", hair:null, hp: 400, mp: 100, speed: 5, haori: null, skills: { z: {name:"獠牙",type:'slash',dmg:25,cost:0,cd:20,rangeX:140,color:'#BDC3C7'}, x: {name:"豬突猛進",type:'dash_knock',dmg:55,cost:25,cd:90,rangeX:150,color:'#95a5a6'}, c: {name:"空間識覺",type:'circle_multi',dmg:90,cost:45,cd:160,rangeX:160,color:'#3498db'}, v: {name:"狂亂斬",type:'slash_multi',dmg:100,cost:30,cd:120,rangeX:260,color:'#bbb'} } },
    nezuko: { name: "竈門 禰豆子", color: "#fd79a8", hair:'#000', hp: 380, mp: 120, speed: 5.5, haori: 'kimono', skills: { z: {name:"踢擊",type:'slash',dmg:30,cost:0,cd:18,rangeX:120,color:'#d63031'}, x: {name:"爆血",type:'circle',dmg:60,cost:30,cd:80,rangeX:100,color:'#e84393'}, c: {name:"覺醒",type:'dash',dmg:120,cost:60,cd:190,rangeX:200,color:'#ff7675'}, v: {name:"爆裂重踏",type:'circle',dmg:130,cost:40,cd:140,rangeX:290,color:'#a00'} } },
    rengoku: { name: "煉獄 杏壽郎", color: "#e67e22", hair:'#f39c12', hp: 420, mp: 120, speed: 4.8, haori: 'flame', skills: { z: {name:"不知火",type:'dash',dmg:30,cost:0,cd:25,rangeX:240,color:'#e74c3c'}, x: {name:"盛炎之渦",type:'circle',dmg:55,cost:30,cd:90,rangeX:110,color:'#d35400'}, c: {name:"煉獄",type:'dash_pierce',dmg:160,cost:80,cd:250,rangeX:400,color:'#ff4757'}, v: {name:"炎虎",type:'beam',dmg:150,cost:50,cd:180,rangeX:430,color:'#ff6b6b'} } },
    giyu: { name: "富岡 義勇", color: "#2c3e50", hair:'#000', hp: 360, mp: 130, speed: 4.5, haori: 'split', skills: { z: {name:"水面斬",type:'slash',dmg:22,cost:0,cd:15,rangeX:160,color:'#3498db'}, x: {name:"流流舞",type:'dash',dmg:40,cost:20,cd:60,rangeX:150,color:'#2980b9'}, c: {name:"生生流轉",type:'beam',dmg:130,cost:60,cd:200,rangeX:300,color:'#0984e3'}, v: {name:"凪・反擊",type:'buff_inv',dmg:60,cost:40,cd:200,rangeX:250,color:'#74b9ff'} } },
    shinobu: { name: "胡蝶 忍", color: "#8e44ad", hair:'#000', hp: 250, mp: 160, speed: 7.5, haori: 'butterfly', skills: { z: {name:"戲弄",type:'dash',dmg:12,cost:0,cd:8,rangeX:200,color:'#a29bfe'}, x: {name:"蜂牙",type:'slash',dmg:35,cost:15,cd:40,rangeX:50,color:'#6c5ce7'}, c: {name:"蜈蚣舞",type:'dash_pierce',dmg:100,cost:50,cd:150,rangeX:400,color:'#8e44ad'}, v: {name:"致命連刺",type:'triangle',dmg:90,cost:30,cd:100,rangeX:270,width:80,color:'#a29bfe'} } },
    tengen: { name: "宇髓 天元", color: "#95a5a6", hair:'#eee', hp: 380, mp: 110, speed: 5.2, haori: null, skills: { z: {name:"鳴弦奏",type:'slash',dmg:35,cost:0,cd:30,rangeX:160,color:'#bdc3c7'}, x: {name:"炸藥丸",type:'circle',dmg:70,cost:30,cd:100,rangeX:130,color:'#f39c12'}, c: {name:"譜面",type:'circle_multi',dmg:150,cost:70,cd:240,rangeX:250,color:'#e67e22'}, v: {name:"定點爆破",type:'distant_boom',dmg:120,cost:40,cd:120,rangeX:350,radius:100,color:'#555'} } },
    // 新增角色
    muichiro: { name: "時透 無一郎", color: "#a0e6e6", hair:'#222', hp: 320, mp: 140, speed: 5.0, haori: null, skills: { z: {name:"平流斬",type:'slash',dmg:25,cost:0,cd:15,rangeX:160,color:'#a0e6e6'}, x: {name:"散霧",type:'dash',dmg:45,cost:20,cd:60,rangeX:150,color:'#fff'}, c: {name:"朧",type:'circle',dmg:110,cost:60,cd:180,rangeX:130,color:'#b2dfdb'}, v: {name:"雲靄",type:'buff_inv',dmg:50,cost:40,cd:160,rangeX:230,color:'#e0f2f1'} } },
    mitsuri: { name: "甘露寺 蜜璃", color: "#ff69b4", hair:'#ff69b4', hp: 360, mp: 110, speed: 5.0, haori: 'white', skills: { z: {name:"初戀",type:'slash',dmg:28,cost:0,cd:20,rangeX:240,color:'#ff69b4'}, x: {name:"貓足戀風",type:'dash',dmg:50,cost:25,cd:70,rangeX:200,color:'#ff1493'}, c: {name:"搖擺戀情",type:'circle_multi',dmg:120,cost:65,cd:200,rangeX:200,color:'#ffb6c1'}, v: {name:"甘酸之風",type:'slash_multi',dmg:90,cost:30,cd:110,rangeX:300,color:'#ffc0cb'} } },
    obanai: { name: "伊黑 小芭內", color: "#fff", hair:'#000', hp: 340, mp: 130, speed: 5.2, haori: 'stripes', skills: { z: {name:"委蛇斬",type:'slash',dmg:25,cost:0,cd:18,rangeX:180,color:'#fff'}, x: {name:"狹頭之毒牙",type:'dash',dmg:45,cost:20,cd:65,rangeX:160,color:'#800080'}, c: {name:"頸蛇雙生",type:'circle',dmg:115,cost:60,cd:190,rangeX:150,color:'#4b0082'}, v: {name:"蜿蜿長蛇",type:'beam',dmg:100,cost:40,cd:140,rangeX:450,color:'#eee'} } },
    sanemi: { name: "不死川 實彌", color: "#2ecc71", hair:'#eee', hp: 390, mp: 100, speed: 5.5, haori: 'kanji', skills: { z: {name:"塵旋風",type:'dash',dmg:30,cost:0,cd:15,rangeX:200,color:'#2ecc71'}, x: {name:"科戶風",type:'circle',dmg:55,cost:25,cd:80,rangeX:120,color:'#27ae60'}, c: {name:"韋馱天",type:'slash_multi',dmg:130,cost:70,cd:210,rangeX:250,color:'#98fb98'}, v: {name:"烈風",type:'triangle',dmg:95,cost:35,cd:130,rangeX:300,width:100,color:'#00fa9a'} } }
};

const state = { 
    run: false, score: 0, entities: [], allies: [], particles: [], 
    texts: [], projectiles: [], items: [], 
    player: null, bosses: [], shake: 0, bossIndex: 0
};

// --- 類別 ---
class FloatingText {
    constructor(text, x, y, color, size, velocityY) { this.text=text;this.x=x;this.y=y;this.color=color;this.size=size;this.life=40;this.vy=velocityY; }
    update() { this.y-=this.vy;this.life--; }
    draw() { ctx.save();ctx.globalAlpha=Math.max(0,this.life/40);ctx.fillStyle=this.color;ctx.font=`bold ${this.size}px Arial`;ctx.strokeStyle='#000';ctx.lineWidth=3;ctx.strokeText(this.text,this.x,this.y);ctx.fillText(this.text,this.x,this.y);ctx.restore(); }
}

class Item {
    constructor(x, y, type) { this.x=x;this.y=y;this.type=type;this.floatOffset=Math.random()*Math.PI*2;this.life=600; }
    update() { this.life--; this.floatOffset+=0.1; let p=state.player; if(Math.abs(p.x-this.x)<40&&Math.abs(p.y-this.y)<40){ if(this.type==='potion'){p.hp=Math.min(p.hp+200,p.maxHp);state.texts.push(new FloatingText("+200 HP",p.x,p.y-80,'#2ecc71',30,1));}else{spawnAlly();state.texts.push(new FloatingText("強力支援!",p.x,p.y-80,'#f1c40f',30,1));} this.life=0; } }
    draw() { let drawY=this.y-30+Math.sin(this.floatOffset)*5; ctx.save(); ctx.translate(this.x,drawY); if(this.type==='potion'){ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(0,0,15,0,Math.PI*2);ctx.fill();ctx.fillStyle='#2ecc71';ctx.beginPath();ctx.moveTo(-8,5);ctx.lineTo(0,-10);ctx.lineTo(8,5);ctx.fill();}else{ctx.fillStyle='#f1c40f';ctx.beginPath();ctx.arc(0,0,15,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.font="20px Arial";ctx.textAlign="center";ctx.fillText("鴉",0,7);} ctx.restore(); }
}

class Entity {
    constructor(x, y, w, h, color) { this.x=x;this.y=y;this.w=w;this.h=h;this.color=color;this.hp=100;this.maxHp=100;this.dir=1;this.hitTimer=0;this.dead=false; }
    takeDamage(amt) { this.hp-=amt;this.hitTimer=8;state.texts.push(new FloatingText(Math.floor(amt),this.x,this.y-this.h,'#fff',24,2));if(this.hp<=0)this.dead=true;for(let i=0;i<5;i++)state.particles.push({x:this.x,y:this.y-this.h/2,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,life:20,color:this.hp<=0?'#fff':'#a00'}); }
    
    drawFeatures(key, dir) {
        if(key!=='inosuke'){ctx.fillStyle=SKIN_COLOR;ctx.fillRect(-15,-65,30,25);ctx.fillStyle='#fff';ctx.fillRect(dir>0?2:-12,-55,8,6);ctx.fillStyle='#000';ctx.fillRect(dir>0?6:-8,-53,3,3);ctx.fillStyle='#d3a37f';ctx.fillRect(dir>0?8:-10,-48,2,2);ctx.fillRect(dir>0?5:-8,-43,6,1);}
        let hc=CHAR_DATA[key].hair; if(hc){ctx.fillStyle=hc;ctx.beginPath();ctx.moveTo(-20,-60);ctx.lineTo(-15,-78);ctx.lineTo(15,-78);ctx.lineTo(20,-60);ctx.lineTo(dir*22,-45);ctx.fill();}
        if(key==='tanjiro'){ctx.fillStyle='#800';ctx.fillRect(-18,-62,8,8);} if(key==='nezuko'){ctx.fillStyle='#27ae60';ctx.fillRect(dir>0?2:-14,-45,12,6);} 
        if(key==='muichiro'||key==='mitsuri'||key==='sanemi'||key==='obanai'||key==='giyu'||key==='shinobu'||key==='rengoku'||key==='tanjiro'||key==='zenitsu') {ctx.fillStyle='#fff';ctx.fillRect(-20,-35,40,8);} 
    }
}

class Ally extends Entity {
    constructor(key) { let d=CHAR_DATA[key]; super(state.player.x-50,state.player.y,40,70,d.color); this.data=d;this.key=key;this.lifeTime=1200;this.hp=9999;this.atkCd=0; }
    update() { this.lifeTime--; let target=null, minDis=9999; let targets=[...state.entities, ...state.bosses]; targets.forEach(e=>{let d=Math.abs(e.x-this.x)+Math.abs(e.y-this.y);if(d<minDis){minDis=d;target=e;}}); if(target){let dx=target.x-this.x,dy=target.y-this.y; if(Math.abs(dx)>40||Math.abs(dy)>10){this.x+=(dx>0?1:-1)*3.5;this.y+=(dy>0?1:-1)*3.5;this.dir=dx>0?1:-1;}else if(this.atkCd<=0){target.takeDamage(40);this.atkCd=35;createSkillEffect(this,{type:'slash',color:this.data.skills.z.color,rangeX:60},0);}} if(this.atkCd>0)this.atkCd--; }
    draw() { ctx.save();ctx.translate(this.x,this.y);ctx.globalAlpha=0.8; if(this.key==='inosuke'){ctx.fillStyle='#d1ccc0';ctx.fillRect(-20,-75,40,30);ctx.fillStyle='#000';ctx.fillRect(this.dir*10,-60,5,5);} ctx.fillStyle=this.color;ctx.fillRect(-20,-70,40,70);this.drawFeatures(this.key,this.dir);ctx.fillStyle='white';ctx.fillRect(-20,-90,40*(this.lifeTime/1200),4);ctx.restore(); }
}

class Player extends Entity {
    constructor(key) { 
        let d = CHAR_DATA[key];
        // 難度調整：簡單模式血量1.5倍，困難模式0.8倍
        let hpMult = currentDiff === 'easy' ? 1.5 : (currentDiff === 'hard' ? 0.8 : 1.0);
        super(100, 400, 40, 70, d.color);
        this.data = d; this.key = key;
        this.hp = d.hp * hpMult; this.maxHp = this.hp; this.mp = d.mp; this.maxMp = d.mp;
        this.cds = {z:0, x:0, c:0, v:0}; this.action = null;
        this.statuses = { poison: 0, freeze: 0, paralysis: 0 };
    }
    update() {
        // 狀態異常邏輯
        if (this.statuses.freeze > 0) { this.statuses.freeze--; return; } // 冰凍：完全不動
        if (this.statuses.paralysis > 0) { this.statuses.paralysis--; if(Math.random()<0.3) return; } // 麻痺：隨機不動
        if (this.statuses.poison > 0) { this.statuses.poison--; if(this.statuses.poison % 60 === 0) this.takeDamage(8); } // 中毒：扣血

        if (this.mp < this.maxMp) this.mp += 0.3;
        Object.keys(this.cds).forEach(k => {if(this.cds[k]>0) this.cds[k]--});
        if (this.hitTimer > 0) this.hitTimer--;
        if (this.action) { this.action.timer--; if (this.action.timer <= 0) this.action = null; return; }

        let speed = this.data.speed;
        if(this.statuses.paralysis > 0) speed *= 0.5; // 麻痺緩速

        if (keys['arrowup'] && this.y > GROUND) this.y -= speed;
        if (keys['arrowdown'] && this.y < H-10) this.y += speed;
        if (keys['arrowleft'] && this.x > 30) { this.x -= speed; this.dir = -1; }
        if (keys['arrowright'] && this.x < W-30) { this.x += speed; this.dir = 1; }

        ['z','x','c','v'].forEach(k => { if(keys[k]) this.useSkill(k); });
    }
    useSkill(k) {
        let s=this.data.skills[k]; if(this.cds[k]>0||this.mp<s.cost)return; this.mp-=s.cost;this.cds[k]=s.cd; this.action={type:s.type,timer:18,maxTimer:18,skillData:s}; state.texts.push(new FloatingText(s.name,this.x,this.y-80,s.color,24,0.5));
        if(s.type==='projectile'){for(let i=0;i<3;i++)state.projectiles.push({x:this.x,y:this.y-35,vx:Math.cos((i-1)*0.2)*10*this.dir,vy:Math.sin((i-1)*0.2)*10,life:60,color:s.color,owner:'player',dmg:s.dmg});return;}
        let targets=[...state.entities, ...state.bosses];
        targets.forEach(e=>{
            let dx=e.x-this.x, dy=Math.abs(e.y-this.y), hit=false;
            if(s.type==='triangle'){if(dx*this.dir>0&&Math.abs(dx)<s.rangeX){if(dy<(Math.abs(dx)/s.rangeX)*(s.width/2))hit=true;}}
            else if(s.type==='distant_boom'){if(Math.sqrt(((this.x+this.dir*s.rangeX)-e.x)**2+(this.y-e.y)**2)<s.radius)hit=true;}
            else if(s.type==='buff_inv'||s.type==='stun_circle'){if(Math.abs(dx)<s.rangeX&&dy<(s.rangeY||s.rangeX))hit=true;}
            else { if(dy>45)return; if(s.type.includes('circle')){if(Math.sqrt(dx*dx+dy*dy)<s.rangeX)hit=true;}else if(s.type==='beam'){if(dx*this.dir>0&&Math.abs(dx)<s.rangeX&&dy<25)hit=true;}else{if(dx*this.dir>0&&Math.abs(dx)<s.rangeX)hit=true;}}
            if(hit){e.takeDamage(s.dmg);state.shake=5;if(s.type.includes('stun'))e.hitTimer+=50;if(!s.type.includes('circle')&&s.type!=='buff_inv'&&s.type!=='distant_boom')e.x+=this.dir*30;}
        });
        if(s.type==='buff_inv')state.projectiles=state.projectiles.filter(p=>Math.sqrt((p.x-this.x)**2+(p.y-(this.y-35))**2)>80);
    }
    draw() {
        ctx.fillStyle='rgba(0,0,0,0.3)';ctx.beginPath();ctx.ellipse(this.x,this.y,20,8,0,0,Math.PI*2);ctx.fill(); ctx.save();ctx.translate(this.x,this.y);if(this.hitTimer>0&&Math.floor(Date.now()/50)%2)ctx.globalAlpha=0.5;
        
        // 狀態顏色覆蓋
        if(this.statuses.poison > 0) ctx.fillStyle='#8e44ad';
        else if(this.statuses.freeze > 0) ctx.fillStyle='#74b9ff';
        else if(this.statuses.paralysis > 0 && Math.floor(Date.now()/100)%2) ctx.fillStyle='#f1c40f';
        else ctx.fillStyle=this.color;
        
        ctx.fillRect(-20,-70,40,70); let h=this.data.haori;
        if(h==='checkered'){ctx.fillStyle='#000';for(let i=0;i<4;i++)for(let j=0;j<7;j++)if((i+j)%2)ctx.fillRect(-20+i*10,-70+j*10,10,10);}
        else if(h==='triangle'){ctx.fillStyle='#fff';for(let i=0;i<3;i++){ctx.beginPath();ctx.moveTo(-15+i*15,-70);ctx.lineTo(-7.5+i*15,-60);ctx.lineTo(0+i*15,-70);ctx.fill();}}
        else if(h==='split'){ctx.fillStyle='#a52a2a';ctx.fillRect(-20,-70,20,70);ctx.fillStyle='#27ae60';ctx.fillRect(0,-70,20,70);ctx.fillStyle='#f1c40f';for(let i=0;i<2;i++)for(let j=0;j<7;j++)ctx.fillRect(i*10,-70+j*10,5,5);}
        else if(h==='flame'){ctx.fillStyle='#f1c40f';ctx.beginPath();ctx.moveTo(-20,-10);ctx.lineTo(0,-30);ctx.lineTo(20,-10);ctx.lineTo(20,0);ctx.lineTo(-20,0);ctx.fill();}
        else if(h==='kimono'){ctx.fillStyle='#000';ctx.fillRect(-20,-70,40,25);ctx.fillStyle='#d63031';ctx.fillRect(-18,-30,10,10);ctx.fillRect(8,-20,10,10);}
        else if(h==='butterfly'){ctx.fillStyle='#ccc';ctx.beginPath();ctx.moveTo(-20,-10);ctx.lineTo(-20,0);ctx.lineTo(20,0);ctx.lineTo(20,-10);ctx.lineTo(0,-30);ctx.fill();}
        else if(h==='white'){ctx.fillStyle='#fff';ctx.fillRect(-20,-70,40,30);}
        else if(h==='stripes'){ctx.fillStyle='#333';for(let i=0;i<4;i++)ctx.fillRect(-20+i*10,-70,5,70);}
        else if(h==='kanji'){ctx.fillStyle='#fff';ctx.font="12px Arial";ctx.fillText("殺",-5,-50);}

        if(this.key==='inosuke'){ctx.fillStyle='#d1ccc0';ctx.fillRect(-20,-75,40,30);ctx.fillStyle='#000';ctx.fillRect(this.dir*10,-60,5,5);}else{this.drawFeatures(this.key,this.dir);}
        if(this.action)createSkillEffect(this,this.action.skillData,0);
        ctx.restore();
    }
}

function createSkillEffect(e,s,t) {
    ctx.fillStyle=s.color;ctx.strokeStyle=s.color;ctx.lineWidth=4;
    if(s.type==='triangle'){ctx.globalAlpha=0.6;ctx.beginPath();ctx.moveTo(0,-35);ctx.lineTo(e.dir*s.rangeX,-35-s.width/2);ctx.lineTo(e.dir*s.rangeX,-35+s.width/2);ctx.fill();}
    else if(s.type==='distant_boom'){ctx.globalAlpha=0.5;ctx.beginPath();ctx.arc(e.dir*s.rangeX,-35,s.radius,0,Math.PI*2);ctx.fill();}
    else if(s.type==='slash'||s.type==='stun'){ctx.beginPath();ctx.moveTo(0,-35);ctx.lineTo(e.dir*s.rangeX,-35+(Math.random()-0.5)*40);ctx.stroke();}
    else if(s.type.includes('dash')||s.type==='slash_multi'){ctx.globalAlpha=0.5;ctx.fillRect(0,-60,e.dir*s.rangeX,60);}
    else if(s.type==='beam'){ctx.fillRect(0,-45,e.dir*s.rangeX,20);}
    else if(s.type.includes('circle')||s.type==='buff_inv'||s.type==='stun_circle'){ctx.globalAlpha=0.4;ctx.beginPath();ctx.arc(0,-35,s.rangeX,0,Math.PI*2);ctx.fill();}
}

class Enemy extends Entity {
    constructor(x, y, type, bossData = null) {
        let isBoss = type === 'boss';
        super(x, y, isBoss?70:40, isBoss?90:70, isBoss?bossData.color:(type==='ranged'?'#2980b9':'#c0392b'));
        this.type = type; this.isBoss = isBoss;
        
        // 難度係數
        let diff = DIFF_SETTINGS[currentDiff];
        let hpBase = isBoss ? bossData.hp : (type==='ranged'?50:80);
        let dmgBase = 10; // 雜魚基礎傷
        
        this.hp = hpBase * (isBoss ? diff.bossHpMult : 1);
        this.maxHp = this.hp; 
        this.speed = (isBoss ? bossData.speed * diff.bossSpdMult : 1.3); 
        this.atkCd = 0;
        this.baseDmg = isBoss ? 0 : (dmgBase * diff.dmgMult);

        if(isBoss) { 
            this.bossData = bossData; 
            this.bossSkillCds = [0,0,0]; 
            this.bossGlobalCd = 0; 
            this.isCharging = false;
            this.chargeTimer = 0;
            this.pendingSkill = null;
            this.summonTimer = 500; 
        }
    }
    update(p) {
        if(this.hitTimer>0) {this.hitTimer--; return;} if(this.dead) return;
        
        if(this.isBoss){
            if(this.bossGlobalCd > 0) this.bossGlobalCd--;
            this.bossSkillCds.forEach((cd,i) => { if(cd>0) this.bossSkillCds[i]-- });
            
            // Boss 召喚 2 隻
            this.summonTimer--;
            if (this.summonTimer <= 0) {
                if (state.entities.length < 8) {
                     for(let k=0; k<2; k++) {
                         let type = Math.random()<0.3 ? 'ranged' : 'melee';
                         state.entities.push(new Enemy(Math.random()<0.5?-50:W+50, Math.random()*(H-GROUND-20)+GROUND, type));
                     }
                     state.texts.push(new FloatingText("雜魚召喚 x2!", this.x, this.y - 120, '#aaa', 24, 1));
                }
                this.summonTimer = 600 + Math.random() * 300;
            }

            if (this.isCharging) {
                this.chargeTimer--;
                if (this.chargeTimer <= 0) {
                    this.executeBossSkill(p);
                    this.isCharging = false;
                    this.bossGlobalCd = 180; 
                }
                return; 
            }
        }

        let target = p; let minDis = Math.abs(p.x-this.x)+Math.abs(p.y-this.y);
        state.allies.forEach(a => { let d = Math.abs(a.x-this.x)+Math.abs(a.y-this.y); if(d<minDis){minDis=d;target=a;} });

        let dx = target.x-this.x, dy = target.y-this.y, dist = Math.sqrt(dx*dx+dy*dy);
        let stopDist = this.type === 'ranged' ? 350 : (this.isBoss?150:40);
        
        if (Math.abs(dx)>stopDist || Math.abs(dy)>20) {
            this.x+=(dx>0?1:-1)*this.speed; this.y+=(dy>0?1:-1)*this.speed; this.dir=dx>0?1:-1;
        }

        if (this.isBoss) {
            if (this.bossGlobalCd <= 0) {
                let availableSkills = [];
                this.bossData.skills.forEach((s, i) => { if(this.bossSkillCds[i] <= 0) availableSkills.push({s, i}); });
                if (availableSkills.length > 0) {
                    let chosen = availableSkills[Math.floor(Math.random()*availableSkills.length)];
                    this.startCharging(chosen.s, chosen.i); 
                }
            }
        } else {
            if (this.atkCd <= 0) {
                if (this.type === 'ranged' && Math.abs(dy) < 60) {
                    let dmg = 15 * DIFF_SETTINGS[currentDiff].dmgMult;
                    state.projectiles.push({x:this.x, y:this.y-35, vx:Math.cos(Math.atan2(dy,dx))*8, vy:Math.sin(Math.atan2(dy,dx))*8, life:100, color:'#f00', owner:'enemy', dmg: dmg});
                    this.atkCd = 200; 
                } else if (dist < 90) {
                    target.takeDamage(this.baseDmg); this.atkCd = 110;
                }
            } else { this.atkCd--; }
        }
    }

    startCharging(skill, index) {
        this.isCharging = true;
        this.chargeTimer = 70; 
        this.pendingSkill = skill;
        this.bossSkillCds[index] = skill.cd;
        state.texts.push(new FloatingText("⚠ " + skill.name, this.x, this.y - 120, '#ff0000', 30, 0.2));
    }

    executeBossSkill(target) {
        let s = this.pendingSkill;
        state.shake = 10;
        let skillDmg = s.dmg * DIFF_SETTINGS[currentDiff].dmgMult;
        
        if (s.type === 'projectile') {
             state.projectiles.push({x:this.x, y:this.y-40, vx:this.dir*9, vy:0, life:80, color:s.color, owner:'enemy', dmg: skillDmg, effect: s.effect});
        } else {
            let targets = [state.player, ...state.allies];
            targets.forEach(e => {
                let dx = e.x - this.x, dy = Math.abs(e.y - this.y);
                let hit = false;
                if (s.type.includes('circle') || s.type === 'buff_inv' || s.type === 'stun_circle') { if (Math.sqrt(dx*dx + dy*dy) < s.range) hit = true; }
                else if (s.type === 'beam') { if (dx * this.dir > 0 && Math.abs(dx) < s.range && dy < 30) hit = true; }
                else { if (dx * this.dir > 0 && Math.abs(dx) < s.range && dy < 50) hit = true; }

                if (hit) {
                    e.takeDamage(skillDmg);
                    // 應用狀態異常 (只對玩家有效)
                    if (e === state.player && s.effect) {
                        if (s.effect === 'poison') { state.player.statuses.poison = 300; state.texts.push(new FloatingText("中毒!", e.x, e.y-100, '#8e44ad', 30, 1)); }
                        if (s.effect === 'freeze') { state.player.statuses.freeze = 120; state.texts.push(new FloatingText("冰凍!", e.x, e.y-100, '#74b9ff', 30, 1)); }
                        if (s.effect === 'paralysis') { state.player.statuses.paralysis = 300; state.texts.push(new FloatingText("麻痺!", e.x, e.y-100, '#f1c40f', 30, 1)); }
                        if (s.effect === 'sleep') { state.player.statuses.freeze = 180; state.texts.push(new FloatingText("昏睡!", e.x, e.y-100, '#aaa', 30, 1)); } // 昏睡等同長時間冰凍
                    }
                    if(s.type.includes('knock')) e.x += this.dir * 80;
                    if(s.type.includes('stun')) e.hitTimer += 60;
                }
            });
            createSkillEffect(this, {type: s.type.includes('circle')||s.type.includes('stun')?'circle':'beam', color:s.color, rangeX:s.range}, 0);
        }
    }

    draw() {
        ctx.fillStyle='rgba(0,0,0,0.3)';ctx.beginPath();ctx.ellipse(this.x,this.y,this.w/2,8,0,0,Math.PI*2);ctx.fill();
        
        if (this.isBoss && this.isCharging && this.pendingSkill) {
            let s = this.pendingSkill;
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.fillStyle = `rgba(255, 0, 0, ${0.2 + Math.sin(Date.now()/50)*0.1})`; 
            ctx.strokeStyle = 'red'; ctx.lineWidth = 2;
            if (s.type.includes('circle') || s.type === 'buff_inv' || s.type === 'stun_circle') {
                ctx.beginPath(); ctx.arc(0, 0, s.range, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            } else if (s.type === 'beam' || s.type.includes('slash')) {
                ctx.fillRect(0, -30, this.dir * s.range, 60); ctx.strokeRect(0, -30, this.dir * s.range, 60);
            } else if (s.type.includes('dash')) {
                ctx.fillRect(0, -40, this.dir * s.range, 80); ctx.strokeRect(0, -40, this.dir * s.range, 80);
            }
            ctx.restore();
        }

        ctx.save(); ctx.translate(this.x, this.y);
        if (this.hitTimer>0) ctx.globalAlpha = 0.5;
        ctx.fillStyle = this.color; ctx.fillRect(-this.w/2, -this.h, this.w, this.h);
        
        if (!this.isBoss && this.type !== 'ranged') {
            ctx.fillStyle = SKIN_COLOR; ctx.fillRect(-10, -this.h+10, 20, 20);
            ctx.fillStyle = 'yellow'; ctx.fillRect(this.dir>0?2:-8, -this.h+15, 6, 4); 
            ctx.fillStyle = 'red'; ctx.fillRect(this.dir>0?2:-8, -this.h+25, 6, 2);
        }
        
        if (this.isBoss) {
            const v = this.bossData.visuals; ctx.fillStyle = v.skin; ctx.fillRect(-this.w/2+5, -this.h+5, this.w-10, 30);
            ctx.fillStyle = (this.bossData.name.includes('黑死牟')||this.bossData.name.includes('無慘')) ? 'red' : 'yellow';
            ctx.fillRect(this.dir>0?8:-18, -this.h+15, 10, 6);
            if (v.hair) {
                ctx.fillStyle = v.hair; ctx.beginPath(); ctx.moveTo(-this.w/2, -this.h+10); ctx.lineTo(this.w/2, -this.h+10); ctx.lineTo(this.w/2+5, -this.h-15); ctx.lineTo(-this.w/2-5, -this.h-15); ctx.fill();
                if(v.hairTip) { ctx.fillStyle = v.hairTip; ctx.fillRect(this.dir>0?this.w/2:-this.w/2-10, -this.h, 10, 20); }
            }
            if (v.marks === 'dots') { ctx.fillStyle = 'red'; ctx.fillRect(this.dir>0?12:-14, -this.h+25, 3, 3); ctx.fillRect(this.dir>0?16:-18, -this.h+22, 3, 3); }
            else if (v.marks === 'sash') { ctx.fillStyle = '#ffb6c1'; ctx.fillRect(-this.w/2, -this.h/2-10, this.w, 15); }
            else if (v.marks === 'sickle') { ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(0, -this.h/2, 30, 0, Math.PI, true); ctx.stroke(); }
            else if (v.marks === 'eyes') { ctx.fillStyle = 'red'; ctx.fillRect(0, -this.h+10, 4, 4); ctx.fillRect(0, -this.h+20, 4, 4); }
            else if (v.marks === 'suit') { ctx.fillStyle = '#fff'; ctx.fillRect(-5, -this.h+30, 10, 20); ctx.fillStyle = '#000'; ctx.fillRect(-2, -this.h+30, 4, 20); }
            
            ctx.strokeStyle = '#fff'; ctx.lineWidth=3; ctx.strokeRect(-this.w/2+5, -this.h+5, this.w-10, this.h-10);
        } else if (this.type==='ranged') {
            ctx.fillStyle = '#0ff'; ctx.fillRect(0, -this.h/2, 10, 10);
        }
        if (!this.isBoss && this.hp < this.maxHp) {
            ctx.fillStyle = 'red'; ctx.fillRect(-20,-this.h-10,40,4); ctx.fillStyle = '#0f0'; ctx.fillRect(-20,-this.h-10,40*(this.hp/this.maxHp),4);
        }
        ctx.restore();
    }
}

// --- 系統 ---
function loop() {
    if (!state.run) return;
    ctx.clearRect(0,0,W,H); ctx.save();
    if (state.shake > 0) { ctx.translate((Math.random()-0.5)*state.shake, (Math.random()-0.5)*state.shake); state.shake *= 0.9; if(state.shake<0.5) state.shake=0; }

    state.player.update(); if (state.player.hp <= 0) return gameOver(false);

    // Update UI Debuffs
    let dbText = "";
    if(state.player.statuses.poison > 0) dbText += `<span style="color:#8e44ad">中毒</span>`;
    if(state.player.statuses.freeze > 0) dbText += `<span style="color:#74b9ff">冰凍</span>`;
    if(state.player.statuses.paralysis > 0) dbText += `<span style="color:#f1c40f">麻痺</span>`;
    document.getElementById('debuffs').innerHTML = dbText;

    if (state.bosses.length === 0) {
        if (state.score > 0 && state.score % 20 === 0) spawnBoss();
        else if (state.entities.length < 6 && Math.random() < 0.018) {
            state.entities.push(new Enemy(W+60, Math.random()*(H-GROUND-20)+GROUND, Math.random()<0.25?'ranged':'melee'));
        }
    }

    state.allies.forEach((a,i) => { a.update(); if(a.lifeTime<=0) state.allies.splice(i,1); });

    let activeBosses = state.bosses.filter(b => !b.dead);
    state.bosses = activeBosses;
    if (state.bosses.length === 0) { document.getElementById('boss-ui').style.display='none'; }
    
    [...state.entities, ...state.bosses].forEach(e => {
        if(e) {
            e.update(state.player);
            if(e.dead) {
                if(!e.isBoss) { state.entities = state.entities.filter(ent => ent !== e); if (Math.random() < 0.35) state.items.push(new Item(e.x, e.y, Math.random()<0.6?'potion':'summon')); state.score++; }
            }
        }
    });

    state.items.forEach((item, i) => { item.update(); if(item.life<=0) state.items.splice(i,1); });

    state.projectiles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.life--;
        if (p.owner === 'enemy') {
            let targets = [state.player, ...state.allies];
            targets.forEach(t => { 
                if(p.life>0 && Math.abs(p.x-t.x)<25 && Math.abs(p.y-t.y+35)<35) { 
                    t.takeDamage(p.dmg||15); p.life=0; 
                    if(t===state.player && p.effect) {
                        if(p.effect==='poison') state.player.statuses.poison=300;
                        if(p.effect==='paralysis') state.player.statuses.paralysis=300;
                    }
                } 
            });
        } else if (p.owner === 'player') {
             [...state.entities, ...state.bosses].forEach(e => { if(p.life>0 && Math.abs(p.x-e.x)<30 && Math.abs(p.y-e.y+35)<40) { e.takeDamage(p.dmg); p.life=0; } });
        }
        if(p.life<=0) state.projectiles.splice(i,1);
    });

    state.particles.forEach((p, i) => { p.x+=p.vx; p.y+=p.vy; p.life--; if(p.life<=0) state.particles.splice(i,1); });
    state.texts.forEach((t, i) => { t.update(); if(t.life<=0) state.texts.splice(i,1); });

    ctx.strokeStyle = '#555'; ctx.beginPath(); ctx.moveTo(0, GROUND); ctx.lineTo(W, GROUND); ctx.stroke();

    let renderList = [...state.entities, ...state.bosses, state.player, ...state.allies, ...state.items, ...state.particles, ...state.texts];
    renderList.sort((a,b) => (a.y||0) - (b.y||0));
    renderList.forEach(e => { if(e.draw) e.draw(); else { ctx.fillStyle=e.color; ctx.beginPath(); ctx.arc(e.x,e.y,e.size||3,0,Math.PI*2); ctx.fill(); } });
    state.projectiles.forEach(p => { ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,5,0,Math.PI*2); ctx.fill(); });

    ctx.restore();
    updateUI();
    requestAnimationFrame(loop);
}

function updateUI() {
    let p = state.player;
    document.getElementById('hp-bar').style.width = (p.hp/p.maxHp*100) + '%';
    document.getElementById('mp-bar').style.width = (p.mp/p.maxMp*100) + '%';
    document.getElementById('score').innerText = state.score;
    ['z','x','c','v'].forEach(k => { document.getElementById(`cd-${k}`).style.height = (p.cds[k]/p.data.skills[k].cd*100) + '%'; });
    if (state.bosses.length > 0) {
        let totalHp = 0, totalMax = 0; let names = "";
        state.bosses.forEach(b => { totalHp += b.hp; totalMax += b.maxHp; names += b.bossData.name + " "; });
        document.getElementById('boss-hp').style.width = (totalHp/totalMax*100) + '%';
        document.getElementById('boss-name').innerText = names;
    }
}

function spawnAlly() {
    let keys = Object.keys(CHAR_DATA); let rk = keys[Math.floor(Math.random()*keys.length)];
    while(rk===state.player.key) rk = keys[Math.floor(Math.random()*keys.length)];
    state.allies.push(new Ally(rk));
    document.getElementById('msg-area').innerText = `${CHAR_DATA[rk].name} 參戰!`;
    setTimeout(()=>document.getElementById('msg-area').innerText = "", 2000);
}

function startGame(key) {
    document.getElementById('menu-overlay').style.display = 'none';
    document.getElementById('ui-layer').style.display = 'block';
    state.player = new Player(key);
    state.entities = []; state.allies = []; state.particles = []; state.texts = []; state.projectiles = []; state.items = []; state.bosses = [];
    state.score = 0; state.run = true; state.bossIndex = 0;
    let p = state.player;
    document.getElementById('p-name').innerText = p.data.name; document.getElementById('p-name').style.color = p.data.color;
    ['z','x','c','v'].forEach(k => document.getElementById(`n-${k}`).innerText = p.data.skills[k].name);
    document.getElementById('boss-ui').style.display = 'none';
    loop();
}

function spawnBoss() {
    let w = document.getElementById('warning'); w.style.display = 'block';
    state.score += 1; 
    setTimeout(() => { 
        w.style.display = 'none'; 
        let bossIdx = state.bossIndex % BOSS_DATA.length;
        // 第9戰(黑死牟)時，額外召喚童磨 (雙Boss)
        if (bossIdx === 8) {
            let boss1 = new Enemy(W-100, 400, 'boss', BOSS_DATA[8]); 
            let boss2 = new Enemy(W-100, 300, 'boss', BOSS_DATA[7]); 
            state.bosses.push(boss1, boss2);
            document.getElementById('msg-area').innerText = "絕望：上弦壹 & 貳 同時降臨！";
        } else {
            let bossInfo = BOSS_DATA[bossIdx];
            state.bosses.push(new Enemy(W-100, 400, 'boss', bossInfo));
        }
        document.getElementById('boss-ui').style.display = 'block'; 
        state.bossIndex++;
    }, 2500);
}

function gameOver(win) {
    state.run = false;
    let end = document.getElementById('end-overlay'); end.style.display = 'flex';
    document.getElementById('end-title').innerText = win ? "惡鬼滅殺" : "力盡倒下";
    document.getElementById('end-title').style.color = win ? "#f1c40f" : "#e74c3c";
    document.getElementById('end-score').innerText = "擊殺數: " + state.score;
}
</script>
</body>
</html>
