<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨åŠŸèƒ½ç”˜ç‰¹åœ–ï¼šå…§å®¹æ¬„ä½ + å¹´è¦–åœ–</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #475569;
            --bg-color: #f8fafc;
            --border-color: #e2e8f0;
            --main-task-color: #3b82f6;
            --sub-task-color: #10b981;
            --weekend-color: #f1f5f9;
            --column-width: 40px; 
            --row-height: 42px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 20px;
            background-color: var(--bg-color); color: #333;
            user-select: none;
        }

        .container {
            max-width: 1400px; margin: 0 auto;
            background: white; padding: 20px;
            border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h2 { border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 0; }

        /* å·¥å…·åˆ— */
        .toolbar {
            display: flex; gap: 10px; margin-bottom: 20px; padding: 10px;
            background: #eff6ff; border-radius: 6px; align-items: center; flex-wrap: wrap;
        }
        .btn-tool {
            padding: 8px 15px; border: 1px solid #bfdbfe; background: white; color: #1e40af;
            border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px;
        }
        .btn-tool:hover { background: #dbeafe; }
        
        .view-switcher {
            display: flex; background: #fff; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; margin-left: auto;
        }
        .view-btn {
            border: none; background: #fff; padding: 8px 15px; cursor: pointer; border-right: 1px solid #ccc; font-size: 14px;
        }
        .view-btn:last-child { border-right: none; }
        .view-btn.active { background: #2563eb; color: white; }

        /* è¼¸å…¥å€ */
        .input-group {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px; margin-bottom: 20px; align-items: end;
            background: #f1f5f9; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;
        }
        .form-control { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: 600; font-size: 0.85em; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        input[disabled] { background-color: #e2e2e2; cursor: not-allowed; }

        .btn-action { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-add { background-color: var(--primary-color); }
        .btn-update { background-color: #d97706; display: none; }
        .btn-cancel { background-color: #64748b; margin-left: 5px; display: none; }

        /* åˆ—è¡¨å€ */
        .task-list-container {
            max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); margin-bottom: 20px;
        }
        .task-list { width: 100%; border-collapse: collapse; }
        .task-list th { position: sticky; top: 0; background: #eee; z-index: 2; padding: 10px; text-align: left; }
        .task-list td { padding: 8px 10px; border-bottom: 1px solid var(--border-color); font-size: 0.9em; vertical-align: middle; }
        .type-main { font-weight: bold; color: var(--primary-color); }
        .type-sub { padding-left: 20px; color: var(--secondary-color); }
        
        .action-cell button { margin-right: 5px; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; color: white; font-size: 0.8em; }
        .btn-edit { background-color: #f59e0b; }
        .btn-del { background-color: #ef4444; }

        .btn-generate { width: 100%; padding: 12px; background: #0f172a; color: white; font-weight: bold; border: none; border-radius: 4px; font-size: 1.1em; cursor: pointer; }

        /* ç”˜ç‰¹åœ–æ ¸å¿ƒ */
        #gantt-chart-view {
            display: none; border: 1px solid var(--border-color); background: white; margin-top: 20px; position: relative;
        }
        .gantt-header { display: flex; border-bottom: 1px solid #ddd; background: #f8f9fa; height: 40px; }
        .gantt-sidebar-header { min-width: 220px; width: 220px; padding: 10px; font-weight: bold; border-right: 1px solid #ddd; background: #f8f9fa; z-index: 20; box-sizing: border-box; }
        
        .timeline-header-container { overflow: hidden; flex-grow: 1; position: relative; }
        .timeline-header { display: flex; height: 100%; position: relative; }
        
        /* æ¨™é¡Œå„²å­˜æ ¼æ¨£å¼ */
        .header-cell {
            text-align: center; border-right: 1px solid #eee; font-size: 0.8em; padding: 10px 0; box-sizing: border-box;
            white-space: nowrap; overflow: hidden; display: inline-block;
        }

        .gantt-scroll-wrapper { display: flex; overflow: auto; max-height: 500px; position: relative; }
        .gantt-sidebar { min-width: 220px; width: 220px; position: sticky; left: 0; background: white; z-index: 10; border-right: 1px solid #ddd; }
        
        .task-name-cell { height: var(--row-height); padding: 0 10px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; box-sizing: border-box; }
        
        .gantt-timeline-area { position: relative; flex-grow: 1; }
        .grid-background { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: block; z-index: 0; pointer-events: none; }
        .grid-line {
            border-right: 1px solid #f5f5f5; height: 100%; box-sizing: border-box; position: absolute; top: 0;
        }
        .weekend { background-color: var(--weekend-color); }

        #arrow-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .arrow-line { stroke: #94a3b8; stroke-width: 2; fill: none; }
        
        .bar-row { height: var(--row-height); border-bottom: 1px solid transparent; position: relative; box-sizing: border-box; }
        .bar {
            position: absolute; height: 24px; top: 9px; border-radius: 4px; color: white; font-size: 12px;
            display: flex; align-items: center; padding-left: 8px; white-space: nowrap; overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: grab; z-index: 5;
        }
        .bar:active { cursor: grabbing; opacity: 0.8; }
        .bar.main { background-color: var(--main-task-color); }
        .bar.sub { background-color: var(--sub-task-color); }

    </style>
</head>
<body>

<div class="container">
    <h2>å°ˆæ¡ˆç®¡ç†ç”˜ç‰¹åœ– (Pro)</h2>

    <div class="toolbar">
        <button class="btn-tool" onclick="saveProject()">ğŸ’¾ å­˜æª”</button>
        <button class="btn-tool" onclick="document.getElementById('fileInput').click()">ğŸ“‚ è®€æª”</button>
        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="loadProject(this)">
        <button class="btn-tool" onclick="exportToImage()">ğŸ“· åŒ¯å‡ºåœ–ç‰‡</button>

        <div class="view-switcher">
            <button class="view-btn active" onclick="switchView('day')" id="view-day">æ—¥</button>
            <button class="view-btn" onclick="switchView('week')" id="view-week">é€±</button>
            <button class="view-btn" onclick="switchView('month')" id="view-month">æœˆ</button>
            <button class="view-btn" onclick="switchView('year')" id="view-year">å¹´</button>
        </div>
    </div>

    <div class="input-group">
        <input type="hidden" id="taskId">
        
        <div class="form-control">
            <label>ä»»å‹™åç¨±</label>
            <input type="text" id="taskName" placeholder="ä»»å‹™åç¨±">
        </div>
        <div class="form-control" style="flex-grow: 2;">
            <label>ä»»å‹™å…§å®¹</label>
            <input type="text" id="taskContent" placeholder="ç°¡è¿°ä»»å‹™å…§å®¹">
        </div>
        
        <div class="form-control">
            <label>é¡å‹</label>
            <select id="taskType">
                <option value="main">ä¸»é …ç›®</option>
                <option value="sub">â”” å­é …ç›®</option>
            </select>
        </div>
        <div class="form-control">
            <label>å‰ç½®</label>
            <select id="predecessor" onchange="checkPredecessor(this)">
                <option value="">(ç„¡)</option>
            </select>
        </div>
        <div class="form-control">
            <label>é–‹å§‹æ—¥æœŸ</label>
            <input type="date" id="startDate">
        </div>
        <div class="form-control">
            <label>å¤©æ•¸</label>
            <input type="number" id="duration" min="1" value="3" style="width: 60px;">
        </div>
        
        <div style="display:flex;">
            <button class="btn-action btn-add" id="btnAdd" onclick="addOrUpdateTask()">+ åŠ å…¥</button>
            <button class="btn-action btn-update" id="btnUpdate" onclick="addOrUpdateTask()">æ›´æ–°</button>
            <button class="btn-action btn-cancel" id="btnCancel" onclick="cancelEdit()">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="task-list-container">
        <table class="task-list">
            <thead>
                <tr>
                    <th width="20%">ä»»å‹™åç¨±</th>
                    <th width="25%">å…§å®¹</th> <th>é–‹å§‹æ—¥æœŸ</th>
                    <th>çµæŸæ—¥æœŸ</th>
                    <th>å¤©æ•¸</th>
                    <th>å‰ç½®</th>
                    <th width="100">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="taskListBody"></tbody>
        </table>
    </div>

    <button class="btn-generate" onclick="generateGantt()">ç”¢å‡º / é‡ç¹ªç”˜ç‰¹åœ–</button>

    <div id="gantt-chart-view">
        <div class="gantt-header">
            <div class="gantt-sidebar-header">é …ç›®åˆ—è¡¨</div>
            <div class="timeline-header-container" id="timelineHeaderContainer">
                <div class="timeline-header" id="timelineHeader"></div>
            </div>
        </div>
        
        <div class="gantt-scroll-wrapper" id="ganttScrollWrapper">
            <div class="gantt-sidebar" id="ganttSidebar"></div>
            <div class="gantt-timeline-area" id="ganttTimelineArea">
                <div class="grid-background" id="gridBackground"></div>
                <svg id="arrow-layer"></svg>
                <div id="barsContainer"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let tasks = [];
    
    // è¦–åœ–è¨­å®šï¼šå¹´æ¨¡å¼å¢åŠ 
    let currentView = 'day'; 
    const VIEW_CONFIG = {
        day: { pxPerDay: 40 },
        week: { pxPerDay: 15 },
        month: { pxPerDay: 4 },
        year: { pxPerDay: 1 } // ä¸€å¹´ç´„ 365px
    };

    const ROW_HEIGHT = 42;

    document.getElementById('startDate').valueAsDate = new Date();

    // ----------------------------
    // å·¥å…·å‡½å¼
    // ----------------------------
    function formatDate(date) { return date.toISOString().split('T')[0]; }
    function addDays(dateStr, days) {
        const d = new Date(dateStr);
        d.setDate(d.getDate() + days);
        return d;
    }
    
    function checkPredecessor(select) {
        const predId = select.value;
        const dateInput = document.getElementById('startDate');
        if (predId) {
            const predTask = tasks.find(t => t.id === predId);
            if (predTask) {
                const newStart = addDays(predTask.start, predTask.duration);
                dateInput.value = formatDate(newStart);
                dateInput.disabled = true;
                dateInput.title = "ç”±å‰ç½®ä»»å‹™è‡ªå‹•æ±ºå®š";
            }
        } else {
            dateInput.disabled = false;
            dateInput.title = "";
        }
    }

    // ----------------------------
    // è³‡æ–™æ“ä½œ (CRUD)
    // ----------------------------

    function addOrUpdateTask() {
        const id = document.getElementById('taskId').value;
        const name = document.getElementById('taskName').value;
        const content = document.getElementById('taskContent').value; // è®€å–å…§å®¹
        const type = document.getElementById('taskType').value;
        let start = document.getElementById('startDate').value;
        const duration = parseInt(document.getElementById('duration').value);
        const predecessorId = document.getElementById('predecessor').value || null;

        if (!name || !start || !duration) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"); return; }

        if (predecessorId) {
            const predTask = tasks.find(t => t.id === predecessorId);
            if (predTask) {
                const calculatedDate = addDays(predTask.start, predTask.duration);
                start = formatDate(calculatedDate);
            }
        }

        if (id) {
            const taskIndex = tasks.findIndex(t => t.id === id);
            if (taskIndex > -1) {
                // æ›´æ–°ç‰©ä»¶åŒ…å« content
                tasks[taskIndex] = { id, name, content, type, start, duration, predecessorId };
            }
            cancelEdit();
        } else {
            const newTask = {
                id: Date.now().toString(),
                name, content, type, start, duration, predecessorId
            };
            tasks.push(newTask);
        }

        recalculateAllDates();
        updateUI();
        
        if (!id) {
            document.getElementById('taskName').value = '';
            document.getElementById('taskContent').value = ''; // æ¸…ç©ºå…§å®¹
            document.getElementById('taskName').focus();
        }
    }

    function recalculateAllDates() {
        let changed = true;
        let loops = 0;
        while(changed && loops < tasks.length + 1) {
            changed = false;
            tasks.forEach(task => {
                if (task.predecessorId) {
                    const parent = tasks.find(t => t.id === task.predecessorId);
                    if (parent) {
                        const newStart = formatDate(addDays(parent.start, parent.duration));
                        if (task.start !== newStart) {
                            task.start = newStart;
                            changed = true;
                        }
                    }
                }
            });
            loops++;
        }
    }

    function editTask(id) {
        const task = tasks.find(t => t.id === id);
        if (!task) return;

        document.getElementById('taskId').value = task.id;
        document.getElementById('taskName').value = task.name;
        document.getElementById('taskContent').value = task.content || ''; // å¡«å…¥å…§å®¹
        document.getElementById('taskType').value = task.type;
        document.getElementById('duration').value = task.duration;
        
        updatePredecessorSelect(task.id); 
        document.getElementById('predecessor').value = task.predecessorId || "";
        document.getElementById('startDate').value = task.start;
        checkPredecessor(document.getElementById('predecessor'));

        document.getElementById('btnAdd').style.display = 'none';
        document.getElementById('btnUpdate').style.display = 'inline-block';
        document.getElementById('btnCancel').style.display = 'inline-block';
    }

    function cancelEdit() {
        document.getElementById('taskId').value = '';
        document.getElementById('taskName').value = '';
        document.getElementById('taskContent').value = ''; // æ¸…ç©ºå…§å®¹
        document.getElementById('duration').value = '3';
        document.getElementById('predecessor').value = '';
        document.getElementById('startDate').disabled = false;
        
        document.getElementById('btnAdd').style.display = 'inline-block';
        document.getElementById('btnUpdate').style.display = 'none';
        document.getElementById('btnCancel').style.display = 'none';
        
        updatePredecessorSelect();
    }

    function removeTask(id) {
        if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ")) return;
        tasks = tasks.filter(t => t.id !== id);
        tasks.forEach(t => { if (t.predecessorId === id) t.predecessorId = null; });
        if(document.getElementById('taskId').value === id) cancelEdit();
        updateUI();
    }

    function updateUI() {
        renderTaskList();
        updatePredecessorSelect();
    }

    function updatePredecessorSelect(excludeId = null) {
        const select = document.getElementById('predecessor');
        const currentVal = select.value;
        select.innerHTML = '<option value="">(ç„¡)</option>';
        tasks.forEach(task => {
            if (task.id === excludeId) return;
            const option = document.createElement('option');
            option.value = task.id;
            option.textContent = task.name;
            select.appendChild(option);
        });
        if(currentVal && currentVal !== excludeId) select.value = currentVal;
    }

    function renderTaskList() {
        const tbody = document.getElementById('taskListBody');
        tbody.innerHTML = '';
        tasks.forEach(task => {
            const predTask = tasks.find(t => t.id === task.predecessorId);
            const predName = predTask ? predTask.name : '-';
            const endDate = formatDate(addDays(task.start, task.duration));
            
            const tr = document.createElement('tr');
            const nameClass = task.type === 'main' ? 'type-main' : 'type-sub';
            const prefix = task.type === 'sub' ? 'â”” ' : '';
            
            // æ–°å¢å…§å®¹æ¬„ä½çš„é¡¯ç¤º
            tr.innerHTML = `
                <td class="${nameClass}">${prefix}${task.name}</td>
                <td style="color:#555;">${task.content || ''}</td>
                <td>${task.start}</td>
                <td style="color:#666; font-size:0.85em">${endDate}</td>
                <td>${task.duration}</td>
                <td>${predName}</td>
                <td class="action-cell">
                    <button class="btn-edit" onclick="editTask('${task.id}')">ä¿®æ”¹</button>
                    <button class="btn-del" onclick="removeTask('${task.id}')">åˆªé™¤</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ----------------------------
    // ç”˜ç‰¹åœ–ç¹ªè£½é‚è¼¯ (æ”¯æ´å¹´æ¨¡å¼)
    // ----------------------------

    function switchView(mode) {
        currentView = mode;
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`view-${mode}`).classList.add('active');
        if(tasks.length > 0) generateGantt();
    }

    function generateGantt() {
        if (tasks.length === 0) return;
        recalculateAllDates();

        const chartView = document.getElementById('gantt-chart-view');
        chartView.style.display = 'block';
        
        const pxPerDay = VIEW_CONFIG[currentView].pxPerDay;

        let minTime = new Date(tasks[0].start).getTime();
        let maxTime = new Date(tasks[0].start).getTime();

        tasks.forEach(t => {
            const s = new Date(t.start).getTime();
            const e = new Date(t.start);
            e.setDate(e.getDate() + t.duration);
            if (s < minTime) minTime = s;
            if (e.getTime() > maxTime) maxTime = e.getTime();
        });

        const minDate = new Date(minTime);
        minDate.setDate(minDate.getDate() - 7);
        const finalDate = new Date(maxTime);
        finalDate.setDate(finalDate.getDate() + 30);

        const totalDays = Math.ceil((finalDate - minDate) / (1000 * 60 * 60 * 24));
        
        buildHeaderAndGrid(minDate, totalDays, pxPerDay);
        buildBars(minDate, pxPerDay);
        drawArrows(minDate, pxPerDay);
        
        const scrollWrapper = document.getElementById('ganttScrollWrapper');
        const headerContainer = document.getElementById('timelineHeaderContainer');
        scrollWrapper.onscroll = function() {
            headerContainer.scrollLeft = scrollWrapper.scrollLeft;
        };
    }

    function buildHeaderAndGrid(minDate, totalDays, pxPerDay) {
        const header = document.getElementById('timelineHeader');
        const gridBg = document.getElementById('gridBackground');
        header.innerHTML = '';
        gridBg.innerHTML = '';
        
        let totalWidth = totalDays * pxPerDay;
        
        // çµ•å°å®šä½æ¨¡å¼ (é©ç”¨æ‰€æœ‰è¦–åœ–ï¼Œæ›´éˆæ´»)
        // Day view: ç•« Grid
        // Week view: ç•« Grid per week
        // Month view: ç•« Grid per month
        // Year view: ç•« Grid per year
        
        if (currentView === 'day') {
            for (let i = 0; i < totalDays; i++) {
                const d = new Date(minDate);
                d.setDate(d.getDate() + i);
                
                const cell = document.createElement('div');
                cell.className = 'header-cell';
                cell.style.width = `${pxPerDay}px`;
                cell.innerText = `${d.getMonth()+1}/${d.getDate()}`;
                
                const line = document.createElement('div');
                line.className = 'grid-line';
                line.style.left = `${i * pxPerDay}px`;
                line.style.width = `${pxPerDay}px`;
                
                const day = d.getDay();
                if (day === 0 || day === 6) {
                    cell.style.backgroundColor = '#f1f5f9';
                    line.classList.add('weekend');
                }
                
                header.appendChild(cell);
                gridBg.appendChild(line);
            }
        } 
        else if (currentView === 'week') {
             // ç°¡åŒ– Week è™•ç†ï¼Œç›´æ¥ç”¨ Days è·‘ï¼Œä½†åªåœ¨æ¯é€±ç¬¬ä¸€å¤©ç•«ç·š
             // ç‚ºäº†å°é½Šï¼Œé‚„æ˜¯ç”¨ absolute grid line
             for (let i = 0; i < totalDays; i++) {
                const d = new Date(minDate);
                d.setDate(d.getDate() + i);
                
                // å‡è¨­æ¯é€±æ—¥ç‚ºèµ·å§‹
                if (d.getDay() === 0 || i === 0) {
                     const label = document.createElement('div');
                     label.className = 'header-cell';
                     label.style.position = 'absolute';
                     label.style.left = `${i * pxPerDay}px`;
                     label.style.width = `${pxPerDay * 7}px`;
                     label.innerText = `Week of ${d.getMonth()+1}/${d.getDate()}`;
                     header.appendChild(label);

                     const line = document.createElement('div');
                     line.className = 'grid-line';
                     line.style.left = `${i * pxPerDay}px`;
                     line.style.borderLeft = '1px solid #ddd';
                     gridBg.appendChild(line);
                }
             }
        }
        else if (currentView === 'month' || currentView === 'year') {
            // Month å’Œ Year è¦–åœ–é‚è¼¯
            for (let i = 0; i < totalDays; i++) {
                const d = new Date(minDate);
                d.setDate(d.getDate() + i);
                
                const isFirstDayOfMonth = d.getDate() === 1;
                const isFirstDayOfYear = d.getMonth() === 0 && d.getDate() === 1;
                
                // æ ¹æ“šæ¨¡å¼æ±ºå®šç•«ç·šæ™‚æ©Ÿ
                let drawLine = false;
                let labelText = '';
                
                if (currentView === 'month' && (isFirstDayOfMonth || i === 0)) {
                    drawLine = true;
                    labelText = `${d.getFullYear()}-${d.getMonth()+1}`;
                } else if (currentView === 'year' && (isFirstDayOfYear || i === 0)) {
                    drawLine = true;
                    labelText = `${d.getFullYear()}`;
                }

                if (drawLine) {
                    const label = document.createElement('div');
                    label.className = 'header-cell';
                    label.style.position = 'absolute';
                    label.style.left = `${i * pxPerDay}px`;
                    label.style.width = currentView === 'year' ? `${365 * pxPerDay}px` : `${30 * pxPerDay}px`;
                    label.style.textAlign = 'left';
                    label.style.paddingLeft = '5px';
                    label.innerText = labelText;
                    header.appendChild(label);

                    const line = document.createElement('div');
                    line.className = 'grid-line';
                    line.style.left = `${i * pxPerDay}px`;
                    line.style.borderLeft = '1px solid #ccc';
                    gridBg.appendChild(line);
                }
            }
        }

        gridBg.style.width = `${totalWidth}px`;
        document.getElementById('arrow-layer').style.width = `${totalWidth}px`;
    }

    function buildBars(minDate, pxPerDay) {
        const sidebar = document.getElementById('ganttSidebar');
        const barsContainer = document.getElementById('barsContainer');
        
        sidebar.innerHTML = '';
        barsContainer.innerHTML = '';
        barsContainer.style.height = `${tasks.length * ROW_HEIGHT}px`;
        document.getElementById('arrow-layer').style.height = `${tasks.length * ROW_HEIGHT}px`;

        tasks.forEach((task, index) => {
            const nameDiv = document.createElement('div');
            nameDiv.className = 'task-name-cell';
            const prefix = task.type === 'sub' ? '&nbsp;&nbsp;â”” ' : '';
            // é€™è£¡å´é‚Šæ¬„åªé¡¯ç¤ºåç¨±ï¼Œä¿æŒç°¡æ½”
            nameDiv.innerHTML = `<span class="${task.type === 'main' ? 'type-main' : 'type-sub'}">${prefix}${task.name}</span>`;
            sidebar.appendChild(nameDiv);

            const rowDiv = document.createElement('div');
            rowDiv.className = 'bar-row';
            barsContainer.appendChild(rowDiv);

            const bar = document.createElement('div');
            bar.className = `bar ${task.type}`;
            bar.id = `bar-${task.id}`;
            
            // å¹´æ¨¡å¼æˆ–æœˆæ¨¡å¼ä¸‹ï¼Œå¦‚æœå¯¬åº¦å¤ªçª„å°±ä¸é¡¯ç¤ºæ–‡å­—
            const isCompact = ['month', 'year'].includes(currentView);
            bar.innerText = isCompact ? '' : `${task.duration}å¤©`;
            bar.title = `åç¨±: ${task.name}\nå…§å®¹: ${task.content || 'ç„¡'}\næ—¥æœŸ: ${task.start} (${task.duration}å¤©)`; // Tooltip å¢åŠ å…§å®¹é¡¯ç¤º
            
            const diffTime = new Date(task.start) - minDate;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);
            
            bar.style.left = `${diffDays * pxPerDay}px`;
            // æœ€å°å¯¬åº¦è¨­ç‚º 2px ç¢ºä¿çœ‹å¾—åˆ°
            bar.style.width = `${Math.max(task.duration * pxPerDay, 2)}px`; 
            bar.style.top = `${(index * ROW_HEIGHT) + 9}px`;
            
            bar.dataset.taskId = task.id;
            bar.dataset.minDate = minDate.getTime();
            
            bar.addEventListener('mousedown', handleDragStart);
            barsContainer.appendChild(bar);
        });
    }

    // ----------------------------
    // æ‹–æ‹‰é‚è¼¯
    // ----------------------------
    let draggedBar = null, startX = 0, originalLeft = 0;
    
    function handleDragStart(e) {
        const taskId = e.target.dataset.taskId;
        const task = tasks.find(t => t.id === taskId);
        if (task && task.predecessorId) {
            alert("æ­¤ä»»å‹™å—å‰ç½®ä»»å‹™é™åˆ¶ï¼Œç„¡æ³•æ‰‹å‹•æ‹–ç§»ã€‚");
            return;
        }
        draggedBar = e.target;
        startX = e.clientX;
        originalLeft = parseFloat(draggedBar.style.left || 0);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
        draggedBar.style.opacity = '0.7';
    }

    function handleDragMove(e) {
        if (!draggedBar) return;
        const deltaX = e.clientX - startX;
        let newLeft = originalLeft + deltaX;
        if (newLeft < 0) newLeft = 0;
        draggedBar.style.left = `${newLeft}px`;
        requestAnimationFrame(() => drawArrows(null, VIEW_CONFIG[currentView].pxPerDay));
    }

    function handleDragEnd(e) {
        if (!draggedBar) return;
        document.removeEventListener('mousemove', handleDragMove);
        document.removeEventListener('mouseup', handleDragEnd);
        
        const pxPerDay = VIEW_CONFIG[currentView].pxPerDay;
        const currentLeft = parseFloat(draggedBar.style.left || 0);
        
        const dayIndex = Math.round(currentLeft / pxPerDay);
        const snappedLeft = dayIndex * pxPerDay;
        
        draggedBar.style.left = `${snappedLeft}px`;
        draggedBar.style.opacity = '1';

        const taskId = draggedBar.dataset.taskId;
        const minDateTs = parseInt(draggedBar.dataset.minDate);
        const task = tasks.find(t => t.id === taskId);
        
        if (task) {
            const newDate = new Date(minDateTs);
            newDate.setDate(newDate.getDate() + dayIndex);
            task.start = formatDate(newDate);
            recalculateAllDates();
            updateUI();
            generateGantt();
        }
        draggedBar = null;
    }

    // ----------------------------
    // é€£ç·šç¹ªè£½
    // ----------------------------
    function drawArrows(minDateObj = null, pxPerDay = 40) {
        const svg = document.getElementById('arrow-layer');
        svg.innerHTML = '';
        const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
        const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
        marker.setAttribute("id", "arrowhead");
        marker.setAttribute("markerWidth", "10");
        marker.setAttribute("markerHeight", "7");
        marker.setAttribute("refX", "9");
        marker.setAttribute("refY", "3.5");
        marker.setAttribute("orient", "auto");
        const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        polygon.setAttribute("points", "0 0, 10 3.5, 0 7");
        polygon.setAttribute("fill", "#94a3b8");
        marker.appendChild(polygon);
        defs.appendChild(marker);
        svg.appendChild(defs);

        tasks.forEach(task => {
            if (task.predecessorId) {
                const currentBar = document.getElementById(`bar-${task.id}`);
                const predBar = document.getElementById(`bar-${task.predecessorId}`);
                
                if (currentBar && predBar) {
                    const x1 = parseFloat(predBar.style.left) + parseFloat(predBar.style.width);
                    const y1 = parseFloat(predBar.style.top) + 12;
                    const x2 = parseFloat(currentBar.style.left);
                    const y2 = parseFloat(currentBar.style.top) + 12;
                    
                    const midX = x1 + 10;
                    let d = `M ${x1} ${y1} L ${midX} ${y1}`;
                    if (x2 > midX) {
                        d += ` L ${midX} ${y2} L ${x2} ${y2}`;
                    } else {
                        const midY = y2 > y1 ? y1 + 20 : y1 - 20;
                        d += ` L ${midX} ${midY} L ${x2 - 10} ${midY} L ${x2 - 10} ${y2} L ${x2} ${y2}`;
                    }
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", d);
                    path.setAttribute("class", "arrow-line");
                    path.setAttribute("marker-end", "url(#arrowhead)");
                    svg.appendChild(path);
                }
            }
        });
    }

    function saveProject() {
        if(tasks.length===0) return alert("ç„¡è³‡æ–™");
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tasks));
        a.download = "project.json";
        a.click();
    }
    function loadProject(inp) {
        const r = new FileReader();
        r.onload = e => {
            try { tasks = JSON.parse(e.target.result); updateUI(); alert("è®€å–æˆåŠŸ"); } 
            catch { alert("æ ¼å¼éŒ¯èª¤"); }
        };
        if(inp.files[0]) r.readAsText(inp.files[0]);
        inp.value='';
    }
    function exportToImage() {
        const el = document.getElementById("gantt-chart-view");
        if(el.style.display==='none') return alert("è«‹å…ˆç”¢å‡ºåœ–è¡¨");
        const wrapper = document.getElementById("ganttScrollWrapper");
        const header = document.getElementById("timelineHeaderContainer");
        const origW = el.style.width;
        el.style.width = (wrapper.scrollWidth + 240) + "px";
        wrapper.style.overflow = "visible";
        header.style.overflow = "visible";
        html2canvas(el, { scale: 2 }).then(c => {
            const link = document.createElement('a');
            link.download = 'gantt.png';
            link.href = c.toDataURL();
            link.click();
            el.style.width = origW;
            wrapper.style.overflow = "";
            header.style.overflow = "";
        });
    }
</script>

</body>
</html>
