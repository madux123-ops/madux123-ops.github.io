<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨åŠŸèƒ½ç”˜ç‰¹åœ–ï¼šå­˜æª”/è®€æª”/åŒ¯å‡ºåœ–ç‰‡</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #475569;
            --bg-color: #f8fafc;
            --border-color: #e2e8f0;
            --main-task-color: #3b82f6;
            --sub-task-color: #10b981;
            --day-width: 40px;
            --row-height: 42px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: #333;
            user-select: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h2 { border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 0; }

        /* å·¥å…·åˆ—å€åŸŸ */
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: #e0f2fe;
            border-radius: 6px;
            align-items: center;
        }
        
        .btn-tool {
            padding: 8px 15px;
            border: 1px solid #0284c7;
            background: white;
            color: #0284c7;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-tool:hover { background: #0284c7; color: white; }
        .btn-export-img { border-color: #059669; color: #059669; }
        .btn-export-img:hover { background: #059669; color: white; }

        /* è¼¸å…¥å€åŸŸ */
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
            background: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
        }

        .form-control { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        button { cursor: pointer; transition: 0.2s; }
        .btn-add { padding: 10px 20px; border: none; border-radius: 4px; background-color: var(--primary-color); color: white; font-weight: bold;}
        .btn-add:hover { background-color: #1d4ed8; }
        .btn-generate { padding: 12px; border: none; border-radius: 4px; background-color: #0f172a; color: white; width: 100%; margin-top: 10px; font-weight: bold; font-size: 1.1em;}
        .btn-delete { background-color: #ef4444; border: none; border-radius: 4px; color: white; padding: 5px 10px; font-size: 0.8em; }

        /* ä»»å‹™åˆ—è¡¨ */
        .task-list-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .task-list { width: 100%; border-collapse: collapse; }
        .task-list th { position: sticky; top: 0; background: #eee; z-index: 2; }
        .task-list th, .task-list td { padding: 8px 10px; border-bottom: 1px solid var(--border-color); text-align: left; font-size: 0.9em; }
        .type-main { font-weight: bold; color: var(--primary-color); }
        .type-sub { padding-left: 20px; color: var(--secondary-color); }

        /* ç”˜ç‰¹åœ–é¡¯ç¤ºå€åŸŸ */
        #gantt-chart-view {
            display: none;
            border: 1px solid var(--border-color);
            background: white;
            margin-top: 20px;
            position: relative;
            /* overflow: hidden; */ 
            /* æ³¨æ„ï¼šç‚ºäº†æˆªåœ–ï¼Œé€™è£¡ä¸èƒ½éš¨æ„ hiddenï¼Œçµæ§‹ç”±ä¸‹æ–¹ wrapper æ§åˆ¶ */
        }

        .gantt-header {
            display: flex;
            border-bottom: 1px solid #ddd;
            background: #f8f9fa;
            height: 40px;
        }

        .gantt-sidebar-header {
            min-width: 200px;
            width: 200px;
            padding: 10px;
            font-weight: bold;
            border-right: 1px solid #ddd;
            background: #f8f9fa;
            box-sizing: border-box;
            z-index: 20;
        }

        .timeline-header-container {
            overflow: hidden; 
            flex-grow: 1;
            position: relative;
        }
        
        .timeline-header { display: flex; }

        .day-cell {
            min-width: var(--day-width);
            width: var(--day-width);
            text-align: center;
            border-right: 1px solid #eee;
            font-size: 0.8em;
            padding: 10px 0;
            box-sizing: border-box;
        }

        /* æ²å‹•å€åŸŸ */
        .gantt-scroll-wrapper {
            display: flex;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 500px;
            position: relative;
        }

        .gantt-sidebar {
            min-width: 200px;
            width: 200px;
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            border-right: 1px solid #ddd;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        .task-name-cell {
            height: var(--row-height);
            padding: 0 10px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            box-sizing: border-box;
        }

        .gantt-timeline-area {
            position: relative;
            flex-grow: 1;
        }

        .grid-background {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            z-index: 0;
            pointer-events: none;
        }
        .grid-line {
            min-width: var(--day-width);
            width: var(--day-width);
            border-right: 1px solid #f5f5f5;
            height: 100%;
            box-sizing: border-box;
        }

        #arrow-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        
        .arrow-line { stroke: #94a3b8; stroke-width: 2; fill: none; }
        .arrow-head { fill: #94a3b8; }

        .bar-row {
            height: var(--row-height);
            border-bottom: 1px solid transparent;
            position: relative;
            box-sizing: border-box;
        }

        .bar {
            position: absolute;
            height: 24px;
            top: 9px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            padding-left: 8px;
            white-space: nowrap;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: grab;
            z-index: 5;
        }
        .bar:active { cursor: grabbing; opacity: 0.8; }
        .bar.main { background-color: var(--main-task-color); }
        .bar.sub { background-color: var(--sub-task-color); }

        .weekend { background-color: #f8fafc; }

    </style>
</head>
<body>

<div class="container">
    <h2>å°ˆæ¡ˆç”˜ç‰¹åœ–ç¹ªè£½å·¥å…·</h2>

    <div class="toolbar">
        <button class="btn-tool" onclick="saveProject()">ğŸ’¾ å„²å­˜å°ˆæ¡ˆ (JSON)</button>
        <button class="btn-tool" onclick="document.getElementById('fileInput').click()">ğŸ“‚ è®€å–å°ˆæ¡ˆ</button>
        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="loadProject(this)">
        <div style="flex-grow: 1;"></div>
        <button class="btn-tool btn-export-img" onclick="exportToImage()">ğŸ“· åŒ¯å‡ºåœ–ç‰‡ (PNG)</button>
    </div>

    <div class="input-group">
        <div class="form-control">
            <label>ä»»å‹™åç¨±</label>
            <input type="text" id="taskName" placeholder="ä»»å‹™åç¨±">
        </div>
        <div class="form-control">
            <label>é¡å‹</label>
            <select id="taskType">
                <option value="main">ä¸»é …ç›®</option>
                <option value="sub">â”” å­é …ç›®</option>
            </select>
        </div>
        <div class="form-control">
            <label>é–‹å§‹æ—¥æœŸ</label>
            <input type="date" id="startDate">
        </div>
        <div class="form-control">
            <label>å¤©æ•¸</label>
            <input type="number" id="duration" min="1" value="3" style="width: 60px;">
        </div>
        <div class="form-control">
            <label>å‰ç½®ä»»å‹™</label>
            <select id="predecessor">
                <option value="">(ç„¡)</option>
            </select>
        </div>
        <button class="btn-add" onclick="addTask()">+ åŠ å…¥</button>
    </div>

    <div class="task-list-container">
        <table class="task-list">
            <thead>
                <tr>
                    <th width="30%">ä»»å‹™åç¨±</th>
                    <th>é–‹å§‹æ—¥æœŸ</th>
                    <th>å¤©æ•¸</th>
                    <th>å‰ç½®ä»»å‹™</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="taskListBody"></tbody>
        </table>
    </div>

    <button class="btn-generate" onclick="generateGantt()">ç”¢å‡º / é‡ç¹ªç”˜ç‰¹åœ–</button>

    <div id="gantt-chart-view">
        <div class="gantt-header">
            <div class="gantt-sidebar-header">é …ç›®åˆ—è¡¨</div>
            <div class="timeline-header-container" id="timelineHeaderContainer">
                <div class="timeline-header" id="timelineHeader"></div>
            </div>
        </div>
        
        <div class="gantt-scroll-wrapper" id="ganttScrollWrapper">
            <div class="gantt-sidebar" id="ganttSidebar"></div>
            <div class="gantt-timeline-area" id="ganttTimelineArea">
                <div class="grid-background" id="gridBackground"></div>
                <svg id="arrow-layer"></svg>
                <div id="barsContainer"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let tasks = [];
    const DAY_WIDTH = 40;
    const ROW_HEIGHT = 42;
    let minDate, totalDays;

    document.getElementById('startDate').valueAsDate = new Date();

    // ----------------------
    //  å­˜æª”èˆ‡è®€æª”åŠŸèƒ½
    // ----------------------

    function saveProject() {
        if (tasks.length === 0) {
            alert("ç›®å‰æ²’æœ‰ä»»ä½•ä»»å‹™å¯ä¾›å„²å­˜ã€‚");
            return;
        }
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tasks));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "gantt_project.json");
        document.body.appendChild(downloadAnchorNode); // required for firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function loadProject(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loadedTasks = JSON.parse(e.target.result);
                if (Array.isArray(loadedTasks)) {
                    tasks = loadedTasks;
                    updateUI();
                    alert("å°ˆæ¡ˆè®€å–æˆåŠŸï¼è«‹é»æ“Šã€Œç”¢å‡ºç”˜ç‰¹åœ–ã€ä¾†æŸ¥çœ‹ã€‚");
                } else {
                    alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                }
            } catch (err) {
                alert("ç„¡æ³•è®€å–æª”æ¡ˆï¼Œè«‹ç¢ºèªæ˜¯å¦ç‚ºæ­£ç¢ºçš„ JSON æª”ã€‚");
            }
        };
        reader.readAsText(file);
        // æ¸…ç©º input è®“åŒæª”åå¯é‡è¤‡è§¸ç™¼
        input.value = '';
    }

    // ----------------------
    //  åŒ¯å‡ºåœ–ç‰‡åŠŸèƒ½
    // ----------------------
    
    function exportToImage() {
        const chartElement = document.getElementById("gantt-chart-view");
        if (chartElement.style.display === "none") {
            alert("è«‹å…ˆç”¢å‡ºç”˜ç‰¹åœ–ï¼");
            return;
        }

        // æˆªåœ–å‰çš„æº–å‚™ï¼šç‚ºäº†æˆªåˆ°å®Œæ•´å¯¬åº¦ï¼Œéœ€è¦æš«æ™‚ä¿®æ”¹æ¨£å¼
        const scrollWrapper = document.getElementById("ganttScrollWrapper");
        const timelineHeaderContainer = document.getElementById("timelineHeaderContainer");
        
        // ç´€éŒ„åŸå§‹æ¨£å¼
        const originalOverflow = scrollWrapper.style.overflow;
        const originalWidth = scrollWrapper.style.width;
        
        // å¼·åˆ¶å±•é–‹æ²è»¸å€åŸŸï¼Œè®“ html2canvas èƒ½æŠ“åˆ°å…¨éƒ¨å…§å®¹
        // é€™è£¡è¨­å®šå›ºå®šå¯¬åº¦ç‚ºå…§å®¹çš„ scrollWidth
        const fullWidth = scrollWrapper.scrollWidth;
        
        // ç‚ºäº†é¿å… sticky å®šä½åœ¨æˆªåœ–æ™‚è·‘ç‰ˆï¼Œé€šå¸¸å»ºè­°æˆªåœ–æ™‚æš«æ™‚ç§»é™¤ sticky æˆ–ç¢ºä¿è¦–çª—å¤ å¤§
        // é€™è£¡æˆ‘å€‘å˜—è©¦ç›´æ¥æˆªå–ï¼Œå¦‚æœ sticky è·‘æ‰ï¼Œé€šå¸¸æ˜¯å› ç‚º html2canvas å° sticky æ”¯æ´åº¦æœ‰é™
        // ä¸€å€‹è§£æ³•æ˜¯æˆªåœ–ç•¶ä¸‹æŠŠ sticky æ”¹æˆ static (ä½†é€™æ¨£åˆ—è¡¨æœƒè·‘ä¸Šå»)ï¼Œæˆ–ç›´æ¥æˆªå¤§åœ–
        
        // é€™è£¡æ¡ç”¨ä¸€å€‹ç°¡å–®ç­–ç•¥ï¼šæš«æ™‚æŠŠå¤–æ¡†æ’å¤§
        chartElement.style.width = (fullWidth + 210) + "px"; // 200 sidebar + buffer
        scrollWrapper.style.overflow = "visible";
        timelineHeaderContainer.style.overflow = "visible";

        html2canvas(chartElement, {
            scale: 2, // æé«˜è§£æåº¦
            backgroundColor: "#ffffff"
        }).then(canvas => {
            // å¾©åŸæ¨£å¼
            chartElement.style.width = "";
            scrollWrapper.style.overflow = "";
            timelineHeaderContainer.style.overflow = "";

            // ä¸‹è¼‰åœ–ç‰‡
            const link = document.createElement('a');
            link.download = 'gantt_chart.png';
            link.href = canvas.toDataURL();
            link.click();
        }).catch(err => {
            console.error(err);
            alert("åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨ä¸»æ§å°ã€‚");
            // ç™¼ç”ŸéŒ¯èª¤ä¹Ÿè¦å¾©åŸ
            chartElement.style.width = "";
            scrollWrapper.style.overflow = "";
            timelineHeaderContainer.style.overflow = "";
        });
    }


    // ----------------------
    //  åŸºæœ¬é‚è¼¯ (åŒå‰ç‰ˆ)
    // ----------------------

    function formatDate(date) { return date.toISOString().split('T')[0]; }

    function addTask() {
        const name = document.getElementById('taskName').value;
        const type = document.getElementById('taskType').value;
        const start = document.getElementById('startDate').value;
        const duration = parseInt(document.getElementById('duration').value);
        const predecessorId = document.getElementById('predecessor').value;

        if (!name || !start || !duration) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"); return; }

        const task = {
            id: Date.now().toString(),
            name, type, start, duration,
            predecessorId: predecessorId || null
        };

        tasks.push(task);
        updateUI();
        document.getElementById('taskName').value = '';
        document.getElementById('taskName').focus();
    }

    function removeTask(id) {
        tasks = tasks.filter(t => t.id !== id);
        tasks.forEach(t => { if (t.predecessorId === id) t.predecessorId = null; });
        updateUI();
    }

    function updateUI() {
        renderTaskList();
        updatePredecessorSelect();
    }

    function updatePredecessorSelect() {
        const select = document.getElementById('predecessor');
        select.innerHTML = '<option value="">(ç„¡)</option>';
        tasks.forEach(task => {
            const option = document.createElement('option');
            option.value = task.id;
            option.textContent = task.name;
            select.appendChild(option);
        });
    }

    function renderTaskList() {
        const tbody = document.getElementById('taskListBody');
        tbody.innerHTML = '';
        tasks.forEach(task => {
            const predTask = tasks.find(t => t.id === task.predecessorId);
            const predName = predTask ? predTask.name : '-';
            const tr = document.createElement('tr');
            const nameClass = task.type === 'main' ? 'type-main' : 'type-sub';
            const prefix = task.type === 'sub' ? 'â”” ' : '';
            tr.innerHTML = `
                <td class="${nameClass}">${prefix}${task.name}</td>
                <td id="list-date-${task.id}">${task.start}</td>
                <td>${task.duration}</td>
                <td>${predName}</td>
                <td><button class="btn-delete" onclick="removeTask('${task.id}')">X</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function generateGantt() {
        if (tasks.length === 0) return;
        const chartView = document.getElementById('gantt-chart-view');
        chartView.style.display = 'block';

        let minTime = new Date(tasks[0].start).getTime();
        let maxTime = new Date(tasks[0].start).getTime();

        tasks.forEach(t => {
            const s = new Date(t.start).getTime();
            const e = new Date(t.start);
            e.setDate(e.getDate() + t.duration);
            if (s < minTime) minTime = s;
            if (e.getTime() > maxTime) maxTime = e.getTime();
        });

        minDate = new Date(minTime);
        minDate.setDate(minDate.getDate() - 3);
        const finalDate = new Date(maxTime);
        finalDate.setDate(finalDate.getDate() + 10);
        totalDays = Math.ceil((finalDate - minDate) / (1000 * 60 * 60 * 24));

        buildTimelineHeader(totalDays);
        buildChartBody(totalDays);
        drawArrows();

        const scrollWrapper = document.getElementById('ganttScrollWrapper');
        const headerContainer = document.getElementById('timelineHeaderContainer');
        scrollWrapper.onscroll = function() {
            headerContainer.scrollLeft = scrollWrapper.scrollLeft;
        };
    }

    function buildTimelineHeader(days) {
        const header = document.getElementById('timelineHeader');
        header.innerHTML = '';
        for (let i = 0; i < days; i++) {
            const current = new Date(minDate);
            current.setDate(current.getDate() + i);
            const div = document.createElement('div');
            div.className = 'day-cell';
            div.innerText = `${current.getMonth() + 1}/${current.getDate()}`;
            if (current.getDay() === 0 || current.getDay() === 6) div.style.backgroundColor = '#f1f5f9';
            header.appendChild(div);
        }
    }

    function buildChartBody(days) {
        const sidebar = document.getElementById('ganttSidebar');
        const barsContainer = document.getElementById('barsContainer');
        const gridBackground = document.getElementById('gridBackground');
        const arrowLayer = document.getElementById('arrow-layer');
        
        sidebar.innerHTML = ''; barsContainer.innerHTML = ''; gridBackground.innerHTML = '';
        
        const totalWidth = days * DAY_WIDTH;
        gridBackground.style.width = `${totalWidth}px`;
        arrowLayer.style.width = `${totalWidth}px`;
        arrowLayer.innerHTML = '';

        for (let i = 0; i < days; i++) {
            const line = document.createElement('div');
            line.className = 'grid-line';
            const current = new Date(minDate);
            current.setDate(current.getDate() + i);
            if (current.getDay() === 0 || current.getDay() === 6) line.classList.add('weekend');
            gridBackground.appendChild(line);
        }

        tasks.forEach((task, index) => {
            const nameDiv = document.createElement('div');
            nameDiv.className = 'task-name-cell';
            const prefix = task.type === 'sub' ? '&nbsp;&nbsp;â”” ' : '';
            nameDiv.innerHTML = `<span class="${task.type === 'main' ? 'type-main' : 'type-sub'}">${prefix}${task.name}</span>`;
            sidebar.appendChild(nameDiv);

            const rowDiv = document.createElement('div');
            rowDiv.className = 'bar-row';
            barsContainer.appendChild(rowDiv);

            const bar = document.createElement('div');
            bar.className = `bar ${task.type}`;
            bar.id = `bar-${task.id}`;
            bar.innerText = `${task.duration}å¤©`;
            
            const diffTime = new Date(task.start) - minDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            bar.style.left = `${diffDays * DAY_WIDTH}px`;
            bar.style.width = `${task.duration * DAY_WIDTH - 6}px`;
            bar.style.top = `${(index * ROW_HEIGHT) + 9}px`;
            bar.dataset.taskId = task.id;
            
            bar.addEventListener('mousedown', handleDragStart);
            barsContainer.appendChild(bar);
        });
        
        const totalHeight = tasks.length * ROW_HEIGHT;
        arrowLayer.style.height = `${totalHeight}px`;
        barsContainer.style.height = `${totalHeight}px`;
    }

    let draggedBar = null, startX = 0, originalLeft = 0;
    function handleDragStart(e) {
        draggedBar = e.target;
        startX = e.clientX;
        originalLeft = parseFloat(draggedBar.style.left || 0);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
        draggedBar.style.opacity = '0.7';
    }
    function handleDragMove(e) {
        if (!draggedBar) return;
        const deltaX = e.clientX - startX;
        let newLeft = originalLeft + deltaX;
        if (newLeft < 0) newLeft = 0;
        draggedBar.style.left = `${newLeft}px`;
        requestAnimationFrame(drawArrows);
    }
    function handleDragEnd(e) {
        if (!draggedBar) return;
        document.removeEventListener('mousemove', handleDragMove);
        document.removeEventListener('mouseup', handleDragEnd);
        
        const currentLeft = parseFloat(draggedBar.style.left || 0);
        const dayIndex = Math.round(currentLeft / DAY_WIDTH);
        const snappedLeft = dayIndex * DAY_WIDTH;
        
        draggedBar.style.left = `${snappedLeft}px`;
        draggedBar.style.opacity = '1';

        const taskId = draggedBar.dataset.taskId;
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            const newDate = new Date(minDate);
            newDate.setDate(newDate.getDate() + dayIndex);
            task.start = formatDate(newDate);
            const listDateCell = document.getElementById(`list-date-${taskId}`);
            if (listDateCell) listDateCell.innerText = task.start;
        }
        drawArrows();
        draggedBar = null;
    }

    function drawArrows() {
        const svg = document.getElementById('arrow-layer');
        svg.innerHTML = '';
        const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
        const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
        marker.setAttribute("id", "arrowhead");
        marker.setAttribute("markerWidth", "10");
        marker.setAttribute("markerHeight", "7");
        marker.setAttribute("refX", "9");
        marker.setAttribute("refY", "3.5");
        marker.setAttribute("orient", "auto");
        const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        polygon.setAttribute("points", "0 0, 10 3.5, 0 7");
        polygon.setAttribute("fill", "#94a3b8");
        marker.appendChild(polygon);
        defs.appendChild(marker);
        svg.appendChild(defs);

        tasks.forEach(task => {
            if (task.predecessorId) {
                const currentBar = document.getElementById(`bar-${task.id}`);
                const predBar = document.getElementById(`bar-${task.predecessorId}`);
                if (currentBar && predBar) {
                    const x1 = parseFloat(predBar.style.left) + parseFloat(predBar.style.width);
                    const y1 = parseFloat(predBar.style.top) + 12;
                    const x2 = parseFloat(currentBar.style.left);
                    const y2 = parseFloat(currentBar.style.top) + 12;
                    const midX = x1 + 15;
                    let d = `M ${x1} ${y1} L ${midX} ${y1}`;
                    if (x2 > midX) {
                        d += ` L ${midX} ${y2} L ${x2} ${y2}`;
                    } else {
                        const midY = y2 > y1 ? y1 + (ROW_HEIGHT/2) + 5 : y1 - (ROW_HEIGHT/2) - 5;
                        d += ` L ${midX} ${midY} L ${x2 - 10} ${midY} L ${x2 - 10} ${y2} L ${x2} ${y2}`;
                    }
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", d);
                    path.setAttribute("class", "arrow-line");
                    path.setAttribute("marker-end", "url(#arrowhead)");
                    svg.appendChild(path);
                }
            }
        });
    }
</script>

</body>
</html>