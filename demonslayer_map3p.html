<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¬¼æ»…ä¹‹åˆƒï¼šç„¡é™åŸ (ä¸‰äººæ±ºæˆ°ç‰ˆ)</title>
    <style>
        body {
            background-color: #000;
            color: #e0e0e0;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }
        #game-wrapper {
            display: flex;
            gap: 15px;
            max-width: 1100px; /* å¯¬åº¦å¢åŠ ä»¥å®¹ç´3äººå¡ç‰‡ */
            width: 98%;
            height: 96vh;
        }

        /* å·¦å´é¢æ¿ */
        #main-panel {
            flex: 1.6;
            display: flex;
            flex-direction: column;
            background-color: #0a0a0a;
            border: 2px solid #b71c1c;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 0 60px rgba(183, 28, 28, 0.15);
        }

        /* å³å´åœ°åœ–é¢æ¿ */
        #map-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #050505;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
        }

        h1 { text-align: center; color: #ff5252; margin: 0 0 8px 0; font-size: 18px; border-bottom: 1px solid #333; padding-bottom: 6px; }

        /* è§’è‰²ç‹€æ…‹ (3äºº) */
        #party-status { display: flex; gap: 4px; margin-bottom: 8px; }
        .char-card {
            flex: 1; background: #1a1a1a; padding: 5px; border-radius: 4px;
            border-left: 3px solid #555; position: relative; transition: 0.3s;
            min-width: 0; /* é˜²æ­¢è¢«æ“ å£“ */
        }
        .char-card.p1 { border-color: #29b6f6; }
        .char-card.p2 { border-color: #66bb6a; }
        .char-card.p3 { border-color: #ffa726; }
        .char-card.dead { opacity: 0.3; filter: grayscale(100%); border-color: #444; }
        
        .char-name { font-weight: bold; font-size: 0.95em; display: block; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-row { font-size: 0.75em; color: #bbb; display: flex; justify-content: space-between; }
        .stat-val { color: #fff; font-weight: bold; }
        
        .bar-con { background: #333; height: 4px; border-radius: 2px; margin-top: 3px; overflow: hidden; }
        .hp-bar { height: 100%; background: #d50000; width: 100%; transition: width 0.3s; }
        .focus-bar { height: 3px; background: #00b0ff; width: 100%; margin-top: 2px; }

        /* æ—¥èªŒ */
        #game-log {
            flex-grow: 1; overflow-y: auto; background: #000; padding: 8px;
            border: 1px solid #222; border-radius: 5px; font-family: monospace;
            font-size: 13px; line-height: 1.4; margin-bottom: 8px;
        }
        #game-log::-webkit-scrollbar { width: 5px; }
        #game-log::-webkit-scrollbar-thumb { background: #444; }

        .msg { margin-bottom: 3px; border-bottom: 1px solid #111; }
        .msg-p1 { color: #90caf9; } .msg-p2 { color: #a5d6a7; } .msg-p3 { color: #ffcc80; }
        .msg-enemy { color: #ff5252; } 
        .msg-boss-skill { color: #ff1744; font-weight: bold; text-shadow: 0 0 5px rgba(255, 23, 68, 0.4); }
        .msg-event { color: #ffd740; font-weight: bold; }
        .msg-item { color: #69f0ae; font-weight: bold; }
        .msg-skill { color: #e040fb; text-shadow: 0 0 5px rgba(224, 64, 251, 0.4); }
        .msg-nakime { color: #ff4081; font-weight: bold; border: 1px solid #ff4081; padding: 2px; text-align: center;}
        .msg-death { color: #bdbdbd; background: #333; padding: 2px; border-left: 3px solid #fff; }

        /* åœ°åœ–ç¶²æ ¼ 6x8 */
        #grid-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr); /* 6 åˆ— */
            gap: 1px;
            background: #222;
            padding: 4px;
            border-radius: 6px;
            margin-bottom: 10px;
            width: 100%;
            max-width: 280px; 
        }
        .tile {
            background-color: #080808;
            border-radius: 2px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            height: 40px; /* æ ¼å­ç¨å¾®å¤§ä¸€é» */
            cursor: default;
            transition: all 0.1s;
            position: relative;
        }
        .tile.fog { background-color: #000 !important; border: 1px solid #050505; color: transparent !important; } 
        .tile.visited { background-color: #1e1e1e; border: 1px solid #333; } 
        .tile.player { 
            background-color: #263238; 
            border: 1px solid #fff; 
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); 
            z-index: 10;
            font-size: 24px;
        }

        #controls-area { width: 100%; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        #dpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; width: 120px; }
        .d-btn { padding: 10px; background: #263238; border: 1px solid #37474f; color: #fff; border-radius: 4px; cursor: pointer; text-align: center; }
        .d-btn:active { background: #455a64; }

        #combat-controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; display: none; width: 100%; }
        button.action-btn { padding: 14px; background: #263238; color: white; border: 1px solid #37474f; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button.action-btn:hover { background: #37474f; }
        .btn-atk { background: #b71c1c; } .btn-skill { background: #0d47a1; } .btn-rest { background: #1b5e20; }

        #turn-indicator { text-align: center; padding: 4px; background: #b71c1c; border-radius: 4px; margin-bottom: 5px; display: none; color: white; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="main-panel">
        <h1>ğŸ‘¹ é¬¼æ»…ä¹‹åˆƒï¼šç„¡é™åŸ <span style="font-size:0.7em; color:#aaa;">(3äººæ±ºæˆ°)</span></h1>
        
        <div id="party-status">
            <div class="char-card p1" id="card-p1">
                <span class="char-name" id="name-p1">P1</span>
                <div class="stat-row"><span>HP <b class="stat-val" id="hp-p1">0</b></span><span>ATK <b class="stat-val" id="atk-p1">0</b></span></div>
                <div class="stat-row"><span>FCS <b class="stat-val" id="focus-p1">0</b></span><span style="font-size:0.8em;color:#f48fb1">COST:<b id="cost-p1">2</b></span></div>
                <div class="bar-con"><div class="hp-bar" id="bar-p1"></div></div>
                <div class="focus-bar" id="fbar-p1"></div>
            </div>
            <div class="char-card p2" id="card-p2">
                <span class="char-name" id="name-p2">P2</span>
                <div class="stat-row"><span>HP <b class="stat-val" id="hp-p2">0</b></span><span>ATK <b class="stat-val" id="atk-p2">0</b></span></div>
                <div class="stat-row"><span>FCS <b class="stat-val" id="focus-p2">0</b></span><span style="font-size:0.8em;color:#f48fb1">COST:<b id="cost-p2">2</b></span></div>
                <div class="bar-con"><div class="hp-bar" id="bar-p2"></div></div>
                <div class="focus-bar" id="fbar-p2"></div>
            </div>
            <div class="char-card p3" id="card-p3">
                <span class="char-name" id="name-p3">P3</span>
                <div class="stat-row"><span>HP <b class="stat-val" id="hp-p3">0</b></span><span>ATK <b class="stat-val" id="atk-p3">0</b></span></div>
                <div class="stat-row"><span>FCS <b class="stat-val" id="focus-p3">0</b></span><span style="font-size:0.8em;color:#f48fb1">COST:<b id="cost-p3">2</b></span></div>
                <div class="bar-con"><div class="hp-bar" id="bar-p3"></div></div>
                <div class="focus-bar" id="fbar-p3"></div>
            </div>
        </div>

        <div id="game-log"></div>
        <div id="turn-indicator">æˆ°é¬¥è³‡è¨Š</div>
        <div id="combat-controls"></div>
    </div>

    <div id="map-panel">
        <div style="color:#ffd740; font-weight:bold; margin-bottom:5px;" id="floor-display">1F</div>
        
        <div id="grid-container"></div>

        <div id="controls-area">
            <div id="dpad">
                <div></div><div class="d-btn" onclick="movePlayer(0, -1)">â–²</div><div></div>
                <div class="d-btn" onclick="movePlayer(-1, 0)">â—€</div>
                <div class="d-btn" onclick="movePlayer(0, 1)">â–¼</div>
                <div class="d-btn" onclick="movePlayer(1, 0)">â–¶</div>
            </div>
            <div style="font-size:0.8em; color:#666; margin-top:5px;">WASD ç§»å‹•</div>
        </div>
    </div>
</div>

<script>
    // --- æ•¸æ“šåº« ---
    const CHAR_DB = [
        { id: 0, name: "ç«ˆé–€ç‚­æ²»éƒ", hp: 140, focus: 20, atk: 25, skills: ["æ°´é¢æ–¬", "æ°´è»Š", "æµæµèˆ", "æ‰“æ½®", "æ…ˆé›¨", "æ‰­è½‰æ¼©æ¸¦", "ç€§å£º", "ç”Ÿç”Ÿæµè½‰", "ç«ä¹‹ç¥Â·åœ“èˆ", "ç¢§ç¾…ä¹‹å¤©", "çƒˆæ—¥ç´…é¡", "å¹»æ—¥è™¹", "ç«è»Š", "é™½è¯çª", "æ—¥ä¹‹å‘¼å¸Â·åä¸‰å‹"] },
        { id: 1, name: "æˆ‘å¦»å–„é€¸", hp: 110, focus: 22, atk: 32, skills: ["éœ¹é‚ä¸€é–ƒ", "ä¸€é–ƒÂ·å…­é€£", "ä¸€é–ƒÂ·å…«é€£", "ç¨»é­‚", "é é›·", "ç†±ç•Œé›·", "é›»å…‰é›·è½Ÿ", "èšèšŠæˆé›·", "ç¥é€Ÿ", "ç¥é€ŸÂ·ç™¾é€£", "ç¥é€ŸÂ·åƒé€£", "ç«é›·ç¥", "ç«é›·ç¥Â·é›™é¾", "ç«é›·ç¥Â·å…«é›·ç¥", "é»ƒé›·ä¹‹ç¥"] },
        { id: 2, name: "å˜´å¹³ä¼Šä¹‹åŠ©", hp: 170, focus: 16, atk: 24, skills: ["ç©¿é€åˆºå°„", "ç‹‚è£‚", "ç©ºé–“è­˜è¦º", "åˆ‡ç´°è£‚", "ç‹‚ç‰™ç¶»è£‚", "äº‚æ­å’¬", "ä¼¸èœ¿æ–¬", "çˆ†è£‚çŒ›é€²", "åœ“è½‰æ—‹ç‰™", "é£›æŠ•è£‚æ–¬", "ç¬æ¯è£‚æ®º", "ç¸ä¹‹å‘¼å¸Â·çµ‚ç‰™", "é‡æ€§è¦ºé†’", "å±±ç¥ä¹‹æ€’", "ç¸ç¥é™è‡¨"] },
        { id: 3, name: "æ —èŠ±è½é¦™å¥ˆä¹", hp: 130, focus: 25, atk: 22, skills: ["çœŸä¹‹éœ", "å¾¡å½±æ¢…", "ç´…èŠ±è¡£", "å¾’ä¹‹èŠè—¥", "æ¸¦æ¡ƒ", "æ¸¦æ¡ƒÂ·æ”¹", "å½¼å²¸æœ±çœ¼", "æœ±çœ¼Â·é–‹", "æœ±çœ¼Â·é€£æ–¬", "æœ±çœ¼Â·çµ‚ç„‰", "è½èŠ±ä¹‹èˆ", "æ•£è¯", "èŠ±ç¥ä¹‹æ¯", "èŠ±é³¥é¢¨æœˆ", "ç™¾èŠ±ç¹šäº‚"] },
        { id: 4, name: "ä¸æ­»å·ç„å½Œ", hp: 190, focus: 12, atk: 28, skills: ["é›™ç®¡å°„æ“Š", "éœ°å½ˆé€£ç™¼", "ç ç‰™æ’•å’¬", "é¬¼åŒ–Â·å†ç”Ÿ", "é¬¼åŒ–Â·å¼·è…•", "é¬¼åŒ–Â·ç¡¬åŒ–", "æ¨¹æœ¨æ“ä½œ", "ç„¡é–“æ¥­æ¨¹", "é»‘è¡€æ³æ£˜", "åå™¬Â·ä¸‹å¼¦", "åå™¬Â·ä¸Šå¼¦", "å®Œå…¨é¬¼åŒ–", "æ“¬ä¼¼åŠå¤©ç‹—", "å™¬é¬¼ä¹‹ç‹", "ä¸æ»…ä¹‹è»€"] },
        { id: 5, name: "æ™‚é€ç„¡ä¸€éƒ", hp: 120, focus: 24, atk: 30, skills: ["å‚å¤©é éœ", "å…«é‡éœ", "éœæ•£ä¹‹é£›æ²«", "ç§»æµæ–¬", "é›²æµ·", "æœˆä¹‹éœæ¶ˆ", "æœ§", "æœ§Â·æ”¹", "ç„¡æˆ‘ä¹‹å¢ƒ", "é€æ˜ä¸–ç•Œ", "èµ«åˆ€Â·éœ", "éœé¾ä¹‹èˆ", "å¤©éœ§", "é›²å¤–è’¼å¤©", "ç„¡é™ä¹‹éœ"] },
        { id: 6, name: "ç…‰ç„æå£½éƒ", hp: 160, focus: 18, atk: 36, skills: ["ä¸çŸ¥ç«", "æ˜‡ç‚å¤©", "æ°£ç‚è¬è±¡", "ç››ç‚ä¹‹æ¸¦", "ç‚è™", "ç‚è™Â·æ”¹", "ç‚é¾", "ç…‰ç„", "ç…‰ç„Â·æ”¹", "ç…‰ç„Â·æ¥µ", "èµ«åˆ€Â·ç…‰ç„", "æ—¥è¼ªå…‰è€€", "ç‚æŸ±ä¹‹é­‚", "çƒˆç«ç„šå¤©", "åŠ«ç«Â·å…«å¤§åœ°ç„"] },
        { id: 7, name: "èƒ¡è¶å¿", hp: 100, focus: 26, atk: 20, skills: ["è¶ä¹‹èˆÂ·æˆ²å¼„", "èœ‚ç‰™ä¹‹èˆ", "èœ»è›‰ä¹‹èˆ", "èœˆèš£ä¹‹èˆ", "ç´«è—¤èŠ±æ¯’", "è¤‡çœ¼å…­è§’", "ç¥ä¹‹æ¯’", "å½¼å²¸èŠ±ä¹‹æ¯’", "éº»ç—ºä¹‹æ¯’", "å£æ­»ä¹‹æ¯’", "æº¶è§£ä¹‹æ¯’", "ç«¥ç£¨ä¹‹æ¨", "èŸ²æŸ±Â·æœ€çµ‚å¼", "çµ•å‘½Â·è—¥å¸«å¦‚ä¾†", "è¼ªè¿´ä¹‹æ¯’"] }
    ];

    const BOSS_DB = {
        5: { name: "æ‰‹é¬¼", skills: ["å¤šé‡æ‰‹è‡‚é‡æ“Š", "æŠ“æ¡æ“ å£“", "åœ°è£‚è¡æ“Š"] },
        10: { name: "æ²¼é¬¼", skills: ["äºŒæœ¬è§’æ–¬", "æ²¼æ¾¤æ½›ä¼", "ä¸‰é‡çˆªæ“Š"] },
        15: { name: "çŸ¢ç¶ç¾½ & æœ±ç´—ä¸¸", skills: ["ç´…æ½”ä¹‹ç®­", "å…­é€£æ‰‹æ¯¬", "æ–¹å‘æ“ä½œ"] },
        20: { name: "éŸ¿å‡±", skills: ["å°šé€Ÿé¼“æ‰“", "çˆªç—•æ–¬æ“Š", "æˆ¿é–“è¿´è½‰"] },
        25: { name: "ä¸‹å¼¦ä¹‹ä¼Â·ç´¯", skills: ["åˆ»ç·šè¼ªè½‰", "æ®ºç›®ç± ", "è¡€é¬¼è¡“Â·åˆ»ç·šç‰¢"] },
        30: { name: "ä¸‹å¼¦ä¹‹å£¹Â·é­˜å¤¢", skills: ["å¼·åˆ¶æ˜ç¡å‚¬çœ ", "è¡€é¬¼è¡“Â·çœ¼", "å¤¢å¢ƒåå™¬"] },
        35: { name: "ä¸Šå¼¦ä¹‹é™¸Â·å¢®å§¬", skills: ["å…«é‡å¸¶æ–¬", "è¡€é¬¼è¡“Â·èš¯èš“å¸¶", "é ¸éƒ¨é˜²ç¦¦"] },
        40: { name: "ä¸Šå¼¦ä¹‹é™¸Â·å¦“å¤«å¤ªéƒ", skills: ["è¡€é®Â·åœ“æ–¬æ—‹è¿´", "é£›è¡€é®", "çŒ›æ¯’æ–¬æ“Š"] },
        45: { name: "ä¸Šå¼¦ä¹‹ä¼Â·ç‰å£º", skills: ["åƒæœ¬é‡é­šæ®º", "è¡€ç„ç¼½", "é™£æ®ºé­šé±—"] },
        50: { name: "ä¸Šå¼¦ä¹‹è‚†Â·åŠå¤©ç‹—", skills: ["å–œæ€’å“€æ¨‚é€£æ“Š", "ç©æ€’Â·é›·æ“Š", "å“€çµ•Â·æ¿€æ·šåˆºçª"] },
        55: { name: "ä¸Šå¼¦ä¹‹è‚†Â·æ†ç€å¤©", skills: ["æœ¨é¾Â·å¾¡å­èˆ", "ç„¡é–“æ¥­æ¨¹", "ç‹‚é³´é›·æ®º"] },
        60: { name: "æ–°ä¸Šå¼¦ä¹‹é™¸Â·çªå²³", skills: ["é›·ä¹‹å‘¼å¸Â·è‚†ä¹‹å‹", "ç¨»é­‚Â·é»‘é›·", "ç†±ç•Œé›·"] },
        65: { name: "æ–°ä¸Šå¼¦ä¹‹è‚†Â·é³´å¥³", skills: ["ç„¡é™åŸè½‰ç§»", "ç©ºé–“å£“æ®º", "å¤šé‡çœ¼çƒåµæ¸¬"] },
        70: { name: "ä¸Šå¼¦ä¹‹åƒÂ·çŒ—çª©åº§", skills: ["ç ´å£æ®ºÂ·äº‚å¼", "ç ´å£æ®ºÂ·æ»…å¼", "ç ´å£æ®ºÂ·è…³å¼"] },
        75: { name: "ä¸Šå¼¦ä¹‹åƒÂ·çŒ—çª©åº§(è¦ºé†’)", skills: ["çµ‚å¼Â·é’éŠ€äº‚æ®˜å…‰", "ç ´å£æ®ºÂ·ç¾…é‡", "è¬è‘‰é–ƒæŸ³"] },
        80: { name: "ä¸Šå¼¦ä¹‹è²³Â·ç«¥ç£¨", skills: ["è“®è‘‰å†°", "å¯’çƒˆä¹‹ç™½å§¬", "éœ§å†°Â·ç¡è“®è©è–©"] },
        85: { name: "ä¸Šå¼¦ä¹‹å£¹Â·é»‘æ­»ç‰Ÿ", skills: ["æœˆä¹‹å‘¼å¸Â·å£¹ä¹‹å‹", "ç½ç¦æœˆé­„", "åå…­ä¹‹å‹Â·æœˆè™¹"] },
        90: { name: "é¬¼ç‹Â·ç‚­æ²»éƒ (IFç·š)", skills: ["æ—¥ä¹‹å‘¼å¸Â·æ··åˆé¬¼è¡“", "è§¸æ‰‹é­æ“Š", "é™½è¯çªÂ·é»‘è¡€"] },
        95: { name: "é¬¼èˆè¾»ç„¡æ…˜ (ç¹­)", skills: ["é»‘è¡€æ³æ£˜", "è¡æ“Šæ³¢", "è‚‰é«”å¸æ”¶"] },
        100: { name: "é¬¼èˆè¾»ç„¡æ…˜ (å®Œå…¨é«”)", skills: ["å»£ç¯„åœé­æ“Š", "å¸æ°£", "é¬¼ç‹å’†å“®", "ç´°èƒå´©å£"] }
    };

    // --- åœ°åœ–è¨­å®š (6x8) ---
    const MAP_W = 6; 
    const MAP_H = 8; 
    const TILE_EMPTY = 0;
    const TILE_ENEMY = 1;
    const TILE_EVENT_SPECIAL = 2;  
    const TILE_EXIT = 9;

    // --- ç‹€æ…‹ ---
    let party = []; // æœƒå­˜3å€‹ç‰©ä»¶
    let gameState = {
        floor: 1, maxFloor: 100,
        inCombat: false,
        enemy: null,
        map: [],
        visited: [], 
        playerPos: {x:0, y:0}
    };

    // DOM
    const logDiv = document.getElementById('game-log');
    const gridDiv = document.getElementById('grid-container');
    const combatControls = document.getElementById('combat-controls');
    const dpad = document.getElementById('dpad');
    const turnDisplay = document.getElementById('turn-indicator');

    // --- UI ---
    function log(msg, type="system") {
        const div = document.createElement('div');
        div.className = `msg msg-${type}`;
        div.innerHTML = msg;
        logDiv.appendChild(div);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateUI() {
        document.getElementById('floor-display').innerText = `${gameState.floor}F / 100F`;
        // è¿´åœˆè™•ç† 3 å€‹è§’è‰²
        for (let i = 0; i < 3; i++) {
            const p = party[i];
            const s = `p${i+1}`;
            const card = document.getElementById(`card-${s}`);
            
            if(p) {
                const skillCost = 2 + p.skillLv;
                document.getElementById(`name-${s}`).innerText = `${p.name}`;
                document.getElementById(`hp-${s}`).innerText = p.hp;
                document.getElementById(`atk-${s}`).innerText = p.atk;
                document.getElementById(`focus-${s}`).innerText = p.focus;
                document.getElementById(`cost-${s}`).innerText = skillCost;
                
                const hpPct = Math.max(0, (p.hp/p.maxHp)*100);
                const fPct = Math.max(0, (p.focus/p.maxFocus)*100);
                document.getElementById(`bar-${s}`).style.width = `${hpPct}%`;
                document.getElementById(`fbar-${s}`).style.width = `${fPct}%`;
                
                if(p.hp<=0) card.classList.add('dead'); else card.classList.remove('dead');
            } else {
                // é˜²æ­¢æœªåˆå§‹åŒ–å ±éŒ¯
                card.style.display = 'none';
            }
        }
    }

    function setCombatButtons(btns) {
        combatControls.innerHTML = "";
        btns.forEach(b => {
            const btn = document.createElement('button');
            btn.className = `action-btn ${b.cls || ''}`;
            btn.innerHTML = b.html;
            btn.onclick = b.action;
            combatControls.appendChild(btn);
        });
    }

    // --- åˆå§‹åŒ– ---
    function initGame() {
        log("é¬¼æ»…ä¹‹åˆƒï¼šç„¡é™åŸ (3äººæ±ºæˆ°) å•Ÿå‹•ã€‚", "system");
        showCharSelect(0);
    }

    function showCharSelect(pIdx) {
        combatControls.style.display = "grid";
        dpad.style.display = "none";
        const btns = CHAR_DB.map(c => ({ html: `<b>${c.name}</b>`, action: () => selectChar(pIdx, c) }));
        setCombatButtons(btns);
    }

    function selectChar(pIdx, data) {
        party[pIdx] = { ...data, maxHp: data.hp, maxFocus: data.focus, skillLv: 0, skillTree: data.skills };
        log(`P${pIdx+1} é¸æ“‡äº† ${data.name}`, `p${pIdx+1}`);
        
        if (pIdx < 2) {
            log(`è«‹é¸æ“‡ P${pIdx+2}ï¼š`, "system");
            showCharSelect(pIdx + 1);
        } else {
            log("3äººå°éšŠçµæˆï¼ç›®æ¨™ï¼šæ“Šæ½°ç„¡æ…˜ï¼", "msg-event");
            combatControls.style.display = "none";
            dpad.style.display = "grid";
            generateMap();
            updateUI();
            renderMap();
        }
    }

    function recruitNewMember(slotIdx) {
        const currentNames = party.map(p => p.name);
        const pool = CHAR_DB.filter(c => !currentNames.includes(c.name));
        if(pool.length === 0) return;
        const newCharData = pool[Math.floor(Math.random() * pool.length)];
        party[slotIdx] = { 
            ...newCharData, maxHp: newCharData.hp, maxFocus: newCharData.focus, 
            skillLv: 0, skillTree: newCharData.skills 
        };
        log(`ğŸ©¸ éšŠå“¡é™£äº¡... ã€${newCharData.name}ã€éè£œåŠ å…¥ï¼`, "msg-event");
        updateUI();
    }

    // --- åœ°åœ– (6x8) ---
    function generateMap() {
        gameState.map = Array(MAP_H).fill().map(() => Array(MAP_W).fill(TILE_EMPTY));
        gameState.visited = Array(MAP_H).fill().map(() => Array(MAP_W).fill(false));
        gameState.playerPos = {x:0, y:0};
        
        // åœ°åœ–å°ï¼Œç‰©ä»¶å¯†åº¦è¦æ§åˆ¶ï¼Œä½†å› ç‚º3äººå¾ˆå¼·ï¼Œæ€ªç‰©å¯ä»¥å¤šä¸€é»
        placeRandom(TILE_EVENT_SPECIAL, 6); 
        placeRandom(TILE_ENEMY, 10); 
        
        let exitPlaced = false;
        while(!exitPlaced) {
            let ex = Math.floor(Math.random() * MAP_W);
            let ey = Math.floor(Math.random() * MAP_H);
            if ((ex + ey) > 4 && gameState.map[ey][ex] === TILE_EMPTY) {
                gameState.map[ey][ex] = TILE_EXIT;
                exitPlaced = true;
            }
        }
        
        gameState.map[0][0] = TILE_EMPTY;
        revealFog(0, 0);
        
        log(`<br>ğŸ¯ --- ç¬¬ ${gameState.floor} å±¤ ---`, "msg-event");
        if (gameState.floor > 1) applyFloorBonus();
    }

    function applyFloorBonus() {
        party.forEach(p => {
            if (p.hp > 0) {
                p.maxHp += 5; p.maxFocus += 2;
                p.hp = Math.min(p.maxHp, p.hp + 40);
                p.focus = Math.min(p.maxFocus, p.focus + 20);
            }
        });
        updateUI();
    }

    function placeRandom(type, count) {
        let placed = 0;
        while(placed < count) {
            let x = Math.floor(Math.random() * MAP_W);
            let y = Math.floor(Math.random() * MAP_H);
            if (x===0 && y===0) continue;
            if (gameState.map[y][x] === TILE_EMPTY) {
                gameState.map[y][x] = type;
                placed++;
            }
        }
    }

    function revealFog(px, py) {
        gameState.visited[py][px] = true;
    }

    function renderMap() {
        gridDiv.innerHTML = "";
        for(let y=0; y<MAP_H; y++) {
            for(let x=0; x<MAP_W; x++) {
                const div = document.createElement('div');
                div.className = "tile";
                
                const isPlayer = (x === gameState.playerPos.x && y === gameState.playerPos.y);

                if (isPlayer) {
                    div.classList.add("player");
                    div.innerText = "ğŸ—¡ï¸"; 
                    div.classList.remove("fog");
                } else if (!gameState.visited[y][x]) {
                    div.classList.add("fog");
                    div.innerText = "";
                } else {
                    div.classList.add("visited");
                    const type = gameState.map[y][x];
                    if (type === TILE_EXIT) div.innerText = "â›©ï¸";
                    else if (type === TILE_EVENT_SPECIAL) div.innerText = "âœ¨";
                    else div.innerText = ""; 
                }
                gridDiv.appendChild(div);
            }
        }
    }

    function movePlayer(dx, dy) {
        if (gameState.inCombat) return;

        const nx = gameState.playerPos.x + dx;
        const ny = gameState.playerPos.y + dy;
        if (nx < 0 || nx >= MAP_W || ny < 0 || ny >= MAP_H) return;

        gameState.playerPos = {x: nx, y: ny};
        revealFog(nx, ny);
        
        const type = gameState.map[ny][nx];
        renderMap(); 

        if (type === TILE_ENEMY) {
            log("âš ï¸ é­é‡å¼·æ•µï¼", "msg-enemy");
            gameState.map[ny][nx] = TILE_EMPTY;
            startCombat(false);
        } 
        else if (type === TILE_EVENT_SPECIAL) {
            gameState.map[ny][nx] = TILE_EMPTY;
            triggerRandomEvent();
        } 
        else if (type === TILE_EXIT) {
            handleExit();
        }
    }

    function triggerRandomEvent() {
        const roll = Math.floor(Math.random() * 10);
        let msg = "";
        party.forEach(p => { if(p.hp > 0) {
            switch(roll) {
                case 0: p.hp = Math.min(p.maxHp, p.hp + Math.floor(p.maxHp*0.15)); msg = "ğŸ™ é£¯ç³° (HPå°è£œ)"; break;
                case 1: p.hp = Math.min(p.maxHp, p.hp + Math.floor(p.maxHp*0.5)); msg = "ğŸ± ä¾¿ç•¶ (HPå¤§è£œ)"; break;
                case 2: p.atk += 2; msg = "ğŸª¨ ç£¨åˆ€ (Atk+2)"; break;
                case 3: p.atk += 5; msg = "ğŸ”¥ é›åˆ€ (Atk+5)"; break;
                case 4: p.maxFocus += 3; p.focus += 3; msg = "ğŸ§˜ å†¥æƒ³ (MaxFocus+3)"; break;
                case 5: p.focus = p.maxFocus; msg = "ğŸ¦… é¹é´‰ (Focuså…¨æ»¿)"; break;
                case 6: p.hp = p.maxHp; msg = "ğŸ§ª ç ä¸–çš„è—¥ (HPå…¨æ»¿)"; break;
                case 7: if(p.skillLv < 14) { p.skillLv++; msg = `ğŸ’¡ é ˜æ‚Ÿ ${p.skillTree[p.skillLv]}!`; } else msg = "ğŸ’¨ ç„¡äº‹ç™¼ç”Ÿ"; break;
                case 8: p.atk += 3; p.maxHp += 10; msg = "â˜ ï¸ æ¯’ç´ èª¿åˆ (èƒ½åŠ›UP)"; break;
                case 9: p.atk += 10; p.maxHp += 50; p.hp += 50; msg = "âš¡ æ–‘ç´‹è¦ºé†’ (èƒ½åŠ›å¤§UP)"; break;
            }
        }});
        log(`âœ¨ ${msg}`, "msg-item");
        updateUI();
    }

    function handleExit() {
        // æ©Ÿç‡é™ä½åˆ° 8%
        if (Math.random() < 0.08 && gameState.floor > 1) {
            log("ğŸ¸ é³´å¥³çš„ç„¡é™åŸå‚³é€ï¼(é€€å›ä¸Šä¸€å±¤)", "msg-nakime");
            gameState.floor--;
            generateMap();
            renderMap();
        } else {
            if (gameState.floor % 5 === 0) {
                log("âš ï¸ åäºŒé¬¼æœˆæ””è·¯ï¼", "msg-enemy");
                startCombat(true);
            } else {
                log("â¡ï¸ å‰å¾€ä¸‹ä¸€å±¤...", "msg-event");
                gameState.floor++;
                generateMap();
                renderMap();
            }
        }
    }

    document.addEventListener('keydown', (e) => {
        if(gameState.inCombat) return;
        if(e.key==="ArrowUp"||e.key==="w") movePlayer(0,-1);
        if(e.key==="ArrowDown"||e.key==="s") movePlayer(0,1);
        if(e.key==="ArrowLeft"||e.key==="a") movePlayer(-1,0);
        if(e.key==="ArrowRight"||e.key==="d") movePlayer(1,0);
    });

    // --- æˆ°é¬¥ç³»çµ± (3äººè¼ªæµ) ---
    function startCombat(isBoss) {
        gameState.inCombat = true;
        dpad.style.display = "none";
        combatControls.style.display = "grid";
        turnDisplay.style.display = "block";

        const f = gameState.floor;
        let eName = "";
        let eHp = 0;
        let eAtk = 0;
        let bossData = null;

        if (isBoss) {
            bossData = BOSS_DB[f] || { name: `åäºŒé¬¼æœˆ (Lv.${f})`, skills: ["å¼·åŠ›å†ç”Ÿ", "è¡€é¬¼è¡“Â·æš´èµ°", "çŒ›æ”»"] };
            eName = bossData.name;
            
            // 10~50å€
            let multiplier = 10 + Math.floor(Math.random() * 40); 
            // æœ€çµ‚ x2 (å› æ‡‰3äºº)
            eHp = (200 + (f * 50)) * multiplier * 2; 
            
            let atkMult = 2 + Math.random() * 3;
            eAtk = 20 + Math.floor(f * atkMult);
        } else {
            eName = `Lv.${f} æƒ¡é¬¼`;
            eHp = 400 + (f * 100); // é›œé­šè¡€é‡ä¹Ÿæå‡
            eAtk = 25 + f * 1.5;
        }
        
        gameState.enemy = { name: eName, maxHp: eHp, hp: eHp, atk: eAtk, isBoss: isBoss, data: bossData };
        
        log(`âš”ï¸ é­é‡ ${eName} (HP:${Math.floor(eHp)})`, "msg-enemy");
        combatRound();
    }

    function combatRound() {
        // æª¢æŸ¥å…¨æ»…
        if (party[0].hp <= 0 && party[1].hp <= 0 && party[2].hp <= 0) return gameOver();
        if (gameState.enemy.hp <= 0) return winCombat();
        
        // å°‹æ‰¾ä¸‹ä¸€å€‹è¡Œå‹•è€…
        // é‚è¼¯ï¼šå˜—è©¦ P1 -> P2 -> P3 -> Enemy -> Loop
        // é€™è£¡ç°¡åŒ–ï¼šæ¯æ¬¡ Round é–‹å§‹ï¼Œä¾åºåˆ¤å®š P1, P2, P3 æ˜¯å¦å­˜æ´»ä¸¦è¡Œå‹•
        // ç‚ºäº†è®“ UI äº’å‹•é †æš¢ï¼Œæˆ‘å€‘ç”¨ chain çš„æ–¹å¼
        
        nextActor(0);
    }

    function nextActor(idx) {
        if (gameState.enemy.hp <= 0) { winCombat(); return; }

        if (idx < 3) {
            if (party[idx].hp > 0) {
                setTurn(idx);
            } else {
                nextActor(idx + 1); // è·³éæ­»è€…
            }
        } else {
            // è¼ªåˆ°æ•µäºº
            setTimeout(enemyAct, 500);
        }
    }

    function setTurn(pIdx) {
        turnDisplay.innerText = `è¼ªåˆ° ${party[pIdx].name}`;
        // é¡è‰²å€åˆ†
        const colors = ['#29b6f6', '#66bb6a', '#ffa726'];
        turnDisplay.style.backgroundColor = colors[pIdx];
        
        const p = party[pIdx];
        const cost = 2 + p.skillLv;
        const skillName = p.skillTree[p.skillLv];

        // å‚³é pIdx çµ¦ actionï¼Œåšå®Œå¾Œå‘¼å« nextActor(pIdx + 1)
        setCombatButtons([
            { html: "âš”ï¸ æ”»æ“Š", cls: "btn-atk", action: () => playerAct(pIdx, "atk") },
            { html: `ğŸŒŠ ${skillName}<br><small>Cost ${cost}</small>`, cls: "btn-skill", action: () => playerAct(pIdx, "skill") },
            { html: "ğŸ’¨ å‘¼å¸å›å¾©", cls: "btn-rest", action: () => playerAct(pIdx, "rest") }
        ]);
    }

    function playerAct(pIdx, type) {
        const p = party[pIdx];
        const enemy = gameState.enemy;
        const cost = 2 + p.skillLv;
        let dmg = 0;

        if (type === "atk") {
            dmg = Math.floor(p.atk * (0.9 + Math.random()*0.2));
            log(`${p.name} æ”»æ“Š ${dmg} å‚·ã€‚`, `p${pIdx+1}`);
        } else if (type === "skill") {
            if (p.focus < cost) { log("Focus ä¸è¶³ï¼", "msg-enemy"); return; }
            p.focus -= cost;
            let mult = 1.5 + (p.skillLv * 0.4);
            dmg = Math.floor(p.atk * mult);
            if(p.name.includes("ç„å½Œ") || p.name.includes("ç¦°è±†å­")) p.hp = Math.min(p.maxHp, p.hp + Math.floor(dmg*0.25));
            log(`ğŸŒŠ ${p.skillTree[p.skillLv]}ï¼é€ æˆ ${dmg} å‚·å®³ï¼`, "msg-skill");
        } else {
            p.hp = Math.min(p.maxHp, p.hp + Math.floor(p.maxHp*0.3));
            p.focus = Math.min(p.maxFocus, p.focus + 25);
            log(`${p.name} èª¿æ•´å‘¼å¸ï¼Œå¤§å¹…å›å¾©ã€‚`, "msg-event");
        }

        enemy.hp -= dmg;
        updateUI();

        if (enemy.hp <= 0) {
            winCombat();
        } else {
            nextActor(pIdx + 1);
        }
    }

    function enemyAct() {
        const enemy = gameState.enemy;
        turnDisplay.innerText = `${enemy.name} æ”»æ“Šä¸­...`;
        turnDisplay.style.backgroundColor = '#b71c1c';
        combatControls.innerHTML = ""; 

        const targets = party.filter(p => p.hp > 0);
        if(targets.length === 0) { gameOver(); return; }
        const target = targets[Math.floor(Math.random() * targets.length)];
        
        let dmg = Math.floor(enemy.atk * (0.8 + Math.random() * 0.4));
        
        if (enemy.isBoss && enemy.data && enemy.data.skills) {
            const skill = enemy.data.skills[Math.floor(Math.random() * enemy.data.skills.length)];
            log(`ğŸ©¸ ${enemy.name} ä½¿ç”¨äº† ã€${skill}ã€‘ï¼`, "msg-boss-skill");
            dmg = Math.floor(dmg * 1.3); 
        } else {
            log(`ğŸ’¥ ${enemy.name} æ”»æ“Š ${target.name}ï¼`, "msg-enemy");
        }

        target.hp -= dmg;
        log(`>> ${target.name} å—åˆ° ${dmg} é»å‚·å®³ï¼`, "msg-enemy");
        
        updateUI();
        
        // å›åˆçµæŸï¼Œä¸‹ä¸€è¼ª
        setTimeout(combatRound, 800);
    }

    function winCombat() {
        log("ğŸ† å‹åˆ©ï¼", "msg-item");
        gameState.inCombat = false;
        turnDisplay.style.display = "none";
        dpad.style.display = "grid";
        combatControls.style.display = "none";

        party.forEach(p => {
            if(p.hp>0) {
                p.maxHp += 15; p.atk += 3;
                if(gameState.enemy.isBoss || Math.random() < 0.3) {
                    if(p.skillLv < 14) { p.skillLv++; log(`ğŸ’¡ ${p.name} é ˜æ‚Ÿäº†æ–°æ‹›ï¼`, "msg-skill"); }
                }
            }
        });

        party.forEach((p, idx) => {
            if (p.hp <= 0) recruitNewMember(idx);
        });

        if(gameState.enemy.isBoss) {
            log("å‰å¾€ä¸‹ä¸€å±¤...", "msg-event");
            gameState.floor++;
            generateMap();
            renderMap();
        } else {
            renderMap();
        }
    }

    function gameOver() {
        dpad.style.display = "none";
        combatControls.style.display = "none";
        turnDisplay.innerText = "GAME OVER";
        log("ğŸ’€ å…¨å“¡æˆ°æ­»...", "msg-enemy");
        setCombatButtons([{ html: "ğŸ”„ é‡ä¾†", action: () => location.reload() }]);
    }

    initGame();
</script>

</body>
</html>