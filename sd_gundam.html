<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDé‹¼å½ˆGä¸–ä»£ï¼šæˆ°ç·šçªåœ (é›£åº¦ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-color: #1c1c1e;
            --accent-color: #0a84ff;
            --danger-color: #ff453a;
            --text-color: #f2f2f7;
            --tile-size: 36px;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- æ¨™é¡Œç•«é¢ --- */
        #title-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 200;
        }
        .title-text { font-size: 3em; font-weight: bold; color: var(--accent-color); margin-bottom: 20px; text-shadow: 0 0 10px var(--accent-color); }
        .diff-btn {
            width: 200px; padding: 15px; margin: 10px; border: 1px solid #444; background: #222; color: #fff;
            cursor: pointer; font-size: 1.2em; transition: 0.3s; border-radius: 5px;
        }
        .diff-btn:hover { background: var(--accent-color); color: #000; transform: scale(1.05); }
        .diff-desc { color: #888; font-size: 0.9em; margin-bottom: 30px; }

        /* --- å·¦å´åœ°åœ–å€ --- */
        #game-area {
            flex: 3; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #000; position: relative; border-right: 1px solid #333;
        }

        #map-container {
            overflow: auto; max-width: 100%; max-height: 100%; padding: 20px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }

        #map-grid {
            display: grid; grid-template-columns: repeat(15, var(--tile-size));
            grid-template-rows: repeat(15, var(--tile-size));
            gap: 1px; background: #333; border: 1px solid #555;
        }

        .tile {
            width: var(--tile-size); height: var(--tile-size); background-color: #111;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            position: relative; font-size: 10px;
        }
        .tile:hover { z-index: 10; outline: 2px solid #fff; }
        .tile.player { background-color: rgba(10, 132, 255, 0.2); }
        .tile.enemy { background-color: rgba(255, 69, 58, 0.2); }
        .tile.selected { box-shadow: inset 0 0 0 2px #ffd60a; }

        .unit-icon { font-size: 22px; z-index: 2; pointer-events: none; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.8)); }
        
        .city-icon { position: absolute; top: 1px; right: 1px; font-size: 9px; pointer-events:none; font-weight: bold;}
        .city-lv1 { color: #a0a0a0; }
        .city-lv2 { color: #ffd60a; }
        .city-lv3 { color: #bf5af2; text-shadow: 0 0 4px #bf5af2; }

        .hp-bar { position: absolute; bottom: 2px; left: 2px; width: calc(100% - 4px); height: 3px; background: #444; border-radius: 1px; }
        .hp-val { height: 100%; background: #32d74b; border-radius: 1px; transition: width 0.3s; }
        .hp-val.enemy { background: #ff453a; }

        /* --- å³å´æ§åˆ¶é¢æ¿ --- */
        #control-panel {
            flex: 1.3; min-width: 340px; background-color: var(--panel-color); padding: 15px;
            display: flex; flex-direction: column; border-left: 1px solid #333;
        }

        .header { display: flex; justify-content: space-between; margin-bottom: 15px; background: #2c2c2e; padding: 10px; border-radius: 8px; }
        .res-item { font-family: monospace; font-size: 1.1em; font-weight: bold; }
        
        .panel-box { background: #2c2c2e; padding: 12px; margin-bottom: 10px; border-radius: 8px; }
        h3 { margin: 0 0 8px 0; color: var(--accent-color); font-size: 0.95em; border-bottom: 1px solid #444; padding-bottom: 5px;}

        .btn {
            background: var(--accent-color); color: white; border: none; padding: 10px; margin: 5px 0;
            cursor: pointer; width: 100%; border-radius: 6px; font-weight: 600; transition: 0.2s; display: flex; justify-content: space-between;
        }
        .btn:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .btn:disabled { background: #444; color: #888; cursor: not-allowed; transform: none; }
        .btn-small { width: auto; padding: 6px 12px; font-size: 0.85em; display: inline-block; margin-right: 5px; margin-bottom: 5px;}

        #log-area { flex: 1; background: #000; color: #32d74b; font-family: 'Courier New', monospace; padding: 10px; overflow-y: auto; font-size: 12px; border-radius: 4px; border: 1px solid #333; max-height: 200px;}

        /* --- åˆ—è¡¨èˆ‡Modal --- */
        .list-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #333; font-size: 0.9em; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 100;
        }
        .modal-content {
            background: #1c1c1e; padding: 25px; width: 600px; max-height: 85vh; overflow-y: auto;
            border: 1px solid #444; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .close-btn { float: right; cursor: pointer; font-size: 1.5em; color: #888; }

        /* --- æˆ°é¬¥ UI --- */
        .battle-layout { display: flex; flex-direction: column; height: 400px; }
        .battle-stage { flex: 2; display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #000; border: 1px solid #333; border-radius: 4px; margin-bottom: 10px; }
        .side { width: 45%; }
        .side-p { text-align: left; border-right: 1px dashed #333; padding-right: 10px; }
        .side-e { text-align: right; border-left: 1px dashed #333; padding-left: 10px; }
        .b-unit { margin: 5px 0; padding: 5px; background: #222; font-size: 0.9em; }
    </style>
</head>
<body>

    <div id="title-screen">
        <div class="title-text">SDé‹¼å½ˆGä¸–ä»£ï¼šæˆ°ç·šçªåœ</div>
        <div class="diff-desc">è«‹é¸æ“‡æŒ‡æ®å®˜çš„æŒ‘æˆ°é›£åº¦</div>
        <button class="diff-btn" style="border-color:#32d74b" onclick="startGame(0)">ğŸŸ¢ ç°¡å–® (Easy)</button>
        <button class="diff-btn" style="border-color:#0a84ff" onclick="startGame(1)">ğŸ”µ æ™®é€š (Normal)</button>
        <button class="diff-btn" style="border-color:#ff453a" onclick="startGame(2)">ğŸ”´ å›°é›£ (Hard)</button>
        <div style="margin-top:20px; color:#666; font-size:0.8em;">ç°¡å–®ï¼šæ•µå¼±è³‡æºå¤š / å›°é›£ï¼šæ•µå¼·AIå…‡çŒ›</div>
    </div>

    <div id="game-area">
        <div style="margin-bottom: 10px; font-size: 1.1em; font-weight: bold; display: flex; justify-content: space-between; width: 90%;">
            <span>TURN <span id="turn-display" style="color: var(--accent-color);">1</span></span>
            <span id="diff-display" style="font-size: 0.8em; color: #888;"></span>
        </div>
        <div id="map-container">
            <div id="map-grid"></div>
        </div>
        <div style="margin-top: 10px; color: #666; font-size: 0.85em;">
            æç¤ºï¼šéƒ¨ç½²æ©Ÿé«”å¾Œå°‡è‡ªå‹•æœç´¢èˆ‡ç™¼å±•è©²å€åŸŸã€‚
        </div>
    </div>

    <div id="control-panel">
        <div class="header">
            <div class="res-item" title="è³‡é‡‘">ğŸ’° <span id="money">0</span></div>
            <div class="res-item" title="é›¶ä»¶">âš™ï¸ <span id="parts">0</span></div>
            <div class="res-item" title="è¡Œå‹•åŠ›" style="color: #ff9f0a;">âš¡ <span id="ap">3</span>/3</div>
        </div>

        <div class="panel-box">
            <h3>ğŸ“ åœ°å¡Šæƒ…å ±</h3>
            <div id="tile-info" style="font-size: 0.9em; color: #aaa; min-height: 45px; margin-bottom: 10px;">
                è«‹é¸æ“‡åœ°åœ–ä¸Šçš„å€åŸŸ...
            </div>
            <div id="tile-actions"></div>
        </div>

        <div class="panel-box">
            <h3>ğŸš§ ç”Ÿç”¢èˆ‡ç ”ç™¼ (ç„¡APæ¶ˆè€—)</h3>
            <div id="queue-list" style="font-size: 0.85em; color: #666; min-height: 20px;">ç„¡ä»»å‹™é€²è¡Œä¸­</div>
        </div>

        <div class="panel-box" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
            <h3>ğŸ¤– æ ¼ç´åº« (å…è²»å‡ºæ“Š)</h3>
            <div id="hangar-list" style="overflow-y: auto; flex: 1;"></div>
        </div>

        <div>
            <button class="btn" onclick="openModal('research-modal')">ğŸ§ª ç ”ç©¶æ‰€ (ç ”ç™¼æ–°æ©Ÿé«”)</button>
            <button class="btn" onclick="openModal('recruit-modal')">ğŸ­ å·¥å»  (ç”Ÿç”¢æ©Ÿé«”)</button>
            <button class="btn" style="background-color: var(--danger-color); text-align: center; justify-content: center;" onclick="nextTurn()">ğŸŒ™ çµæŸå›åˆ (çµç®—)</button>
        </div>

        <div id="log-area"><div>ç­‰å¾…æŒ‡æ®å®˜ä¸‹é”æŒ‡ä»¤...</div></div>
    </div>

    <div id="research-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('research-modal')">&times;</span>
            <h2>MS é–‹ç™¼è¨ˆç•«</h2>
            <div id="research-list"></div>
        </div>
    </div>

    <div id="recruit-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('recruit-modal')">&times;</span>
            <h2>æ©Ÿé«”ç”Ÿç”¢ç·š</h2>
            <div id="recruit-list"></div>
        </div>
    </div>

    <div id="squad-modal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <span class="close-btn" onclick="closeModal('squad-modal')">&times;</span>
            <h2>âš”ï¸ æˆ°é¬¥ç·¨æˆ</h2>
            <p>ç›®æ¨™ï¼š<strong id="target-name" style="color:var(--danger-color);"></strong></p>
            <p style="font-size:0.9em; color:#aaa;">å‹¾é¸åƒèˆ‡åœæ”»çš„é„°è¿‘æ©Ÿé«”ï¼š</p>
            <div id="squad-list" style="background:#111; padding:10px; border-radius:4px; margin-bottom:15px;"></div>
            <button class="btn" onclick="startBattle()">é–‹å§‹æˆ°é¬¥ (æ¶ˆè€—1AP)</button>
        </div>
    </div>

    <div id="battle-modal" class="modal">
        <div class="modal-content" style="width: 700px; border: 1px solid var(--danger-color);">
            <h2 style="text-align: center; color: var(--danger-color);">âš ï¸ BATTLE START</h2>
            <div class="battle-layout">
                <div class="battle-stage">
                    <div class="side side-p" id="battle-p-side"></div>
                    <div style="font-weight:bold; color:#555;">VS</div>
                    <div class="side side-e" id="battle-e-side"></div>
                </div>
                <div id="battle-log" style="flex:1; background:#111; padding:10px; overflow-y:auto; font-family:monospace; font-size:12px; color:#32d74b;"></div>
            </div>
            <div style="margin-top:10px; text-align:right;">
                <button id="battle-next-btn" class="btn" style="width:auto; display:inline-block;" onclick="battleRound()">ä¸‹ä¸€è¼ªæ”»é˜²</button>
                <button id="battle-end-btn" class="btn" style="width:auto; display:none; background:#555;" onclick="closeModal('battle-modal')">é›¢é–‹æˆ°å ´</button>
            </div>
        </div>
    </div>

<script>
/* ================= è¨­å®šèˆ‡è³‡æ–™åº« ================= */

// é›£åº¦è¨­å®š
const DIFF_SETTINGS = [
    { name: "EASY", enemyMod: 0.8, incomeMod: 1.5, spawnRate: 10, aiType: 'passive' },
    { name: "NORMAL", enemyMod: 1.0, incomeMod: 1.0, spawnRate: 6, aiType: 'normal' },
    { name: "HARD", enemyMod: 1.3, incomeMod: 0.7, spawnRate: 4, aiType: 'aggressive' }
];

const UNIT_DB = [
    { id: 0, name: "å‰å§† (GM)", hp: 150, atk: 30, def: 10, cost: 500, prod: 1, unlocked: true },
    { id: 1, name: "è–©å…‹II", hp: 180, atk: 35, def: 8, cost: 550, prod: 1, unlocked: true },
    { id: 2, name: "é‹¼å½ˆ RX-78", hp: 400, atk: 80, def: 30, cost: 2500, res:{m:3000,p:50}, resT:2, prod:2, unlocked:false },
    { id: 3, name: "Zé‹¼å½ˆ", hp: 380, atk: 90, def: 25, cost: 2800, res:{m:3500,p:60}, resT:3, prod:2, unlocked:false },
    { id: 4, name: "ZZé‹¼å½ˆ", hp: 500, atk: 110, def: 40, cost: 3500, res:{m:4500,p:80}, resT:3, prod:3, unlocked:false },
    { id: 5, name: "è‡ªç”±é‹¼å½ˆ", hp: 450, atk: 120, def: 20, cost: 4000, res:{m:5000,p:100}, resT:4, prod:3, unlocked:false },
    { id: 6, name: "é£›ç¿¼é›¶å¼", hp: 360, atk: 140, def: 15, cost: 3800, res:{m:4800,p:90}, resT:3, prod:3, unlocked:false },
    { id: 7, name: "ç¨è§’ç¸é‹¼å½ˆ", hp: 480, atk: 105, def: 35, cost: 4200, res:{m:5500,p:120}, resT:4, prod:3, unlocked:false },
    { id: 8, name: "çµé­”é‹¼å½ˆ", hp: 550, atk: 130, def: 25, cost: 3600, res:{m:4600,p:110}, resT:3, prod:3, unlocked:false },
    { id: 9, name: "Nué‹¼å½ˆ", hp: 460, atk: 100, def: 35, cost: 3900, res:{m:5200,p:100}, resT:4, prod:3, unlocked:false },

    // æ•µè»
    { id: 90, name: "è–©å…‹II (æ•µ)", hp: 200, atk: 35, def: 5, cost:0, unlocked:true },
    { id: 91, name: "å¤å¤« (èè‹±)", hp: 350, atk: 60, def: 15, cost:0, unlocked:true },
    { id: 99, name: "ç²¾ç¥æ„Ÿæ‡‰é‹¼å½ˆ", hp: 2500, atk: 150, def: 80, cost:0, unlocked:true }
];

const MAP_SIZE = 15;
const MAX_AP = 3;
const TILE = { EMPTY: 0, CITY: 1, BASE: 2 };

let state = {
    diffIdx: 1, // é è¨­ Normal
    turn: 1,
    money: 0,
    parts: 0,
    ap: MAX_AP,
    map: [],
    units: [],
    enemies: [],
    selectedTile: -1,
    qProd: [],
    qRes: [],
    battle: null
};

/* ================= éŠæˆ²åˆå§‹åŒ–èˆ‡æ ¸å¿ƒé‚è¼¯ ================= */

function startGame(diffLevel) {
    state.diffIdx = diffLevel;
    document.getElementById('title-screen').style.display = 'none';
    
    // åˆå§‹åŒ–è³‡æºèˆ‡åœ°åœ–
    state.money = 3000;
    state.parts = 30;
    document.getElementById('diff-display').innerText = `é›£åº¦: ${DIFF_SETTINGS[state.diffIdx].name}`;
    
    // ç”Ÿæˆåœ°åœ–
    for(let i=0; i<MAP_SIZE*MAP_SIZE; i++) {
        state.map.push({ idx: i, type: TILE.EMPTY, level: 1, owner: null });
    }
    // ç©å®¶åŸºåœ°
    setTile(0, 'player', TILE.BASE);
    setTile(1, 'player', TILE.CITY);
    setTile(15, 'player', TILE.CITY);

    // æ•µè»é…ç½® (3å, æ ¹æ“šé›£åº¦å¼·åŒ–)
    let bossIdx = 224; 
    setTile(bossIdx, 'enemy', TILE.BASE);
    spawnEnemy(bossIdx, 99); // Boss
    spawnEnemy(bossIdx-1, 91); // å¤å¤«
    spawnEnemy(bossIdx-15, 90); // è–©å…‹

    // éš¨æ©ŸåŸå¸‚
    for(let i=0; i<10; i++) {
        let r = Math.floor(Math.random()*225);
        if(state.map[r].type === TILE.EMPTY) state.map[r].type = TILE.CITY;
    }

    // åˆå§‹æ©Ÿé«”
    addUnit(0); addUnit(0);

    renderMap();
    updateUI();
    log(`éŠæˆ²é–‹å§‹ï¼é›£åº¦: ${DIFF_SETTINGS[state.diffIdx].name}`);
}

function setTile(idx, owner, type) {
    state.map[idx].owner = owner;
    state.map[idx].type = type;
}

function getXY(idx) { return { x: idx%MAP_SIZE, y: Math.floor(idx/MAP_SIZE) }; }
function getNeighbors(idx) {
    let p = getXY(idx);
    let res = [];
    for(let y=p.y-1; y<=p.y+1; y++) {
        for(let x=p.x-1; x<=p.x+1; x++) {
            if(x>=0 && x<MAP_SIZE && y>=0 && y<MAP_SIZE && !(x===p.x && y===p.y))
                res.push(y*MAP_SIZE+x);
        }
    }
    return res;
}

/* ================= åœ°åœ–æ¸²æŸ“ ================= */

function renderMap() {
    const grid = document.getElementById('map-grid');
    grid.innerHTML = '';
    state.map.forEach(t => {
        let el = document.createElement('div');
        el.className = `tile ${t.owner === 'player' ? 'player' : (t.owner === 'enemy' ? 'enemy' : '')}`;
        if(t.idx === state.selectedTile) el.classList.add('selected');
        
        let inner = '';
        if(t.type === TILE.CITY) inner += `<span class="city-icon city-lv${t.level}">Lv${t.level}</span>`;
        if(t.type === TILE.BASE) inner += `<span class="city-icon" style="color:#fff">âš“</span>`;

        // é¡¯ç¤ºæ©Ÿé«”
        let pUnit = state.units.find(u => u.deployed && u.idx === t.idx);
        let eUnit = state.enemies.find(u => u.idx === t.idx);

        if(pUnit) {
            let pct = (pUnit.hp/pUnit.maxHp)*100;
            inner += `<div class="unit-icon">ğŸ¤–</div><div class="hp-bar"><div class="hp-val" style="width:${pct}%"></div></div>`;
        } else if(eUnit) {
            let pct = (eUnit.hp/eUnit.maxHp)*100;
            inner += `<div class="unit-icon">ğŸ‘¿</div><div class="hp-bar"><div class="hp-val enemy" style="width:${pct}%"></div></div>`;
        } else if (t.type === TILE.CITY || t.type === TILE.BASE) {
            inner += `<div style="font-size:14px; opacity:0.5;">${t.type===TILE.BASE?'âš“':'ğŸ™ï¸'}</div>`;
        }

        el.innerHTML = inner;
        el.onclick = () => selectTile(t.idx);
        grid.appendChild(el);
    });
}

function selectTile(idx) {
    state.selectedTile = idx;
    renderMap();
    const t = state.map[idx];
    const info = document.getElementById('tile-info');
    const act = document.getElementById('tile-actions');
    
    let typeName = t.type === TILE.BASE ? "åŸºåœ°" : (t.type === TILE.CITY ? "åŸå¸‚" : "è’åœ°");
    let ownerName = t.owner === 'player' ? "æˆ‘è»" : (t.owner === 'enemy' ? "æ•µè»" : "ç„¡äºº");
    let pUnit = state.units.find(u => u.deployed && u.idx === idx);
    let eUnit = state.enemies.find(u => u.idx === idx);

    info.innerHTML = `<strong>[${getXY(idx).x}, ${getXY(idx).y}] ${typeName}</strong> (${ownerName})`;
    if(pUnit) info.innerHTML += `<br>é§è»: ${pUnit.name} (HP:${pUnit.hp})`;
    if(eUnit) info.innerHTML += `<br>æ•µè»: ${eUnit.name} (HP:${eUnit.hp})`;

    act.innerHTML = '';
    const hasAP = state.ap > 0;

    if(t.owner === 'player') {
        if(t.type === TILE.EMPTY) {
            addBtn(act, "ğŸ—ï¸ å»ºè¨­åŸå¸‚ ($800, 1AP)", () => buildCity(idx), hasAP);
        } else if (t.type === TILE.CITY && t.level < 3) {
            let cost = t.level === 1 ? 1500 : 3000;
            addBtn(act, `â« å‡ç´šåŸå¸‚ ($${cost}, 1AP)`, () => upgradeCity(idx, cost), hasAP);
        }
        if(!pUnit) {
            addBtn(act, "ğŸš€ éƒ¨ç½²æ©Ÿé«” (å…è²»)", () => deployUnit(idx), true);
        }
    } else {
        let near = getNeighbors(idx).some(n => state.map[n].owner === 'player' || state.units.some(u => u.deployed && u.idx === n));
        if(near) {
            if(eUnit) {
                addBtn(act, "âš”ï¸ ç™¼å‹•æ”»æ“Š (1AP)", () => prepBattle(idx), hasAP);
            } else {
                addBtn(act, "ğŸš© ä½”é ˜å€åŸŸ (1AP)", () => captureTile(idx), hasAP);
            }
        }
    }
}

function addBtn(p, txt, cb, en) {
    let b = document.createElement('button');
    b.className = 'btn btn-small';
    b.innerText = txt;
    b.onclick = cb;
    b.disabled = !en;
    p.appendChild(b);
}

/* ================= ç©å®¶è¡Œå‹• ================= */

function buildCity(idx) {
    if(state.money >= 800) {
        state.money -= 800; state.ap--;
        state.map[idx].type = TILE.CITY; state.map[idx].level = 1;
        log("åŸå¸‚å»ºè¨­å®Œæˆã€‚"); updateUI(); renderMap(); selectTile(idx);
    } else alert("è³‡é‡‘ä¸è¶³");
}

function upgradeCity(idx, cost) {
    if(state.money >= cost) {
        state.money -= cost; state.ap--;
        state.map[idx].level++;
        log(`åŸå¸‚å‡ç´šè‡³ Lv${state.map[idx].level}ï¼`); updateUI(); renderMap(); selectTile(idx);
    } else alert("è³‡é‡‘ä¸è¶³");
}

function deployUnit(idx) {
    let u = state.units.find(u => !u.deployed);
    if(u) {
        u.deployed = true; u.idx = idx;
        log(`${u.name} å·²éƒ¨ç½²ã€‚`); updateUI(); renderMap(); selectTile(idx);
    } else alert("ç„¡é–’ç½®æ©Ÿé«”");
}

function captureTile(idx) {
    state.ap--; state.map[idx].owner = 'player';
    log("å€åŸŸä½”é ˜æˆåŠŸã€‚"); updateUI(); renderMap(); selectTile(idx);
}

/* ================= å›åˆèˆ‡AI (å«é›£åº¦é‚è¼¯) ================= */

function nextTurn() {
    state.turn++;
    state.ap = MAX_AP;
    let diff = DIFF_SETTINGS[state.diffIdx];
    log(`=== ç¬¬ ${state.turn} å›åˆ ===`);

    // 1. ç©å®¶è‡ªå‹•æœç´¢ & ç™¼å±•
    let totalSearchM = 0; let totalSearchP = 0;
    state.units.forEach(u => {
        if(u.deployed) {
            // æœç´¢è³‡æº
            let tile = state.map[u.idx];
            let isRich = (tile.type === TILE.CITY || tile.type === TILE.BASE);
            let m = isRich ? (200 + Math.random()*300) : (10 + Math.random()*40);
            let p = isRich ? (5 + Math.random()*5) : (Math.random() > 0.8 ? 1 : 0);
            
            // é›£åº¦å½±éŸ¿æ”¶å…¥
            totalSearchM += Math.floor(m * diff.incomeMod);
            totalSearchP += Math.floor(p * diff.incomeMod);

            // è‡ªå‹•ç™¼å±•è’åœ°
            if(tile.type === TILE.EMPTY && tile.owner === 'player') {
                tile.type = TILE.CITY; tile.level = 1;
                log(`${u.name} é–‹æ‹“äº†è’åœ°ï¼`);
            }
            // è‡ªå‹•ä½”é ˜å‘¨åœ
            getNeighbors(u.idx).forEach(n => {
                let t = state.map[n];
                if(!state.enemies.some(e=>e.idx===n) && t.type !== TILE.BASE && t.owner !== 'player' && t.owner !== 'enemy') {
                    t.owner = 'player';
                }
            });
        }
    });
    if(totalSearchM > 0) log(`æœç´¢å›å ±: $${totalSearchM} âš™ï¸${totalSearchP}`);
    state.money += totalSearchM; state.parts += totalSearchP;

    // 2. ç¨…æ”¶
    let income = 0;
    state.map.forEach(t => {
        if(t.owner === 'player') {
            if(t.type === TILE.BASE) income += 200;
            if(t.type === TILE.CITY) income += (200 * Math.pow(2, t.level-1));
        }
    });
    // é›£åº¦å½±éŸ¿ç¨…æ”¶
    income = Math.floor(income * diff.incomeMod);
    state.money += income;
    log(`é ˜åœ°ç¨…æ”¶: $${income}`);

    // 3. æ¨é€²ç”Ÿç”¢ç ”ç™¼
    processQ(state.qProd, (i) => { addUnit(i.id); log(`${i.name} ç”Ÿç”¢å®Œæˆ`); });
    processQ(state.qRes, (i) => { UNIT_DB.find(u=>u.id===i.id).unlocked = true; log(`${i.name} ç ”ç™¼å®Œæˆ`); });

    // 4. æ•µè» AI è¡Œå‹•
    runEnemyAI();

    // 5. ç¶­ä¿®
    state.units.forEach(u => { if(!u.deployed && u.hp < u.maxHp) u.hp = Math.min(u.maxHp, u.hp+200); });

    updateUI(); renderMap();
}

function runEnemyAI() {
    let diff = DIFF_SETTINGS[state.diffIdx];
    
    state.enemies.forEach(e => {
        // å¿…åšï¼šä½”é ˜è…³ä¸‹
        if(state.map[e.idx].owner !== 'enemy') state.map[e.idx].owner = 'enemy';

        let neighbors = getNeighbors(e.idx);
        let target = state.units.find(u => u.deployed && neighbors.includes(u.idx));

        if(target) {
            // æœ‰äººå°±æ‰“
            let dmg = Math.max(10, e.atk - target.def);
            target.hp -= dmg;
            log(`æ•µæ©Ÿ ${e.name} æ”»æ“Š ${target.name} (-${dmg})`);
            if(target.hp <= 0) {
                log(`ğŸ’” ${target.name} è¢«æ“Šå¢œï¼`);
                state.units = state.units.filter(u => u !== target);
            }
        } else {
            // ç§»å‹•é‚è¼¯ (æ ¹æ“š AI é¡å‹)
            let moves = neighbors.filter(n => !state.enemies.some(z => z.idx === n) && !state.units.some(z => z.deployed && z.idx === n));
            
            if(moves.length > 0) {
                let nextMove = -1;

                if (diff.aiType === 'passive') {
                    // ç°¡å–®ï¼šéš¨æ©Ÿäº‚èµ°
                    nextMove = moves[Math.floor(Math.random()*moves.length)];
                } else if (diff.aiType === 'aggressive') {
                    // å›°é›£ï¼šå°‹æ‰¾æœ€è¿‘çš„ç©å®¶
                    let nearestP = state.units.find(u => u.deployed); // ç°¡åŒ–ï¼šæ‰¾ç¬¬ä¸€å°
                    if (nearestP) {
                        // ç°¡å–®çš„è¶¨å‘ç®—æ³•
                        let pPos = getXY(nearestP.idx);
                        // é¸æ“‡é›¢ç›®æ¨™æœ€è¿‘çš„æ ¼å­
                        moves.sort((a,b) => {
                            let da = Math.abs(getXY(a).x - pPos.x) + Math.abs(getXY(a).y - pPos.y);
                            let db = Math.abs(getXY(b).x - pPos.x) + Math.abs(getXY(b).y - pPos.y);
                            return da - db;
                        });
                        nextMove = moves[0];
                    } else {
                        nextMove = moves[Math.floor(Math.random()*moves.length)];
                    }
                } else {
                    // æ™®é€šï¼šæœ‰ç©ºåœ°å°±ä½”ï¼Œéš¨æ©Ÿåå‘æœªçŸ¥
                    nextMove = moves[Math.floor(Math.random()*moves.length)];
                }

                if(nextMove !== -1) {
                    e.idx = nextMove;
                    state.map[e.idx].owner = 'enemy';
                }
            }
        }
    });

    // å¢æ´æ©Ÿåˆ¶
    if(state.turn % diff.spawnRate === 0) {
        let base = state.map.find(t => t.type === TILE.BASE && t.owner === 'enemy');
        if(base) {
            // æ‰¾å€‹ç©ºæ ¼ç”Ÿ
            let spawnIdx = base.idx;
            if(state.enemies.some(e=>e.idx===spawnIdx)) {
                 let n = getNeighbors(spawnIdx).find(x => !state.enemies.some(e=>e.idx===x));
                 if(n) spawnIdx = n;
            }
            // éš¨æ©Ÿç”Ÿä¸€ç¨®å…µ
            let type = Math.random() > 0.7 ? 91 : 90; 
            spawnEnemy(spawnIdx, type);
            log(`âš ï¸ æ•µè»å¢æ´å‡ºç¾ï¼(é›£åº¦:${diff.name})`);
        }
    }
}

/* ================= æˆ°é¬¥ ================= */

function prepBattle(idx) {
    let enemy = state.enemies.find(e => e.idx === idx);
    let neighbors = getNeighbors(idx);
    let attackers = state.units.filter(u => u.deployed && neighbors.includes(u.idx));
    
    if(attackers.length === 0) { alert("ç„¡é„°è¿‘æˆ‘æ–¹å–®ä½"); return; }

    document.getElementById('target-name').innerText = enemy.name;
    let list = document.getElementById('squad-list');
    list.innerHTML = '';
    attackers.forEach(u => {
        list.innerHTML += `<div class="list-row"><label><input type="checkbox" value="${u.uuid}" checked> ${u.name} (ATK:${u.atk})</label></div>`;
    });

    state.battle = { enemyIdx: idx, enemy: enemy };
    openModal('squad-modal');
}

function startBattle() {
    let cbs = document.querySelectorAll('#squad-list input:checked');
    if(cbs.length === 0) return;
    state.ap--;
    closeModal('squad-modal');

    let ids = Array.from(cbs).map(c => parseFloat(c.value));
    state.battle.squad = state.units.filter(u => ids.includes(u.uuid));

    openModal('battle-modal');
    document.getElementById('battle-next-btn').style.display = 'inline-block';
    document.getElementById('battle-end-btn').style.display = 'none';
    document.getElementById('battle-log').innerHTML = "æˆ°é¬¥é–‹å§‹...";
    updateBattleUI(); updateUI();
}

function battleRound() {
    let b = state.battle;
    let logD = document.getElementById('battle-log');
    let aliveSquad = b.squad.filter(u => u.hp > 0);

    if(aliveSquad.length === 0) {
        logD.innerHTML += `<div>æˆ‘æ–¹å…¨æ»…...</div>`;
        endBattleState(); return;
    }

    // æˆ‘æ–¹æ”»æ“Š
    let dmg = 0;
    aliveSquad.forEach(u => dmg += Math.max(1, u.atk - b.enemy.def*0.6));
    b.enemy.hp -= Math.floor(dmg);
    logD.innerHTML += `<div style="color:#32d74b">>> æˆ‘æ–¹é½Šå°„: ${Math.floor(dmg)} å‚·å®³</div>`;

    if(b.enemy.hp <= 0) {
        logD.innerHTML += `<div style="color:yellow; font-weight:bold;">>> æ•µæ©Ÿæ“Šç ´ï¼</div>`;
        state.enemies = state.enemies.filter(e => e !== b.enemy);
        state.map[b.enemyIdx].owner = 'player';
        endBattleState(); return;
    }

    // æ•µæ–¹åæ“Š
    let target = aliveSquad[Math.floor(Math.random()*aliveSquad.length)];
    let eDmg = Math.floor(Math.max(1, b.enemy.atk - target.def*0.5));
    target.hp -= eDmg;
    logD.innerHTML += `<div style="color:#ff453a">>> æ•µæ–¹åæ“Š ${target.name}: ${eDmg} å‚·å®³</div>`;

    if(target.hp <= 0) {
        logD.innerHTML += `<div style="color:red">!! ${target.name} æ’¤é€€</div>`;
        state.units = state.units.filter(u => u !== target);
    }

    updateBattleUI(); logD.scrollTop = logD.scrollHeight;
}

function endBattleState() {
    document.getElementById('battle-next-btn').style.display = 'none';
    document.getElementById('battle-end-btn').style.display = 'inline-block';
    renderMap();
}

function updateBattleUI() {
    let b = state.battle;
    let pSide = document.getElementById('battle-p-side');
    let eSide = document.getElementById('battle-e-side');
    pSide.innerHTML = ''; eSide.innerHTML = '';
    b.squad.forEach(u => pSide.innerHTML += `<div class="b-unit" style="color:${u.hp>0?'white':'red'}">${u.name} ${u.hp>0?u.hp:'X'}</div>`);
    eSide.innerHTML = `<div class="b-unit" style="color:${b.enemy.hp>0?'white':'red'}">${b.enemy.name} ${Math.max(0,Math.floor(b.enemy.hp))}</div>`;
}

/* ================= è¼”åŠ©èˆ‡UI ================= */

function addUnit(id) {
    let t = UNIT_DB.find(u=>u.id===id);
    state.units.push({ ...t, uuid: Math.random(), maxHp: t.hp, deployed: false, idx: -1 });
    updateUI();
}
// ç”Ÿæˆæ•µäººæ™‚å¥—ç”¨é›£åº¦æ•¸å€¼ä¿®æ­£
function spawnEnemy(idx, id) {
    let t = UNIT_DB.find(u=>u.id===id);
    let mod = DIFF_SETTINGS[state.diffIdx].enemyMod;
    let modifiedHp = Math.floor(t.hp * mod);
    let modifiedAtk = Math.floor(t.atk * mod);
    state.enemies.push({ ...t, hp: modifiedHp, atk: modifiedAtk, uuid: Math.random(), maxHp: modifiedHp, idx: idx });
}
function processQ(q, cb) {
    for(let i=q.length-1; i>=0; i--) {
        q[i].t--;
        if(q[i].t <= 0) { cb(q[i]); q.splice(i,1); }
    }
}
function startProd(id) {
    let u = UNIT_DB.find(x=>x.id===id);
    if(state.money >= u.cost) {
        state.money -= u.cost;
        state.qProd.push({id:id, name:u.name, t:u.prod});
        closeModal('recruit-modal'); updateUI();
    } else alert("è³‡é‡‘ä¸è¶³");
}
function startRes(id) {
    let u = UNIT_DB.find(x=>x.id===id);
    if(state.money >= u.res.m && state.parts >= u.res.p) {
        state.money -= u.res.m; state.parts -= u.res.p;
        state.qRes.push({id:id, name:u.name, t:u.resT});
        closeModal('research-modal'); updateUI();
    } else alert("è³‡æºä¸è¶³");
}
function updateUI() {
    document.getElementById('money').innerText = state.money;
    document.getElementById('parts').innerText = state.parts;
    document.getElementById('ap').innerText = state.ap;
    document.getElementById('turn-display').innerText = state.turn;
    
    // Queue
    let qEl = document.getElementById('queue-list');
    qEl.innerHTML = '';
    state.qProd.forEach(i => qEl.innerHTML += `<div class="list-row"><span>ğŸ­ ${i.name}</span><span>${i.t}å›</span></div>`);
    state.qRes.forEach(i => qEl.innerHTML += `<div class="list-row"><span>ğŸ§ª ${i.name}</span><span>${i.t}å›</span></div>`);
    
    // Hangar
    let hEl = document.getElementById('hangar-list');
    hEl.innerHTML = '';
    state.units.filter(u=>!u.deployed).forEach(u => hEl.innerHTML += `<div class="list-row"><span>${u.name}</span><span>${u.hp}HP</span></div>`);

    // Modals
    let rList = document.getElementById('research-list');
    rList.innerHTML = '';
    UNIT_DB.filter(u=>!u.unlocked && u.res).forEach(u => {
        let ing = state.qRes.find(q=>q.id===u.id);
        rList.innerHTML += `<div class="list-row"><div>${u.name}<br><small>$${u.res.m} âš™ï¸${u.res.p}</small></div><button class="btn btn-small" ${ing?'disabled':''} onclick="startRes(${u.id})">${ing?'ä¸­':'ç ”ç™¼'}</button></div>`;
    });
    let pList = document.getElementById('recruit-list');
    pList.innerHTML = '';
    UNIT_DB.filter(u=>u.unlocked && u.id<90).forEach(u => {
        pList.innerHTML += `<div class="list-row"><div>${u.name}<br><small>$${u.cost}</small></div><button class="btn btn-small" onclick="startProd(${u.id})">ç”Ÿç”¢</button></div>`;
    });
}
function log(msg) {
    let d = document.getElementById('log-area');
    d.innerHTML += `<div>> ${msg}</div>`;
    d.scrollTop = d.scrollHeight;
}
function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

</script>
</body>
</html>
