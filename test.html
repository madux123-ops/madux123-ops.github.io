<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰åœ‹å¿—ï¼šæ¼¢æœ«éœ¸æ¥­ (é“è·¯èˆ‡æˆ°é¬¥ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #1a1815;
            --panel-bg: #2b2623;
            --text-color: #dcd6cc;
            --accent-color: #8b0000;
            --gold-color: #d4af37;
            --map-bg: #2f353b;
        }
        body {
            font-family: "PMingLiU", "KaiTi", serif;
            background-color: var(--bg-color);
            background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://www.transparenttextures.com/patterns/aged-paper.png');
            color: var(--text-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden; user-select: none;
        }
        h1 { margin: 6px 0; font-size: 1.4rem; text-shadow: 2px 2px 2px #000; letter-spacing: 4px; color: var(--gold-color); font-weight: bold; }

        #game-container { width: 100%; max-width: 1600px; display: none; height: 96vh; }

        /* é–‹å§‹é¸å–® */
        #start-screen {
            background: var(--panel-bg); padding: 40px; border: 2px solid #5d4037;
            box-shadow: 0 0 50px rgba(0,0,0,1); text-align: center;
            max-width: 1200px; width: 95%; margin-top: 40px; overflow-y: auto; max-height: 90vh;
        }
        .clan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 20px; }
        .clan-btn {
            padding: 15px; cursor: pointer; color: #ddd; border: 1px solid #444; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #3e3832; min-height: 80px; position: relative;
        }
        .clan-btn:hover { transform: translateY(-3px); border-color: var(--gold-color); filter: brightness(1.2); z-index: 10; }
        .tier-badge { position: absolute; top: 0; left: 0; font-size: 0.7rem; padding: 2px 6px; background: rgba(0,0,0,0.6); color: var(--gold-color); }

        /* ä¸Šæ–¹è³‡è¨Šåˆ— */
        .top-bar {
            display: flex; gap: 15px; background: #201c1a; padding: 6px 20px;
            border-bottom: 2px solid #5d4037; border-top: 2px solid #5d4037;
            justify-content: space-between; align-items: center; font-size: 0.9rem;
        }
        .stat-box { text-align: center; min-width: 60px; }
        .stat-label { font-size: 0.7rem; color: #a1887f; display: block; }
        .stat-val { font-size: 1rem; font-weight: bold; color: var(--gold-color); font-family: "Georgia"; }
        .ap-box { background: var(--accent-color); padding: 4px 12px; border-radius: 2px; font-weight: bold; color: white; border: 1px solid #ff5252; }

        /* ä¸»éŠæˆ²å€ */
        .main-content { display: grid; grid-template-columns: 1fr 320px; gap: 0; height: 100%; }
        
        /* åœ°åœ–å€åŸŸ */
        .map-frame {
            background-color: var(--map-bg);
            /* æ¨¡æ“¬åœ°å½¢ */
            background-image: radial-gradient(circle at 30% 60%, #3a3f44 0%, var(--map-bg) 60%);
            border-right: 2px solid #3e3832; position: relative; overflow: auto; cursor: grab;
        }
        
        /* é“è·¯ SVG */
        #road-layer { position: absolute; top: 0; left: 0; width: 1400px; height: 1200px; pointer-events: none; z-index: 0; }
        .road-line { stroke: rgba(255, 255, 255, 0.15); stroke-width: 2; stroke-dasharray: 5,5; }

        .map-grid {
            display: grid;
            grid-template-columns: repeat(40, 32px); /* å›ºå®šå¯¬åº¦ä»¥ä¾¿ç¹ªç·š */
            grid-template-rows: repeat(35, 32px);
            gap: 4px; padding: 40px; width: 1400px; height: 1200px; position: relative; z-index: 1;
        }
        .province {
            border: 1px solid rgba(255,255,255,0.15); background: #4a4a4a;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; transition: 0.15s; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4); color: #ccc; border-radius: 2px;
        }
        .province:hover { border-color: #ffd700; z-index: 100; transform: scale(1.3); box-shadow: 0 0 15px #000; }
        .prov-name { font-weight: bold; font-family: "KaiTi"; font-size: 0.9rem; text-shadow: 1px 1px 2px #000; pointer-events: none; white-space: nowrap; margin-bottom: 2px; z-index: 2;}
        .prov-info { font-size: 0.6rem; pointer-events: none; color: #fff; z-index: 2; }
        
        /* ç‹€æ…‹æ¨£å¼ */
        .status-direct { border: 2px solid #fff; box-shadow: inset 0 0 5px #fff; }
        .status-auto { border: 2px double #66bb6a; }
        .status-ally { border: 2px dashed #42a5f5; opacity: 0.9; }

        /* çµ±è¨ˆé¢æ¿ */
        .stats-overlay {
            position: absolute; top: 10px; left: 10px; background: rgba(30, 25, 20, 0.95);
            border: 1px solid #8d6e63; padding: 8px; width: 180px; max-height: 400px; overflow-y: auto;
            z-index: 1000; font-size: 0.75rem; color: #ddd; box-shadow: 3px 3px 8px rgba(0,0,0,0.7);
        }
        .stats-table { border-collapse: collapse; width: 100%; }
        .stats-table td { padding: 3px; border-bottom: 1px solid #3e3832; }

        /* å‹¢åŠ›é¡è‰² */
        .c-wei { background: #0d47a1; color: #fff; } 
        .c-shu { background: #1b5e20; color: #fff; } 
        .c-wu { background: #b71c1c; color: #fff; }  
        .c-yuan { background: #fbc02d; color: #000; } 
        .c-dong { background: #4a148c; color: #fff; } 
        .c-lu { background: #212121; border: 1px solid #ff5252; } 
        .c-ma { background: #006064; }
        .c-liu_biao { background: #5d4037; }
        .c-liu_zhang { background: #827717; }
        .c-gongsun { background: #e65100; }
        .c-yuan_shu { background: #f06292; color:#000; }
        .c-neutral { background: #546e7a; opacity: 0.6; }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { background: var(--panel-bg); padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.5); z-index: 50; }
        .panel-block { background: #352e2a; padding: 10px; border: 1px solid #5d4037; margin-bottom: 5px; }
        .panel-header { color: var(--gold-color); font-size: 0.9rem; border-bottom: 1px solid #5d4037; margin-bottom: 8px; font-family: "KaiTi"; font-weight:bold; }
        
        button { 
            width: 100%; padding: 10px; margin-bottom: 6px; cursor: pointer; 
            background: #4e443e; color: #e0e0e0; border: 1px solid #6d5e56; text-align: left; transition: 0.2s; font-size: 0.9rem;
        }
        button:hover { background: #6d5e56; border-color: #a1887f; color:#fff; }
        select { width: 100%; padding: 8px; background: #26211e; color: #e0e0e0; border: 1px solid #5d4037; margin-bottom: 8px; }
        
        .btn-wait { background: #212121; color: #cfd8dc; border: 1px solid #455a64; text-align: center; height: 45px; margin-top: auto; font-size: 1rem; }
        #log-box { height: 180px; background: #111; border: 1px solid #5d4037; padding: 8px; font-size: 0.8rem; overflow-y: auto; font-family: 'Consolas', monospace; color: #ccc; }
        
        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center; }
        .modal-box { background: #2d2d2d; padding: 20px; width: 500px; border: 2px solid var(--gold-color); text-align: center; box-shadow: 0 0 30px #000; max-height: 90vh; overflow-y: auto;}
        
        /* æˆ°é¬¥æº–å‚™ä»‹é¢ */
        .battle-prep-container { display: flex; gap: 20px; text-align: left; margin-bottom: 20px; }
        .battle-side { flex: 1; background: #222; padding: 10px; border: 1px solid #444; }
        .gen-list-item { padding: 5px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .gen-list-item:hover { background: #333; }
        .gen-checkbox { transform: scale(1.2); cursor: pointer; }
        .stat-badge { font-size: 0.75rem; padding: 1px 4px; border-radius: 3px; margin-left: 5px; }
        
        .manage-grid { display: flex; gap: 15px; margin-top: 20px; }
        .manage-card { flex: 1; padding: 15px; border: 1px solid #666; cursor: pointer; background: #333; transition:0.2s; }
        .manage-card:hover { background: #444; border-color: var(--gold-color); }
        .close-btn { background: #444; border: 1px solid #666; padding: 8px 25px; cursor: pointer; color:#fff; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>ä¸‰åœ‹å¿—ï¼šæ¼¢æœ«éœ¸æ¥­</h1>
        <p style="color:#a1887f; font-family:'KaiTi';">å…¬å…ƒ190å¹´ - ç¾¤é›„å‰²æ“š</p>
        <div style="margin-bottom: 20px;">
            <select id="difficulty" style="width: auto; padding: 5px;">
                <option value="1">åˆç´š (è³‡æºè±æ²›)</option>
                <option value="2" selected>ä¸­ç´š (ç¾¤é›„ä¸¦èµ·)</option>
                <option value="3">ä¸Šç´š (ä¿®ç¾…ä¹‹é“)</option>
            </select>
        </div>
        <div class="clan-grid" id="clan-select-area"></div>
    </div>

    <div id="game-container">
        <div class="top-bar">
            <div class="stat-box"><span class="stat-label">æ™‚é–“</span><div class="stat-val" id="d-year">190å¹´ æ˜¥</div></div>
            <div class="stat-box"><span class="stat-label">è³‡é‡‘</span><div class="stat-val" id="d-gold">0</div></div>
            <div class="stat-box"><span class="stat-label">è»ç³§</span><div class="stat-val" id="d-food">0</div></div>
            <div class="stat-box"><span class="stat-label">ç¸½å…µåŠ›</span><div class="stat-val"><span id="d-troops">0</span><span class="wounded-box">(<span id="d-wounded">0</span>)</span></div></div>
            <div class="stat-box"><span class="stat-label">åŸæ± </span><div class="stat-val" id="d-lands">0</div></div>
            <div class="ap-box">æ”¿ä»¤: <span id="d-ap">3</span></div>
        </div>

        <div class="main-content">
            <div class="map-frame" id="map-frame">
                <svg id="road-layer"></svg>
                <div id="stats-box" class="stats-overlay"></div>
                <div class="map-grid" id="map-grid"></div>
            </div>

            <div class="control-panel">
                <div class="panel-block">
                    <div class="panel-header">å…§æ”¿æŒ‡ä»¤</div>
                    <select id="general-select"></select>
                    <button onclick="doAction('commerce')">ğŸ’° å•†æ¥­é–‹ç™¼ (é‡‘+)</button>
                    <button onclick="doAction('agriculture')">ğŸŒ¾ è¾²æ¥­é–‹å¢¾ (ç³§+)</button>
                    <button onclick="doAction('recruit')">âš”ï¸ å¾µå¬ç¾©å…µ (å…µ+)</button>
                    <button onclick="doAction('fortify')">ğŸ”¨ ä¿®ç¯‰åŸé˜² (é˜²+)</button>
                </div>
                <div class="panel-block">
                    <div class="panel-header">å¤–äº¤</div>
                    <select id="diplo-select"></select>
                    <button onclick="doDiplomacy()">ğŸ“œ ç· çµåŒç›Ÿ (é‡‘-800)</button>
                </div>
                <button class="btn-wait" onclick="endTurn()">ğŸŒ™ çµæŸæœ¬æœˆ</button>
                <div id="log-box"></div>
            </div>
        </div>
    </div>

    <div id="manage-modal" class="modal">
        <div class="modal-box">
            <h3 id="manage-title" style="color:var(--gold-color); margin-top:0;">å¤ªå®ˆä»»å‘½</h3>
            <p style="font-size:0.9rem; color:#aaa;">å¤ªå®ˆå°‡è‡ªå‹•ç®¡ç†å…§æ”¿èˆ‡é˜²ç¦¦ã€‚</p>
            <select id="manage-gen-select" style="margin-bottom:20px;"></select>
            <div class="manage-grid">
                <div class="manage-card" onclick="setProvinceState('direct')">
                    <strong style="color:#ef5350;">â˜… ç›´è½„</strong><br><span style="font-size:0.8rem; color:#bbb;">å…µåŠ›æ­¸ä¸­å¤®</span>
                </div>
                <div class="manage-card" onclick="setProvinceState('auto')">
                    <strong style="color:#66bb6a;">â™» å§”ä»»</strong><br><span style="font-size:0.8rem; color:#bbb;">å…µåŠ›ç¨ç«‹</span>
                </div>
            </div>
            <button class="close-btn" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="battle-modal" class="modal">
        <div class="modal-box" style="width: 700px;">
            <h2 style="color:#ff5252; margin-top:0;">è»äº‹å‡ºå¾</h2>
            <div class="battle-prep-container">
                <div class="battle-side">
                    <h4 style="color:#64b5f6; margin:0 0 10px 0;">æˆ‘è»ä¸»å°‡ (æœ€å¤š5äºº)</h4>
                    <div id="battle-gen-list" style="height: 250px; overflow-y: auto;"></div>
                    <div style="margin-top:10px; font-size:0.9rem;">
                        é è¨ˆå…µåŠ›: <span id="battle-player-troops" style="color:#gold">0</span><br>
                        å¹³å‡çµ±ç‡: <span id="battle-avg-lead" style="color:#ccc">0</span>
                    </div>
                </div>
                <div class="battle-side">
                    <h4 style="color:#ef5350; margin:0 0 10px 0;">æ•µæ–¹æƒ…å ±</h4>
                    <div id="battle-enemy-info" style="font-size:0.9rem; line-height:1.6;"></div>
                </div>
            </div>
            <button style="background:#b71c1c; text-align:center; font-weight:bold; font-size:1.1rem;" onclick="executeBattle()">é–‹æˆ°</button>
            <button class="close-btn" onclick="closeModal()">æ’¤é€€</button>
        </div>
    </div>
    
    <div id="end-modal" class="modal">
        <div class="modal-box">
            <h2 id="end-title" style="color: var(--gold-color);"></h2>
            <p id="end-msg"></p>
            <button class="close-btn" onclick="location.reload()">é‡è¿”äº‚ä¸–</button>
        </div>
    </div>

<script>
    // åº§æ¨™å®šç¾©
    const PROVINCES_DATA = [
        {id:1,n:"è¥„å¹³",r:3,c:32}, {id:2,n:"åŒ—å¹³",r:4,c:29}, {id:3,n:"è–Š",r:5,c:28},
        {id:4,n:"å—çš®",r:7,c:28}, {id:5,n:"é„´",r:9,c:27}, {id:6,n:"æ™‰é™½",r:7,c:25}, {id:7,n:"å¹³åŸ",r:9,c:29},
        {id:8,n:"åŒ—æµ·",r:9,c:32}, {id:9,n:"æ¿®é™½",r:11,c:28}, {id:10,n:"é™³ç•™",r:12,c:27},
        {id:11,n:"æ´›é™½",r:12,c:24}, {id:12,n:"è¨±æ˜Œ",r:14,c:26}, {id:13,n:"æ±å—",r:16,c:27},
        {id:14,n:"ä¸‹é‚³",r:13,c:31}, {id:15,n:"å°æ²›",r:12,c:30}, {id:16,n:"å»£é™µ",r:15,c:33},
        {id:17,n:"å£½æ˜¥",r:16,c:30}, {id:18,n:"å®›",r:15,c:24},
        {id:19,n:"é•·å®‰",r:13,c:21}, {id:20,n:"å¤©æ°´",r:11,c:17}, {id:21,n:"å®‰å®š",r:10,c:19},
        {id:22,n:"æ­¦å¨",r:8,c:14}, {id:23,n:"è¥¿å¹³",r:9,c:12},
        {id:24,n:"æ¼¢ä¸­",r:15,c:19}, {id:25,n:"æ¢“æ½¼",r:17,c:17}, {id:26,n:"æˆéƒ½",r:19,c:16},
        {id:27,n:"æ±Ÿå·",r:20,c:19}, {id:28,n:"å»ºå¯§",r:26,c:15}, {id:29,n:"é›²å—",r:28,c:13},
        {id:30,n:"æ°¸å®‰",r:19,c:21},
        {id:31,n:"ä¸Šåº¸",r:14,c:22}, {id:32,n:"è¥„é™½",r:16,c:23}, {id:33,n:"æ±Ÿå¤",r:18,c:26},
        {id:34,n:"æ±Ÿé™µ",r:19,c:23}, {id:35,n:"é•·æ²™",r:22,c:25}, {id:36,n:"æ­¦é™µ",r:21,c:22},
        {id:37,n:"é›¶é™µ",r:25,c:23}, {id:38,n:"æ¡‚é™½",r:25,c:26},
        {id:39,n:"å»¬æ±Ÿ",r:18,c:29}, {id:40,n:"å»ºæ¥­",r:17,c:32}, {id:41,n:"å³",r:18,c:34},
        {id:42,n:"æœƒç¨½",r:20,c:35}, {id:43,n:"æŸ´æ¡‘",r:21,c:28}, {id:44,n:"è±«ç« ",r:23,c:29},
        {id:45,n:"å—æµ·",r:28,c:27}, {id:46,n:"äº¤è¶¾",r:30,c:24}
    ];

    const CLANS = {
        wei: { n: 'æ›¹æ“', c: 'c-wei', t: 1, startProvs: [10, 12] },
        shu: { n: 'åŠ‰å‚™', c: 'c-shu', t: 1, startProvs: [7] },
        wu: { n: 'å­«å …', c: 'c-wu', t: 1, startProvs: [35] },
        yuan: { n: 'è¢ç´¹', c: 'c-yuan', t: 1, startProvs: [4, 5, 2] },
        dong: { n: 'è‘£å“', c: 'c-dong', t: 1, startProvs: [11, 19, 21] },
        lu: { n: 'å‘‚å¸ƒ', c: 'c-lu', t: 2, startProvs: [9] },
        ma: { n: 'é¦¬é¨°', c: 'c-ma', t: 2, startProvs: [22, 23] },
        liu_biao: { n: 'åŠ‰è¡¨', c: 'c-liu_biao', t: 2, startProvs: [32, 33] },
        liu_zhang: { n: 'åŠ‰ç’‹', c: 'c-liu_zhang', t: 2, startProvs: [26, 25] },
        yuan_shu: { n: 'è¢è¡“', c: 'c-yuan_shu', t: 3, startProvs: [13, 17] },
        gongsun: { n: 'å…¬å­«ç“š', c: 'c-gongsun', t: 3, startProvs: [3] },
        neutral: { n: 'åœ¨é‡', c: 'c-neutral', t: 0, startProvs: [] }
    };

    const REAL_GENERALS = {
        wei: [{n:'æ›¹æ“',w:99,p:96}, {n:'å¤ä¾¯æƒ‡',w:92,p:70}, {n:'å¤ä¾¯æ·µ',w:93,p:60}, {n:'æ›¹ä»',w:89,p:75}, {n:'å¼µé¼',w:95,p:78}, {n:'è¨±è¤š',w:98,p:20}, {n:'å¸é¦¬æ‡¿',w:98,p:98}, {n:'éƒ­å˜‰',w:75,p:98}, {n:'è€å½§',w:60,p:99}],
        shu: [{n:'åŠ‰å‚™',w:80,p:90}, {n:'é—œç¾½',w:98,p:75}, {n:'å¼µé£›',w:99,p:30}, {n:'è¶™é›²',w:97,p:75}, {n:'é¦¬è¶…',w:98,p:45}, {n:'é»ƒå¿ ',w:94,p:60}, {n:'è«¸è‘›äº®',w:95,p:100}, {n:'é¾çµ±',w:88,p:97}, {n:'æ³•æ­£',w:82,p:94}],
        wu: [{n:'å­«å …',w:94,p:78}, {n:'å­«ç­–',w:96,p:70}, {n:'å­«æ¬Š',w:78,p:88}, {n:'å‘¨ç‘œ',w:97,p:96}, {n:'å‘‚è’™',w:93,p:88}, {n:'é™¸éœ',w:96,p:95}, {n:'ç”˜å¯§',w:95,p:40}, {n:'å¤ªå²æ…ˆ',w:94,p:50}, {n:'å‘¨æ³°',w:90,p:30}],
        yuan: [{n:'è¢ç´¹',w:82,p:75}, {n:'é¡è‰¯',w:94,p:30}, {n:'æ–‡é†œ',w:95,p:25}, {n:'ç”°è±',w:70,p:92}, {n:'å¼µéƒƒ',w:91,p:68}],
        dong: [{n:'è‘£å“',w:88,p:60}, {n:'æå„’',w:60,p:94}, {n:'è¯é›„',w:92,p:20}, {n:'æå‚•',w:78,p:40}, {n:'éƒ­æ±œ',w:76,p:35}],
        lu: [{n:'å‘‚å¸ƒ',w:100,p:20}, {n:'é™³å®®',w:80,p:90}, {n:'é«˜é †',w:88,p:50}, {n:'å¼µé¼',w:95,p:75}],
        ma: [{n:'é¦¬é¨°',w:85,p:60}, {n:'é¦¬è¶…',w:98,p:45}, {n:'é¾å¾·',w:94,p:50}],
        liu_biao: [{n:'åŠ‰è¡¨',w:65,p:80}, {n:'æ–‡è˜',w:86,p:70}, {n:'è”¡ç‘',w:75,p:72}, {n:'é»ƒç¥–',w:72,p:50}],
        liu_zhang: [{n:'åŠ‰ç’‹',w:40,p:65}, {n:'å¼µä»»',w:89,p:70}, {n:'åš´é¡',w:86,p:72}, {n:'æ³•æ­£',w:75,p:94}],
        yuan_shu: [{n:'è¢è¡“',w:60,p:50}, {n:'ç´€éˆ',w:86,p:40}],
        gongsun: [{n:'å…¬å­«ç“š',w:85,p:60}, {n:'è¶™é›²',w:97,p:75}, {n:'åš´ç¶±',w:75,p:50}]
    };

    let state = {
        turn: 1, year: 190, season: 0, player: null, difficulty: 2, actions: 3,
        resources: { gold: 0, food: 0, troops: 0, wounded: 0 },
        dev: { comm: 1, agri: 1 },
        provinces: {}, generals: [], alliances: {}, selectedProv: -1,
        battleTarget: -1
    };

    window.onload = () => {
        const area = document.getElementById('clan-select-area');
        Object.keys(CLANS).forEach(key => {
            if(key === 'neutral') return;
            let div = document.createElement('div');
            div.className = `clan-btn ${CLANS[key].c}`;
            div.innerHTML = `<span class="tier-badge">${CLANS[key].t===1?'ç¾¤é›„':(CLANS[key].t===2?'è«¸ä¾¯':'å‰²æ“š')}</span><strong>${CLANS[key].n}</strong>`;
            div.onclick = () => startGame(key);
            area.appendChild(div);
        });
    };

    function startGame(clanKey) {
        state.player = clanKey;
        state.difficulty = parseInt(document.getElementById('difficulty').value);
        let baseRes = state.difficulty === 1 ? 4000 : (state.difficulty === 3 ? 1000 : 2500);
        state.resources = { gold: baseRes, food: baseRes, troops: 5000, wounded: 0 };
        state.generals = [];

        let gid = 0;
        Object.keys(CLANS).forEach(k => {
            if(k === 'neutral') return;
            let gens = REAL_GENERALS[k] || [];
            gens.forEach(g => {
                state.generals.push({ id: gid++, name: g.n, w: g.w, p: g.p, owner: k, status: 'free', assignedTo: null });
            });
        });

        initMap();
        drawRoads(); // ç¹ªè£½é“è·¯
        updateUI();
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
    }

    function initMap() {
        const grid = document.getElementById('map-grid');
        state.provinces = {};
        PROVINCES_DATA.forEach(p => {
            state.provinces[p.id] = { 
                id: p.id, name: p.n, owner: 'neutral', 
                troops: 2000 + Math.floor(Math.random()*1000), 
                status: 'direct', generalId: null, defense: 100, wounded: 0, pop: 20000
            };
        });
        Object.keys(CLANS).forEach(k => {
            if(k === 'neutral') return;
            CLANS[k].startProvs.forEach(pid => {
                if(state.provinces[pid]) {
                    state.provinces[pid].owner = k;
                    state.provinces[pid].troops = (k === state.player) ? 0 : (3000 + CLANS[k].t * 1000);
                }
            });
        });
        PROVINCES_DATA.forEach(p => {
            let div = document.createElement('div');
            let owner = state.provinces[p.id].owner;
            div.className = `province ${CLANS[owner].c}`;
            div.style.gridRow = p.r; div.style.gridColumn = p.c;
            div.id = `prov-${p.id}`; div.onclick = () => clickProvince(p.id);
            div.innerHTML = `<div class="prov-name">${p.n}</div><div class="prov-info" id="info-${p.id}"></div>`;
            grid.appendChild(div);
        });
    }

    // ç¹ªè£½é“è·¯ (SVG)
    function drawRoads() {
        const svg = document.getElementById('road-layer');
        svg.innerHTML = '';
        const gridStyle = 36; // 32px + 4px gap

        PROVINCES_DATA.forEach(p1 => {
            let neighbors = getNeighbors(p1.id);
            neighbors.forEach(nid => {
                // ç‚ºé¿å…é‡è¤‡ç¹ªè£½ï¼Œåªç•« id å°é€£åˆ°å¤§çš„
                if (p1.id < nid) {
                    let p2 = PROVINCES_DATA.find(x => x.id === nid);
                    if (p2) {
                        // è¨ˆç®—ä¸­å¿ƒé»åº§æ¨™
                        let x1 = (p1.c - 1) * gridStyle + 56; // 40px padding + 16px half-width
                        let y1 = (p1.r - 1) * gridStyle + 56;
                        let x2 = (p2.c - 1) * gridStyle + 56;
                        let y2 = (p2.r - 1) * gridStyle + 56;
                        
                        let line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', x1); line.setAttribute('y1', y1);
                        line.setAttribute('x2', x2); line.setAttribute('y2', y2);
                        line.setAttribute('class', 'road-line');
                        svg.appendChild(line);
                    }
                }
            });
        });
    }

    function getNeighbors(pid) {
        let p1 = PROVINCES_DATA.find(x => x.id === pid);
        let list = [];
        PROVINCES_DATA.forEach(p2 => {
            if(p1.id !== p2.id) {
                let dr = Math.abs(p1.r - p2.r);
                let dc = Math.abs(p1.c - p2.c);
                if (dr <= 2 && dc <= 2 && (dr+dc <= 3)) list.push(p2.id);
            }
        });
        return list;
    }

    // å…§æ”¿èˆ‡å¤–äº¤é‚è¼¯ (ç°¡åŒ–ç‰ˆ)
    function doAction(type) {
        if(state.actions <= 0) return alert("æ”¿ä»¤æ¬¡æ•¸è€—ç›¡");
        const sel = document.getElementById('general-select');
        if(!sel.value) return alert("ç„¡å¯ç”¨æ­¦å°‡");
        const gen = state.generals.find(g => g.id == sel.value);
        let directs = Object.values(state.provinces).filter(p => p.owner === state.player && p.status === 'direct');
        if(directs.length === 0 && type !== 'fortify') return alert("ç„¡ç›´è½„é ˜åœ°");
        
        let bonus = 1 + (gen.p/100);
        let msg = "";
        
        if(type==='commerce') { 
            state.resources.gold += Math.floor(400 * bonus); state.resources.food -= 100; state.dev.comm++; msg="å•†æ¥­é–‹ç™¼æˆåŠŸ";
        } else if(type==='agriculture') {
            state.resources.food += Math.floor(400 * bonus); state.resources.gold -= 100; state.dev.agri++; msg="è¾²æ¥­é–‹å¢¾æˆåŠŸ";
        } else if(type==='recruit') {
            if(state.resources.gold < 200) return alert("è³‡é‡‘ä¸è¶³");
            state.resources.troops += Math.floor(500 * (1+gen.w/100)); state.resources.gold -= 200; state.resources.food -= 200; msg="å¾µå…µå®Œæˆ";
        } else if(type==='fortify') {
            let t = directs[Math.floor(Math.random()*directs.length)];
            t.defense = Math.min(400, t.defense + 30); state.resources.gold -= 150; msg=`${t.name} åŸé˜²ä¿®ç¯‰å®Œæˆ`;
        }
        state.actions--; log(`${gen.name}: ${msg}`); updateUI();
    }

    function doDiplomacy() {
        if(state.actions <= 0 || state.resources.gold < 800) return alert("æ¢ä»¶ä¸è¶³");
        const target = document.getElementById('diplo-select').value;
        state.resources.gold -= 800; state.actions--;
        if(Math.random() < 0.4) { state.alliances[target]=12; log(`èˆ‡ ${CLANS[target].n} çµç›ŸæˆåŠŸï¼`); }
        else { log(`${CLANS[target].n} æ‹’çµ•äº†åŒç›Ÿã€‚`); }
        updateUI();
    }

    // --- æˆ°é¬¥ç³»çµ± ---

    function clickProvince(pid) {
        const p = state.provinces[pid];
        if(p.owner === state.player) { openManage(pid); return; }
        if(state.alliances[p.owner] > 0) return alert("åŒç›Ÿä¸­");
        if(state.actions <= 0) return alert("æ”¿ä»¤æ¬¡æ•¸è€—ç›¡");
        if(!isAdjacent(pid, state.player)) return alert("ä¸ç›¸é„°");
        
        // é–‹å•Ÿæˆ°é¬¥æº–å‚™
        openBattlePrep(pid);
    }

    function openBattlePrep(pid) {
        state.battleTarget = pid;
        const p = state.provinces[pid];
        const modal = document.getElementById('battle-modal');
        const list = document.getElementById('battle-gen-list');
        const enemyInfo = document.getElementById('battle-enemy-info');
        
        // æ•µäººæƒ…å ±
        let guardName = p.generalId ? state.generals.find(g=>g.id===p.generalId).name : "ç„¡å¤ªå®ˆ";
        let guardStat = p.generalId ? state.generals.find(g=>g.id===p.generalId).w : 50;
        let defTroops = p.troops; 
        if(p.owner===state.player) defTroops = 0; // ä¸æ‡‰è©²ç™¼ç”Ÿ
        
        enemyInfo.innerHTML = `
            <strong>${p.name}</strong> (${CLANS[p.owner].n})<br>
            <br>
            å®ˆè»å…µåŠ›: <span style="color:#ef5350">${defTroops}</span><br>
            åŸé˜²ç­‰ç´š: ${p.defense}<br>
            å®ˆå°‡: ${guardName} (çµ±æ­¦: ${guardStat})
        `;

        // æˆ‘æ–¹æ­¦å°‡åˆ—è¡¨
        list.innerHTML = '';
        let freeGens = state.generals.filter(g => g.owner === state.player && g.status === 'free');
        if(freeGens.length === 0) {
            list.innerHTML = '<div style="color:gray">ç„¡é–’ç½®æ­¦å°‡</div>';
        } else {
            freeGens.sort((a,b)=>b.w - a.w).forEach(g => {
                let item = document.createElement('div');
                item.className = 'gen-list-item';
                item.innerHTML = `
                    <label>
                        <input type="checkbox" class="gen-checkbox" value="${g.id}" onchange="updateBattleStats()">
                        <span style="font-size:1rem; margin-left:10px;">${g.name}</span>
                    </label>
                    <div>
                        <span class="stat-badge" style="background:#b71c1c">çµ±æ­¦ ${g.w}</span>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        updateBattleStats();
        modal.style.display = 'flex';
    }

    function updateBattleStats() {
        const checkboxes = document.querySelectorAll('.gen-checkbox:checked');
        // é™åˆ¶é¸5äºº
        if(checkboxes.length > 5) {
            alert("æœ€å¤šæ´¾é£ 5 åæ­¦å°‡ï¼");
            event.target.checked = false;
            return;
        }

        let totalLead = 0;
        let count = checkboxes.length;
        checkboxes.forEach(box => {
            let g = state.generals.find(x => x.id == box.value);
            totalLead += g.w;
        });
        
        let avg = count > 0 ? Math.floor(totalLead / count) : 0;
        document.getElementById('battle-avg-lead').innerText = avg;
        document.getElementById('battle-player-troops').innerText = state.resources.troops;
    }

    function executeBattle() {
        const checkboxes = document.querySelectorAll('.gen-checkbox:checked');
        if(checkboxes.length === 0) return alert("è«‹è‡³å°‘æ´¾é£ä¸€åæ­¦å°‡");
        if(state.resources.food < 300 || state.resources.troops < 500) return alert("å…µç³§æˆ–å…µåŠ›ä¸è¶³");

        let selectedGenIds = Array.from(checkboxes).map(c => parseInt(c.value));
        let selectedGens = state.generals.filter(g => selectedGenIds.includes(g.id));
        
        const target = state.provinces[state.battleTarget];
        
        // æ¶ˆè€—
        state.actions--;
        state.resources.gold -= 100;
        state.resources.food -= 300;
        closeModal();

        // --- æˆ°é¬¥è¨ˆç®—æ ¸å¿ƒ ---
        
        // 1. æ”»æ“Šæ–¹æ•¸å€¼
        let avgLead = selectedGens.reduce((sum, g) => sum + g.w, 0) / selectedGens.length;
        // æ”»æ“ŠåŠ› = ç¸½å…µåŠ› * (å¹³å‡çµ±æ­¦/100) * éš¨æ©Ÿä¿‚æ•¸
        let atkPower = state.resources.troops * (avgLead / 100) * (0.8 + Math.random() * 0.4);

        // 2. é˜²ç¦¦æ–¹æ•¸å€¼
        let defGenStat = 50; // é è¨­é›œå…µ
        if (target.generalId) {
            let dg = state.generals.find(g => g.id === target.generalId);
            defGenStat = dg.w;
        }
        // é˜²ç¦¦åŠ› = (æ•µå…µåŠ› * çµ±æ­¦ä¿‚æ•¸) + (åŸé˜² * 10)
        let defPower = (target.troops * (defGenStat / 100)) + (target.defense * 15);
        if (target.owner !== 'neutral') defPower *= 1.2; // å‹¢åŠ›åŠ æˆ

        // 3. åˆ¤å®šå‹è² 
        let win = atkPower > defPower;
        
        // 4. æˆ°æè¨ˆç®— (é˜²ç¦¦è¶Šé«˜ï¼Œæ”»æ“Šæ–¹æå¤±è¶Šå¤§ï¼›çµ±ç‡è¶Šé«˜ï¼Œå·±æ–¹æå¤±è¶Šå°)
        let dmgReduction = Math.min(0.8, avgLead / 200); // çµ±ç‡æ¸›å‚·
        let baseLoss = win ? target.troops * 0.4 : state.resources.troops * 0.3;
        let atkLoss = Math.floor(baseLoss * (1 - dmgReduction));
        // åŸé˜²é€ æˆçš„é¡å¤–å‚·å®³
        atkLoss += Math.floor(target.defense * 2);
        
        let defLoss = win ? target.troops : Math.floor(state.resources.troops * 0.2);

        // 5. çµç®—
        state.resources.troops = Math.max(0, state.resources.troops - atkLoss);
        state.resources.wounded += Math.floor(atkLoss * 0.6); // å‚·å…µ

        if (win) {
            target.troops = 0;
            captureProv(target, state.player);
            log(`<span class="log-good">å¤§æ·ï¼${selectedGens[0].name} ç‡è»æ”»é™· ${target.name}ï¼</span>`);
        } else {
            target.troops = Math.max(0, target.troops - defLoss);
            log(`<span class="log-bad">æˆ°æ•—ï¼æ”»æ‰“ ${target.name} å¤±åˆ©ï¼Œæå¤± ${atkLoss} å…µé¦¬ã€‚</span>`);
        }
        
        if(win && target.owner !== 'neutral') checkDestruction(target.owner, state.player);
        updateUI();
    }

    function captureProv(p, newOwner) {
        if(p.generalId !== null) {
            let gen = state.generals.find(g=>g.id===p.generalId);
            if(Math.random() < 0.3) { 
                gen.owner = newOwner; gen.status = 'free'; gen.assignedTo = null; 
                if(newOwner === state.player) log(`<span class="log-sys">${gen.name} æ­¸é™ï¼</span>`); 
            } else { gen.status='free'; gen.assignedTo=null; }
        }
        p.owner = newOwner; p.status = (newOwner === state.player) ? 'direct' : 'auto'; 
        p.generalId = null; p.troops = 0; p.defense = Math.max(50, p.defense - 50);
    }

    function checkDestruction(loser, winner) {
        if(Object.values(state.provinces).filter(p=>p.owner===loser).length === 0) {
            log(`ã€${CLANS[loser].n}ã€‘æ»…äº¡ã€‚`);
            state.generals.forEach(g => { if(g.owner===loser) { g.owner=winner; g.status='free'; g.assignedTo=null; }});
        }
    }

    // UI èˆ‡é€šç”¨
    function updateUI() {
        const s = ['æ˜¥','å¤','ç§‹','å†¬'];
        document.getElementById('d-year').innerText = `${state.year}å¹´ ${s[state.season]}`;
        document.getElementById('d-gold').innerText = state.resources.gold;
        document.getElementById('d-food').innerText = state.resources.food;
        document.getElementById('d-troops').innerText = state.resources.troops;
        document.getElementById('d-wounded').innerText = state.resources.wounded;
        document.getElementById('d-ap').innerText = state.actions;
        document.getElementById('d-lands').innerText = Object.values(state.provinces).filter(p=>p.owner===state.player).length;

        Object.values(state.provinces).forEach(p => {
            const el = document.getElementById(`prov-${p.id}`);
            el.className = `province ${CLANS[p.owner].c}`;
            el.classList.remove('status-direct','status-auto','status-ally');
            let info = p.troops;
            if(p.owner === state.player) {
                if(p.status === 'direct') { el.classList.add('status-direct'); info = `â˜… ${p.defense}`; }
                else { el.classList.add('status-auto'); let gn = p.generalId ? state.generals.find(g=>g.id===p.generalId).name[0] : "ç„¡"; info = `â™»${gn}`; }
            } else if(state.alliances[p.owner]) { el.classList.add('status-ally'); }
            document.getElementById(`info-${p.id}`).innerText = info;
        });

        // ä¸‹æ‹‰é¸å–®æ›´æ–°
        const ms = document.getElementById('general-select'); ms.innerHTML = '';
        state.generals.filter(g=>g.owner===state.player && g.status==='free').forEach(g => {
            let o = document.createElement('option'); o.value = g.id; o.innerText = `${g.name} (çµ±${g.w})`; ms.appendChild(o);
        });
        const ds = document.getElementById('diplo-select'); ds.innerHTML = '';
        [...new Set(Object.values(state.provinces).map(p=>p.owner))].forEach(c => {
            if(c!==state.player && c!=='neutral' && !state.alliances[c]) {
                let o = document.createElement('option'); o.value = c; o.innerText = CLANS[c].n; ds.appendChild(o);
            }
        });
    }

    function endTurn() {
        state.actions = 3; state.season++;
        // ç°¡å–® AI èˆ‡ è³‡æºçµç®—
        if(state.resources.wounded>0) { state.resources.wounded -= Math.ceil(state.resources.wounded*0.3); state.resources.troops += Math.ceil(state.resources.wounded*0.3); }
        state.resources.food = Math.max(0, state.resources.food - Math.floor(state.resources.troops/15));
        
        if(state.season > 3) { state.season=0; state.year++; state.resources.gold+=2000; state.resources.food+=2000; log("æ–°å¹´ç¨…æ”¶"); }

        // AI æ“´å¼µ (ç°¡åŒ–)
        let ais = [...new Set(Object.values(state.provinces).map(p=>p.owner))].filter(o=>o!=='neutral'&&o!==state.player);
        ais.forEach(ai => {
            Object.values(state.provinces).filter(p=>p.owner===ai).forEach(p => {
                p.troops += 200; 
                if(p.troops > 4000 && Math.random() < 0.2) {
                    let targets = getNeighbors(p.id).filter(n => state.provinces[n].owner !== ai);
                    if(targets.length > 0) {
                        let t = state.provinces[targets[0]];
                        if(t.owner !== state.player) { // AI äº’æ‰“
                            if(p.troops > t.troops * 1.2) { p.troops -= 1000; captureProv(t, ai); }
                        }
                    }
                }
            });
        });
        updateUI();
    }

    function isAdjacent(pid, owner) { return getNeighbors(pid).some(nid => state.provinces[nid].owner === owner); }
    function openManage(pid) {
        state.selectedProv = pid;
        const p = state.provinces[pid];
        document.getElementById('manage-title').innerText = `å¤ªå®ˆä»»å‘½ï¼š${p.name}`;
        const sel = document.getElementById('manage-gen-select'); sel.innerHTML = '<option value="-1">-- è§£ä»» --</option>';
        if(p.generalId !== null) {
            let g = state.generals.find(x=>x.id===p.generalId);
            let o = document.createElement('option'); o.value=g.id; o.innerText=`${g.name} (ç¾ä»»)`; o.selected=true; sel.appendChild(o);
        }
        state.generals.filter(g=>g.owner===state.player && g.status==='free').forEach(g => {
            let o = document.createElement('option'); o.value=g.id; o.innerText=`${g.name} (çµ±${g.w})`; sel.appendChild(o);
        });
        document.getElementById('manage-modal').style.display = 'flex';
    }
    function setProvinceState(type) {
        const pid = state.selectedProv, p = state.provinces[pid], gid = parseInt(document.getElementById('manage-gen-select').value);
        if(p.generalId !== null && p.generalId !== gid) { let g = state.generals.find(x=>x.id===p.generalId); g.status='free'; g.assignedTo=null; }
        if(gid !== -1) { let g = state.generals.find(x=>x.id===gid); g.status='assigned'; g.assignedTo=pid; p.generalId=gid; } else { p.generalId=null; }
        p.status = type; 
        if(type==='direct') { p.troops=0; if(p.generalId) { let g=state.generals.find(x=>x.id===p.generalId); g.status='free'; g.assignedTo=null; p.generalId=null; } }
        else if(p.troops===0) p.troops=1000;
        closeModal(); updateUI();
    }
    function closeModal() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }
    function log(t) { const b = document.getElementById('log-box'); b.innerHTML += `<div>${t}</div>`; b.scrollTop = b.scrollHeight; }

</script>
</body>
</html>
