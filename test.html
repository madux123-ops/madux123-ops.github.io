<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰åœ‹å¿—ï¼šæ¼¢æœ«éœ¸æ¥­ (ç¶²é ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #1a1815;
            --panel-bg: #2b2623;
            --text-color: #dcd6cc;
            --accent-color: #8b0000;
            --gold-color: #d4af37;
            --map-bg: #2f353b;
        }
        body {
            font-family: "PMingLiU", "KaiTi", serif; /* æ”¹ç”¨æ¥·é«”æ›´å…·å¤é¢¨ */
            background-color: var(--bg-color);
            background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://www.transparenttextures.com/patterns/aged-paper.png');
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }
        h1 { margin: 6px 0; font-size: 1.4rem; text-shadow: 2px 2px 2px #000; letter-spacing: 4px; color: var(--gold-color); font-weight: bold; }

        /* éŠæˆ²å®¹å™¨ */
        #game-container { width: 100%; max-width: 1600px; display: none; height: 96vh; }

        /* é–‹å§‹é¸å–® */
        #start-screen {
            background: var(--panel-bg);
            padding: 40px;
            border: 2px solid #5d4037;
            box-shadow: 0 0 50px rgba(0,0,0,1);
            text-align: center;
            max-width: 1200px;
            width: 95%;
            margin-top: 40px;
            overflow-y: auto;
            max-height: 90vh;
        }
        
        .clan-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px; 
            margin-top: 20px; 
        }
        
        .clan-btn {
            padding: 15px; 
            cursor: pointer; 
            color: #ddd; 
            border: 1px solid #444; 
            transition: 0.2s;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            background: #3e3832;
            min-height: 80px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            position: relative;
        }
        .clan-btn:hover { transform: translateY(-3px); border-color: var(--gold-color); filter: brightness(1.2); z-index: 10; }
        .clan-btn strong { font-size: 1.2rem; margin-bottom: 4px; font-family: "KaiTi"; }
        
        .tier-badge {
            position: absolute; top: 0; left: 0;
            font-size: 0.7rem; padding: 2px 6px; 
            background: rgba(0,0,0,0.6); border-bottom-right-radius: 4px;
            color: var(--gold-color);
        }

        /* ä¸Šæ–¹è³‡è¨Šåˆ— */
        .top-bar {
            display: flex; gap: 15px; background: #201c1a; padding: 6px 20px;
            border-bottom: 2px solid #5d4037; border-top: 2px solid #5d4037;
            justify-content: space-between; align-items: center;
            font-size: 0.9rem;
        }
        .stat-box { text-align: center; min-width: 60px; }
        .stat-label { font-size: 0.7rem; color: #a1887f; display: block; }
        .stat-val { font-size: 1rem; font-weight: bold; color: var(--gold-color); font-family: "Georgia"; }
        .ap-box { background: var(--accent-color); padding: 4px 12px; border-radius: 2px; font-weight: bold; color: white; border: 1px solid #ff5252; }
        .wounded-box { color: #ef9a9a; font-size: 0.8rem; }

        /* ä¸»éŠæˆ²å€ */
        .main-content { display: grid; grid-template-columns: 1fr 300px; gap: 0; height: 100%; }
        
        /* åœ°åœ–å€åŸŸ */
        .map-frame {
            background-color: var(--map-bg);
            /* æ¨¡æ“¬ä¸­åœ‹åœ°åœ–åœ°å½¢çš„åº•åœ– */
            background-image: radial-gradient(circle at 30% 60%, #3a3f44 0%, var(--map-bg) 60%);
            border-right: 2px solid #3e3832;
            position: relative;
            overflow: auto;
            cursor: grab;
        }
        .map-grid {
            display: grid;
            /* èª¿æ•´ç‚ºé©åˆä¸­åœ‹åœ°åœ–çš„æ¯”ä¾‹ */
            grid-template-columns: repeat(40, minmax(32px, 1fr));
            grid-template-rows: repeat(35, minmax(32px, 1fr));
            gap: 4px;
            padding: 40px;
            width: 1400px; /* å¯¬åº¦ */
            height: 1200px;
        }
        .province {
            border: 1px solid rgba(255,255,255,0.15);
            background: #4a4a4a;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; transition: 0.15s; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            color: #ccc;
            border-radius: 2px;
        }
        .province:hover { border-color: #ffd700; z-index: 100; transform: scale(1.25); box-shadow: 0 0 15px #000;}
        .prov-name { font-weight: bold; font-family: "KaiTi"; font-size: 0.9rem; text-shadow: 1px 1px 2px #000; pointer-events: none; white-space: nowrap; margin-bottom: 2px;}
        .prov-info { font-size: 0.7rem; pointer-events: none; color: #fff; text-shadow: 1px 1px 1px #000; font-family: "Arial";}
        .pop-info { font-size: 0.6rem; color: #b0bec5; pointer-events: none; display:none; } /* ç°¡åŒ–é¡¯ç¤º */
        .province:hover .pop-info { display: block; position:absolute; bottom:-15px; background:#000; padding:2px; z-index:101; white-space:nowrap;}

        /* ç‹€æ…‹é‚Šæ¡† */
        .status-direct { border: 2px solid #fff; box-shadow: inset 0 0 5px #fff; }
        .status-auto { border: 2px solid #66bb6a; border-style: double; }
        .status-ally { border: 2px dashed #42a5f5; opacity: 0.9; }

        /* çµ±è¨ˆé¢æ¿ */
        .stats-overlay {
            position: absolute; top: 10px; left: 10px;
            background: rgba(30, 25, 20, 0.95);
            border: 1px solid #8d6e63;
            padding: 8px;
            width: 180px; 
            max-height: 400px; overflow-y: auto;
            z-index: 1000;
            font-size: 0.75rem; 
            color: #ddd;
            box-shadow: 3px 3px 8px rgba(0,0,0,0.7);
        }
        .stats-table { border-collapse: collapse; width: 100%; }
        .stats-table th { color: #d7ccc8; border-bottom: 1px solid #5d4037; padding-bottom:4px;}
        .stats-table td { padding: 3px; text-align: right; border-bottom: 1px solid #3e3832; }
        .stats-table td:nth-child(2) { text-align: left; font-weight: bold;} 

        /* ä¸‰åœ‹å‹¢åŠ›é¡è‰² */
        .c-wei { background: #0d47a1; color: #fff; } /* é­è— */
        .c-shu { background: #1b5e20; color: #fff; } /* èœ€ç¶  */
        .c-wu { background: #b71c1c; color: #fff; }  /* å³ç´… */
        .c-yuan { background: #fbc02d; color: #000; } /* è¢ç´¹é‡‘ */
        .c-dong { background: #4a148c; color: #fff; } /* è‘£å“ç´« */
        .c-lu { background: #212121; border: 1px solid #ff5252; } /* å‘‚å¸ƒé»‘ */
        .c-ma { background: #006064; } /* é¦¬é¨°é’ */
        .c-liu_biao { background: #5d4037; } /* åŠ‰è¡¨æ£• */
        .c-liu_zhang { background: #827717; } /* åŠ‰ç’‹æ©„æ¬– */
        .c-gongsun { background: #e65100; } /* å…¬å­«ç“šæ©˜ */
        .c-yuan_shu { background: #f06292; color:#000; } /* è¢è¡“ç²‰ */
        .c-neutral { background: #546e7a; opacity: 0.6; }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { background: var(--panel-bg); padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.5); z-index: 50; }
        .panel-block { background: #352e2a; padding: 10px; border: 1px solid #5d4037; margin-bottom: 5px; }
        .panel-header { color: var(--gold-color); font-size: 0.9rem; border-bottom: 1px solid #5d4037; margin-bottom: 8px; padding-bottom: 4px; display:flex; justify-content:space-between; font-family: "KaiTi"; font-weight:bold;}
        
        button { 
            width: 100%; padding: 10px; margin-bottom: 6px; cursor: pointer; 
            background: #4e443e; color: #e0e0e0; border: 1px solid #6d5e56; 
            text-align: left; transition: 0.2s; font-size: 0.9rem; font-family: "PMingLiU";
        }
        button:hover { background: #6d5e56; border-color: #a1887f; color:#fff; }
        .btn-bonus { font-size: 0.7rem; color: #bbb; float: right; margin-top: 2px;}

        select { width: 100%; padding: 8px; background: #26211e; color: #e0e0e0; border: 1px solid #5d4037; margin-bottom: 8px; outline: none; font-size: 0.9rem;}
        
        .btn-wait { background: #212121; color: #cfd8dc; border: 1px solid #455a64; text-align: center; height: 45px; margin-top: auto; font-size: 1rem;}
        .btn-wait:hover { background: #37474f; border-color: #607d8b; color:#fff;}
        
        #log-box { height: 200px; background: #111; border: 1px solid #5d4037; padding: 8px; font-size: 0.8rem; overflow-y: auto; font-family: 'Consolas', monospace; line-height: 1.5; color: #ccc; }
        .log-bad { color: #ff5252; } .log-good { color: #9ccc65; } .log-sys { color: #4fc3f7; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center; }
        .modal-box { background: #2d2d2d; padding: 30px; width: 450px; border: 2px solid var(--gold-color); text-align: center; box-shadow: 0 0 30px #000; position:relative; }
        .manage-grid { display: flex; gap: 15px; margin-top: 20px; }
        .manage-card { flex: 1; padding: 15px; border: 1px solid #666; cursor: pointer; background: #333; transition:0.2s; }
        .manage-card:hover { background: #444; border-color: var(--gold-color); transform: scale(1.05); }
        .close-btn { background: #444; border: 1px solid #666; margin-top: 20px; padding: 8px 25px; cursor: pointer; color:#fff; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>ä¸‰åœ‹å¿—ï¼šæ¼¢æœ«éœ¸æ¥­</h1>
        <p style="color:#a1887f; font-size:1rem; margin-bottom:20px; font-family:'KaiTi';">
            è’¼å¤©å·²æ­»ï¼Œé»ƒå¤©ç•¶ç«‹ã€‚æ­²åœ¨ç”²å­ï¼Œå¤©ä¸‹å¤§å‰ã€‚<br>
            å…¬å…ƒ190å¹´ - åè‘£å“è¯ç›Ÿ
        </p>
        <div style="margin-bottom: 20px;">
            <label style="color:#ddd;">éŠæˆ²é›£åº¦ï¼š</label>
            <select id="difficulty" style="width: auto; display:inline-block; padding: 5px;">
                <option value="1">åˆç´š (è³‡æºè±æ²›)</option>
                <option value="2" selected>ä¸­ç´š (ç¾¤é›„ä¸¦èµ·)</option>
                <option value="3">ä¸Šç´š (ä¿®ç¾…ä¹‹é“)</option>
            </select>
        </div>
        <div class="clan-grid" id="clan-select-area"></div>
    </div>

    <div id="game-container">
        <div class="top-bar">
            <div class="stat-box"><span class="stat-label">æ™‚é–“</span><div class="stat-val" id="d-year">190å¹´ æ˜¥</div></div>
            <div class="stat-box"><span class="stat-label">è³‡é‡‘</span><div class="stat-val" id="d-gold">0</div></div>
            <div class="stat-box"><span class="stat-label">è»ç³§</span><div class="stat-val" id="d-food">0</div></div>
            <div class="stat-box"><span class="stat-label">ç¸½å…µåŠ›/å‚·</span><div class="stat-val"><span id="d-troops">0</span><span class="wounded-box">+(<span id="d-wounded">0</span>)</span></div></div>
            <div class="stat-box"><span class="stat-label">åŸæ± </span><div class="stat-val" id="d-lands">0</div></div>
            <div class="ap-box">æ”¿ä»¤: <span id="d-ap">3</span></div>
        </div>

        <div class="main-content">
            <div class="map-frame">
                <div id="stats-box" class="stats-overlay"></div>
                <div class="map-grid" id="map-grid"></div>
            </div>

            <div class="control-panel">
                <div class="panel-block">
                    <div class="panel-header">
                        å…§æ”¿ (å•†Lv:<span id="lvl-com" style="color:#fff">1</span> è¾²Lv:<span id="lvl-agr" style="color:#fff">1</span>)
                    </div>
                    <select id="general-select"></select>
                    <button onclick="doAction('commerce')">ğŸ’° å•†æ¥­é–‹ç™¼ <span class="btn-bonus">é‡‘++ äºº+</span></button>
                    <button onclick="doAction('agriculture')">ğŸŒ¾ è¾²æ¥­é–‹å¢¾ <span class="btn-bonus">ç³§++ äºº+</span></button>
                    <button onclick="doAction('recruit')">âš”ï¸ å¾µå¬ç¾©å…µ <span class="btn-bonus">å…µ+ äºº-</span></button>
                    <button onclick="doAction('fortify')">ğŸ”¨ ä¿®ç¯‰åŸé˜² <span class="btn-bonus">é˜²+</span></button>
                </div>

                <div class="panel-block">
                    <div class="panel-header">å¤–äº¤èˆ‡è»äº‹</div>
                    <select id="diplo-select"></select>
                    <button onclick="doDiplomacy()">ğŸ“œ ç· çµåŒç›Ÿ (é‡‘-800)</button>
                </div>

                <button class="btn-wait" onclick="endTurn()">ğŸŒ™ çµæŸæœ¬æœˆ</button>
                <div id="log-box"></div>
            </div>
        </div>
    </div>

    <div id="manage-modal" class="modal">
        <div class="modal-box">
            <h3 id="manage-title" style="color:var(--gold-color); margin-top:0; font-family:'KaiTi'; font-size:1.5rem;">å¤ªå®ˆä»»å‘½</h3>
            <p style="font-size:0.9rem; color:#aaa; margin-bottom:20px;">å§”ä»»å¤ªå®ˆå°‡è‡ªå‹•é€²è¡Œå…§æ”¿ç™¼å±•èˆ‡é‚Šå¢ƒé˜²ç¦¦ã€‚</p>
            
            <label style="display:block; text-align:left; font-size:0.9rem; color:#888; margin-bottom:5px;">é¸æ“‡å¤ªå®ˆ:</label>
            <select id="manage-gen-select" style="margin-bottom:20px;"></select>
            
            <div class="manage-grid">
                <div class="manage-card" onclick="setProvinceState('direct')">
                    <strong style="color:#ef5350; font-size:1.2rem;">â˜… ç›´è½„</strong><br>
                    <span style="font-size:0.8rem; color:#bbb;">å›ä¸»è¦ªè‡ªæŒ‡æ®<br>å…µåŠ›æ­¸ä¸­å¤®èª¿åº¦</span>
                </div>
                <div class="manage-card" onclick="setProvinceState('auto')">
                    <strong style="color:#66bb6a; font-size:1.2rem;">â™» å§”ä»»</strong><br>
                    <span style="font-size:0.8rem; color:#bbb;">å¤ªå®ˆè‡ªä¸»ç™¼å±•<br>å…µåŠ›ç¨ç«‹è¨ˆç®—</span>
                </div>
            </div>
            <button class="close-btn" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div id="end-modal" class="modal">
        <div class="modal-box" style="border-color:#fff;">
            <h2 id="end-title" style="color: var(--gold-color); font-size:2rem; font-family:'KaiTi';"></h2>
            <p id="end-msg" style="font-size:1.2rem; margin:20px 0;"></p>
            <button class="close-btn" onclick="location.reload()">é‡è¿”äº‚ä¸–</button>
        </div>
    </div>

<script>
    // --- éŠæˆ²æ•¸æ“š ---

    // æ¨¡æ“¬ä¸­åœ‹åœ°åœ–çš„ç°¡æ˜“åº§æ¨™ç³»çµ± (40x35 Grid)
    // æ±åŒ—-è¯åŒ—-ä¸­åŸ-è¥¿åŒ—-å·´èœ€-èŠå·-æ±Ÿæ±-å—ä¸­
    const PROVINCES_DATA = [
        // æ±åŒ— (å¹½å·)
        {id:1,n:"è¥„å¹³",r:3,c:32}, {id:2,n:"åŒ—å¹³",r:4,c:29}, {id:3,n:"è–Š",r:5,c:28},
        
        // è¯åŒ— (å†€å·ã€å¹¶å·)
        {id:4,n:"å—çš®",r:7,c:28}, {id:5,n:"é„´",r:9,c:27}, {id:6,n:"æ™‰é™½",r:7,c:25}, {id:7,n:"å¹³åŸ",r:9,c:29},
        
        // ä¸­åŸ (å¸éš¸ã€å…—å·ã€è±«å·ã€é’å·ã€å¾å·)
        {id:8,n:"åŒ—æµ·",r:9,c:32}, {id:9,n:"æ¿®é™½",r:11,c:28}, {id:10,n:"é™³ç•™",r:12,c:27},
        {id:11,n:"æ´›é™½",r:12,c:24}, {id:12,n:"è¨±æ˜Œ",r:14,c:26}, {id:13,n:"æ±å—",r:16,c:27},
        {id:14,n:"ä¸‹é‚³",r:13,c:31}, {id:15,n:"å°æ²›",r:12,c:30}, {id:16,n:"å»£é™µ",r:15,c:33},
        {id:17,n:"å£½æ˜¥",r:16,c:30}, {id:18,n:"å®›",r:15,c:24},
        
        // è¥¿åŒ— (æ¶¼å·ã€é›å·)
        {id:19,n:"é•·å®‰",r:13,c:21}, {id:20,n:"å¤©æ°´",r:11,c:17}, {id:21,n:"å®‰å®š",r:10,c:19},
        {id:22,n:"æ­¦å¨",r:8,c:14}, {id:23,n:"è¥¿å¹³",r:9,c:12},
        
        // å·´èœ€ (ç›Šå·ã€æ¼¢ä¸­)
        {id:24,n:"æ¼¢ä¸­",r:15,c:19}, {id:25,n:"æ¢“æ½¼",r:17,c:17}, {id:26,n:"æˆéƒ½",r:19,c:16},
        {id:27,n:"æ±Ÿå·",r:20,c:19}, {id:28,n:"å»ºå¯§",r:26,c:15}, {id:29,n:"é›²å—",r:28,c:13},
        {id:30,n:"æ°¸å®‰",r:19,c:21},

        // èŠå·
        {id:31,n:"ä¸Šåº¸",r:14,c:22}, {id:32,n:"è¥„é™½",r:16,c:23}, {id:33,n:"æ±Ÿå¤",r:18,c:26},
        {id:34,n:"æ±Ÿé™µ",r:19,c:23}, {id:35,n:"é•·æ²™",r:22,c:25}, {id:36,n:"æ­¦é™µ",r:21,c:22},
        {id:37,n:"é›¶é™µ",r:25,c:23}, {id:38,n:"æ¡‚é™½",r:25,c:26},

        // æ±Ÿæ± (æšå·)
        {id:39,n:"å»¬æ±Ÿ",r:18,c:29}, {id:40,n:"å»ºæ¥­",r:17,c:32}, {id:41,n:"å³",r:18,c:34},
        {id:42,n:"æœƒç¨½",r:20,c:35}, {id:43,n:"æŸ´æ¡‘",r:21,c:28}, {id:44,n:"è±«ç« ",r:23,c:29},
        
        // äº¤å·
        {id:45,n:"å—æµ·",r:28,c:27}, {id:46,n:"äº¤è¶¾",r:30,c:24}
    ];

    const CLANS = {
        wei: { n: 'æ›¹æ“', full: 'æ›¹å­Ÿå¾·', c: 'c-wei', t: 1, startProvs: [10, 12] }, // é™³ç•™, è¨±æ˜Œ
        shu: { n: 'åŠ‰å‚™', full: 'åŠ‰ç„å¾·', c: 'c-shu', t: 1, startProvs: [7] }, // å¹³åŸ
        wu: { n: 'å­«å …', full: 'å­«æ–‡å°', c: 'c-wu', t: 1, startProvs: [35] }, // é•·æ²™
        yuan: { n: 'è¢ç´¹', full: 'è¢æœ¬åˆ', c: 'c-yuan', t: 1, startProvs: [4, 5, 2] }, // å—çš®, é„´, åŒ—å¹³
        dong: { n: 'è‘£å“', full: 'è‘£ä»²ç©', c: 'c-dong', t: 1, startProvs: [11, 19, 21] }, // æ´›é™½, é•·å®‰, å®‰å®š
        lu: { n: 'å‘‚å¸ƒ', full: 'å‘‚å¥‰å…ˆ', c: 'c-lu', t: 2, startProvs: [9] }, // æ¿®é™½
        ma: { n: 'é¦¬é¨°', full: 'é¦¬å£½æˆ', c: 'c-ma', t: 2, startProvs: [22, 23] }, // æ­¦å¨
        liu_biao: { n: 'åŠ‰è¡¨', full: 'åŠ‰æ™¯å‡', c: 'c-liu_biao', t: 2, startProvs: [32, 33] }, // è¥„é™½, æ±Ÿå¤
        liu_zhang: { n: 'åŠ‰ç’‹', full: 'åŠ‰å­£ç‰', c: 'c-liu_zhang', t: 2, startProvs: [26, 25] }, // æˆéƒ½
        yuan_shu: { n: 'è¢è¡“', full: 'è¢å…¬è·¯', c: 'c-yuan_shu', t: 3, startProvs: [13, 17] }, // æ±å—
        gongsun: { n: 'å…¬å­«ç“š', full: 'å…¬å­«ä¼¯åœ­', c: 'c-gongsun', t: 3, startProvs: [3] }, // è–Š
        neutral: { n: 'åœ¨é‡', full: 'åœ°æ–¹è±ªæ—', c: 'c-neutral', t: 0, startProvs: [] }
    };

    // ä¸‰åœ‹åå°‡æ•¸æ“š (çµ±ç‡ War, æ”¿æ²» Pol)
    const REAL_GENERALS = {
        wei: [
            {n:'æ›¹æ“',w:99,p:96}, {n:'å¤ä¾¯æƒ‡',w:92,p:70}, {n:'å¤ä¾¯æ·µ',w:93,p:60}, {n:'æ›¹ä»',w:89,p:75}, 
            {n:'å¼µé¼',w:95,p:78}, {n:'è¨±è¤š',w:98,p:20}, {n:'å…¸éŸ‹',w:97,p:15}, {n:'å¾æ™ƒ',w:91,p:65}, 
            {n:'å¼µéƒƒ',w:90,p:68}, {n:'éƒ­å˜‰',w:75,p:98}, {n:'è€å½§',w:60,p:99}, {n:'è€æ”¸',w:65,p:94}, 
            {n:'ç¨‹æ˜±',w:70,p:90}, {n:'å¸é¦¬æ‡¿',w:98,p:98}, {n:'é„§è‰¾',w:94,p:85}
        ],
        shu: [
            {n:'åŠ‰å‚™',w:80,p:90}, {n:'é—œç¾½',w:98,p:75}, {n:'å¼µé£›',w:99,p:30}, {n:'è¶™é›²',w:97,p:75}, 
            {n:'é¦¬è¶…',w:98,p:45}, {n:'é»ƒå¿ ',w:94,p:60}, {n:'è«¸è‘›äº®',w:95,p:100}, {n:'é¾çµ±',w:88,p:97}, 
            {n:'æ³•æ­£',w:82,p:94}, {n:'é­å»¶',w:92,p:40}, {n:'å§œç¶­',w:93,p:92}, {n:'é—œå¹³',w:85,p:65}, 
            {n:'å‘¨å€‰',w:82,p:30}, {n:'é¦¬è¬–',w:70,p:80}
        ],
        wu: [
            {n:'å­«å …',w:94,p:78}, {n:'å­«ç­–',w:96,p:70}, {n:'å­«æ¬Š',w:78,p:88}, {n:'å‘¨ç‘œ',w:97,p:96}, 
            {n:'é­¯è‚…',w:80,p:95}, {n:'å‘‚è’™',w:93,p:88}, {n:'é™¸éœ',w:96,p:95}, {n:'ç”˜å¯§',w:95,p:40}, 
            {n:'å¤ªå²æ…ˆ',w:94,p:50}, {n:'å‘¨æ³°',w:90,p:30}, {n:'é»ƒè“‹',w:86,p:65}, {n:'ç¨‹æ™®',w:85,p:75}, 
            {n:'å¼µæ˜­',w:30,p:92}, {n:'å‡Œçµ±',w:88,p:50}
        ],
        yuan: [
            {n:'è¢ç´¹',w:82,p:75}, {n:'é¡è‰¯',w:94,p:30}, {n:'æ–‡é†œ',w:95,p:25}, {n:'ç”°è±',w:70,p:92}, 
            {n:'æ²®æˆ',w:75,p:90}, {n:'å¼µéƒƒ',w:91,p:68}, {n:'é«˜è¦½',w:85,p:50}, {n:'å¯©é…',w:72,p:80},
            {n:'éƒ­åœ–',w:50,p:70}
        ],
        dong: [
            {n:'è‘£å“',w:88,p:60}, {n:'æå„’',w:60,p:94}, {n:'è¯é›„',w:92,p:20}, {n:'æå‚•',w:78,p:40}, 
            {n:'éƒ­æ±œ',w:76,p:35}, {n:'å¾æ¦®',w:82,p:65}, {n:'æ¨Šç¨ ',w:75,p:30}, {n:'å¼µæ¿Ÿ',w:72,p:50}
        ],
        lu: [
            {n:'å‘‚å¸ƒ',w:100,p:20}, {n:'é™³å®®',w:80,p:90}, {n:'å¼µé¼',w:95,p:75}, {n:'é«˜é †',w:88,p:50}, 
            {n:'å‘‚ç²ç¶º',w:85,p:40}, {n:'è‡§éœ¸',w:82,p:55}, {n:'ä¾¯æˆ',w:70,p:40}
        ],
        ma: [
            {n:'é¦¬é¨°',w:85,p:60}, {n:'é¦¬è¶…',w:98,p:45}, {n:'é¦¬å²±',w:86,p:65}, {n:'é¾å¾·',w:94,p:50}, 
            {n:'éŸ“é‚',w:80,p:75}, {n:'æˆå…¬è‹±',w:70,p:82}
        ],
        liu_biao: [
            {n:'åŠ‰è¡¨',w:65,p:80}, {n:'æ–‡è˜',w:86,p:70}, {n:'è”¡ç‘',w:75,p:72}, {n:'å¼µå…',w:70,p:65}, 
            {n:'è’¯è‰¯',w:50,p:88}, {n:'é»ƒç¥–',w:72,p:50}, {n:'ç”˜å¯§',w:94,p:40}
        ],
        liu_zhang: [
            {n:'åŠ‰ç’‹',w:40,p:65}, {n:'å¼µä»»',w:89,p:70}, {n:'åš´é¡',w:86,p:72}, {n:'é»ƒæ¬Š',w:70,p:84}, 
            {n:'ç‹å¹³',w:83,p:75}, {n:'æ³•æ­£',w:75,p:94}, {n:'å¼µæ¾',w:30,p:90}
        ],
        yuan_shu: [
            {n:'è¢è¡“',w:60,p:50}, {n:'ç´€éˆ',w:86,p:40}, {n:'é–»è±¡',w:40,p:80}, {n:'æ¥Šå¼˜',w:35,p:75}, 
            {n:'æ©‹è•¤',w:70,p:50}, {n:'å¼µå‹³',w:72,p:45}
        ],
        gongsun: [
            {n:'å…¬å­«ç“š',w:85,p:60}, {n:'è¶™é›²',w:97,p:75}, {n:'åš´ç¶±',w:75,p:50}, {n:'ç”°æ¥·',w:70,p:60}, 
            {n:'å…¬å­«è¶Š',w:72,p:50}
        ]
    };

    // --- éŠæˆ²é‚è¼¯ ---

    let state = {
        turn: 1, year: 190, season: 0,
        player: null, difficulty: 2, actions: 3,
        resources: { gold: 0, food: 0, troops: 0, wounded: 0 },
        dev: { comm: 1, agri: 1 },
        provinces: {}, generals: [], alliances: {}, selectedProv: -1
    };

    window.onload = () => {
        const area = document.getElementById('clan-select-area');
        Object.keys(CLANS).forEach(key => {
            if(key === 'neutral') return;
            let div = document.createElement('div');
            div.className = `clan-btn ${CLANS[key].c}`;
            let tierName = CLANS[key].t === 1 ? "ç¾¤é›„" : (CLANS[key].t === 2 ? "è«¸ä¾¯" : "å‰²æ“š");
            div.innerHTML = `
                <span class="tier-badge">${tierName}</span>
                <strong>${CLANS[key].n}</strong>
                <small>${CLANS[key].full}</small>
            `;
            div.onclick = () => startGame(key);
            area.appendChild(div);
        });
    };

    function startGame(clanKey) {
        state.player = clanKey;
        state.difficulty = parseInt(document.getElementById('difficulty').value);
        state.year = 190; state.season = 0; state.actions = 3; state.generals = []; state.alliances = {};
        state.dev = { comm: 1, agri: 1 };

        // é›£åº¦è³‡æºèª¿æ•´
        let baseRes = 2000;
        if(state.difficulty === 1) baseRes = 4000;
        if(state.difficulty === 3) baseRes = 1000;
        
        state.resources = { gold: baseRes, food: baseRes, troops: 5000, wounded: 0 };

        // åˆå§‹åŒ–æ­¦å°‡
        let gid = 0;
        Object.keys(CLANS).forEach(k => {
            if(k === 'neutral') return;
            let gens = REAL_GENERALS[k] || [];
            gens.forEach(g => {
                state.generals.push({ id: gid++, name: g.n, w: g.w, p: g.p, owner: k, status: 'free', assignedTo: null });
            });
        });

        initMap();
        updateUI();
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        log(`ã€æ¼¢æœ«éœ¸æ¥­ã€‘é–‹å§‹ã€‚æ‚¨æ‰®æ¼” ${CLANS[clanKey].full}ã€‚`);
    }

    function initMap() {
        const grid = document.getElementById('map-grid');
        state.provinces = {};

        PROVINCES_DATA.forEach(p => {
            // äººå£è¨­å®š (ä¸­åŸèˆ‡å¤§åŸäººå£è¼ƒå¤š)
            let basePop = 20000 + Math.floor(Math.random()*15000);
            if ([11, 12, 5, 26, 32, 40, 19].includes(p.id)) basePop += 15000;

            state.provinces[p.id] = { 
                id: p.id, name: p.n, owner: 'neutral', 
                troops: 1500 + Math.floor(Math.random()*1000), 
                status: 'direct', generalId: null, defense: 100, wounded: 0,
                pop: basePop
            };
        });

        Object.keys(CLANS).forEach(k => {
            if(k === 'neutral') return;
            CLANS[k].startProvs.forEach(pid => {
                if(state.provinces[pid]) {
                    state.provinces[pid].owner = k;
                    // ç©å®¶åˆå§‹å…µåŠ›ç‚º0(ç”±ä¸­å¤®èª¿åº¦)ï¼ŒAIåˆå§‹æœ‰å®ˆè»
                    state.provinces[pid].troops = (k === state.player) ? 0 : (3000 + CLANS[k].t * 1000);
                }
            });
        });

        PROVINCES_DATA.forEach(p => {
            let div = document.createElement('div');
            let owner = state.provinces[p.id].owner;
            div.className = `province ${CLANS[owner].c}`;
            div.style.gridRow = p.r; div.style.gridColumn = p.c;
            div.id = `prov-${p.id}`; div.onclick = () => clickProvince(p.id);
            div.innerHTML = `
                <div class="prov-name">${p.n}</div>
                <div class="prov-info" id="info-${p.id}"></div>
                <div class="pop-info" id="pop-${p.id}">ğŸ‘¥${Math.floor(state.provinces[p.id].pop/1000)}k</div>
            `;
            grid.appendChild(div);
        });
    }

    function getNeighbors(pid) {
        let p1 = PROVINCES_DATA.find(x => x.id === pid);
        let list = [];
        PROVINCES_DATA.forEach(p2 => {
            if(p1.id !== p2.id) {
                let dr = Math.abs(p1.r - p2.r);
                let dc = Math.abs(p1.c - p2.c);
                // æ“´å¤§ä¸€é»ç›¸é„°åˆ¤å®šï¼Œå› ç‚ºä¸­åœ‹åœ°åœ–è¼ƒå¤§
                if (dr <= 2 && dc <= 2 && (dr+dc <= 3)) list.push(p2.id);
            }
        });
        return list;
    }

    function doAction(type) {
        if(state.actions <= 0) return alert("æ”¿ä»¤æ¬¡æ•¸å·²è€—ç›¡");
        const sel = document.getElementById('general-select');
        if(!sel.value) return alert("ç„¡å¯ç”¨æ­¦å°‡");
        const gen = state.generals.find(g => g.id == sel.value);
        
        let directs = Object.values(state.provinces).filter(p => p.owner === state.player && p.status === 'direct');
        let landCount = directs.length;
        if(landCount === 0 && type !== 'fortify') return alert("ç„¡ç›´è½„é ˜åœ°");

        let landBonus = 1 + (landCount * 0.05); 
        let pMod = (1 + gen.p/100) * landBonus;
        let wMod = (1 + gen.w/100) * landBonus;
        let msg = "";

        if(type === 'commerce') {
            if(state.resources.food < 100) return alert("è»ç³§ä¸è¶³ï¼Œç„¡æ³•è³‘æ¿Ÿ");
            state.resources.food -= 100; 
            let val = Math.floor(300 * pMod * (1 + state.dev.comm * 0.25));
            state.resources.gold += val;
            state.dev.comm++;
            
            let popGain = Math.floor(400 * pMod);
            directs.forEach(p => p.pop += popGain);

            msg = `${gen.name} åŸ·è¡Œå•†æ¥­é–‹ç™¼ï¼Œç²é‡‘${val}ï¼Œäººå£å¢é•·ã€‚`;
        } 
        else if (type === 'agriculture') {
            if(state.resources.gold < 100) return alert("è³‡é‡‘ä¸è¶³ï¼Œç„¡æ³•è³¼è²·è¾²å…·");
            state.resources.gold -= 100; 
            let val = Math.floor(300 * pMod * (1 + state.dev.agri * 0.25));
            state.resources.food += val;
            state.dev.agri++;
            
            let popGain = Math.floor(200 * pMod);
            directs.forEach(p => p.pop += popGain);
            
            msg = `${gen.name} åŸ·è¡Œè¾²æ¥­é–‹å¢¾ï¼Œç²ç³§${val}ï¼Œäººå£å¢é•·ã€‚`;
        } 
        else if (type === 'recruit') {
            if(state.resources.gold < 200 || state.resources.food < 200) return alert("è³‡é‡‘æˆ–è»ç³§ä¸è¶³");
            
            let totalAvail = 0;
            directs.forEach(p => { if(p.pop > 8000) totalAvail += (p.pop - 8000); });
            
            if(totalAvail < 500) return alert("ç›´è½„åœ°äººå£æ¯ç«­ï¼ç„¡æ³•å¾µå…µ");

            state.resources.gold -= 200; 
            state.resources.food -= 200; 
            
            let val = Math.floor(500 * wMod);
            val = Math.min(val, totalAvail); 
            
            let deduct = Math.ceil(val / directs.length);
            directs.forEach(p => {
                if(p.pop > 8000) p.pop = Math.max(8000, p.pop - deduct);
            });

            state.resources.troops += val;
            msg = `${gen.name} å¾µå¬ç¾©å…µ ${val} äººï¼Œé ˜åœ°äººå£æ¸›å°‘ã€‚`;
        } 
        else if (type === 'fortify') {
            if(directs.length === 0) return alert("ç„¡ç›´è½„é ˜åœ°");
            if(state.resources.gold < 150) return alert("è³‡é‡‘ä¸è¶³");
            state.resources.gold -= 150;
            let target = directs[Math.floor(Math.random() * directs.length)];
            target.defense = Math.min(400, target.defense + 30);
            msg = `${gen.name} ä¿®ç¯‰ ${target.name} åŸé˜²ï¼Œé˜²ç¦¦+30`;
        }
        state.actions--; log(msg); updateUI();
    }

    function doDiplomacy() {
        if(state.actions <= 0) return alert("æ”¿ä»¤æ¬¡æ•¸è€—ç›¡");
        const target = document.getElementById('diplo-select').value;
        if(!target) return;
        if(state.resources.gold < 800) return alert("è²¢é‡‘ä¸è¶³ (éœ€800)");
        state.resources.gold -= 800; state.actions--;
        
        let successRate = 0.4;
        if(CLANS[target].t < CLANS[state.player].t) successRate += 0.2; // å°åœ‹æ˜“çµç›Ÿ

        if(Math.random() < successRate) {
            state.alliances[target] = 12; log(`<span class="log-good">ä½¿è€…å›å ±ï¼šèˆ‡ ${CLANS[target].n} çµç›ŸæˆåŠŸï¼</span>`);
        } else {
            log(`<span class="log-bad">${CLANS[target].n} æ”¶ä¸‹äº†è²¢é‡‘ï¼Œä½†æ‹’çµ•äº†çµç›Ÿè«‹æ±‚ã€‚</span>`);
        }
        updateUI();
    }

    function clickProvince(pid) {
        const p = state.provinces[pid];
        if(p.owner === state.player) { openManage(pid); return; }
        if(state.alliances[p.owner] > 0) { alert("åŒç›Ÿä¸­ï¼Œä¸å¯æ”»æ“Š"); return; }
        if(state.actions <= 0) { alert("æ”¿ä»¤æ¬¡æ•¸è€—ç›¡"); return; }
        if(!isAdjacent(pid, state.player)) { alert("ç›®æ¨™ä¸èˆ‡æˆ‘æ–¹é ˜åœŸç›¸é„°"); return; }
        if(state.resources.food < 300 || state.resources.troops < 1000) return alert("è»è³‡ä¸è¶³ï¼Œç„¡æ³•å‡ºå¾");
        
        if(confirm(`å‡ºå…µæ”»æ‰“ ${p.name} (é˜²ç¦¦${p.defense})?`)) {
            state.actions--; state.resources.gold -= 100; state.resources.food -= 300;
            const sel = document.getElementById('general-select');
            const gen = state.generals.find(g=>g.id==sel.value) || {name:'å‰¯å°‡', w:70};
            battle(state.player, p, state.resources.troops, gen.w, true);
        }
    }

    function battle(atkOwner, defProv, atkTroops, atkWar, isPlayerMain) {
        let defTroops = defProv.troops;
        if(defProv.owner === state.player && defProv.status === 'direct') defTroops = state.resources.troops;
        
        // é˜²ç¦¦ä¿‚æ•¸ï¼šåŸé˜²è¶Šé«˜ï¼Œå‚·å®³æ¸›å…è¶Šé«˜
        let defFactor = 120 / Math.max(50, defProv.defense);
        // éš¨æ©Ÿæ³¢å‹•
        let atkPwr = atkTroops * (atkWar/100) * (0.9 + Math.random()*0.3);
        let defPwr = defTroops * (0.9 + Math.random()*0.3);
        
        // éä¸­ç«‹å‹¢åŠ›æœ‰é˜²å®ˆåŠ æˆ
        if(defProv.owner !== 'neutral') defPwr *= 1.3;

        const win = atkPwr > defPwr;
        const loser = defProv.owner;
        
        // æˆ°æè¨ˆç®—
        let atkLossBase = win ? (defTroops * 0.4) : (atkTroops * 0.5);
        let defLossBase = win ? (defTroops * 0.95) : (atkTroops * 0.3);
        
        let atkLossReal = Math.floor(atkLossBase * (defProv.defense / 100));
        let defLossReal = Math.floor(defLossBase * defFactor);
        
        if(isPlayerMain) {
            state.resources.troops = Math.max(0, state.resources.troops - atkLossReal);
            let wounded = Math.floor(atkLossReal * 0.5); // 50%å‚·å…µç‡
            state.resources.wounded += wounded;
            
            if(win) {
                captureProv(defProv, atkOwner);
                log(`<span class="log-good">æ·å ±ï¼æ”»é™· ${defProv.name}ï¼æ”¶å®¹å‚·å…µ ${wounded} äººã€‚</span>`);
            } else {
                defProv.troops = Math.max(0, defProv.troops - defLossReal);
                log(`<span class="log-bad">æ”»åŸå¤±æ•—ï¼Œæˆ‘è»æ•—é€€ï¼Œæå¤±å…µé¦¬ ${atkLossReal}ã€‚</span>`);
            }
        } else {
            // AI vs AI æˆ– AI vs ç©å®¶å§”ä»»
            if(win) {
                captureProv(defProv, atkOwner);
                defProv.troops = Math.max(1000, atkTroops - atkLossReal);
                if(atkOwner === state.player) log(`<span class="log-good">å§”ä»»è»åœ˜æ”»ä¸‹ ${defProv.name}ã€‚</span>`);
                else if(loser === state.player) log(`<span class="log-bad">æ€¥å ±ï¼æˆ‘æ–¹ ${defProv.name} è¢« ${CLANS[atkOwner].n} æ”»é™·ï¼</span>`);
            }
            return win;
        }
        if(win && loser !== 'neutral') checkDestruction(loser, atkOwner);
        updateUI();
    }

    function captureProv(p, newOwner) {
        // ä¿˜è™œåˆ¤å®š
        if(p.generalId !== null) {
            let gen = state.generals.find(g=>g.id===p.generalId);
            if(Math.random() < 0.3) { 
                gen.owner = newOwner; gen.status = 'free'; gen.assignedTo = null; 
                if(newOwner === state.player) log(`<span class="log-sys">${gen.name} é¡˜é™ï¼åŠ å…¥æˆ‘è»ã€‚</span>`); 
            } else { 
                gen.status = 'free'; gen.assignedTo = null; 
                // æœªåŠ å…¥å‰‡æµæ”¾(æ­¤è™•ç°¡åŒ–ç‚ºä¸è®Šæ›´æ­¸å±¬ä½†ç§»é™¤è·ä½)
            }
        }
        p.owner = newOwner; 
        p.status = (newOwner === state.player) ? 'direct' : 'auto'; 
        p.generalId = null; 
        p.troops = 0;
        p.defense = Math.max(50, p.defense - 40); // åŸé˜²å—æ
        p.wounded = 0;
    }

    function checkDestruction(loser, winner) {
        if(Object.values(state.provinces).filter(p=>p.owner===loser).length === 0) {
            log(`ã€${CLANS[loser].n}ã€‘å‹¢åŠ›æ»…äº¡ã€‚`);
            // æ¥æ”¶æ­¦å°‡
            state.generals.forEach(g => { 
                if(g.owner === loser) { 
                    g.owner = winner; g.status='free'; g.assignedTo=null; 
                } 
            });
            if(loser === state.player) {
                document.getElementById('end-title').innerText = "éœ¸æ¥­æœªæˆ";
                document.getElementById('end-msg').innerText = "æ‚¨çš„å‹¢åŠ›å·²æ»…äº¡ï¼Œè«‹é‡æ–°ä¾†éã€‚";
                document.getElementById('end-modal').style.display = 'flex';
            }
        }
    }

    function updateStats() {
        const box = document.getElementById('stats-box');
        let html = `<table class="stats-table">
            <tr><th style="width:10px">è‰²</th><th>å‹¢åŠ›</th><th>åŸæ± </th><th>å…µåŠ›</th><th>äººå£</th></tr>`;
        
        let data = [];
        Object.keys(CLANS).forEach(k => {
            if(k === 'neutral') return;
            let provs = Object.values(state.provinces).filter(p => p.owner === k);
            let lands = provs.length;
            if(lands === 0) return; 

            let pop = provs.reduce((acc, p) => acc + p.pop, 0);
            
            let troops = 0;
            if(k === state.player) {
                troops = state.resources.troops;
                provs.forEach(p => { if(p.status === 'auto') troops += p.troops; });
            } else {
                troops = provs.reduce((acc, p) => acc + p.troops, 0);
            }

            data.push({ name: CLANS[k].n, l: lands, t: troops, p: pop, color: CLANS[k].c });
        });

        data.sort((a, b) => b.l - a.l); // æŒ‰åŸæ± æ•¸æ’åº

        data.forEach(d => {
            let style = d.name===CLANS[state.player].n ? 'color:#ffd700' : '';
            html += `<tr style="${style}">
                <td><div class="${d.color}" style="width:10px; height:10px; border:1px solid #aaa;"></div></td>
                <td>${d.name}</td>
                <td>${d.l}</td>
                <td>${Math.floor(d.t/100)/10}k</td>
                <td>${Math.floor(d.p/1000)}k</td>
            </tr>`;
        });
        html += `</table>`;
        box.innerHTML = html;
    }

    function endTurn() {
        state.actions = 3; state.season++;
        
        // å‚·å…µå›å¾©
        if(state.resources.wounded > 0) {
            let recovered = Math.ceil(state.resources.wounded * 0.3);
            state.resources.wounded -= recovered;
            state.resources.troops += recovered;
            log(`<span class="log-sys">å‚·å…µç‡Ÿå›å¾©å…µåŠ›ï¼š${recovered}ã€‚</span>`);
        }
        
        // å…µç³§æ¶ˆè€—
        let cost = Math.floor(state.resources.troops / 100 * 8);
        state.resources.food = Math.max(0, state.resources.food - cost);
        
        // äººå£è‡ªç„¶å¢é•·
        Object.values(state.provinces).forEach(p => {
            p.pop = Math.floor(p.pop * 1.008);
        });

        const seasonName = ['æ˜¥','å¤','ç§‹','å†¬'];
        if(state.season > 3) {
            state.season = 0; state.year++;
            // æ–°å¹´ç¨…æ”¶
            let taxGold = 1500 + (state.dev.comm * 150);
            let taxFood = 1500 + (state.dev.agri * 150);
            state.resources.gold += taxGold; 
            state.resources.food += taxFood;
            log(`ã€${state.year}å¹´ã€‘æ–°å¹´ç¨…æ”¶ï¼šé‡‘+${taxGold}ï¼Œç³§+${taxFood}ã€‚`);
        }

        // å§”ä»»è»åœ˜ AI
        Object.values(state.provinces).forEach(p => {
            if(p.owner === state.player && p.status === 'auto' && p.generalId) {
                let gen = state.generals.find(g=>g.id===p.generalId);
                let incomeG = Math.floor(gen.p * 0.8);
                let incomeF = Math.floor(gen.p * 0.8);
                
                // è‡ªå‹•ä¿®åŸ
                if(p.defense < 200 && Math.random() < 0.6) {
                    p.defense += 20;
                    incomeG = Math.max(0, incomeG - 60);
                }
                
                state.resources.gold += incomeG;
                state.resources.food += incomeF;
                // å§”ä»»åŸå¾µå…µ
                p.troops += Math.floor(gen.w * 0.8);
                
                if(p.troops > 3000) {
                    // å°‹æ‰¾æ”»æ“Šç›®æ¨™
                    let targets = getNeighbors(p.id).filter(nid => {
                        let t = state.provinces[nid];
                        return t.owner !== state.player && !state.alliances[t.owner];
                    });
                    if(targets.length > 0) {
                        let t = state.provinces[targets[0]];
                        let def = t.troops;
                        if(t.owner === state.player && t.status === 'direct') def = state.resources.troops;
                        
                        // å…µåŠ›å£“åˆ¶æ‰æ‰“
                        if(p.troops > def * 1.25) {
                            if(battle(state.player, t, p.troops, gen.w, false)) p.troops = 1000;
                            else p.troops = Math.floor(p.troops*0.5);
                        }
                    }
                }
            }
        });

        aiAction();
        
        // å‹åˆ©åˆ¤å®š
        if(Object.values(state.provinces).filter(p=>p.owner===state.player).length === PROVINCES_DATA.length) {
            document.getElementById('end-title').innerText = "å¤©ä¸‹ä¸€çµ±";
            document.getElementById('end-msg').innerText = `æ­·ç¶“è‰±è¾›ï¼Œ${CLANS[state.player].n} çµ‚æ–¼å¹³å®šäº‚ä¸–ï¼Œå»ºç«‹æ–°æœï¼`;
            document.getElementById('end-modal').style.display = 'flex';
        }
        updateUI();
    }

    function aiAction() {
        let ais = [...new Set(Object.values(state.provinces).map(p=>p.owner))].filter(o=>o!=='neutral' && o!==state.player);
        ais.forEach(ai => {
            // AI è³‡æºå¢é•·
            Object.values(state.provinces).filter(p=>p.owner===ai).forEach(p => {
                p.troops += 150 * state.difficulty; // AIå¾µå…µé€Ÿåº¦éš¨é›£åº¦å¢åŠ 
                if(p.defense < 300) p.defense += 8;
                p.pop = Math.floor(p.pop * 1.005);
            });
            
            // AI æ”»æ“Šé‚è¼¯
            if(Math.random() < 0.35 * state.difficulty) {
                let attackers = Object.values(state.provinces).filter(p=>p.owner===ai && p.troops > 2500);
                if(attackers.length > 0) {
                    let p = attackers[Math.floor(Math.random()*attackers.length)];
                    let neighbors = getNeighbors(p.id);
                    for(let nid of neighbors) {
                        let t = state.provinces[nid];
                        if(t.owner !== ai && !state.alliances[ai]) {
                            let def = t.troops;
                            if(t.owner === state.player && t.status === 'direct') def = state.resources.troops;
                            
                            // AI æœƒè©•ä¼°å…µåŠ›
                            if(p.troops > def * 1.1) {
                                let aiWar = 80; // å¹³å‡çµ±ç‡
                                if(battle(ai, t, p.troops, aiWar, false)) p.troops = 1200;
                                break;
                            }
                        }
                    }
                }
            }
        });
    }

    function updateUI() {
        const s = ['æ˜¥','å¤','ç§‹','å†¬'];
        document.getElementById('d-year').innerText = `${state.year}å¹´ ${s[state.season]}`;
        document.getElementById('d-gold').innerText = state.resources.gold;
        document.getElementById('d-food').innerText = state.resources.food;
        document.getElementById('d-troops').innerText = state.resources.troops;
        document.getElementById('d-wounded').innerText = state.resources.wounded;
        document.getElementById('d-ap').innerText = state.actions;
        document.getElementById('d-lands').innerText = Object.values(state.provinces).filter(p=>p.owner===state.player).length;
        document.getElementById('lvl-com').innerText = state.dev.comm;
        document.getElementById('lvl-agr').innerText = state.dev.agri;
        
        Object.values(state.provinces).forEach(p => {
            const el = document.getElementById(`prov-${p.id}`);
            el.className = `province ${CLANS[p.owner].c}`;
            el.classList.remove('status-direct','status-auto','status-ally');
            let info = p.troops;
            let defShield = `ğŸ›¡ï¸${p.defense}`;

            if(p.owner === state.player) {
                if(p.status === 'direct') { el.classList.add('status-direct'); info = `â˜… ${defShield}`; }
                else { 
                    el.classList.add('status-auto'); 
                    let gn = p.generalId ? state.generals.find(g=>g.id===p.generalId).name[0] : "ç„¡";
                    info = `â™»${gn} ${p.troops}`; 
                }
            } else if(state.alliances[p.owner]) {
                el.classList.add('status-ally');
                info = `${p.troops}`;
            } else {
                info = `${p.troops}`;
            }
            document.getElementById(`info-${p.id}`).innerText = info;
            document.getElementById(`pop-${p.id}`).innerText = `ğŸ‘¥${Math.floor(p.pop/1000)}k`;
            el.title = `${p.name} | é˜²ç¦¦: ${p.defense} | äººå£: ${p.pop}`;
        });
        
        const ms = document.getElementById('general-select'); ms.innerHTML = '';
        state.generals.filter(g=>g.owner===state.player && g.status==='free').forEach(g => {
            let o = document.createElement('option'); o.value = g.id; o.innerText = `${g.name} (çµ±${g.w} æ”¿${g.p})`; ms.appendChild(o);
        });
        const ds = document.getElementById('diplo-select'); ds.innerHTML = '';
        [...new Set(Object.values(state.provinces).map(p=>p.owner))].forEach(c => {
            if(c!==state.player && c!=='neutral' && !state.alliances[c]) {
                let o = document.createElement('option'); o.value = c; o.innerText = CLANS[c].n; ds.appendChild(o);
            }
        });

        updateStats();
    }

    function isAdjacent(pid, owner) { return getNeighbors(pid).some(nid => state.provinces[nid].owner === owner); }

    function openManage(pid) {
        state.selectedProv = pid;
        const p = state.provinces[pid];
        document.getElementById('manage-title').innerText = `æ²»ç†ï¼š${p.name}`;
        const sel = document.getElementById('manage-gen-select'); sel.innerHTML = '<option value="-1">-- è§£é™¤ä»»å‘½ --</option>';
        if(p.generalId !== null) {
            let g = state.generals.find(x=>x.id===p.generalId);
            let o = document.createElement('option'); o.value=g.id; o.innerText=`${g.name} (ç¾ä»»)`; o.selected=true; sel.appendChild(o);
        }
        state.generals.filter(g=>g.owner===state.player && g.status==='free').forEach(g => {
            let o = document.createElement('option'); o.value=g.id; o.innerText=`${g.name} (çµ±${g.w} æ”¿${g.p})`; sel.appendChild(o);
        });
        document.getElementById('manage-modal').style.display = 'flex';
    }

    function setProvinceState(type) {
        const pid = state.selectedProv, p = state.provinces[pid], gid = parseInt(document.getElementById('manage-gen-select').value);
        
        // è§£é™¤èˆŠå¤ªå®ˆ
        if(p.generalId !== null && p.generalId !== gid) { 
            let g = state.generals.find(x=>x.id===p.generalId); 
            g.status='free'; g.assignedTo=null; 
        }
        
        // ä»»å‘½æ–°å¤ªå®ˆ
        if(gid !== -1) { 
            let g = state.generals.find(x=>x.id===gid); 
            g.status='assigned'; g.assignedTo=pid; 
            p.generalId=gid; 
        } else { 
            p.generalId=null; 
        }
        
        p.status = type; 
        if(type==='direct') { 
            // ç›´è½„åŒ–ï¼šå…µåŠ›æ­¸å…¬ï¼Œè§£é™¤å¤ªå®ˆ
            p.troops=0; 
            if(p.generalId) { 
                let g=state.generals.find(x=>x.id===p.generalId); 
                g.status='free'; g.assignedTo=null; 
                p.generalId=null; 
            } 
        } else if(p.troops===0) {
            // å§”ä»»åŒ–ï¼šçµ¦äºˆåˆå§‹å…µåŠ›
            p.troops=1000;
        }
        closeModal(); updateUI();
    }
    
    function closeModal() { document.getElementById('manage-modal').style.display = 'none'; }
    function log(t) { const b = document.getElementById('log-box'); b.innerHTML += `<div>${t}</div>`; b.scrollTop = b.scrollHeight; }

</script>
</body>
</html>
