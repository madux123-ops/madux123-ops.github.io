<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿¡é•·ä¹‹é‡æœ›ï¼šå¤©ä¸‹å‰µä¸– (æˆ°é¬¥ç³»çµ±å¯¦è£ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --map-bg: #27ae60;
            --city-own: #2980b9;
            --city-enemy: #c0392b;
            --panel-bg: rgba(0, 0, 0, 0.8);
            --text-color: #ecf0f1;
            --accent: #f1c40f;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        /* å·¦å´è³‡è¨Šæ¬„ */
        #sidebar {
            width: 250px;
            background: #34495e;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #7f8c8d;
        }

        .stat-box {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }

        h2, h3 { margin: 0 0 10px 0; color: var(--accent); }
        button {
            background: var(--accent);
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            color: #000;
            font-weight: bold;
            margin-top: 5px;
            width: 100%;
        }
        button:hover { background: #f39c12; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }

        /* å³å´åœ°åœ–å€ */
        #map-container {
            flex: 1;
            position: relative;
            background: #1a1a1a;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-map {
            display: grid;
            grid-template-columns: repeat(8, 60px);
            grid-template-rows: repeat(8, 60px);
            gap: 2px;
            background: #7f8c8d;
            border: 5px solid #34495e;
        }

        .tile {
            width: 60px;
            height: 60px;
            background: var(--map-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        .tile:hover { filter: brightness(1.2); }
        
        .city {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            border: 2px solid #fff;
            z-index: 2;
        }
        
        .city.player { background-color: var(--city-own); }
        .city.enemy { background-color: var(--city-enemy); }
        
        /* ç¯„åœæŒ‡ç¤ºå™¨ */
        .tile.in-range {
            background-color: rgba(241, 196, 15, 0.3); /* é»ƒè‰²åŠé€æ˜ */
            box-shadow: inset 0 0 10px var(--accent);
        }

        /* =========================================
           æˆ°é¬¥ç³»çµ± UI (Battle System Overlay)
           ========================================= */
        #battle-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: none; /* é è¨­éš±è— */
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .battle-window {
            width: 800px;
            height: 600px;
            background: #2c3e50;
            border: 2px solid var(--accent);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 0 0 20px #000;
        }

        .battle-header {
            text-align: center;
            border-bottom: 1px solid #7f8c8d;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        /* æº–å‚™éšæ®µ */
        #prep-screen { display: flex; flex: 1; gap: 20px; }
        
        .prep-col { flex: 1; background: rgba(0,0,0,0.2); padding: 10px; overflow-y: auto; }

        .general-select-item {
            display: flex;
            justify-content: space-between;
            background: #34495e;
            margin-bottom: 5px;
            padding: 5px;
            cursor: pointer;
        }
        .general-select-item.selected { border-left: 4px solid var(--accent); background: #465f75; }
        .gen-stats { font-size: 0.8em; color: #bdc3c7; }

        /* æˆ°é¬¥éšæ®µ */
        #combat-screen { display: none; flex: 1; flex-direction: column; }
        
        #turn-order-bar {
            height: 50px;
            background: #000;
            display: flex;
            align-items: center;
            padding: 0 10px;
            overflow-x: auto;
            border-bottom: 1px solid #555;
        }
        .order-unit {
            background: #2980b9;
            padding: 5px 10px;
            margin-right: 5px;
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
        }
        .order-unit.enemy { background: #c0392b; }

        #battle-visuals {
            flex: 1;
            display: flex;
            justify-content: space-between;
            padding: 20px;
            background: linear-gradient(to bottom, #2c3e50, #1a1a1a);
        }
        
        .army-box { width: 45%; text-align: center; }
        .hp-bar-container { background: #555; height: 15px; border-radius: 10px; margin: 5px 0; overflow: hidden;}
        .hp-bar { height: 100%; transition: width 0.5s; }
        
        #battle-log {
            height: 150px;
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 10px;
            overflow-y: auto;
            border-top: 1px solid #555;
            font-size: 14px;
        }

        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; }
        .log-dmg { color: #e74c3c; font-weight: bold; }
        .log-kill { color: var(--accent); }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>å¤©ä¸‹å‰µä¸–</h2>
        <div class="stat-box">
            <h3>æœ¬å®¶æƒ…å ±</h3>
            <p>å¤§åï¼š<span id="daimyo-name">ç¹”ç”°ä¿¡é•·</span></p>
            <p>é‡‘éŒ¢ï¼š<span id="res-gold">1000</span></p>
            <p>å…µç³§ï¼š<span id="res-rice">2000</span></p>
            <p>ç•¶å‰å­£ç¯€ï¼š<span id="game-season">æ˜¥</span></p>
        </div>
        <div id="city-info" class="stat-box" style="display:none;">
            <h3>æ“šé»æƒ…å ±</h3>
            <p id="sel-city-name">--</p>
            <p>å…µåŠ›ï¼š<span id="sel-city-troops">0</span></p>
            <p>åŸé˜²ï¼š<span id="sel-city-def">0</span></p>
            <div id="city-actions"></div>
        </div>
        <button onclick="nextTurn()">é€²è¡Œä¸‹ä¸€å›åˆ</button>
    </div>

    <div id="map-container">
        <div id="game-map"></div>
    </div>

    <div id="battle-overlay">
        <div class="battle-window">
            <div class="battle-header">
                <h2 id="battle-title">æ”»åŸæˆ°æº–å‚™</h2>
            </div>

            <div id="prep-screen">
                <div class="prep-col">
                    <h3>1. é¸æ“‡å‡ºé™£æ­¦å°‡ (æœ€å¤š8å)</h3>
                    <div id="prep-general-list">
                        </div>
                </div>
                <div class="prep-col">
                    <h3>2. å…µåŠ›å¾µèª¿ (ç¯„åœ4æ ¼å…§)</h3>
                    <p>é™„è¿‘å¯ç”¨å…µåŠ›æ± : <span id="pool-troops" style="color:var(--accent); font-size:1.2em;">0</span></p>
                    <p>é è¨ˆåˆ†é…: æ¯äºº <span id="troops-per-gen">0</span> (ä¸Šé™5000)</p>
                    <hr>
                    <p>ç¸½å‡ºé™£å…µåŠ›: <span id="total-deploy-troops">0</span> / 40000</p>
                    <div style="margin-top: 20px;">
                        <button onclick="startCombat()" id="btn-start-combat">ç¢ºèªå‡ºé™£</button>
                        <button onclick="closeBattle()" style="background:#7f8c8d;">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <div id="combat-screen">
                <div id="turn-order-bar"></div>

                <div id="battle-visuals">
                    <div class="army-box">
                        <h3 style="color:var(--city-own)">æˆ‘è» (ç¹”ç”°)</h3>
                        <div id="attacker-status"></div>
                    </div>
                    <div class="army-box">
                        <h3 style="color:var(--city-enemy)" id="defender-name">æ•µè»</h3>
                        <div class="hp-bar-container">
                            <div id="def-wall-bar" class="hp-bar" style="width: 100%; background: #95a5a6;"></div>
                        </div>
                        <small>åŸé˜²: <span id="def-wall-val">100</span></small>
                        <div class="hp-bar-container">
                            <div id="def-troops-bar" class="hp-bar" style="width: 100%; background: #c0392b;"></div>
                        </div>
                        <small>å®ˆè»: <span id="def-troops-val">1000</span></small>
                    </div>
                </div>

                <div id="battle-log"></div>
                
                <div style="text-align: right; padding: 10px;">
                    <button onclick="processBattleRound()" id="btn-next-round">åŸ·è¡Œå›åˆ</button>
                </div>
            </div>

            <div id="result-screen" style="display:none; text-align: center; padding-top: 50px;">
                <h1 id="result-title"></h1>
                <p id="result-desc"></p>
                <button onclick="closeBattle()">è¿”å›å¤§åœ°åœ–</button>
            </div>

        </div>
    </div>

    <script>
        // ==========================================
        // 1. éŠæˆ²åŸºç¤è³‡æ–™çµæ§‹ (Base Data)
        // ==========================================
        
        const MAP_SIZE = 8;
        const PLAYER_ID = 'oda';
        
        // æ¨¡æ“¬æ­¦å°‡è³‡æ–™
        const generals = [
            { id: 1, name: 'ç¹”ç”°ä¿¡é•·', lead: 99, pol: 95, war: 85, int: 90, owner: 'oda', location: 'city_0_0', status: 'free' },
            { id: 2, name: 'æŸ´ç”°å‹å®¶', lead: 88, pol: 50, war: 94, int: 40, owner: 'oda', location: 'city_0_0', status: 'delegated' }, // æ¸¬è©¦è‡ªå‹•è§£é™¤å§”ä»»
            { id: 3, name: 'ç¾½æŸ´ç§€å‰', lead: 85, pol: 92, war: 75, int: 95, owner: 'oda', location: 'city_0_0', status: 'free' },
            { id: 4, name: 'æ˜æ™ºå…‰ç§€', lead: 90, pol: 91, war: 80, int: 93, owner: 'oda', location: 'city_0_0', status: 'free' },
            { id: 5, name: 'ä¸¹ç¾½é•·ç§€', lead: 78, pol: 82, war: 70, int: 75, owner: 'oda', location: 'city_0_0', status: 'free' },
            { id: 6, name: 'å‰ç”°åˆ©å®¶', lead: 75, pol: 60, war: 85, int: 50, owner: 'oda', location: 'city_0_0', status: 'free' },
            { id: 7, name: 'ç€§å·ä¸€ç›Š', lead: 82, pol: 65, war: 80, int: 70, owner: 'oda', location: 'city_0_0', status: 'free' },
            { id: 8, name: 'ä½ä½æˆæ”¿', lead: 72, pol: 55, war: 78, int: 45, owner: 'oda', location: 'city_0_0', status: 'free' },
            { id: 9, name: 'æ£®è˜­ä¸¸',   lead: 60, pol: 60, war: 70, int: 60, owner: 'oda', location: 'city_0_0', status: 'free' },
        ];

        // æ¨¡æ“¬åŸå¸‚è³‡æ–™
        const cities = [
            { id: 'city_0_0', name: 'æ¸…æ´²åŸ', x: 0, y: 0, owner: 'oda', troops: 8000, defense: 200 }, // å¤§æœ¬ç‡Ÿ
            { id: 'city_1_0', name: 'é‚£å¤é‡', x: 1, y: 0, owner: 'oda', troops: 3000, defense: 100 }, // æ”¯æ´åŸ1
            { id: 'city_0_1', name: 'çŠ¬å±±åŸ', x: 0, y: 1, owner: 'oda', troops: 3000, defense: 100 }, // æ”¯æ´åŸ2
            { id: 'city_3_3', name: 'ç¨»è‘‰å±±', x: 3, y: 3, owner: 'saito', troops: 6000, defense: 300 }, // æ•µäºº
            { id: 'city_7_7', name: 'èº‘èº…å´', x: 7, y: 7, owner: 'takeda', troops: 10000, defense: 500 } // é æ–¹æ•µäºº
        ];

        let gameState = {
            turn: 1,
            gold: 5000,
            rice: 5000,
            selectedCity: null
        };

        // ==========================================
        // 2. æ ¸å¿ƒéŠæˆ²é‚è¼¯ (Core Logic)
        // ==========================================

        function initGame() {
            renderMap();
            updateUI();
        }

        function renderMap() {
            const mapEl = document.getElementById('game-map');
            mapEl.innerHTML = '';

            for (let y = 0; y < MAP_SIZE; y++) {
                for (let x = 0; x < MAP_SIZE; x++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    tile.dataset.x = x;
                    tile.dataset.y = y;
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰åŸå¸‚
                    const city = cities.find(c => c.x === x && c.y === y);
                    if (city) {
                        const cityDiv = document.createElement('div');
                        cityDiv.className = `city ${city.owner === PLAYER_ID ? 'player' : 'enemy'}`;
                        cityDiv.innerHTML = `<span>${city.name}</span><span>${city.troops}</span>`;
                        cityDiv.onclick = (e) => {
                            e.stopPropagation(); // é¿å…é»åˆ°æ ¼å­
                            selectCity(city);
                        };
                        tile.appendChild(cityDiv);
                    }

                    mapEl.appendChild(tile);
                }
            }
        }

        function selectCity(city) {
            gameState.selectedCity = city;
            const infoPanel = document.getElementById('city-info');
            infoPanel.style.display = 'block';
            
            document.getElementById('sel-city-name').innerText = city.name;
            document.getElementById('sel-city-troops').innerText = city.troops;
            document.getElementById('sel-city-def').innerText = city.defense;
            
            const actionDiv = document.getElementById('city-actions');
            actionDiv.innerHTML = '';

            if (city.owner === PLAYER_ID) {
                // å·±æ–¹åŸå¸‚åŠŸèƒ½ (ç°¡åŒ–)
                actionDiv.innerHTML = '<small>å·±æ–¹æ“šé»</small>';
            } else {
                // æ•µæ–¹åŸå¸‚åŠŸèƒ½ -> è§¸ç™¼æˆ°é¬¥
                const atkBtn = document.createElement('button');
                atkBtn.innerText = 'å®£æˆ°æ”»æ“Š';
                atkBtn.onclick = () => openBattlePrep(city);
                actionDiv.appendChild(atkBtn);
            }
        }

        // ==========================================
        // 3. æˆ°é¬¥ç³»çµ±æ¨¡çµ„ (Battle System Module)
        // ==========================================
        
        let battleData = {
            targetCity: null,
            originCity: null, // å‡è¨­æ”»æ“Šç™¼èµ·é»ç‚ºæœ€è¿‘çš„å·±æ–¹åŸ
            selectedGenerals: [],
            mobilizedTroops: 0,
            turnOrder: [],
            round: 0,
            active: false
        };

        // --- 3.1 æº–å‚™éšæ®µ (Preparation) ---

        function openBattlePrep(targetCity) {
            battleData.targetCity = targetCity;
            battleData.originCity = findNearestPlayerCity(targetCity); // å°‹æ‰¾æœ€è¿‘çš„å·±æ–¹åŸå¸‚ä½œç‚ºå‰ç·šåŸºåœ°
            
            if (!battleData.originCity) {
                alert("é™„è¿‘æ²’æœ‰å·±æ–¹æ“šé»ï¼Œç„¡æ³•ç™¼å‹•æ”»æ“Šï¼");
                return;
            }

            // é¡¯ç¤º Overlay
            document.getElementById('battle-overlay').style.display = 'flex';
            document.getElementById('battle-title').innerText = `æ”»ç•¥ç›®æ¨™ï¼š${targetCity.name}`;
            
            // åˆ‡æ›åˆ°æº–å‚™ç•«é¢
            document.getElementById('prep-screen').style.display = 'flex';
            document.getElementById('combat-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';

            renderGeneralList();
            highlightMobilizationRange(battleData.originCity);
            calculateMobilizableTroops();
        }

        function findNearestPlayerCity(target) {
            let nearest = null;
            let minDist = 999;
            cities.forEach(c => {
                if (c.owner === PLAYER_ID) {
                    let d = Math.abs(c.x - target.x) + Math.abs(c.y - target.y);
                    if (d < minDist) {
                        minDist = d;
                        nearest = c;
                    }
                }
            });
            return nearest;
        }

        // æ¸²æŸ“æ­¦å°‡é¸æ“‡åˆ—è¡¨
        function renderGeneralList() {
            const list = document.getElementById('prep-general-list');
            list.innerHTML = '';
            battleData.selectedGenerals = []; // é‡ç½®

            // ç¯©é¸å‡ºå±¬æ–¼ç©å®¶çš„æ­¦å°‡ (é€™è£¡ç°¡åŒ–ç‚ºå…¨éƒ¨ç©å®¶æ­¦å°‡ï¼Œå¯¦éš›æ‡‰ç¯©é¸ä½ç½®)
            const playerGenerals = generals.filter(g => g.owner === PLAYER_ID);

            playerGenerals.forEach(gen => {
                const div = document.createElement('div');
                div.className = 'general-select-item';
                
                // è‹¥å§”ä»»ä¸­ï¼Œé¡¯ç¤ºæ¨™è¨˜
                let statusText = gen.status === 'delegated' ? '(å§”ä»»ä¸­)' : '';
                
                div.innerHTML = `
                    <div>
                        <strong>${gen.name}</strong> <span style="color:#f39c12">${statusText}</span><br>
                        <span class="gen-stats">çµ±:${gen.lead} æ”¿:${gen.pol} æ­¦:${gen.war}</span>
                    </div>
                    <div class="checkbox-area">Wait</div>
                `;

                div.onclick = () => toggleGeneralSelection(gen, div);
                list.appendChild(div);
            });
        }

        function toggleGeneralSelection(gen, divElement) {
            const idx = battleData.selectedGenerals.indexOf(gen);
            if (idx > -1) {
                // å–æ¶ˆé¸æ“‡
                battleData.selectedGenerals.splice(idx, 1);
                divElement.classList.remove('selected');
            } else {
                // é¸æ“‡ (ä¸Šé™8äºº)
                if (battleData.selectedGenerals.length >= 8) {
                    alert("æœ€å¤šåªèƒ½æ´¾é£8åæ­¦å°‡ï¼");
                    return;
                }
                battleData.selectedGenerals.push(gen);
                divElement.classList.add('selected');
            }
            distributeTroopsUI();
        }

        // è¨ˆç®—ç¯„åœå…µåŠ› (é‚è¼¯æ ¸å¿ƒ)
        function calculateMobilizableTroops() {
            let totalPool = 0;
            const origin = battleData.originCity;
            const range = 4;

            cities.forEach(c => {
                if (c.owner === PLAYER_ID) {
                    const dist = Math.abs(c.x - origin.x) + Math.abs(c.y - origin.y);
                    if (dist <= range) {
                        totalPool += c.troops;
                    }
                }
            });

            battleData.mobilizedTroops = totalPool;
            document.getElementById('pool-troops').innerText = totalPool;
            distributeTroopsUI();
        }

        // åœ¨åœ°åœ–ä¸Šé«˜äº®ç¯„åœ (UIå„ªåŒ–)
        function highlightMobilizationRange(origin) {
            const tiles = document.querySelectorAll('.tile');
            tiles.forEach(t => {
                t.classList.remove('in-range');
                const tx = parseInt(t.dataset.x);
                const ty = parseInt(t.dataset.y);
                const dist = Math.abs(tx - origin.x) + Math.abs(ty - origin.y);
                if (dist <= 4) {
                    t.classList.add('in-range');
                }
            });
        }

        function distributeTroopsUI() {
            const count = battleData.selectedGenerals.length;
            const pool = battleData.mobilizedTroops;
            if (count === 0) {
                document.getElementById('troops-per-gen').innerText = 0;
                document.getElementById('total-deploy-troops').innerText = 0;
                document.getElementById('btn-start-combat').disabled = true;
                return;
            }

            // ç°¡å–®åˆ†é…ï¼šå¹³å‡åˆ†é…ï¼Œä½†ä¸è¶…é5000
            let perGen = Math.floor(pool / count);
            if (perGen > 5000) perGen = 5000;

            document.getElementById('troops-per-gen').innerText = perGen;
            document.getElementById('total-deploy-troops').innerText = perGen * count;
            document.getElementById('btn-start-combat').disabled = false;
        }

        // --- 3.2 æˆ°é¬¥é–‹å§‹ (Initialization) ---

        function startCombat() {
            // 1. è¨­ç½®æ•¸æ“š
            const count = battleData.selectedGenerals.length;
            let pool = battleData.mobilizedTroops;
            let perGen = Math.floor(pool / count);
            if (perGen > 5000) perGen = 5000;

            // åˆå§‹åŒ–åƒæˆ°æ­¦å°‡ç‹€æ…‹
            battleData.combatUnits = battleData.selectedGenerals.map(g => {
                // è§£é™¤å§”ä»»
                if (g.status === 'delegated') g.status = 'free';
                return {
                    ...g, // è¤‡è£½å±¬æ€§
                    currentTroops: perGen,
                    maxTroops: perGen
                };
            });

            // æ‰£é™¤åœ°åœ–ä¸Šçš„å…µåŠ› (æ­¤è™•ç°¡åŒ–ï¼šç›´æ¥æ‰£ç¸½æ•¸ï¼Œæš«ä¸å¹³å‡æ‰£é™¤å„åŸ)
            let totalUsed = perGen * count;
            // Warning: å¯¦éš›å°ˆæ¡ˆæ‡‰å¯¦ä½œå¾å„åŸæ‰£é™¤çš„é‚è¼¯
            
            // 2. åˆ‡æ›ä»‹é¢
            document.getElementById('prep-screen').style.display = 'none';
            document.getElementById('combat-screen').style.display = 'flex';
            document.getElementById('defender-name').innerText = `æ•µè» (${battleData.targetCity.name})`;

            // åˆå§‹åŒ–é˜²å®ˆæ–¹æ•¸å€¼ (ä½¿ç”¨å‰¯æœ¬é¿å…ç›´æ¥ä¿®æ”¹åŸå§‹æ•¸æ“šç›´åˆ°å‹åˆ©)
            battleData.defCityStats = {
                troops: battleData.targetCity.troops,
                maxTroops: battleData.targetCity.troops,
                defense: battleData.targetCity.defense,
                maxDefense: battleData.targetCity.defense
            };

            updateBattleVisuals();
            logBattle("æˆ°é¬¥é–‹å§‹ï¼å…¨è»çªæ“Šï¼", "white");
            
            // ç”Ÿæˆç¬¬ä¸€å›åˆé †åº
            battleData.round = 0;
            prepareRoundOrder();
        }

        // --- 3.3 æˆ°é¬¥è¿´åœˆ (Combat Loop) ---

        function prepareRoundOrder() {
            battleData.round++;
            
            // æ’åºé‚è¼¯ï¼šçµ±å¸¥ + æ”¿æ²»
            battleData.combatUnits.sort((a, b) => (b.lead + b.pol) - (a.lead + a.pol));
            
            // æ¸²æŸ“è¡Œå‹•æ¢
            const bar = document.getElementById('turn-order-bar');
            bar.innerHTML = '';
            battleData.combatUnits.forEach(u => {
                if (u.currentTroops > 0) {
                    const div = document.createElement('div');
                    div.className = 'order-unit';
                    div.innerText = `${u.name} (${u.lead + u.pol})`;
                    bar.appendChild(div);
                }
            });

            // æ•µæ–¹(åŸ)æ”¾åœ¨æœ€å¾Œæˆ–ä¸­é–“? ç‚ºäº†ç°¡åŒ–ï¼Œæ•µæ–¹ä½œç‚ºåæ“Šæ–¹ï¼Œåœ¨æ¯å›åˆçµæŸçµç®—
            logBattle(`--- ç¬¬ ${battleData.round} å›åˆ ---`, "#f1c40f");
        }

        function processBattleRound() {
            const btn = document.getElementById('btn-next-round');
            btn.disabled = true; // é˜²æ­¢é€£é»

            let delay = 0;

            // 1. æ”»æ“Šæ–¹è¡Œå‹•
            battleData.combatUnits.forEach((unit, index) => {
                if (unit.currentTroops <= 0) return;

                setTimeout(() => {
                    // æ”»æ“Šé‚è¼¯
                    // å‚·å®³ = (å…µåŠ› * 0.1) + (çµ±å¸¥ * 2)
                    let baseDmg = (unit.currentTroops * 0.1) + (unit.lead * 2);
                    
                    // åŸé˜²æ¸›å…
                    let defFactor = 1 + (battleData.defCityStats.defense / 100);
                    let dmg = Math.floor((baseDmg / defFactor) * (0.9 + Math.random()*0.2));

                    // å‚·å®³åˆ¤å®šï¼šå…ˆæ‰“ç‰†ï¼Œæ²’ç‰†æ‰“äºº (æˆ–åŒæ™‚) -> è¦å‰‡ï¼šæ­é…åŸé˜²ï¼Œæ•…å‡è¨­ä¸»è¦æ¶ˆè€—åŸé˜²èˆ‡å®ˆå…µ
                    // é€™è£¡æ”¹ç‚ºï¼šåŒæ™‚é€ æˆå‚·å®³ï¼Œä½†åŸé˜²é«˜æ™‚å®ˆå…µå—å‚·å°‘
                    
                    let wallDmg = Math.floor(dmg * 0.5);
                    let troopDmg = dmg;

                    // æ›´æ–°æ•¸æ“š
                    battleData.defCityStats.defense -= wallDmg;
                    if (battleData.defCityStats.defense < 0) battleData.defCityStats.defense = 0;
                    
                    if (battleData.defCityStats.troops > 0) {
                        battleData.defCityStats.troops -= troopDmg;
                        if (battleData.defCityStats.troops < 0) battleData.defCityStats.troops = 0;
                        logBattle(`âš”ï¸ ${unit.name} æ”»æ“Šï¼é€ æˆ ${troopDmg} æ®ºå‚·, åŸé˜²æ ${wallDmg}`, "#fff");
                    } else {
                        // å·²ç ´åŸï¼Œåªæ‰“åŸé˜²
                        logBattle(`ğŸ”¨ ${unit.name} æ”»åŸï¼åŸé˜²æè€— ${dmg}`, "#fff");
                        battleData.defCityStats.defense -= (dmg * 0.5); // é¡å¤–ç ´å£
                        if (battleData.defCityStats.defense < 0) battleData.defCityStats.defense = 0;
                    }

                    updateBattleVisuals();
                    checkVictory();

                }, index * 800); // æ¯å€‹æ­¦å°‡è¡Œå‹•é–“éš”
                
                delay = (index + 1) * 800;
            });

            // 2. é˜²å®ˆæ–¹åæ“Š (åœ¨æ‰€æœ‰æ­¦å°‡è¡Œå‹•å¾Œ)
            setTimeout(() => {
                if (battleData.active) { // ç¢ºä¿æˆ°é¬¥æœªçµæŸ
                    logBattle(`ğŸ›¡ï¸ æ•µæ–¹åŸé˜²åæ“Šï¼`, "#e74c3c");
                    
                    // å¡”æ¨“å‚·å®³
                    let towerDmg = 200 + (battleData.defCityStats.defense);
                    
                    battleData.combatUnits.forEach(u => {
                        if (u.currentTroops > 0) {
                            // éš¨æ©Ÿæ³¢å‹•
                            let d = Math.floor(towerDmg * (0.8 + Math.random()*0.4));
                            u.currentTroops -= d;
                            if (u.currentTroops < 0) u.currentTroops = 0;
                        }
                    });
                    
                    updateBattleVisuals();
                    updateAttackerStatus(); // æ›´æ–°å·¦å´åˆ—è¡¨
                    
                    // æª¢æŸ¥æ˜¯å¦å…¨è»è¦†æ²’
                    let totalTroops = battleData.combatUnits.reduce((sum, u) => sum + u.currentTroops, 0);
                    if (totalTroops <= 0) {
                        endBattle(false);
                    } else {
                        // æº–å‚™ä¸‹ä¸€å›åˆ
                        prepareRoundOrder();
                        btn.disabled = false;
                    }
                }
            }, delay + 1000);
        }

        function updateBattleVisuals() {
            // æ•µæ–¹è¡€æ¢
            let defPct = (battleData.defCityStats.defense / battleData.defCityStats.maxDefense) * 100;
            let troopPct = (battleData.defCityStats.troops / battleData.defCityStats.maxTroops) * 100;
            
            document.getElementById('def-wall-bar').style.width = `${defPct}%`;
            document.getElementById('def-wall-val').innerText = Math.floor(battleData.defCityStats.defense);
            
            document.getElementById('def-troops-bar').style.width = `${troopPct}%`;
            document.getElementById('def-troops-val').innerText = Math.floor(battleData.defCityStats.troops);

            updateAttackerStatus();
        }

        function updateAttackerStatus() {
            const container = document.getElementById('attacker-status');
            container.innerHTML = '';
            battleData.combatUnits.forEach(u => {
                const div = document.createElement('div');
                div.style.marginBottom = '5px';
                div.style.background = '#34495e';
                div.style.padding = '5px';
                
                let pct = (u.currentTroops / u.maxTroops) * 100;
                let color = pct < 30 ? '#c0392b' : '#2ecc71';

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-size:12px;">
                        <span>${u.name}</span>
                        <span>${u.currentTroops}</span>
                    </div>
                    <div style="height:5px; background:#7f8c8d; width:100%;">
                        <div style="height:100%; background:${color}; width:${pct}%"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function logBattle(msg, color) {
            const log = document.getElementById('battle-log');
            const p = document.createElement('div');
            p.className = 'log-entry';
            p.style.color = color;
            p.innerText = msg;
            log.prepend(p); // æ–°è¨Šæ¯åœ¨æœ€ä¸Š
        }

        function checkVictory() {
            // å‹åˆ©æ¢ä»¶ï¼šåŸé˜²0 ä¸” å…µåŠ›0
            if (battleData.defCityStats.defense <= 0 && battleData.defCityStats.troops <= 0) {
                battleData.active = false;
                endBattle(true);
            }
        }

        function endBattle(isWin) {
            battleData.active = false;
            document.getElementById('combat-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';
            
            if (isWin) {
                document.getElementById('result-title').innerText = "æ”»åŸå‹åˆ©ï¼";
                document.getElementById('result-title').style.color = "gold";
                document.getElementById('result-desc').innerText = `æˆåŠŸä½”é ˜ ${battleData.targetCity.name}ï¼æ•µè»å·²æ½°æ•£ã€‚`;
                
                // å¯¦éš›ä¿®æ”¹éŠæˆ²æ•¸æ“š
                battleData.targetCity.owner = PLAYER_ID;
                battleData.targetCity.troops = 1000; // ä½”é ˜å¾Œçš„åˆå§‹å…µåŠ›
                battleData.targetCity.defense = 50;   // ä½”é ˜å¾Œçš„åŸé˜²
                renderMap(); // é‡ç¹ªåœ°åœ–
            } else {
                document.getElementById('result-title').innerText = "æ”»åŸå¤±æ•—...";
                document.getElementById('result-title').style.color = "red";
                document.getElementById('result-desc').innerText = "å…¨è»è¦†æ²’ï¼Œéƒ¨éšŠæ’¤é€€ã€‚";
            }
        }

        function closeBattle() {
            document.getElementById('battle-overlay').style.display = 'none';
            // æ¸…é™¤ç¯„åœé«˜äº®
            const tiles = document.querySelectorAll('.tile');
            tiles.forEach(t => t.classList.remove('in-range'));
        }

        // ==========================================
        // Utils & Init
        // ==========================================
        
        function updateUI() {
            document.getElementById('res-gold').innerText = gameState.gold;
            document.getElementById('res-rice').innerText = gameState.rice;
        }

        function nextTurn() {
            gameState.turn++;
            gameState.gold += 500;
            gameState.rice += 500;
            updateUI();
            alert(`ç¬¬ ${gameState.turn} å›åˆé–‹å§‹ï¼Œæ”¶å…¥å¢åŠ ã€‚`);
        }

        // Start
        initGame();
        battleData.active = true; // Flag helper

    </script>
</body>
</html>
