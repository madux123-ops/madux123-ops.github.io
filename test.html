<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>進階甘特圖：拖拉與連線版</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #475569;
            --bg-color: #f8fafc;
            --border-color: #e2e8f0;
            --main-task-color: #3b82f6;
            --sub-task-color: #10b981;
            --day-width: 40px; /* 每一天的寬度 */
            --row-height: 42px; /* 每一行的高度 */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: #333;
            user-select: none; /* 防止拖拉時選取文字 */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h2 { border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }

        /* 輸入區域 */
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
            background: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
        }

        .form-control { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        button {
            padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn-add { background-color: var(--primary-color); color: white; }
        .btn-add:hover { background-color: #1d4ed8; }
        .btn-generate { background-color: #0f172a; color: white; width: 100%; margin-top: 10px; }
        .btn-delete { background-color: #ef4444; color: white; padding: 5px 10px; font-size: 0.8em; }

        /* 任務列表表格 */
        .task-list-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .task-list { width: 100%; border-collapse: collapse; }
        .task-list th { position: sticky; top: 0; background: #eee; z-index: 2; }
        .task-list th, .task-list td { padding: 8px 10px; border-bottom: 1px solid var(--border-color); text-align: left; font-size: 0.9em; }
        .type-main { font-weight: bold; color: var(--primary-color); }
        .type-sub { padding-left: 20px; color: var(--secondary-color); }

        /* 甘特圖顯示區域 */
        #gantt-chart-view {
            display: none;
            border: 1px solid var(--border-color);
            background: white;
            margin-top: 20px;
            position: relative;
            overflow: hidden; /* 防止外層溢出 */
        }

        .gantt-header {
            display: flex;
            border-bottom: 1px solid #ddd;
            background: #f8f9fa;
            height: 40px;
        }

        .gantt-sidebar-header {
            min-width: 200px;
            width: 200px;
            padding: 10px;
            font-weight: bold;
            border-right: 1px solid #ddd;
            background: #f8f9fa;
            box-sizing: border-box;
            z-index: 20;
        }

        .timeline-header-container {
            overflow: hidden; /* 隱藏捲軸，由下方同步捲動 */
            flex-grow: 1;
            position: relative;
        }
        
        .timeline-header { display: flex; }

        .day-cell {
            min-width: var(--day-width);
            width: var(--day-width);
            text-align: center;
            border-right: 1px solid #eee;
            font-size: 0.8em;
            padding: 10px 0;
            box-sizing: border-box;
        }

        /* 捲動區域 */
        .gantt-scroll-wrapper {
            display: flex;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 500px;
            position: relative;
        }

        .gantt-sidebar {
            min-width: 200px;
            width: 200px;
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            border-right: 1px solid #ddd;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        .task-name-cell {
            height: var(--row-height);
            padding: 0 10px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            box-sizing: border-box;
        }

        .gantt-timeline-area {
            position: relative;
            flex-grow: 1;
        }

        /* 背景網格 */
        .grid-background {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            z-index: 0;
            pointer-events: none;
        }
        .grid-line {
            min-width: var(--day-width);
            width: var(--day-width);
            border-right: 1px solid #f5f5f5;
            height: 100%;
            box-sizing: border-box;
        }

        /* SVG 連線層 */
        #arrow-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            pointer-events: none; /* 讓點擊事件穿透到下方的 Bar */
        }
        
        .arrow-line {
            stroke: #94a3b8;
            stroke-width: 2;
            fill: none;
        }
        .arrow-head {
            fill: #94a3b8;
        }

        /* 進度條 */
        .bar-row {
            height: var(--row-height);
            border-bottom: 1px solid transparent; /* 佔位用 */
            position: relative;
            box-sizing: border-box;
        }

        .bar {
            position: absolute;
            height: 24px;
            top: 9px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            padding-left: 8px;
            white-space: nowrap;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: grab; /* 手型游標 */
            z-index: 5;
            transition: background-color 0.2s;
        }
        .bar:active { cursor: grabbing; opacity: 0.8; }
        .bar.main { background-color: var(--main-task-color); }
        .bar.sub { background-color: var(--sub-task-color); }

        /* 週末樣式 */
        .weekend { background-color: #f8fafc; }

    </style>
</head>
<body>

<div class="container">
    <h2>甘特圖產生器 (進階版)</h2>

    <div class="input-group">
        <div class="form-control">
            <label>任務名稱</label>
            <input type="text" id="taskName" placeholder="任務名稱">
        </div>
        <div class="form-control">
            <label>類型</label>
            <select id="taskType">
                <option value="main">主項目</option>
                <option value="sub">└ 子項目</option>
            </select>
        </div>
        <div class="form-control">
            <label>開始日期</label>
            <input type="date" id="startDate">
        </div>
        <div class="form-control">
            <label>天數</label>
            <input type="number" id="duration" min="1" value="3" style="width: 60px;">
        </div>
        <div class="form-control">
            <label>前置任務</label>
            <select id="predecessor">
                <option value="">(無)</option>
            </select>
        </div>
        <button class="btn-add" onclick="addTask()">+ 加入</button>
    </div>

    <div class="task-list-container">
        <table class="task-list">
            <thead>
                <tr>
                    <th width="35%">任務名稱</th>
                    <th>開始日期</th>
                    <th>天數</th>
                    <th>前置任務</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="taskListBody"></tbody>
        </table>
    </div>

    <button class="btn-generate" onclick="generateGantt()">產出 / 重繪甘特圖</button>

    <div id="gantt-chart-view">
        <div class="gantt-header">
            <div class="gantt-sidebar-header">項目列表</div>
            <div class="timeline-header-container" id="timelineHeaderContainer">
                <div class="timeline-header" id="timelineHeader"></div>
            </div>
        </div>
        
        <div class="gantt-scroll-wrapper" id="ganttScrollWrapper">
            <div class="gantt-sidebar" id="ganttSidebar"></div>
            
            <div class="gantt-timeline-area" id="ganttTimelineArea">
                <div class="grid-background" id="gridBackground"></div>
                <svg id="arrow-layer"></svg>
                <div id="barsContainer"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let tasks = [];
    const DAY_WIDTH = 40; // 必須對應 CSS
    const ROW_HEIGHT = 42; // 必須對應 CSS
    
    // 初始化
    document.getElementById('startDate').valueAsDate = new Date();

    // 格式化日期字串 yyyy-mm-dd
    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    // 增加日期
    function addDays(dateStr, days) {
        const date = new Date(dateStr);
        date.setDate(date.getDate() + days);
        return date;
    }

    function addTask() {
        const name = document.getElementById('taskName').value;
        const type = document.getElementById('taskType').value;
        const start = document.getElementById('startDate').value;
        const duration = parseInt(document.getElementById('duration').value);
        const predecessorId = document.getElementById('predecessor').value;

        if (!name || !start || !duration) {
            alert("請填寫完整資訊");
            return;
        }

        const task = {
            id: Date.now().toString(), // 使用字串作為 ID
            name,
            type,
            start,
            duration,
            predecessorId: predecessorId || null
        };

        tasks.push(task);
        updateUI();
        
        // 重置輸入
        document.getElementById('taskName').value = '';
        document.getElementById('taskName').focus();
    }

    function removeTask(id) {
        tasks = tasks.filter(t => t.id !== id);
        // 移除其他任務對此任務的依賴
        tasks.forEach(t => {
            if (t.predecessorId === id) t.predecessorId = null;
        });
        updateUI();
    }

    function updateUI() {
        renderTaskList();
        updatePredecessorSelect();
    }

    function updatePredecessorSelect() {
        const select = document.getElementById('predecessor');
        select.innerHTML = '<option value="">(無)</option>';
        tasks.forEach(task => {
            const option = document.createElement('option');
            option.value = task.id;
            option.textContent = task.name;
            select.appendChild(option);
        });
    }

    function renderTaskList() {
        const tbody = document.getElementById('taskListBody');
        tbody.innerHTML = '';
        tasks.forEach(task => {
            const predTask = tasks.find(t => t.id === task.predecessorId);
            const predName = predTask ? predTask.name : '-';
            
            const tr = document.createElement('tr');
            const nameClass = task.type === 'main' ? 'type-main' : 'type-sub';
            const prefix = task.type === 'sub' ? '└ ' : '';
            
            tr.innerHTML = `
                <td class="${nameClass}">${prefix}${task.name}</td>
                <td id="list-date-${task.id}">${task.start}</td>
                <td>${task.duration}</td>
                <td>${predName}</td>
                <td><button class="btn-delete" onclick="removeTask('${task.id}')">X</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- 甘特圖核心邏輯 ---

    let minDate, totalDays;

    function generateGantt() {
        if (tasks.length === 0) return;

        const chartView = document.getElementById('gantt-chart-view');
        chartView.style.display = 'block';

        // 1. 計算全域時間範圍
        let minTime = new Date(tasks[0].start).getTime();
        let maxTime = new Date(tasks[0].start).getTime();

        tasks.forEach(t => {
            const s = new Date(t.start).getTime();
            const e = new Date(t.start);
            e.setDate(e.getDate() + t.duration);
            if (s < minTime) minTime = s;
            if (e.getTime() > maxTime) maxTime = e.getTime();
        });

        // 緩衝日期
        minDate = new Date(minTime);
        minDate.setDate(minDate.getDate() - 3); // 前3天
        const finalDate = new Date(maxTime);
        finalDate.setDate(finalDate.getDate() + 10); // 後10天

        totalDays = Math.ceil((finalDate - minDate) / (1000 * 60 * 60 * 24));

        // 2. 建構 DOM
        buildTimelineHeader(totalDays);
        buildChartBody(totalDays);
        
        // 3. 繪製連線
        drawArrows();

        // 4. 同步 Header 捲動
        const scrollWrapper = document.getElementById('ganttScrollWrapper');
        const headerContainer = document.getElementById('timelineHeaderContainer');
        scrollWrapper.onscroll = function() {
            headerContainer.scrollLeft = scrollWrapper.scrollLeft;
        };
    }

    function buildTimelineHeader(days) {
        const header = document.getElementById('timelineHeader');
        header.innerHTML = '';
        for (let i = 0; i < days; i++) {
            const current = new Date(minDate);
            current.setDate(current.getDate() + i);
            const div = document.createElement('div');
            div.className = 'day-cell';
            div.innerText = `${current.getMonth() + 1}/${current.getDate()}`;
            if (current.getDay() === 0 || current.getDay() === 6) {
                div.style.backgroundColor = '#f1f5f9';
            }
            header.appendChild(div);
        }
    }

    function buildChartBody(days) {
        const sidebar = document.getElementById('ganttSidebar');
        const barsContainer = document.getElementById('barsContainer');
        const gridBackground = document.getElementById('gridBackground');
        const arrowLayer = document.getElementById('arrow-layer');
        
        sidebar.innerHTML = '';
        barsContainer.innerHTML = '';
        gridBackground.innerHTML = '';
        
        // 設定容器總寬度
        const totalWidth = days * DAY_WIDTH;
        gridBackground.style.width = `${totalWidth}px`;
        arrowLayer.style.width = `${totalWidth}px`;
        arrowLayer.innerHTML = ''; // 清空舊箭頭

        // 繪製網格
        for (let i = 0; i < days; i++) {
            const line = document.createElement('div');
            line.className = 'grid-line';
            // 標記週末
            const current = new Date(minDate);
            current.setDate(current.getDate() + i);
            if (current.getDay() === 0 || current.getDay() === 6) {
                line.classList.add('weekend');
            }
            gridBackground.appendChild(line);
        }

        // 繪製每一行任務
        tasks.forEach((task, index) => {
            // 1. 左側欄位
            const nameDiv = document.createElement('div');
            nameDiv.className = 'task-name-cell';
            const prefix = task.type === 'sub' ? '&nbsp;&nbsp;└ ' : '';
            nameDiv.innerHTML = `<span class="${task.type === 'main' ? 'type-main' : 'type-sub'}">${prefix}${task.name}</span>`;
            sidebar.appendChild(nameDiv);

            // 2. 時間軸列 (隱形列，用來定位)
            const rowDiv = document.createElement('div');
            rowDiv.className = 'bar-row';
            barsContainer.appendChild(rowDiv);

            // 3. 建立 Bar
            const bar = document.createElement('div');
            bar.className = `bar ${task.type}`;
            bar.id = `bar-${task.id}`;
            bar.innerText = `${task.duration}天`;
            
            // 計算位置
            const diffTime = new Date(task.start) - minDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            bar.style.left = `${diffDays * DAY_WIDTH}px`;
            bar.style.width = `${task.duration * DAY_WIDTH - 6}px`; // -6 為了留縫隙
            bar.style.top = `${(index * ROW_HEIGHT) + 9}px`; // 絕對定位高度
            
            // 綁定資料屬性
            bar.dataset.taskId = task.id;
            bar.dataset.index = index;
            bar.dataset.currentLeft = diffDays * DAY_WIDTH;

            // 加入拖拉事件
            bar.addEventListener('mousedown', handleDragStart);

            barsContainer.appendChild(bar);
        });

        // 調整 SVG 高度以符合內容
        const totalHeight = tasks.length * ROW_HEIGHT;
        arrowLayer.style.height = `${totalHeight}px`;
        barsContainer.style.height = `${totalHeight}px`;
    }

    // --- 拖拉功能實作 ---
    let draggedBar = null;
    let startX = 0;
    let originalLeft = 0;

    function handleDragStart(e) {
        draggedBar = e.target;
        startX = e.clientX;
        originalLeft = parseFloat(draggedBar.style.left || 0);
        
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
        draggedBar.style.opacity = '0.7';
    }

    function handleDragMove(e) {
        if (!draggedBar) return;
        const deltaX = e.clientX - startX;
        let newLeft = originalLeft + deltaX;
        
        // 邊界檢查
        if (newLeft < 0) newLeft = 0;
        
        draggedBar.style.left = `${newLeft}px`;
        
        // 即時重繪連線 (為了效能，這裡只做簡單計算，真正的吸附在 drop)
        requestAnimationFrame(() => drawArrows());
    }

    function handleDragEnd(e) {
        if (!draggedBar) return;
        
        document.removeEventListener('mousemove', handleDragMove);
        document.removeEventListener('mouseup', handleDragEnd);
        
        // 磁吸效果 (Snap to Grid)
        const currentLeft = parseFloat(draggedBar.style.left || 0);
        const dayIndex = Math.round(currentLeft / DAY_WIDTH);
        const snappedLeft = dayIndex * DAY_WIDTH;
        
        draggedBar.style.left = `${snappedLeft}px`;
        draggedBar.style.opacity = '1';

        // 更新資料模型
        const taskId = draggedBar.dataset.taskId;
        const task = tasks.find(t => t.id === taskId);
        
        if (task) {
            const newDate = new Date(minDate);
            newDate.setDate(newDate.getDate() + dayIndex);
            task.start = formatDate(newDate);
            
            // 同步更新列表顯示
            const listDateCell = document.getElementById(`list-date-${taskId}`);
            if (listDateCell) listDateCell.innerText = task.start;
        }

        // 完整重繪連線
        drawArrows();
        draggedBar = null;
    }

    // --- 繪製連線 (SVG) ---
    function drawArrows() {
        const svg = document.getElementById('arrow-layer');
        svg.innerHTML = ''; // 清除舊線
        
        // 定義箭頭標記
        const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
        const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
        marker.setAttribute("id", "arrowhead");
        marker.setAttribute("markerWidth", "10");
        marker.setAttribute("markerHeight", "7");
        marker.setAttribute("refX", "9");
        marker.setAttribute("refY", "3.5");
        marker.setAttribute("orient", "auto");
        
        const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        polygon.setAttribute("points", "0 0, 10 3.5, 0 7");
        polygon.setAttribute("fill", "#94a3b8");
        
        marker.appendChild(polygon);
        defs.appendChild(marker);
        svg.appendChild(defs);

        tasks.forEach(task => {
            if (task.predecessorId) {
                const currentBar = document.getElementById(`bar-${task.id}`);
                const predBar = document.getElementById(`bar-${task.predecessorId}`);
                
                if (currentBar && predBar) {
                    // 取得相對於 gantt-timeline-area 的座標
                    // 由於 bar 是 absolute positioning，直接讀取 style.left / top 比較準確且快
                    const x1 = parseFloat(predBar.style.left) + parseFloat(predBar.style.width); // 前置任務右側
                    const y1 = parseFloat(predBar.style.top) + 12; // 垂直置中
                    
                    const x2 = parseFloat(currentBar.style.left); // 當前任務左側
                    const y2 = parseFloat(currentBar.style.top) + 12; // 垂直置中

                    // 繪製折線 (類似 MS Project 風格)
                    // 路徑: (x1,y1) -> (x1+10, y1) -> (x1+10, y2) -> (x2, y2)
                    // 如果 x2 < x1，線條會往回繞
                    
                    const midX = x1 + 15; // 轉折點 X 軸位移
                    
                    let d = `M ${x1} ${y1} L ${midX} ${y1}`;
                    
                    if (x2 > midX) {
                        // 簡單情況：目標在右邊
                        d += ` L ${midX} ${y2} L ${x2} ${y2}`;
                    } else {
                        // 複雜情況：目標在左邊 (回溯) -> 需要更多轉折避免穿過 Bar
                        const midY = y2 > y1 ? y1 + (ROW_HEIGHT/2) + 5 : y1 - (ROW_HEIGHT/2) - 5;
                        d += ` L ${midX} ${midY} L ${x2 - 10} ${midY} L ${x2 - 10} ${y2} L ${x2} ${y2}`;
                    }

                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", d);
                    path.setAttribute("class", "arrow-line");
                    path.setAttribute("marker-end", "url(#arrowhead)");
                    
                    svg.appendChild(path);
                }
            }
        });
    }

</script>

</body>
</html>
