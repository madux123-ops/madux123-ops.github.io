<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦æ³é‡çƒé¢¨æ ¼ - å‚³å¥‡é‡æ‰‹é¤Šæˆ Ver.3 (äº’å‹•æ‰“æ“Šç‰ˆ)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --highlight: #f1c40f;
            --bg-color: #ecf0f1;
            --panel-bg: #ffffff;
            --stadium-green: #27ae60;
            --dirt: #d35400;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary);
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            user-select: none; /* Prevent selection during spam clicking */
        }
        .game-container {
            width: 900px;
            background: var(--bg-color);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            overflow: hidden;
            display: grid;
            grid-template-rows: 60px 1fr 180px;
            position: relative;
        }
        
        /* Overlays */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.98);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .hidden { display: none !important; }

        /* Start Screen */
        #input-name {
            padding: 15px; font-size: 1.5em; margin: 20px 0;
            border-radius: 5px; border: none; text-align: center;
        }
        
        /* Interactive Stadium Overlay */
        #stadium-screen {
            background: radial-gradient(circle at 50% 100%, var(--dirt) 20%, var(--stadium-green) 21%);
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        
        /* Stadium UI */
        .match-info-bar {
            background: rgba(0,0,0,0.7);
            color: #fff;
            width: 100%;
            padding: 10px;
            display: flex;
            justify-content: space-around;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* The Field View */
        .field-area {
            position: relative;
            width: 400px;
            height: 500px;
            margin-top: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.1);
        }
        
        /* Pitcher Mound */
        .mound {
            position: absolute; top: 20px; left: 50%;
            transform: translateX(-50%);
            width: 40px; height: 40px;
            background: white; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Home Plate (Strike Zone Area) */
        .home-plate-area {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            width: 120px; height: 100px; /* The Zone */
            border: 3px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.1);
        }
        .home-plate-area::after {
            content: "æ“Šçƒå€";
            color: rgba(255,255,255,0.5);
            position: absolute; width: 100%; text-align: center; top: 40%;
            font-size: 0.8em;
        }
        
        /* The Ball */
        #baseball {
            width: 20px; height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            left: 50%; top: 40px; /* Start at mound */
            transform: translate(-50%, -50%);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            display: none;
            z-index: 10;
        }
        /* Red stitches styling optional, keeping simple for performance */

        /* Result Popup inside Stadium */
        #match-result-text {
            position: absolute; top: 40%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em; font-weight: bold;
            text-shadow: 0 0 10px black;
            color: #fff;
            display: none;
            z-index: 20;
            white-space: nowrap;
        }

        /* Swing Button */
        #btn-swing {
            margin-top: 20px;
            padding: 20px 80px;
            font-size: 2em;
            background: var(--accent);
            color: white;
            border: 5px solid white;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        #btn-swing:active { transform: scale(0.95); background: #c0392b; }
        #btn-swing:disabled { background: #7f8c8d; opacity: 0.5; cursor: default; }

        /* Header */
        header {
            background: var(--primary);
            color: white;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            border-bottom: 4px solid var(--highlight);
        }
        .player-name { font-size: 1.2em; color: var(--highlight); margin-right: 10px; }
        .status-badge { background: var(--accent); padding: 5px 10px; border-radius: 5px; font-size: 0.9em; }

        /* Main Content */
        main { padding: 20px; display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        
        /* Stats Panel */
        .stats-panel {
            background: var(--panel-bg); padding: 15px; border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 10px;
        }
        .stat-row { margin-bottom: 5px; }
        .stat-label { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 3px; font-size: 0.9em; }
        .stat-bar-bg { background: #ddd; height: 8px; border-radius: 4px; overflow: hidden; }
        .stat-bar-fill { height: 100%; width: 0%; transition: width 0.3s; }
        .fill-power { background: #e74c3c; }
        .fill-contact { background: #f39c12; }
        .fill-defense { background: #3498db; }
        .fill-run { background: #9b59b6; }

        /* Game Screen (Text Mode) */
        .game-screen {
            background: var(--panel-bg); border-radius: 10px; padding: 15px;
            display: flex; flex-direction: column; position: relative;
        }
        .dialog-box {
            flex-grow: 1; border: 2px solid #ccc; border-radius: 5px;
            padding: 15px; background: #fff; margin-bottom: 10px;
            overflow-y: auto; height: 250px; font-size: 0.95em; line-height: 1.6;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .log-highlight { color: var(--accent); font-weight: bold; }
        .log-success { color: var(--stadium-green); font-weight: bold; }
        
        /* Stats Grid */
        .season-stats-grid {
            background: #333; color: #fff; padding: 10px; border-radius: 5px;
            font-family: monospace; font-size: 0.85em; display: grid;
            grid-template-columns: repeat(4, 1fr); gap: 8px; text-align: center; margin-top: auto;
        }
        .stat-box { display: flex; flex-direction: column; }
        .stat-title { color: #aaa; font-size: 0.8em; }
        .stat-val { font-size: 1.1em; font-weight: bold; }

        /* Controls */
        .controls {
            background: #dcdcdc; padding: 15px; display: flex; gap: 10px;
            justify-content: center; align-items: center; border-top: 1px solid #bbb;
        }
        button {
            padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;
            transition: transform 0.1s, background 0.2s; font-size: 1em; min-width: 100px;
        }
        button:active { transform: scale(0.95); }
        .btn-train { background: var(--primary); color: white; }
        .btn-train:hover { background: #34495e; }
        .btn-rest { background: var(--stadium-green); color: white; }
        .btn-rest:hover { background: #219150; }
        .btn-next { background: var(--highlight); color: #333; width: 100%; font-size: 1.2em;}
        #warning-msg { color: red; font-weight: bold; text-align: center; visibility: hidden; }

    </style>
</head>
<body>

<div class="game-container">
    
    <div id="start-screen" class="overlay">
        <h1>âš¾ å‚³å¥‡é‡çƒé¤Šæˆ</h1>
        <p>è«‹è¼¸å…¥çƒå“¡åç¨± (æœ€å¤š6å­—)</p>
        <input type="text" id="input-name" maxlength="6" value="é‡çƒå›">
        <button onclick="startGame()" style="background:var(--highlight); color:#333;">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="stadium-screen">
        <div class="match-info-bar">
            <span id="match-counter">ç¬¬ 1 å ´</span>
            <span id="ab-counter">ç¬¬ 1 æ‰“å¸­</span>
            <span id="match-stats-display">H: 0 / HR: 0</span>
        </div>
        
        <div class="field-area">
            <div class="mound"></div>
            
            <div id="baseball"></div>

            <div class="home-plate-area" id="strike-zone"></div>
            
            <div id="match-result-text">å®‰æ‰“!</div>
        </div>

        <button id="btn-swing" onmousedown="attemptSwing()">æ® æ£’ !</button>
        <div style="margin-top:10px; color: white; font-size:0.8em;">(äº¦å¯æŒ‰ç©ºç™½éµæ®æ“Š)</div>
        
        <button id="btn-next-ab" class="hidden" style="margin-top:20px; background:var(--highlight); color:#333;" onclick="nextAtBat()">ä¸‹ä¸€æ‰“å¸­</button>
        <button id="btn-end-match" class="hidden" style="margin-top:20px; background:var(--accent); color:white;" onclick="endMatch()">çµæŸæ¯”è³½</button>
    </div>

    <header>
        <div>
            <span class="player-name" id="display-name"></span>
            <span id="round-display">ç¬¬ 1 è¼ª</span>
        </div>
        <div id="day-display">ç¬¬ 1 å¤© / 90</div>
        <div class="status-badge" id="phase-display">è¨“ç·´æœŸ</div>
    </header>

    <main>
        <div class="stats-panel">
            <h3 style="margin:0;">çƒå“¡èƒ½åŠ›</h3>
            <div class="stat-row">
                <div class="stat-label"><span>Power (åŠ›é‡)</span> <span id="val-power">10</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill fill-power" id="bar-power"></div></div>
            </div>
            <div class="stat-row">
                <div class="stat-label"><span>Contact (æŠ€å·§)</span> <span id="val-contact">10</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill fill-contact" id="bar-contact"></div></div>
            </div>
            <div class="stat-row">
                <div class="stat-label"><span>Defense (å®ˆå‚™)</span> <span id="val-defense">10</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill fill-defense" id="bar-defense"></div></div>
            </div>
            <div class="stat-row">
                <div class="stat-label"><span>Run (è·‘å£˜)</span> <span id="val-run">10</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill fill-run" id="bar-run"></div></div>
            </div>
            
            <hr style="width:100%; margin: 5px 0;">
            
            <h3 style="margin:0;">æœ¬å­£æˆç¸¾</h3>
            <div class="season-stats-grid">
                <div class="stat-box"><span class="stat-title">æ‰“æ“Šç‡</span><span class="stat-val" id="stat-avg">.000</span></div>
                <div class="stat-box"><span class="stat-title">å…¨å£˜æ‰“</span><span class="stat-val" id="stat-hr">0</span></div>
                <div class="stat-box"><span class="stat-title">æ‰“é»</span><span class="stat-val" id="stat-rbi">0</span></div>
                <div class="stat-box"><span class="stat-title">OPS</span><span class="stat-val" id="stat-ops">.000</span></div>
                
                <div class="stat-box"><span class="stat-title">ä¸Šå£˜ç‡</span><span class="stat-val" id="stat-obp">.000</span></div>
                <div class="stat-box"><span class="stat-title">é•·æ‰“ç‡</span><span class="stat-val" id="stat-slg">.000</span></div>
                <div class="stat-box"><span class="stat-title">å®‰æ‰“</span><span class="stat-val" id="stat-h">0</span></div>
                <div class="stat-box"><span class="stat-title">ä¿é€</span><span class="stat-val" id="stat-bb">0</span></div>
                
                <div class="stat-box"><span class="stat-title">ä¸‰æŒ¯</span><span class="stat-val" id="stat-so">0</span></div>
                <div class="stat-box"><span class="stat-title">ç¸½å®‰æ‰“</span><span class="stat-val" id="stat-tb">0</span></div>
            </div>
        </div>

        <div class="game-screen">
            <div class="dialog-box" id="game-log">
                </div>
            <div id="warning-msg">âš  è­¦å‘Šï¼šé€£çºŒè¨“ç·´åŒä¸€é …ç›®æ•ˆç‡æœƒå¤§å¹…é™ä½ï¼</div>
        </div>
    </main>

    <div class="controls" id="control-panel">
        </div>
</div>

<script>
    // --- Configuration ---
    const MAX_STAT = 255;
    const FIELD_HEIGHT = 500;
    
    // --- Game State ---
    const GameState = {
        playerName: "Player",
        round: 1, 
        day: 1,
        phase: 'training',
        subCycleDay: 1,
        
        stats: { power: 10, contact: 10, defense: 10, run: 10 },
        records: { gamesPlayed: 0, ab: 0, h: 0, hr: 0, tb: 0, rbi: 0, bb: 0, so: 0 },

        lastTraining: null,
        warningActive: false,
        matchConfig: { 1: 20, 2: 30, 3: 60 },
        matchesLeft: 0,

        // Batting Mini-game State
        batting: {
            active: false,
            ballY: 0,
            ballSpeed: 0,
            isPitched: false,
            swung: false,
            animationId: null,
            atBatCount: 0 // 1 to 3
        }
    };

    // --- UI Elements ---
    const elLog = document.getElementById('game-log');
    const elControls = document.getElementById('control-panel');
    const elRound = document.getElementById('round-display');
    const elDay = document.getElementById('day-display');
    const elPhase = document.getElementById('phase-display');
    const elWarning = document.getElementById('warning-msg');
    
    // Stadium Elements
    const elStadium = document.getElementById('stadium-screen');
    const elBall = document.getElementById('baseball');
    const elResultText = document.getElementById('match-result-text');
    const elBtnSwing = document.getElementById('btn-swing');
    const elBtnNextAB = document.getElementById('btn-next-ab');
    const elBtnEndMatch = document.getElementById('btn-end-match');

    // --- Core Functions ---

    function startGame() {
        const input = document.getElementById('input-name');
        let name = input.value.trim();
        if(!name) name = "é‡çƒå›";
        GameState.playerName = name;
        document.getElementById('display-name').textContent = name;
        document.getElementById('start-screen').classList.add('hidden');
        
        updateStatsUI();
        setPhase('training');
        log(`æ­¡è¿ ${name} åŠ å…¥è·æ£’é¤Šæˆè¨ˆç•«ï¼`, "log-highlight");
        log("ç¬¬ 1-3 è¼ªç›®æ¨™ï¼šå¼·åŒ–èƒ½åŠ›ï¼Œåœ¨æ¯”è³½ä¸­å±•ç¾å¯¦åŠ›ã€‚", "");
    }

    function log(msg, type='') {
        const div = document.createElement('div');
        div.className = 'log-entry ' + type;
        div.innerHTML = msg;
        elLog.prepend(div);
    }

    function updateStatsUI() {
        // Bars
        ['power','contact','defense','run'].forEach(s => {
            document.getElementById(`val-${s}`).textContent = GameState.stats[s];
            document.getElementById(`bar-${s}`).style.width = (GameState.stats[s] / MAX_STAT * 100) + '%';
        });
        
        // Stats
        let { ab, h, bb, tb, hr, rbi, so } = GameState.records;
        let avg = ab === 0 ? 0 : h / ab;
        let obp = (ab + bb) === 0 ? 0 : (h + bb) / (ab + bb);
        let slg = ab === 0 ? 0 : tb / ab;
        let ops = obp + slg;

        document.getElementById('stat-avg').textContent = avg.toFixed(3).replace(/^0+/, '');
        document.getElementById('stat-ops').textContent = ops.toFixed(3).replace(/^0+/, '');
        document.getElementById('stat-obp').textContent = obp.toFixed(3).replace(/^0+/, '');
        document.getElementById('stat-slg').textContent = slg.toFixed(3).replace(/^0+/, '');
        
        document.getElementById('stat-hr').textContent = hr;
        document.getElementById('stat-rbi').textContent = rbi;
        document.getElementById('stat-h').textContent = h;
        document.getElementById('stat-bb').textContent = bb;
        document.getElementById('stat-so').textContent = so;
        document.getElementById('stat-tb').textContent = tb;
    }

    function setPhase(phase) {
        GameState.phase = phase;
        elPhase.textContent = phase === 'training' ? 'è¨“ç·´æœŸ' : (phase === 'rest' ? 'ä¼‘æ¯é€±' : 'è³½å­£ä¸­');
        elRound.textContent = `ç¬¬ ${GameState.round} è¼ª`;
        
        if (phase === 'match') {
            elDay.textContent = `å‰©é¤˜å ´æ¬¡: ${GameState.matchesLeft}`;
        } else {
            elDay.textContent = `ç¬¬ ${GameState.day} å¤© / 90`;
        }
        
        renderControls();
    }

    function renderControls() {
        elControls.innerHTML = '';
        elWarning.style.visibility = 'hidden';

        if (GameState.phase === 'training') {
            const trainings = [
                { id: 'power', label: 'é‡è¨“ (Power)', color: '#e74c3c' },
                { id: 'contact', label: 'æ‰“æ“Š (Contact)', color: '#f39c12' },
                { id: 'defense', label: 'å®ˆå‚™ (Defense)', color: '#3498db' },
                { id: 'run', label: 'è¡åˆº (Run)', color: '#9b59b6' }
            ];
            trainings.forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'btn-train';
                btn.textContent = t.label;
                btn.style.borderLeft = `5px solid ${t.color}`;
                btn.onclick = () => handleTraining(t.id);
                elControls.appendChild(btn);
            });
        } else if (GameState.phase === 'rest') {
            const rests = [ {id:'shop',l:'é€›è¡—'}, {id:'movie',l:'çœ‹é›»å½±'}, {id:'date',l:'äº¤å‹'}, {id:'book',l:'çœ‹æ›¸'}, {id:'eat',l:'åƒå¤§é¤'} ];
            rests.forEach(r => {
                const btn = document.createElement('button');
                btn.className = 'btn-rest';
                btn.textContent = r.l;
                btn.onclick = () => handleRest(r.id);
                elControls.appendChild(btn);
            });
        } else if (GameState.phase === 'match') {
            const btn = document.createElement('button');
            btn.className = 'btn-next';
            btn.textContent = 'é€²å…¥æ¯”è³½ç¾å ´ (æ‰“æ“Šæ¨¡å¼)';
            btn.onclick = () => startMatchMode();
            elControls.appendChild(btn);
        } else if (GameState.phase === 'post-season') {
            const btn = document.createElement('button');
            btn.className = 'btn-next';
            btn.textContent = 'é€²å…¥ 10 å¤©å­£å¾Œä¼‘æ¯';
            btn.onclick = () => endSeasonRest();
            elControls.appendChild(btn);
        } else if (GameState.phase === 'game-over') {
            const btn = document.createElement('button');
            btn.className = 'btn-next';
            btn.textContent = 'é‡æ–°é–‹å§‹';
            btn.onclick = () => location.reload();
            elControls.appendChild(btn);
        }
    }

    // --- Training & Rest Logic ---

    function handleTraining(type) {
        if (GameState.lastTraining === type) {
            if (!GameState.warningActive) {
                GameState.warningActive = true;
                elWarning.style.visibility = 'visible';
                log("æ•™ç·´ï¼šæ•ˆç‡åœ¨é™ä½ï¼Œå»ºè­°æ›å€‹é …ç›®è¨“ç·´ï¼(å†æ¬¡é»æ“Šå°‡å¼·åˆ¶è¨“ç·´ä¸¦æ‰£æ•¸å€¼)", "log-highlight");
                return;
            } else {
                GameState.stats[type] = Math.max(0, GameState.stats[type] - 5);
                log(`ä½ ç„¡è¦–è­¦å‘Šå¼·è¡Œè¨“ç·´...èº«é«”å—å‚·äº†ï¼ ${type} -5`, "log-highlight");
                GameState.warningActive = false;
                advanceDay();
                updateStatsUI();
                return;
            }
        }
        GameState.lastTraining = type;
        GameState.warningActive = false;
        
        // Changed gain to 1-3
        let gain = Math.floor(Math.random() * 3) + 1; 
        
        if (Math.random() < 0.1) {
            gain += 3;
            log(`ç‹€æ…‹çµ•ä½³ï¼è¨“ç·´æ•ˆæœè¶…ç¾¤ï¼ ${type} +${gain}`, "log-success");
        } else {
            log(`é€²è¡Œäº†${type}è¨“ç·´ã€‚ ${type} +${gain}`);
        }

        GameState.stats[type] = Math.min(MAX_STAT, GameState.stats[type] + gain);
        updateStatsUI();
        advanceDay();
    }

    function handleRest(type) {
        GameState.lastTraining = null;
        let msg = "", bonus = "";
        const rand = Math.random();
        
        if(type==='shop'){ msg="å»é€›è¡—ã€‚"; if(rand<0.3){GameState.stats.run+=2; bonus="è²·äº†å¥½é‹(Run+2)";} }
        else if(type==='movie'){ msg="çœ‹é›»å½±ã€‚"; if(rand<0.3){GameState.stats.power+=2; bonus="ç†±è¡€(Power+2)";} }
        else if(type==='date'){ msg="äº¤å‹ã€‚"; if(rand<0.2){GameState.stats.contact+=3; bonus="äº¤æµæŠ€å·§(Contact+3)";} }
        else if(type==='book'){ msg="çœ‹æ›¸ã€‚"; if(rand<0.4){GameState.stats.defense+=2; bonus="å­¸ç¿’æˆ°è¡“(Defense+2)";} }
        else if(type==='eat'){ msg="åƒå¤§é¤ã€‚"; if(rand<0.5){GameState.stats.power+=1;GameState.stats.contact+=1; bonus="é«”åŠ›æ¢å¾©(All+1)";} }

        log(bonus ? `${msg} <b>${bonus}</b>` : msg, bonus ? "log-success" : "");
        advanceDay();
        updateStatsUI();
    }

    function advanceDay() {
        GameState.day++;
        GameState.subCycleDay++;
        const dayInCycle = (GameState.day - 1) % 30;

        if (GameState.day > 90) {
            startMatchPhase();
            return;
        }

        if (dayInCycle < 20) {
            if (GameState.phase !== 'training') {
                log("---- å‡æœŸçµæŸï¼Œé–‹å§‹è¨“ç·´ï¼ ----");
                setPhase('training');
            }
        } else {
            if (GameState.phase !== 'rest') {
                log("---- 20å¤©è¨“ç·´çµæŸï¼Œæ¥ä¸‹ä¾†10å¤©ä¼‘æ¯èª¿æ•´ã€‚ ----", "log-success");
                setPhase('rest');
            }
        }
        elDay.textContent = `ç¬¬ ${GameState.day} å¤© / 90`;
    }

    function startMatchPhase() {
        GameState.matchesLeft = GameState.matchConfig[GameState.round];
        setPhase('match');
        log(`== ç¬¬ ${GameState.round} è¼ªè¨“ç·´çµæŸï¼Œé–‹å§‹ ${GameState.matchesLeft} å ´æ¯”è³½ ==`, "log-highlight");
    }

    // --- Interactive Batting Game ---

    function startMatchMode() {
        if (GameState.matchesLeft <= 0) return;
        
        // Show Overlay
        elStadium.style.display = 'flex';
        GameState.batting.atBatCount = 0;
        
        // Update overlay stats
        updateStadiumStats();
        
        // Start first at bat
        nextAtBat();
    }

    function updateStadiumStats() {
        document.getElementById('match-counter').textContent = `å‰©é¤˜å ´æ¬¡: ${GameState.matchesLeft}`;
        document.getElementById('match-stats-display').textContent = `æœ¬å­£æ‰“æ“Šç‡: ${document.getElementById('stat-avg').textContent}`;
    }

    function nextAtBat() {
        GameState.batting.atBatCount++;
        
        if (GameState.batting.atBatCount > 3) {
            // End of Game logic
            endMatchLogic();
            return;
        }

        // Reset UI for new pitch
        document.getElementById('ab-counter').textContent = `ç¬¬ ${GameState.batting.atBatCount} æ‰“å¸­`;
        elResultText.style.display = 'none';
        elBtnNextAB.classList.add('hidden');
        elBtnSwing.classList.remove('hidden');
        elBtnSwing.disabled = false;
        elBtnSwing.textContent = "æ® æ£’ !";
        
        preparePitch();
    }

    function preparePitch() {
        GameState.batting.active = true;
        GameState.batting.isPitched = false;
        GameState.batting.swung = false;
        GameState.batting.ballY = 40; // Top of mound
        elBall.style.top = '40px';
        elBall.style.display = 'block';

        // Wait a random moment then pitch
        setTimeout(pitchBall, 1000 + Math.random() * 1000);
    }

    function pitchBall() {
        if (!GameState.batting.active) return;
        GameState.batting.isPitched = true;
        
        // Ball speed (pixels per frame approx)
        // Harder rounds = faster ball? For now constant but varied slightly
        const baseSpeed = 5 + (Math.random() * 2); 
        GameState.batting.ballSpeed = baseSpeed;

        requestAnimationFrame(gameLoop);
    }

    function gameLoop() {
        if (!GameState.batting.active || !GameState.batting.isPitched || GameState.batting.swung) return;

        GameState.batting.ballY += GameState.batting.ballSpeed;
        elBall.style.top = GameState.batting.ballY + 'px';

        // Check if ball passed home plate without swing
        if (GameState.batting.ballY > 500) {
            handleSwingResult("MISS");
        } else {
            requestAnimationFrame(gameLoop);
        }
    }

    // Keyboard support
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && elStadium.style.display === 'flex' && !elBtnSwing.disabled) {
            attemptSwing();
        }
    });

    function attemptSwing() {
        if (!GameState.batting.isPitched || GameState.batting.swung) return;
        
        GameState.batting.swung = true;
        elBtnSwing.disabled = true;

        // Calculate Timing
        // Perfect zone: Ball Y around 420-460 (Center of home plate area at bottom)
        // Field Height 500. Home plate area starts ~380 to 480.
        // Let's define the sweet spot.
        
        const ballPos = GameState.batting.ballY;
        
        // Hit Window Logic
        // Contact stat increases the sweet spot size.
        // Base Sweet Spot: 400 - 450
        const contactBonus = (GameState.stats.contact / MAX_STAT) * 30; // Up to 30px bigger
        const sweetCenter = 430;
        const sweetRadius = 25 + contactBonus; 
        
        const dist = Math.abs(ballPos - sweetCenter);

        if (dist <= sweetRadius) {
            // HIT
            handleSwingResult("HIT");
        } else if (dist <= sweetRadius + 40) {
            // Slightly off
            if (ballPos < sweetCenter) handleSwingResult("EARLY"); // Too early (ball high)
            else handleSwingResult("LATE"); // Too late (ball low)
        } else {
            // Way off
            handleSwingResult("MISS");
        }
    }

    function handleSwingResult(resultType) {
        GameState.batting.active = false;
        GameState.records.ab++;
        
        let text = "";
        let color = "white";

        if (resultType === "MISS") {
            GameState.records.so++;
            text = "ä¸‰æŒ¯ (æ®ç©º)";
            color = "#bdc3c7";
            log("æ®æ£’è½ç©ºï¼Œä¸‰æŒ¯å‡ºå±€ã€‚");
        } 
        else if (resultType === "EARLY") {
            text = "æ»¾åœ°çƒå‡ºå±€ (å¤ªæ—©)";
            color = "#f39c12";
            log("å¤ªæ—©æ®æ£’ï¼Œæ‰“æˆäº†å…§é‡æ»¾åœ°çƒå‡ºå±€ã€‚");
        }
        else if (resultType === "LATE") {
            text = "æ¥æ®ºå‡ºå±€ (å¤ªæ™š)";
            color = "#f39c12";
            log("å¤ªæ™šæ®æ£’ï¼Œæ‰“æˆäº†ç„¡åŠ›çš„é£›çƒè¢«æ¥æ®ºã€‚");
        }
        else if (resultType === "HIT") {
            GameState.records.h++;
            color = "#e74c3c"; // Red for excitement
            
            // Determine Hit Type based on stats (Power/Run)
            const outcome = calculateHitOutcome();
            text = outcome.label;
            
            log(outcome.logMsg, "log-success");
        }

        // Show Result
        elResultText.textContent = text;
        elResultText.style.color = color;
        elResultText.style.display = 'block';
        elBall.style.display = 'none';

        // Prepare next button
        elBtnSwing.classList.add('hidden');
        
        if (GameState.batting.atBatCount < 3) {
            elBtnNextAB.classList.remove('hidden');
        } else {
            elBtnEndMatch.classList.remove('hidden');
        }
    }

    function calculateHitOutcome() {
        // Logic from V2, applied only when contact is made
        // Base weights
        let wSingle = 60;
        let wDouble = 15;
        let wTriple = 2; 
        let wHR = 5;

        // Stat Modifiers
        wHR += (GameState.stats.power / MAX_STAT) * 30; 
        wTriple += (GameState.stats.run / MAX_STAT) * 20; 
        wDouble += (GameState.stats.power / MAX_STAT) * 10; 

        // Constraint: HR reduced 30% -> to 2B
        const reducedAmount = wHR * 0.30;
        wHR = wHR * 0.70;
        wDouble += reducedAmount;

        const totalWeight = wSingle + wDouble + wTriple + wHR;
        const roll = Math.random() * totalWeight;

        let rbi = 0;
        
        if (roll < wHR) {
            GameState.records.hr++;
            GameState.records.tb += 4;
            rbi = 1 + Math.floor(Math.random() * 3);
            GameState.records.rbi += rbi;
            return { label: "å…¨å£˜æ‰“!!!", logMsg: `ğŸ”¥ å®Œç¾çš„æ“Šçƒï¼å…¨å£˜æ‰“ï¼ (+${rbi}æ‰“é»)` };
        } else if (roll < wHR + wTriple) {
            GameState.records.tb += 3;
            rbi = Math.floor(Math.random() * 2);
            GameState.records.rbi += rbi;
            return { label: "ä¸‰å£˜å®‰æ‰“!", logMsg: "æ‰“ç©¿äº†å¤–é‡é˜²ç·šï¼ç‹‚å¥”ä¸Šä¸‰å£˜ï¼" };
        } else if (roll < wHR + wTriple + wDouble) {
            GameState.records.tb += 2;
            rbi = Math.floor(Math.random() * 2);
            GameState.records.rbi += rbi;
            return { label: "äºŒå£˜å®‰æ‰“!", logMsg: "å¼·å‹çš„äºŒå£˜å®‰æ‰“ï¼" };
        } else {
            GameState.records.tb += 1;
            return { label: "ä¸€å£˜å®‰æ‰“", logMsg: "å·§å¦™çš„å®‰æ‰“ä¸Šå£˜ã€‚" };
        }
    }

    function endMatchLogic() {
        elStadium.style.display = 'none';
        elBtnEndMatch.classList.add('hidden');
        
        GameState.records.gamesPlayed++;
        GameState.matchesLeft--;
        updateStatsUI();

        if (GameState.matchesLeft === 0) {
            if (GameState.round < 3) {
                setPhase('post-season');
                log("æœ¬å­£è³½ç¨‹çµæŸï¼è«‹é€²è¡Œå­£å¾Œä¼‘æ¯èª¿æ•´ã€‚", "log-success");
            } else {
                endGame();
            }
        } else {
             elDay.textContent = `å‰©é¤˜å ´æ¬¡: ${GameState.matchesLeft}`;
             log(`æ¯”è³½çµæŸã€‚`, "");
        }
    }
    
    function endMatch() {
        endMatchLogic();
    }

    function endSeasonRest() {
        log("ç¶“éäº†10å¤©çš„ä¼‘é¤Šï¼Œèº«é«”ç‹€æ³æ¢å¾©äº†ã€‚", "log-success");
        GameState.round++;
        GameState.day = 1;
        setPhase('training');
    }

    function endGame() {
        setPhase('game-over');
        elRound.textContent = "å‚³å¥‡èª•ç”Ÿ";
        elDay.textContent = "ç”Ÿæ¶¯çµæŸ";

        let totalScore = GameState.stats.power + GameState.stats.contact + GameState.stats.defense + GameState.stats.run;
        let rank = "D";
        if (totalScore > 800) rank = "S";
        else if (totalScore > 650) rank = "A";
        else if (totalScore > 500) rank = "B";
        else if (totalScore > 350) rank = "C";

        const html = `
            <div style="text-align:center; padding: 20px;">
                <h2 style="color:var(--stadium-green)">é¤ŠæˆçµæŸï¼</h2>
                <p>çƒå“¡: ${GameState.playerName}</p>
                <div style="font-size: 5em; font-weight: bold; color: var(--accent);">${rank}</div>
                <hr>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; padding: 0 20px;">
                    <div>æ‰“æ“Šç‡: ${document.getElementById('stat-avg').textContent}</div>
                    <div>OPS: ${document.getElementById('stat-ops').textContent}</div>
                    <div>å…¨å£˜æ‰“: ${GameState.records.hr}</div>
                    <div>å®‰æ‰“æ•¸: ${GameState.records.h}</div>
                    <div>ç¸½èƒ½åŠ›: ${totalScore}</div>
                </div>
            </div>
        `;
        elLog.innerHTML = html;
    }

</script>
</body>
</html>
