<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>實況野球風格 - 傳奇野手養成</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --highlight: #f1c40f;
            --bg-color: #ecf0f1;
            --panel-bg: #ffffff;
            --stadium-green: #27ae60;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary);
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .game-container {
            width: 800px;
            background: var(--bg-color);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            overflow: hidden;
            display: grid;
            grid-template-rows: 60px 1fr 150px;
        }
        /* Header */
        header {
            background: var(--primary);
            color: white;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            border-bottom: 4px solid var(--highlight);
        }
        .status-badge {
            background: var(--accent);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        /* Main Content */
        main {
            padding: 20px;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }
        
        /* Stats Panel */
        .stats-panel {
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stat-row {
            margin-bottom: 15px;
        }
        .stat-label {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-bar-bg {
            background: #ddd;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }
        .stat-bar-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
        .fill-power { background: #e74c3c; }
        .fill-contact { background: #f39c12; }
        .fill-defense { background: #3498db; }
        .fill-run { background: #9b59b6; }

        /* Game Screen */
        .game-screen {
            background: var(--panel-bg);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .dialog-box {
            flex-grow: 1;
            border: 2px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            background: #fff;
            margin-bottom: 10px;
            overflow-y: auto;
            height: 200px;
            font-size: 0.95em;
            line-height: 1.5;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .log-highlight { color: var(--accent); font-weight: bold; }
        .log-success { color: var(--stadium-green); font-weight: bold; }
        
        /* Season Stats Mini View */
        .season-stats {
            background: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            text-align: center;
        }

        /* Controls */
        .controls {
            background: #dcdcdc;
            padding: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            border-top: 1px solid #bbb;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            font-size: 1em;
            min-width: 100px;
        }
        button:active { transform: scale(0.95); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-train { background: var(--primary); color: white; }
        .btn-train:hover { background: #34495e; }
        
        .btn-rest { background: var(--stadium-green); color: white; }
        .btn-rest:hover { background: #219150; }

        .btn-next { background: var(--highlight); color: #333; width: 100%; font-size: 1.2em;}

        /* Warning Modal */
        #warning-msg {
            color: red;
            font-weight: bold;
            text-align: center;
            margin-top: 5px;
            height: 20px;
            visibility: hidden;
        }

    </style>
</head>
<body>

<div class="game-container">
    <header>
        <div id="round-display">第 1 輪養成</div>
        <div id="day-display">第 1 天 / 90</div>
        <div class="status-badge" id="phase-display">訓練期</div>
    </header>

    <main>
        <div class="stats-panel">
            <h3>球員能力</h3>
            <div class="stat-row">
                <div class="stat-label"><span>Power (力量)</span> <span id="val-power">10</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill fill-power" id="bar-power"></div></div>
            </div>
            <div class="stat-row">
                <div class="stat-label"><span>Contact (技巧)</span> <span id="val-contact">10</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill fill-contact" id="bar-contact"></div></div>
            </div>
            <div class="stat-row">
                <div class="stat-label"><span>Defense (守備)</span> <span id="val-defense">10</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill fill-defense" id="bar-defense"></div></div>
            </div>
            <div class="stat-row">
                <div class="stat-label"><span>Run (跑壘)</span> <span id="val-run">10</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill fill-run" id="bar-run"></div></div>
            </div>
            <hr>
            <h3>本季成績</h3>
            <div class="season-stats">
                <div>打擊率<br><span id="stat-avg">.000</span></div>
                <div>全壘打<br><span id="stat-hr">0</span></div>
                <div>打點<br><span id="stat-rbi">0</span></div>
                <div>OPS<br><span id="stat-ops">.000</span></div>
            </div>
        </div>

        <div class="game-screen">
            <div class="dialog-box" id="game-log">
                <div class="log-entry">歡迎來到實況野球養成計畫！請選擇今天的訓練項目。</div>
            </div>
            <div id="warning-msg">⚠ 警告：連續訓練同一項目效率會大幅降低！</div>
        </div>
    </main>

    <div class="controls" id="control-panel">
        </div>
</div>

<script>
    // Game State
    const GameState = {
        round: 1, // 1, 2, 3
        day: 1,
        totalDaysPerRound: 90,
        phase: 'training', // 'training', 'rest', 'match', 'end'
        subCycleDay: 1, // Tracks the 20 train / 10 rest cycle
        
        stats: {
            power: 10,
            contact: 10,
            defense: 10,
            run: 10
        },
        
        records: {
            gamesPlayed: 0,
            ab: 0, // At Bats
            h: 0,  // Hits
            hr: 0, // Home Runs
            tb: 0, // Total Bases
            rbi: 0,
            bb: 0, // Walks
            so: 0  // Strike Outs
        },

        lastTraining: null,
        warningActive: false,
        
        matchConfig: {
            1: 20,
            2: 30,
            3: 60
        },
        matchesLeft: 0
    };

    // UI Elements
    const elPower = document.getElementById('val-power');
    const elContact = document.getElementById('val-contact');
    const elDefense = document.getElementById('val-defense');
    const elRun = document.getElementById('val-run');
    const elLog = document.getElementById('game-log');
    const elControls = document.getElementById('control-panel');
    const elRound = document.getElementById('round-display');
    const elDay = document.getElementById('day-display');
    const elPhase = document.getElementById('phase-display');
    const elWarning = document.getElementById('warning-msg');

    // Constants
    const MAX_STAT = 255; // Traditional cap
    
    // --- Core Functions ---

    function initGame() {
        updateStatsUI();
        setPhase('training');
    }

    function log(msg, type='') {
        const div = document.createElement('div');
        div.className = 'log-entry ' + type;
        div.innerHTML = msg;
        elLog.prepend(div);
    }

    function updateStatsUI() {
        elPower.textContent = GameState.stats.power;
        elContact.textContent = GameState.stats.contact;
        elDefense.textContent = GameState.stats.defense;
        elRun.textContent = GameState.stats.run;

        document.getElementById('bar-power').style.width = (GameState.stats.power / MAX_STAT * 100) + '%';
        document.getElementById('bar-contact').style.width = (GameState.stats.contact / MAX_STAT * 100) + '%';
        document.getElementById('bar-defense').style.width = (GameState.stats.defense / MAX_STAT * 100) + '%';
        document.getElementById('bar-run').style.width = (GameState.stats.run / MAX_STAT * 100) + '%';
        
        // Update Scoreboard
        let avg = GameState.records.ab === 0 ? 0 : GameState.records.h / GameState.records.ab;
        let obp = (GameState.records.ab + GameState.records.bb) === 0 ? 0 : (GameState.records.h + GameState.records.bb) / (GameState.records.ab + GameState.records.bb);
        let slg = GameState.records.ab === 0 ? 0 : GameState.records.tb / GameState.records.ab;
        let ops = obp + slg;

        document.getElementById('stat-avg').textContent = avg.toFixed(3).replace(/^0+/, '');
        document.getElementById('stat-hr').textContent = GameState.records.hr;
        document.getElementById('stat-rbi').textContent = GameState.records.rbi;
        document.getElementById('stat-ops').textContent = ops.toFixed(3).replace(/^0+/, '');
    }

    function setPhase(phase) {
        GameState.phase = phase;
        elPhase.textContent = phase === 'training' ? '訓練期' : (phase === 'rest' ? '休息週' : '賽季中');
        elRound.textContent = `第 ${GameState.round} 輪養成`;
        
        if (phase === 'match') {
            elDay.textContent = `剩餘場次: ${GameState.matchesLeft}`;
        } else {
            elDay.textContent = `第 ${GameState.day} 天 / 90`;
        }
        
        renderControls();
    }

    function renderControls() {
        elControls.innerHTML = '';
        elWarning.style.visibility = 'hidden';

        if (GameState.phase === 'training') {
            const trainings = [
                { id: 'power', label: '重量訓練 (Power)', color: '#e74c3c' },
                { id: 'contact', label: '打擊練習 (Contact)', color: '#f39c12' },
                { id: 'defense', label: '守備練習 (Defense)', color: '#3498db' },
                { id: 'run', label: '衝刺訓練 (Run)', color: '#9b59b6' }
            ];

            trainings.forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'btn-train';
                btn.textContent = t.label;
                btn.style.borderLeft = `5px solid ${t.color}`;
                btn.onclick = () => handleTraining(t.id);
                elControls.appendChild(btn);
            });
        } else if (GameState.phase === 'rest') {
            const rests = [
                { id: 'shop', label: '逛街' },
                { id: 'movie', label: '看電影' },
                { id: 'date', label: '交友' },
                { id: 'book', label: '看書' },
                { id: 'eat', label: '吃大餐' }
            ];
            rests.forEach(r => {
                const btn = document.createElement('button');
                btn.className = 'btn-rest';
                btn.textContent = r.label;
                btn.onclick = () => handleRest(r.id);
                elControls.appendChild(btn);
            });
        } else if (GameState.phase === 'match') {
            const btn = document.createElement('button');
            btn.className = 'btn-next';
            btn.textContent = '進行下一場比賽';
            btn.onclick = () => playMatch();
            elControls.appendChild(btn);
        } else if (GameState.phase === 'post-season') {
            const btn = document.createElement('button');
            btn.className = 'btn-next';
            btn.textContent = '進入 10 天季後休息';
            btn.onclick = () => endSeasonRest();
            elControls.appendChild(btn);
        } else if (GameState.phase === 'game-over') {
            const btn = document.createElement('button');
            btn.className = 'btn-next';
            btn.textContent = '重新開始';
            btn.onclick = () => location.reload();
            elControls.appendChild(btn);
        }
    }

    // --- Actions ---

    function handleTraining(type) {
        // Warning Check
        if (GameState.lastTraining === type) {
            if (!GameState.warningActive) {
                GameState.warningActive = true;
                elWarning.style.visibility = 'visible';
                log("教練：還練這個？身體會壞掉的！(再次點擊將強制訓練並扣數值)", "log-highlight");
                return;
            } else {
                // Punishment
                GameState.stats[type] = Math.max(0, GameState.stats[type] - 5);
                log(`你無視警告強行訓練...身體受傷了！ ${type} -5`, "log-highlight");
                GameState.warningActive = false;
                advanceDay();
                updateStatsUI();
                return;
            }
        }

        // Normal Training
        GameState.lastTraining = type;
        GameState.warningActive = false;
        
        let gain = Math.floor(Math.random() * 3) + 3; // 3 to 5
        
        // Small chance for "Great Practice"
        if (Math.random() < 0.1) {
            gain += 5;
            log(`狀態絕佳！訓練效果超群！ ${type} +${gain}`, "log-success");
        } else {
            log(`進行了${type}訓練。 ${type} +${gain}`);
        }

        GameState.stats[type] = Math.min(MAX_STAT, GameState.stats[type] + gain);
        
        updateStatsUI();
        advanceDay();
    }

    function handleRest(type) {
        GameState.lastTraining = null; // Reset streak
        let msg = "";
        let bonus = "";

        const rand = Math.random();
        
        switch(type) {
            case 'shop':
                msg = "去商店街逛了一整天，心情放鬆了。";
                if (rand < 0.3) { GameState.stats.run += 2; bonus = "買到了好鞋子 (Run+2)"; }
                break;
            case 'movie':
                msg = "看了一場感人的棒球電影。";
                if (rand < 0.3) { GameState.stats.power += 2; bonus = "熱血沸騰 (Power+2)"; }
                break;
            case 'date':
                msg = "和朋友出去玩，紓解了壓力。";
                if (rand < 0.2) { GameState.stats.contact += 3; bonus = "聊到了打擊技巧 (Contact+3)"; }
                break;
            case 'book':
                msg = "在圖書館安靜地看書。";
                if (rand < 0.4) { GameState.stats.defense += 2; bonus = "學習了戰術 (Defense+2)"; }
                break;
            case 'eat':
                msg = "去吃了一頓高級燒肉！";
                if (rand < 0.5) { GameState.stats.power += 1; GameState.stats.contact += 1; bonus = "體力恢復 (All+1)"; }
                break;
        }

        log(bonus ? `${msg} <b>${bonus}</b>` : msg, bonus ? "log-success" : "");
        advanceDay();
        updateStatsUI();
    }

    function advanceDay() {
        GameState.day++;
        GameState.subCycleDay++;

        // Logic for 20 days train / 10 days rest
        // The subCycle is 30 days total.
        // Days 1-20: Train
        // Days 21-30: Rest
        
        // Calculate current position in the 30-day sub-cycle
        // (GameState.day - 1) % 30 gives 0 to 29.
        // 0-19: Train (20 days)
        // 20-29: Rest (10 days)

        const dayInCycle = (GameState.day - 1) % 30;

        // Check if we hit the limit of the round (90 days)
        if (GameState.day > 90) {
            startMatchPhase();
            return;
        }

        if (dayInCycle < 20) {
            // Training Phase
            if (GameState.phase !== 'training') {
                log("---- 假期結束，開始訓練！ ----");
                setPhase('training');
            }
        } else {
            // Rest Phase
            if (GameState.phase !== 'rest') {
                log("---- 辛苦了20天，接下來10天好好休息吧！ ----", "log-success");
                setPhase('rest');
            }
        }
        
        elDay.textContent = `第 ${GameState.day} 天 / 90`;
    }

    // --- Match Logic ---

    function startMatchPhase() {
        GameState.matchesLeft = GameState.matchConfig[GameState.round];
        setPhase('match');
        log(`== 第 ${GameState.round} 輪訓練結束，開始 ${GameState.matchesLeft} 場比賽 ==`, "log-highlight");
    }

    function playMatch() {
        if (GameState.matchesLeft <= 0) return;

        log(`--- 第 ${GameState.matchConfig[GameState.round] - GameState.matchesLeft + 1} 場比賽 ---`);
        
        // 3 At Bats per game
        for (let i = 0; i < 3; i++) {
            simulateAtBat();
        }

        GameState.records.gamesPlayed++;
        GameState.matchesLeft--;
        updateStatsUI();

        if (GameState.matchesLeft === 0) {
            // End of season
            if (GameState.round < 3) {
                setPhase('post-season');
                log("本季賽程結束！請進行季後休息調整。", "log-success");
            } else {
                endGame();
            }
        } else {
             elDay.textContent = `剩餘場次: ${GameState.matchesLeft}`;
        }
    }

    function simulateAtBat() {
        // RNG Logic based on prompt
        // Base Probability:
        // Walk: 10%
        // Hit: 30% (Distribution affected by stats)
        // Out: 60% (K vs Ground/Fly affected by Contact)

        const roll = Math.random() * 100;
        
        if (roll < 10) {
            // Walk
            GameState.records.bb++;
            log("選球眼！獲得保送上壘。", "log-success");
        } else if (roll < 40) {
            // Hit (30% chance)
            // Determine Hit Type
            // Power affects HR, Run affects 3B, Contact/Base affects 1B/2B
            
            // Normalize stats to 0-1 range roughly (max 255)
            const pRatio = GameState.stats.power / 300; 
            const rRatio = GameState.stats.run / 300;
            
            const hitRoll = Math.random();
            
            // HR Chance inside a hit
            if (hitRoll < (0.1 + pRatio)) {
                // Home Run
                GameState.records.ab++;
                GameState.records.h++;
                GameState.records.hr++;
                GameState.records.rbi += (1 + Math.floor(Math.random() * 3)); // 1-4 RBI
                GameState.records.tb += 4;
                log(" 全壘打！！球飛出了場外！", "log-highlight");
            } else if (hitRoll < (0.1 + pRatio + rRatio * 0.5)) {
                // Triple (rare, needs speed)
                GameState.records.ab++;
                GameState.records.h++;
                GameState.records.rbi += Math.floor(Math.random() * 2);
                GameState.records.tb += 3;
                log("深遠安打！靠著腳程衝上了三壘！", "log-success");
            } else if (hitRoll < 0.6) {
                // Double
                GameState.records.ab++;
                GameState.records.h++;
                GameState.records.rbi += Math.floor(Math.random() * 2);
                GameState.records.tb += 2;
                log("左外野方向二壘安打。");
            } else {
                // Single
                GameState.records.ab++;
                GameState.records.h++;
                GameState.records.tb += 1;
                log("穿越內野的一壘安打。");
            }
        } else {
            // Out (60%)
            // Contact reduces Strikeouts
            const kChance = 0.5 - (GameState.stats.contact / 600); // Higher contact = lower K
            GameState.records.ab++;
            
            if (Math.random() < kChance) {
                GameState.records.so++;
                log("揮棒落空，三振出局。");
            } else {
                log("打擊出去，被接殺出局。");
            }
        }
    }

    function endSeasonRest() {
        // Simple 10 day skip text
        log("經過了10天的休養，身體狀況恢復了。", "log-success");
        GameState.round++;
        GameState.day = 1;
        setPhase('training');
    }

    function endGame() {
        setPhase('game-over');
        elRound.textContent = "傳奇誕生";
        elDay.textContent = "生涯結束";

        let totalScore = GameState.stats.power + GameState.stats.contact + GameState.stats.defense + GameState.stats.run;
        let avg = GameState.records.h / GameState.records.ab;
        let rank = "D";
        
        if (totalScore > 800) rank = "S";
        else if (totalScore > 600) rank = "A";
        else if (totalScore > 450) rank = "B";
        else if (totalScore > 300) rank = "C";

        // Bonus for HR
        if (GameState.records.hr > 50) rank += "+";

        const html = `
            <div style="text-align:center; padding: 20px;">
                <h2 style="color:var(--stadium-green)">養成結束！</h2>
                <div style="font-size: 5em; font-weight: bold; color: var(--accent);">${rank}</div>
                <p>最終評價</p>
                <hr>
                <p>生涯打擊率: .${avg.toFixed(3).split('.')[1]}</p>
                <p>生涯全壘打: ${GameState.records.hr} 支</p>
                <p>生涯打點: ${GameState.records.rbi} 分</p>
                <p>總能力值: ${totalScore}</p>
            </div>
        `;
        
        elLog.innerHTML = html;
    }

    // Start
    initGame();

</script>

</body>
</html>
