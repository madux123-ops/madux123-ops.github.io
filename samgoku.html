<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰åœ‹å¿—ï¼šæ¼¢æœ«éœ¸æ¥­ (ç™¾åæ­¦å°‡å¯¦è£ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #1a1815;
            --panel-bg: #2b2623;
            --text-color: #dcd6cc;
            --gold-color: #d4af37;
            --map-bg: #2f353b;
            --hp-green: #4caf50;
            --hp-red: #f44336;
        }
        body {
            font-family: "PMingLiU", "KaiTi", serif;
            background-color: var(--bg-color);
            background-image: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://www.transparenttextures.com/patterns/aged-paper.png');
            color: var(--text-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden; user-select: none;
        }
        
        h1 { margin: 6px 0; font-size: 1.4rem; text-shadow: 2px 2px 2px #000; letter-spacing: 4px; color: var(--gold-color); font-weight: bold; }
        button { cursor: pointer; border: 1px solid #6d5e56; transition: 0.2s; font-family: inherit; }
        button:hover { filter: brightness(1.2); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 200; justify-content: center; align-items: center; }
        .modal-box { background: #2d2d2d; padding: 20px; border: 2px solid var(--gold-color); text-align: center; box-shadow: 0 0 30px #000; max-height: 95vh; overflow-y: auto; position: relative;}

        #game-container { width: 100%; max-width: 1600px; display: none; height: 96vh; }

        /* é–‹å§‹é¸å–® */
        #start-screen { background: var(--panel-bg); padding: 40px; border: 2px solid #5d4037; text-align: center; width: 1000px; margin-top: 40px; }
        .clan-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; }
        .clan-btn { 
            padding: 15px; color: #ddd; border: 1px solid #444; background: #3e3832; 
            height: 80px; position: relative; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; font-size: 1.1rem;
            box-shadow: inset 0 0 10px #000;
        }
        .clan-btn:hover { border-color: var(--gold-color); background: #4e443e; transform: translateY(-2px); }
        .clan-desc { font-size: 0.75rem; color: #aaa; margin-top: 4px; }

        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .top-bar { display: flex; gap: 15px; background: #201c1a; padding: 5px 20px; border-y: 2px solid #5d4037; justify-content: space-between; align-items: center; }
        .stat-box { text-align: center; min-width: 60px; }
        .stat-val { font-size: 1rem; font-weight: bold; color: var(--gold-color); }
        .stat-label { font-size: 0.7rem; color: #aaa; }

        /* åœ°åœ–å€ */
        .main-content { display: grid; grid-template-columns: 1fr 300px; gap: 0; height: 100%; }
        .map-frame { background-color: var(--map-bg); position: relative; overflow: auto; cursor: grab; border-right: 2px solid #3e3832; }
        
        #road-layer { position: absolute; top: 0; left: 0; width: 1500px; height: 1400px; pointer-events: none; z-index: 0; }
        .road-line { stroke: rgba(255, 255, 255, 0.25); stroke-width: 2; stroke-dasharray: 6,4; }

        .map-grid { display: grid; grid-template-columns: repeat(42, 32px); grid-template-rows: repeat(40, 32px); width: 1500px; height: 1400px; padding: 40px; position: relative; z-index: 1; }
        .province { 
            border: 1px solid rgba(255,255,255,0.2); background: #333; color: #ccc;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; transition: 0.2s; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); border-radius: 3px;
        }
        .province:hover { transform: scale(1.3); z-index: 100; border-color: #fff; box-shadow: 0 0 15px #000; }
        .prov-name { font-size: 0.85rem; font-weight: bold; text-shadow: 1px 1px 2px #000; pointer-events: none; white-space: nowrap; z-index: 2; }
        
        /* å‹¢åŠ›é¡è‰² */
        .c-wei { background: #1565c0; color: #fff; } 
        .c-shu { background: #2e7d32; color: #fff; } 
        .c-wu { background: #c62828; color: #fff; }  
        .c-yuan { background: #f9a825; color: #000; } 
        .c-dong { background: #6a1b9a; color: #fff; } 
        .c-lu { background: #212121; border: 1px solid #ff5252; } 
        .c-others { background: #4e342e; color: #fff; }
        .c-zhang { background: #00838f; color: #fff; }
        .c-neutral { background: #546e7a; opacity: 0.5; }

        .status-direct { border: 2px solid #fff; box-shadow: inset 0 0 8px #fff; }
        .status-auto { border: 2px double #66bb6a; }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { background: var(--panel-bg); padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; z-index: 50; }
        .panel-block { background: #352e2a; padding: 10px; border: 1px solid #5d4037; }
        .action-btn { width: 100%; padding: 10px; margin-bottom: 5px; background: #4e443e; color: #e0e0e0; text-align: left; }
        
        /* æˆ°é¬¥å‹•ç•«ä»‹é¢ */
        #battle-anim-ui { display: none; width: 600px; flex-direction: column; gap: 15px; }
        .battle-stage { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 20px; border-radius: 5px; position: relative; overflow: hidden; }
        .battle-side { width: 45%; text-align: center; z-index: 2; }
        .hp-bar-bg { width: 100%; height: 10px; background: #333; margin-top: 5px; border-radius: 5px; overflow: hidden; }
        .hp-bar-fill { height: 100%; transition: width 0.3s ease-out; }
        .dmg-text { position: absolute; font-size: 1.5rem; font-weight: bold; color: #ffeb3b; text-shadow: 2px 2px 0 #b71c1c; opacity: 0; transition: 0.5s; top: 40%; left: 50%; transform: translate(-50%, -50%); z-index: 10; }
        .battle-log-live { height: 100px; background: #000; color: #0f0; font-family: monospace; overflow-y: auto; text-align: left; padding: 5px; font-size: 0.8rem; border: 1px solid #444; }

        #battle-prep-ui { display: block; width: 600px; }
        .gen-list { height: 200px; overflow-y: auto; background: #222; border: 1px solid #444; text-align: left; }
        .gen-item { padding: 5px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        
        #log-box { height: 150px; background: #111; padding: 5px; font-size: 0.8rem; color: #ccc; overflow-y: auto; }
        .close-btn { background: #444; color: #fff; padding: 5px 15px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>ä¸‰åœ‹å¿—ï¼šæ¼¢æœ«éœ¸æ¥­</h1>
        <p>å…¬å…ƒ190å¹´ Â· è‹±é›„é›†çµ Â· å¯¦åæ­¦å°‡ç‰ˆ</p>
        <div class="clan-grid" id="clan-area"></div>
    </div>

    <div id="game-container">
        <div class="top-bar">
            <div class="stat-box"><span class="stat-label">å¹´</span><div class="stat-val" id="d-year">190</div></div>
            <div class="stat-box"><span class="stat-label">é‡‘</span><div class="stat-val" id="d-gold">0</div></div>
            <div class="stat-box"><span class="stat-label">ç³§</span><div class="stat-val" id="d-food">0</div></div>
            <div class="stat-box"><span class="stat-label">å…µ</span><div class="stat-val" id="d-troops">0</div></div>
            <div class="stat-box"><span class="stat-label">åŸ</span><div class="stat-val" id="d-lands">0</div></div>
            <div style="background:#b71c1c; padding:2px 10px; color:white; font-size:0.9rem;">æ”¿ä»¤: <span id="d-ap">3</span></div>
        </div>

        <div class="main-content">
            <div class="map-frame" id="map-frame">
                <svg id="road-layer"></svg>
                <div class="map-grid" id="map-grid"></div>
            </div>

            <div class="control-panel">
                <div class="panel-block">
                    <div style="color:var(--gold-color); margin-bottom:5px; font-weight:bold;">å…§æ”¿</div>
                    <select id="gen-select" style="width:100%; margin-bottom:5px; padding:5px; background:#222; color:#fff; border:1px solid #555;"></select>
                    <button class="action-btn" onclick="doAction('comm')">ğŸ’° å•†æ¥­é–‹ç™¼ (é‡‘+)</button>
                    <button class="action-btn" onclick="doAction('agri')">ğŸŒ¾ è¾²æ¥­é–‹å¢¾ (ç³§+)</button>
                    <button class="action-btn" onclick="doAction('recruit')">âš”ï¸ å¾µå¬ç¾©å…µ (å…µ+)</button>
                </div>
                <div class="panel-block">
                    <div style="color:var(--gold-color); margin-bottom:5px; font-weight:bold;">è»äº‹</div>
                    <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">é»æ“Šç›¸é„°æ•µåŸé€²è¡Œæ”»æ“Š</div>
                </div>
                <button class="action-btn" style="text-align:center; margin-top:auto; background:#212121;" onclick="endTurn()">ğŸŒ™ çµæŸæœ¬æœˆ</button>
                <div id="log-box"></div>
            </div>
        </div>
    </div>

    <div id="battle-modal" class="modal">
        <div class="modal-box">
            <div id="battle-prep-ui">
                <h2 style="color:#e57373; margin:0 0 10px 0;">å‡ºå¾æº–å‚™</h2>
                <div style="display:flex; gap:20px; text-align:left;">
                    <div style="flex:1;">
                        <h4 style="margin:5px 0; color:#64b5f6;">æˆ‘è»å‡ºé™£ (æœ€å¤š5äºº)</h4>
                        <div class="gen-list" id="prep-gen-list"></div>
                        <div style="margin-top:5px;">å…µåŠ›: <span id="prep-troops">0</span></div>
                    </div>
                    <div style="flex:1; border-left:1px solid #444; padding-left:10px;">
                        <h4 style="margin:5px 0; color:#e57373;">æ•µæ–¹æƒ…å ±</h4>
                        <div id="prep-enemy-info" style="font-size:0.9rem; line-height:1.6;"></div>
                    </div>
                </div>
                <div style="margin-top:20px;">
                    <button style="background:#d32f2f; color:white; padding:10px 30px; font-size:1.1rem; border:none;" onclick="startBattleAnim()">é–‹æˆ°</button>
                    <button class="close-btn" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            </div>

            <div id="battle-anim-ui">
                <h2 style="color:#ffeb3b; margin:0;">å…©è»äº¤æˆ°</h2>
                <div class="battle-stage">
                    <div class="dmg-text" id="dmg-popup">-0</div>
                    <div class="battle-side">
                        <div style="color:#64b5f6; font-weight:bold; font-size:1.2rem;">æˆ‘è»</div>
                        <div style="font-size:0.9rem;" id="anim-p-name"></div>
                        <div class="hp-bar-bg"><div class="hp-bar-fill" id="p-hp-bar" style="width:100%; background:var(--hp-green);"></div></div>
                        <div id="p-hp-text">5000</div>
                    </div>
                    <div style="color:#aaa; font-weight:bold; font-size:1.5rem;">VS</div>
                    <div class="battle-side">
                        <div style="color:#e57373; font-weight:bold; font-size:1.2rem;">æ•µè»</div>
                        <div style="font-size:0.9rem;" id="anim-e-name"></div>
                        <div class="hp-bar-bg"><div class="hp-bar-fill" id="e-hp-bar" style="width:100%; background:var(--hp-red);"></div></div>
                        <div id="e-hp-text">3000</div>
                    </div>
                </div>
                <div class="battle-log-live" id="battle-live-log"></div>
                <button id="battle-end-btn" style="display:none; width:100%; padding:10px;" onclick="finalizeBattle()">ç¢ºèªçµæœ</button>
            </div>
        </div>
    </div>

    <div id="end-modal" class="modal">
        <div class="modal-box">
            <h2 id="end-title" style="color:var(--gold-color);"></h2>
            <p id="end-msg"></p>
            <button class="close-btn" onclick="location.reload()">é‡æ–°é–‹å§‹</button>
        </div>
    </div>

<script>
    // åŸå¸‚æ•¸æ“š
    const CITIES = [
        {id:1,n:"è¥„å¹³",r:2,c:34}, {id:51,n:"é¼è¥¿",r:3,c:32}, {id:2,n:"åŒ—å¹³",r:4,c:30}, {id:3,n:"è–Š",r:5,c:29},
        {id:4,n:"å—çš®",r:7,c:29}, {id:5,n:"é„´",r:9,c:28}, {id:6,n:"æ™‰é™½",r:7,c:26}, {id:7,n:"å¹³åŸ",r:9,c:30},
        {id:8,n:"åŒ—æµ·",r:9,c:33}, {id:9,n:"æ¿®é™½",r:11,c:29}, {id:10,n:"é™³ç•™",r:12,c:28},
        {id:11,n:"æ´›é™½",r:12,c:25}, {id:48,n:"è™ç‰¢",r:12,c:27},
        {id:12,n:"è¨±æ˜Œ",r:14,c:26}, {id:13,n:"æ±å—",r:16,c:28},
        {id:14,n:"ä¸‹é‚³",r:13,c:32}, {id:15,n:"å°æ²›",r:12,c:31}, {id:16,n:"å»£é™µ",r:15,c:34},
        {id:17,n:"å£½æ˜¥",r:16,c:31}, {id:47,n:"æ–°é‡",r:16,c:25}, {id:18,n:"å®›",r:15,c:24},
        {id:19,n:"é•·å®‰",r:13,c:22}, {id:20,n:"å¤©æ°´",r:11,c:18}, {id:21,n:"å®‰å®š",r:10,c:20},
        {id:52,n:"é‡‘åŸ",r:9,c:16}, {id:22,n:"æ­¦å¨",r:7,c:14}, {id:23,n:"è¥¿å¹³",r:8,c:12},
        {id:24,n:"æ¼¢ä¸­",r:15,c:20}, {id:49,n:"è‘­èŒ",r:16,c:18},
        {id:25,n:"æ¢“æ½¼",r:17,c:17}, {id:26,n:"æˆéƒ½",r:19,c:16},
        {id:27,n:"æ±Ÿå·",r:20,c:20}, {id:30,n:"æ°¸å®‰",r:19,c:22},
        {id:50,n:"è¶Šå¶²",r:23,c:16}, {id:28,n:"å»ºå¯§",r:26,c:16}, {id:29,n:"é›²å—",r:28,c:13},
        {id:31,n:"ä¸Šåº¸",r:14,c:23}, {id:32,n:"è¥„é™½",r:17,c:24}, {id:33,n:"æ±Ÿå¤",r:19,c:27},
        {id:34,n:"æ±Ÿé™µ",r:20,c:24}, {id:35,n:"é•·æ²™",r:23,c:26}, {id:36,n:"æ­¦é™µ",r:22,c:23},
        {id:37,n:"é›¶é™µ",r:26,c:24}, {id:38,n:"æ¡‚é™½",r:26,c:27},
        {id:39,n:"å»¬æ±Ÿ",r:18,c:30}, {id:40,n:"å»ºæ¥­",r:18,c:33}, {id:41,n:"å³",r:19,c:35},
        {id:42,n:"æœƒç¨½",r:21,c:36}, {id:43,n:"æŸ´æ¡‘",r:22,c:29}, {id:44,n:"è±«ç« ",r:24,c:30},
        {id:45,n:"å—æµ·",r:29,c:28}, {id:46,n:"äº¤è¶¾",r:31,c:25}
    ];

    // 12åå›ä¸»
    const LORDS = {
        cao: { n: "æ›¹æ“", desc:"æ²»ä¸–èƒ½è‡£", c: "c-wei", cities: [10, 12, 48] },
        liu: { n: "åŠ‰å‚™", desc:"ä»å¾·ä¹‹å›", c: "c-shu", cities: [7] },
        sun: { n: "å­«å …", desc:"æ±Ÿæ±çŒ›è™", c: "c-wu", cities: [35] },
        yuan: { n: "è¢ç´¹", desc:"å››ä¸–ä¸‰å…¬", c: "c-yuan", cities: [4, 5, 2] },
        dong: { n: "è‘£å“", desc:"é­”ç‹é™è‡¨", c: "c-dong", cities: [11, 19, 21] },
        lu: { n: "å‘‚å¸ƒ", desc:"å¤©ä¸‹ç„¡é›™", c: "c-lu", cities: [9] },
        ma: { n: "é¦¬é¨°", desc:"è¥¿æ¶¼éµé¨", c: "c-others", cities: [22, 23, 52] },
        biao: { n: "åŠ‰è¡¨", desc:"é®å®ˆèŠè¥„", c: "c-others", cities: [32, 33, 47] },
        zhang: { n: "åŠ‰ç’‹", desc:"å¤©åºœä¹‹åœŸ", c: "c-others", cities: [26, 25, 49] },
        shu: { n: "è¢è¡“", desc:"ä»²å®¶çš‡å¸", c: "c-others", cities: [13, 17] },
        gong: { n: "å…¬å­«ç“š", desc:"ç™½é¦¬ç¾©å¾", c: "c-others", cities: [3, 51] },
        z_lu: { n: "å¼µé­¯", desc:"äº”æ–—ç±³é“", c: "c-zhang", cities: [24] },
        iné‡: { n: "åœ¨é‡", desc:"", c: "c-neutral", cities: [] }
    };

    // å¯¦åæ­¦å°‡è³‡æ–™åº« (w:çµ±æ­¦, o:åˆå§‹æ­¸å±¬)
    const HISTORICAL_GENS = [
        // é­ (æ›¹æ“)
        {n:"æ›¹æ“",w:99,o:"cao"}, {n:"å¤ä¾¯æƒ‡",w:92,o:"cao"}, {n:"å¤ä¾¯æ·µ",w:91,o:"cao"}, {n:"æ›¹ä»",w:89,o:"cao"}, 
        {n:"æ›¹æ´ª",w:86,o:"cao"}, {n:"æå…¸",w:82,o:"cao"}, {n:"æ¨‚é€²",w:85,o:"cao"}, {n:"è€å½§",w:60,o:"cao"},
        {n:"éƒ­å˜‰",w:50,o:"cao"}, {n:"äºç¦",w:84,o:"cao"}, {n:"å…¸éŸ‹",w:98,o:"cao"},
        // èœ€ (åŠ‰å‚™)
        {n:"åŠ‰å‚™",w:80,o:"liu"}, {n:"é—œç¾½",w:97,o:"liu"}, {n:"å¼µé£›",w:98,o:"liu"}, {n:"ç°¡é›",w:60,o:"liu"},
        {n:"é—œå¹³",w:82,o:"liu"}, {n:"å‘¨å€‰",w:81,o:"liu"},
        // å³ (å­«å …)
        {n:"å­«å …",w:94,o:"sun"}, {n:"å­«ç­–",w:95,o:"sun"}, {n:"å­«æ¬Š",w:78,o:"sun"}, {n:"é»ƒè“‹",w:83,o:"sun"},
        {n:"ç¨‹æ™®",w:84,o:"sun"}, {n:"éŸ“ç•¶",w:82,o:"sun"}, {n:"æœ±æ²»",w:75,o:"sun"}, {n:"ç¥–èŒ‚",w:78,o:"sun"},
        // è¢ç´¹
        {n:"è¢ç´¹",w:82,o:"yuan"}, {n:"é¡è‰¯",w:94,o:"yuan"}, {n:"æ–‡é†œ",w:95,o:"yuan"}, {n:"å¼µéƒƒ",w:90,o:"yuan"},
        {n:"é«˜è¦½",w:87,o:"yuan"}, {n:"é ç¾©",w:85,o:"yuan"}, {n:"ç”°è±",w:70,o:"yuan"}, {n:"æ²®æˆ",w:72,o:"yuan"},
        // è‘£å“
        {n:"è‘£å“",w:88,o:"dong"}, {n:"è¯é›„",w:92,o:"dong"}, {n:"æå„’",w:60,o:"dong"}, {n:"æå‚•",w:78,o:"dong"},
        {n:"éƒ­æ±œ",w:76,o:"dong"}, {n:"å¾æ¦®",w:82,o:"dong"}, {n:"æ¨Šç¨ ",w:75,o:"dong"},
        // å‘‚å¸ƒ
        {n:"å‘‚å¸ƒ",w:100,o:"lu"}, {n:"å¼µé¼",w:94,o:"lu"}, {n:"é«˜é †",w:88,o:"lu"}, {n:"é™³å®®",w:70,o:"lu"},
        {n:"è‡§éœ¸",w:81,o:"lu"}, {n:"é­çºŒ",w:75,o:"lu"},
        // é¦¬é¨°
        {n:"é¦¬é¨°",w:84,o:"ma"}, {n:"é¦¬è¶…",w:97,o:"ma"}, {n:"é¾å¾·",w:93,o:"ma"}, {n:"é¦¬å²±",w:85,o:"ma"},
        // åŠ‰è¡¨
        {n:"åŠ‰è¡¨",w:68,o:"biao"}, {n:"è”¡ç‘",w:78,o:"biao"}, {n:"å¼µå…",w:75,o:"biao"}, {n:"é»ƒç¥–",w:74,o:"biao"},
        {n:"æ–‡è˜",w:86,o:"biao"}, {n:"é»ƒå¿ ",w:95,o:"biao"}, {n:"ç”˜å¯§",w:94,o:"biao"}, {n:"é­å»¶",w:92,o:"biao"},
        // åŠ‰ç’‹
        {n:"åŠ‰ç’‹",w:50,o:"zhang"}, {n:"å¼µä»»",w:89,o:"zhang"}, {n:"åš´é¡",w:85,o:"zhang"}, {n:"æåš´",w:84,o:"zhang"},
        {n:"é›·éŠ…",w:78,o:"zhang"}, {n:"å³è˜­",w:77,o:"zhang"},
        // è¢è¡“
        {n:"è¢è¡“",w:65,o:"shu"}, {n:"ç´€éˆ",w:83,o:"shu"}, {n:"å¼µå‹³",w:72,o:"shu"}, {n:"æ©‹è•¤",w:70,o:"shu"},
        // å…¬å­«ç“š
        {n:"å…¬å­«ç“š",w:84,o:"gong"}, {n:"è¶™é›²",w:96,o:"gong"}, {n:"åš´ç¶±",w:78,o:"gong"}, {n:"ç”°æ¥·",w:72,o:"gong"},
        // å¼µé­¯
        {n:"å¼µé­¯",w:70,o:"z_lu"}, {n:"é–»åœƒ",w:68,o:"z_lu"}, {n:"æ¥Šä»»",w:76,o:"z_lu"}, {n:"æ¥Šæ˜‚",w:74,o:"z_lu"},
        // åœ¨é‡ (éš¨æ©Ÿå‡ºç¾æˆ–ç‰¹å®šåœ°é»ï¼Œæ­¤è™•ç°¡åŒ–ç‚ºçµ±ä¸€åœ¨é‡æ± æˆ–åˆ†é…çµ¦ç©ºåŸ)
        {n:"è¨±è¤š",w:96,o:"iné‡"}, {n:"å¾æ™ƒ",w:91,o:"iné‡"}, {n:"å¤ªå²æ…ˆ",w:93,o:"iné‡"}, {n:"å‘¨æ³°",w:90,o:"iné‡"},
        {n:"è”£æ¬½",w:84,o:"iné‡"}, {n:"é™³æ­¦",w:85,o:"iné‡"}, {n:"æ½˜ç’‹",w:82,o:"iné‡"}
    ];

    let G = {
        turn: 190, player: null, acts: 3, res: {g:2000, f:2000, t:5000},
        map: {}, gens: [], battle: {}
    };

    window.onload = () => {
        const area = document.getElementById('clan-area');
        for(let k in LORDS) {
            if(k === 'iné‡') continue;
            let d = document.createElement('div');
            d.className = `clan-btn ${LORDS[k].c}`;
            d.innerHTML = `<strong>${LORDS[k].n}</strong><div class="clan-desc">${LORDS[k].desc}</div>`;
            d.onclick = () => initGame(k);
            area.appendChild(d);
        }
    };

    function initGame(pid) {
        G.player = pid;
        // åœ°åœ–
        CITIES.forEach(c => {
            G.map[c.id] = { ...c, owner: 'iné‡', troops: 2000, def: 100, gen: null };
        });
        // å‹¢åŠ›
        for(let k in LORDS) {
            LORDS[k].cities.forEach(id => {
                if(G.map[id]) {
                    G.map[id].owner = k;
                    G.map[id].troops = (k===G.player) ? 0 : 3000; 
                }
            });
        }
        // æ­¦å°‡åˆå§‹åŒ–
        let gid = 0;
        HISTORICAL_GENS.forEach(g => {
            G.gens.push({id: gid++, n: g.n, w: g.w, o: g.o, loc: null});
        });

        drawMap();
        updateUI();
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
    }

    function drawMap() {
        const grid = document.getElementById('map-grid');
        const roadLayer = document.getElementById('road-layer');
        grid.innerHTML = ''; roadLayer.innerHTML = '';

        CITIES.forEach(c1 => {
            CITIES.forEach(c2 => {
                if(c1.id < c2.id) {
                    let dist = Math.sqrt(Math.pow(c1.r-c2.r, 2) + Math.pow(c1.c-c2.c, 2));
                    if(dist < 4.2) {
                        let line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', (c1.c-1)*32 + 40 + 16);
                        line.setAttribute('y1', (c1.r-1)*32 + 40 + 16);
                        line.setAttribute('x2', (c2.c-1)*32 + 40 + 16);
                        line.setAttribute('y2', (c2.r-1)*32 + 40 + 16);
                        line.setAttribute('class', 'road-line');
                        roadLayer.appendChild(line);
                    }
                }
            });
        });

        for(let id in G.map) {
            let c = G.map[id];
            let d = document.createElement('div');
            d.className = `province ${LORDS[c.owner].c}`;
            if(c.owner === G.player) {
                if(c.troops === 0) d.classList.add('status-direct');
                else d.classList.add('status-auto');
            }
            d.style.gridRow = c.r; d.style.gridColumn = c.c;
            d.innerHTML = `<div class="prov-name">${c.n}</div><div style="font-size:0.6rem; z-index:2;">${c.troops}</div>`;
            d.onclick = () => clickCity(id);
            grid.appendChild(d);
        }
    }

    function getNeighbors(id) {
        let n = [];
        let c1 = G.map[id];
        for(let k in G.map) {
            let c2 = G.map[k];
            if(c1.id !== c2.id) {
                let dist = Math.sqrt(Math.pow(c1.r-c2.r, 2) + Math.pow(c1.c-c2.c, 2));
                if(dist < 4.2) n.push(k);
            }
        }
        return n;
    }

    function clickCity(id) {
        let c = G.map[id];
        if(c.owner === G.player) {
            if(c.troops === 0) { c.troops = 1000; log(`å§”ä»» ${c.n}`); } 
            else { c.troops = 0; log(`æ”¶å› ${c.n} å…µåŠ›`); }
            drawMap();
        } else {
            if(G.acts <= 0) return alert("æ”¿ä»¤ä¸è¶³");
            let neighbors = getNeighbors(id);
            let canAtk = neighbors.some(nid => G.map[nid].owner === G.player);
            if(!canAtk) return alert("æœªèˆ‡æˆ‘æ–¹é ˜åœŸç›¸é€£");
            prepBattle(id);
        }
    }

    function doAction(type) {
        if(G.acts <= 0) return;
        let genId = document.getElementById('gen-select').value;
        if(!genId) return alert("ç„¡æ­¦å°‡");
        let g = G.gens.find(x=>x.id==genId);
        
        if(type==='comm') { G.res.g += 500; G.res.f -= 100; log(`${g.n} å•†æ¥­é–‹ç™¼ (é‡‘+500)`); }
        if(type==='agri') { G.res.f += 500; G.res.g -= 100; log(`${g.n} è¾²æ¥­é–‹å¢¾ (ç³§+500)`); }
        if(type==='recruit') { 
            if(G.res.g < 200) return alert("é‡‘éŒ¢ä¸è¶³");
            G.res.t += 1000; G.res.g -= 200; log(`${g.n} å¾µå…µ (å…µ+1000)`); 
        }
        G.acts--; updateUI();
    }

    function prepBattle(tid) {
        let t = G.map[tid];
        G.battle = { tid: tid, p_troops: G.res.t, e_troops: t.troops, p_gens: [], result: null };
        
        document.getElementById('battle-prep-ui').style.display = 'block';
        document.getElementById('battle-anim-ui').style.display = 'none';
        
        let guard = t.gen ? G.gens.find(g=>g.id==t.gen).n : (t.owner==='iné‡'?'æµå¯‡':`${LORDS[t.owner].n}è»`);
        document.getElementById('prep-enemy-info').innerHTML = `
            <strong>${t.n}</strong> (${LORDS[t.owner].n})<br>
            å…µåŠ›: ${t.troops}<br>å®ˆè»: ${guard}
        `;
        document.getElementById('prep-troops').innerText = G.res.t;

        let list = document.getElementById('prep-gen-list');
        list.innerHTML = '';
        G.gens.filter(g=>g.o===G.player).sort((a,b)=>b.w-a.w).forEach(g => {
            let row = document.createElement('div');
            row.className = 'gen-item';
            row.innerHTML = `<label><input type="checkbox" value="${g.id}"> ${g.n}</label><span>æ­¦${g.w}</span>`;
            list.appendChild(row);
        });
        
        document.getElementById('battle-modal').style.display = 'flex';
    }

    function startBattleAnim() {
        let cbs = document.querySelectorAll('#prep-gen-list input:checked');
        if(cbs.length === 0 || cbs.length > 5) return alert("è«‹æ´¾é£ 1-5 åæ­¦å°‡");
        if(G.res.t < 500) return alert("å…µåŠ›ä¸è¶³");

        G.battle.p_gens = Array.from(cbs).map(c=>G.gens.find(g=>g.id==c.value));
        G.acts--;

        document.getElementById('battle-prep-ui').style.display = 'none';
        document.getElementById('battle-anim-ui').style.display = 'flex';
        document.getElementById('battle-end-btn').style.display = 'none';
        document.getElementById('battle-live-log').innerHTML = '';

        let p_name = G.battle.p_gens[0].n + (G.battle.p_gens.length>1?" ç­‰":" éšŠ");
        let t = G.map[G.battle.tid];
        let e_name = t.gen ? G.gens.find(g=>g.id==t.gen).n : (t.owner==='iné‡'?'æµå¯‡':`${LORDS[t.owner].n}è»`);
        
        document.getElementById('anim-p-name').innerText = p_name;
        document.getElementById('anim-e-name').innerText = e_name;

        let p_max = G.battle.p_troops;
        let e_max = G.battle.e_troops;
        let p_curr = p_max;
        let e_curr = e_max;

        let p_war = G.battle.p_gens.reduce((a,b)=>a+b.w,0) / G.battle.p_gens.length;
        let e_war = t.gen ? G.gens.find(g=>g.id==t.gen).w : 55;
        if(t.owner !== 'iné‡') e_war += 10; 

        let round = 1;
        let timer = setInterval(() => {
            if(p_curr <= 0 || e_curr <= 0 || round > 8) {
                clearInterval(timer);
                finishAnim(p_curr, e_curr, p_max, e_max);
                return;
            }
            let p_dmg = Math.floor(p_curr * (p_war/200) * (0.8+Math.random()*0.4)) + 50;
            let e_dmg = Math.floor(e_curr * (e_war/200) * (0.8+Math.random()*0.4)) + 50;
            p_dmg = Math.floor(p_dmg * (1 - Math.min(0.5, t.def/200)));
            e_curr -= p_dmg;
            p_curr -= e_dmg;

            if(p_curr < 0) p_curr = 0;
            if(e_curr < 0) e_curr = 0;

            updateBattleAnimUI(p_curr, p_max, e_curr, e_max, p_dmg, e_dmg);
            logBattle(`ç¬¬${round}å›åˆï¼šæˆ‘è»å‚·${e_dmg}ï¼Œæ•µè»å‚·${p_dmg}`);
            round++;
        }, 1000);
    }

    function updateBattleAnimUI(p, pMax, e, eMax, pDmg, eDmg) {
        let pPct = (p / pMax) * 100;
        let ePct = (e / eMax) * 100;
        document.getElementById('p-hp-bar').style.width = pPct + "%";
        document.getElementById('e-hp-bar').style.width = ePct + "%";
        document.getElementById('p-hp-text').innerText = Math.floor(p);
        document.getElementById('e-hp-text').innerText = Math.floor(e);
        let pop = document.getElementById('dmg-popup');
        pop.innerText = `âš”ï¸ -${eDmg} / -${pDmg}`;
        pop.style.opacity = 1;
        setTimeout(() => pop.style.opacity = 0, 800);
    }

    function logBattle(msg) {
        let b = document.getElementById('battle-live-log');
        b.innerHTML += `<div>${msg}</div>`; b.scrollTop = b.scrollHeight;
    }

    function finishAnim(p, e, pMax, eMax) {
        let win = e <= 0;
        G.battle.result = { win: win, p_left: Math.floor(p), e_left: Math.floor(e) };
        let btn = document.getElementById('battle-end-btn');
        btn.style.display = 'block';
        btn.innerText = win ? "å¤§ç²å…¨å‹ - ä½”é ˜åŸæ± " : "æˆ°æ•—æ’¤é€€";
        btn.style.background = win ? "#2e7d32" : "#c62828";
        btn.style.color = "white";
    }

    function finalizeBattle() {
        let r = G.battle.result;
        let t = G.map[G.battle.tid];
        let oldOwner = t.owner;

        G.res.t = r.p_left;
        t.troops = r.e_left;

        if(r.win) {
            t.troops = 0;
            t.def = Math.max(0, t.def - 30);
            if(oldOwner !== 'iné‡') checkRetreatOrDie(oldOwner, t.id);
            t.owner = G.player;
            log(`æ”»ä½” ${t.n}ï¼`);
            // éš¨æ©Ÿç™»åº¸åœ¨é‡
            let frees = G.gens.filter(g=>g.o==='iné‡');
            if(frees.length > 0 && Math.random() < 0.3) {
                let lucky = frees[Math.floor(Math.random()*frees.length)];
                lucky.o = G.player;
                log(`åœ¨é‡æ­¦å°‡ ${lucky.n} æ…•åä¾†æŠ•ï¼`);
            }
        } else {
            log(`é€²æ”» ${t.n} å¤±æ•—...`);
        }
        closeModal(); drawMap(); updateUI();
    }

    function checkRetreatOrDie(loserId, lostCityId) {
        let hasCity = false;
        for(let id in G.map) {
            if(G.map[id].owner === loserId && id != lostCityId) { hasCity = true; break; }
        }
        if(!hasCity) {
            let retreatCity = null;
            let neighbors = getNeighbors(lostCityId);
            for(let nid of neighbors) {
                if(G.map[nid].owner === 'iné‡') { retreatCity = nid; break; }
            }
            if(retreatCity) {
                G.map[retreatCity].owner = loserId; G.map[retreatCity].troops = 1000;
                log(`ã€${LORDS[loserId].n}ã€‘æµäº¡è‡³ ${G.map[retreatCity].n}ï¼`);
            } else {
                log(`ã€${LORDS[loserId].n}ã€‘æ»…äº¡ï¼æ­¦å°‡æ­¸é™ã€‚`);
                G.gens.forEach(g => { if(g.o === loserId) g.o = G.player; });
            }
        }
    }

    function updateUI() {
        document.getElementById('d-year').innerText = G.turn;
        document.getElementById('d-gold').innerText = G.res.g;
        document.getElementById('d-food').innerText = G.res.f;
        document.getElementById('d-troops').innerText = G.res.t;
        document.getElementById('d-lands').innerText = Object.values(G.map).filter(c=>c.owner===G.player).length;
        document.getElementById('d-ap').innerText = G.acts;

        let sel = document.getElementById('gen-select');
        sel.innerHTML = '';
        G.gens.filter(g=>g.o===G.player).forEach(g => {
            let opt = document.createElement('option');
            opt.value = g.id;
            opt.innerText = `${g.n} (æ­¦${g.w})`;
            sel.appendChild(opt);
        });
    }

    function endTurn() {
        G.acts = 3; G.res.g += 500; G.res.f += 500;
        for(let id in G.map) {
            let c = G.map[id];
            if(c.owner !== 'iné‡' && c.owner !== G.player) c.troops += 200;
        }
        log("é€²å…¥ä¸‹å€‹æœˆ");
        updateUI(); drawMap();
    }

    function closeModal() { document.getElementById('battle-modal').style.display='none'; }
    function log(msg) { 
        let b = document.getElementById('log-box'); 
        b.innerHTML += `<div>> ${msg}</div>`; b.scrollTop = b.scrollHeight; 
    }
</script>
</body>
</html>