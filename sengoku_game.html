<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿¡é•·ä¹‹é‡æœ›ï¼šå…¨åœ‹ç‰ˆ (12é›„çˆ­éœ¸)</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #d32f2f;
            --gold-color: #ffb300;
            --ocean-color: #1e272e;
        }
        body {
            font-family: 'Microsoft JhengHei', serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }
        h1 { margin: 5px 0; font-size: 1.4rem; text-shadow: 2px 2px 2px #000; letter-spacing: 2px; }

        /* éŠæˆ²å®¹å™¨ */
        #game-container { width: 100%; max-width: 1600px; display: none; height: 92vh; }

        /* é–‹å§‹é¸å–® (3x4 æ’ç‰ˆ) */
        #start-screen {
            background: var(--panel-bg);
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.9);
            text-align: center;
            max-width: 900px;
            width: 95%;
            margin-top: 40px;
            border: 1px solid #444;
        }
        .difficulty-selector { margin-bottom: 25px; }
        
        .clan-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
            margin-top: 15px; 
        }
        
        .clan-btn {
            padding: 20px; 
            cursor: pointer; 
            color: white; 
            border: 1px solid #555; 
            transition: 0.2s;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            background: #333;
            min-height: 80px;
            border-radius: 4px;
        }
        .clan-btn strong { font-size: 1.1rem; margin-bottom: 4px; }
        .clan-btn small { font-size: 0.8rem; opacity: 0.8; }
        .clan-btn:hover { transform: translateY(-3px); border-color: var(--gold-color); filter: brightness(1.2); z-index: 10; }

        /* ä¸Šæ–¹è³‡è¨Šåˆ— */
        .top-bar {
            display: flex; gap: 15px; background: #252525; padding: 8px 20px;
            border-bottom: 3px solid var(--accent-color); justify-content: space-between; align-items: center;
        }
        .stat-box { text-align: center; min-width: 60px; }
        .stat-label { font-size: 0.7rem; color: #aaa; display: block; }
        .stat-val { font-size: 1.1rem; font-weight: bold; color: var(--gold-color); }
        .ap-box { background: var(--accent-color); padding: 5px 15px; border-radius: 4px; font-weight: bold; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.5);}

        /* ä¸»éŠæˆ²å€ */
        .main-content { display: grid; grid-template-columns: 1fr 320px; gap: 10px; height: 100%; padding-top: 10px;}
        
        /* åœ°åœ–æ¡†æ¶ */
        .map-frame {
            background-color: var(--ocean-color);
            border: 2px solid #444;
            position: relative;
            overflow: auto; /* å…è¨±æ²å‹• */
            border-radius: 6px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        /* ç¶²æ ¼ç³»çµ± - å·¦ç§»èª¿æ•´ */
        .map-grid {
            display: grid;
            grid-template-columns: repeat(32, minmax(35px, 1fr));
            grid-template-rows: repeat(26, minmax(35px, 1fr));
            gap: 2px;
            
            /* ä¿®æ”¹è™•ï¼šæ¸›å°‘å·¦å´ Padding ä¸¦ä½¿ç”¨è²  Margin å°‡ç©ºæµ·åŸŸç§»å‡ºè¦–é‡ */
            padding: 20px 20px 20px 0; 
            margin-left: -90px; /* å‘å·¦å¹³ç§»ï¼Œéš±è— Grid 1-3 åˆ—çš„ç©ºç™½ */
            
            width: 1200px;
            height: 950px;
        }
        .province {
            border: 1px solid rgba(255,255,255,0.15);
            background: #455a64;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; transition: 0.15s; font-size: 0.7rem;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            border-radius: 2px;
            color: #ccc;
        }
        .province:hover { border-color: #fff; z-index: 100; transform: scale(1.2); box-shadow: 0 0 10px #000;}
        .prov-name { font-weight: bold; text-shadow: 1px 1px 2px #000; pointer-events: none; white-space: nowrap; transform: scale(0.9);}
        .prov-info { font-size: 0.65rem; pointer-events: none; margin-top: 1px; color: #fff;}
        
        /* ç‹€æ…‹æ¨™è¨˜ */
        .status-direct { border: 2px solid #fff; z-index: 5; }
        .status-auto { border: 2px solid #66bb6a; z-index: 4; }
        .status-ally { border: 2px dashed #42a5f5; opacity: 0.9; }
        
        /* å‹¢åŠ›é¡è‰² (12è‰²) */
        .c-oda { background: #c62828; }         /* ç¹”ç”° - ç´… */
        .c-takeda { background: #ef6c00; }      /* æ­¦ç”° - æ©˜ */
        .c-uesugi { background: #1565c0; }      /* ä¸Šæ‰ - è— */
        .c-mori { background: #2e7d32; }        /* æ¯›åˆ© - ç¶  */
        .c-hojo { background: #6a1b9a; }        /* åŒ—æ¢ - ç´« */
        .c-date { background: #37474f; border:1px solid #90caf9;} /* ä¼Šé” - é»‘ */
        .c-shimazu { background: #f9a825; color:#000; } /* å³¶æ´¥ - é»ƒ */
        .c-chosokabe { background: #9c27b0; }   /* é•·å®—æˆ‘éƒ¨ - ç²‰ç´« */
        .c-tokugawa { background: #00695c; }    /* å¾·å· - æ·±ç¶  */
        .c-imagawa { background: #4e342e; }     /* ä»Šå· - è¤ */
        .c-otomo { background: #8d6e63; }       /* å¤§å‹ - æ£•ç° */
        .c-miyoshi { background: #c0ca33; color:#000; } /* ä¸‰å¥½ - èŠå§†ç¶  */
        .c-neutral { background: #546e7a; opacity: 0.7; }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { background: var(--panel-bg); padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; border-left: 1px solid #444; }
        .panel-block { background: #222; padding: 12px; border-radius: 4px; border: 1px solid #444; }
        .panel-header { color: #888; font-size: 0.8rem; border-bottom: 1px solid #444; margin-bottom: 8px; padding-bottom: 4px; text-transform: uppercase; letter-spacing: 1px;}
        
        button { width: 100%; padding: 12px; margin-bottom: 6px; cursor: pointer; background: #3c3c3c; color: #ddd; border: 1px solid #555; text-align: left; transition: 0.2s;}
        button:hover { background: #505050; border-color: #888; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        select { width: 100%; padding: 10px; background: #1a1a1a; color: white; border: 1px solid #555; margin-bottom: 8px; outline: none;}
        
        .btn-wait { background: #263238; font-weight: bold; text-align: center; height: 50px; margin-top: auto; border-color: #37474f;}
        .btn-wait:hover { background: #37474f; color: #fff;}
        
        #log-box { height: 200px; background: #000; border: 1px solid #444; padding: 10px; font-size: 0.8rem; overflow-y: auto; font-family: 'Consolas', monospace; line-height: 1.4; color: #ccc; }
        .log-bad { color: #ef5350; } .log-good { color: #9ccc65; } .log-sys { color: #4fc3f7; } .log-warn { color: #ffee58; }

        /* å½ˆå‡ºè¦–çª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; }
        .modal-box { background: #2d2d2d; padding: 30px; width: 450px; border: 2px solid var(--gold-color); text-align: center; box-shadow: 0 0 30px rgba(0,0,0,1); }
        .manage-grid { display: flex; gap: 15px; margin-top: 20px; }
        .manage-card { flex: 1; padding: 20px; border: 1px solid #555; cursor: pointer; transition: 0.2s; background: #333; }
        .manage-card:hover { background: #444; border-color: var(--gold-color); transform: translateY(-2px); }
        .close-btn { background: #444; border: none; text-align: center; margin-top: 20px;}
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>ä¿¡é•·ä¹‹é‡æœ›ï¼šå…¨åœ‹ç‰ˆ</h1>
        <p style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">12é›„çˆ­éœ¸ | æ–œè§’ç§»å‹• | å§”ä»»ç³»çµ±</p>
        <div class="difficulty-selector">
            <label>AI é›£åº¦ï¼š</label>
            <select id="difficulty" style="width: auto; display:inline-block; padding: 6px;">
                <option value="1">åˆç´š (AIæ¶ˆæ¥µ)</option>
                <option value="2" selected>ä¸­ç´š (æ¨™æº–)</option>
                <option value="3">ä¸Šç´š (å¥½æˆ°)</option>
            </select>
        </div>
        <div class="clan-grid" id="clan-select-area"></div>
    </div>

    <div id="game-container">
        <div class="top-bar">
            <div class="stat-box"><span class="stat-label">æ™‚é–“</span><div class="stat-val" id="d-year">1560 æ˜¥</div></div>
            <div class="stat-box"><span class="stat-label">è³‡é‡‘</span><div class="stat-val" id="d-gold">0</div></div>
            <div class="stat-box"><span class="stat-label">å…µç³§</span><div class="stat-val" id="d-food">0</div></div>
            <div class="stat-box"><span class="stat-label">ç›´è½„å…µåŠ›</span><div class="stat-val" id="d-troops">0</div></div>
            <div class="stat-box"><span class="stat-label">é ˜åœ‹</span><div class="stat-val" id="d-lands">0</div></div>
            <div class="ap-box">è¡Œå‹•åŠ›: <span id="d-ap">3</span></div>
        </div>

        <div class="main-content">
            <div class="map-frame">
                <div class="map-grid" id="map-grid"></div>
            </div>

            <div class="control-panel">
                <div class="panel-block">
                    <div class="panel-header">å…§æ”¿è»äº‹ (-1 AP)</div>
                    <select id="general-select"></select>
                    <button onclick="doAction('commerce')">ğŸ’° æ¨‚å¸‚æ¨‚åº§ (é‡‘+)</button>
                    <button onclick="doAction('agriculture')">ğŸŒ¾ æª¢åœ° (ç³§+)</button>
                    <button onclick="doAction('recruit')">âš”ï¸ å¾µå…µ (å…µ+)</button>
                </div>

                <div class="panel-block">
                    <div class="panel-header">å¤–äº¤ (-1 AP)</div>
                    <select id="diplo-select"></select>
                    <button onclick="doDiplomacy()">ğŸ¤ ç· çµåŒç›Ÿ (é‡‘-600)</button>
                </div>

                <button class="btn-wait" onclick="endTurn()">ğŸŒ™ çµæŸå›åˆ</button>
                <div id="log-box"></div>
            </div>
        </div>
    </div>

    <div id="manage-modal" class="modal">
        <div class="modal-box">
            <h3 id="manage-title" style="color:#eee; margin-top:0;">é ˜åœ°ç®¡ç†</h3>
            <p style="font-size:0.8rem; color:#aaa;">æŒ‡æ´¾åŸä¸»å¯è‡ªå‹•ç™¼å±•ä¸¦æ“´å¼µï¼Œä½†è‹¥è¢«æ”»é™·å¯èƒ½æŠ•é™ã€‚</p>
            
            <label style="display:block; text-align:left; font-size:0.8rem; color:#888;">åŸä¸»ä»»å‘½:</label>
            <select id="manage-gen-select"></select>
            
            <div class="manage-grid">
                <div class="manage-card" onclick="setProvinceState('direct')">
                    <strong style="color:#ef5350; font-size:1.1rem;">â˜… ç›´è½„</strong><br>
                    <span style="font-size:0.75rem; color:#aaa;">ç©å®¶è¦ªè‡ªæŒ‡æ®<br>é€²æ”»è·³æ¿ / ä¸­å¤®å…µåŠ›</span>
                </div>
                <div class="manage-card" onclick="setProvinceState('auto')">
                    <strong style="color:#66bb6a; font-size:1.1rem;">â™» å§”ä»»</strong><br>
                    <span style="font-size:0.75rem; color:#aaa;">è‡ªå‹•ç™¼å±• / è‡ªå‹•æ“´å¼µ<br>éœ€æŒ‡æ´¾åŸä¸»</span>
                </div>
            </div>
            <button class="close-btn" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="end-modal" class="modal">
        <div class="modal-box">
            <h2 id="end-title" style="color: gold;"></h2>
            <p id="end-msg" style="margin: 20px 0; line-height:1.6;"></p>
            <button class="close-btn" onclick="location.reload()">è¿”å›æ¨™é¡Œ</button>
        </div>
    </div>

<script>
    // --- 96åœ‹åœ°åœ–æ•¸æ“š (32x26 Grid) ---
    const PROVINCES_DATA = [
        // åŒ—æµ·é“
        {id:0,n:"è¦å¤·",r:2,c:28}, {id:1,n:"æ¸¡å³¶",r:3,c:27},
        // æ±åŒ—
        {id:2,n:"åŒ—é™¸å¥§",r:4,c:27}, {id:3,n:"é™¸å¥§",r:5,c:27}, {id:4,n:"é™¸ä¸­",r:6,c:27}, {id:5,n:"é™¸å‰",r:7,c:27},
        {id:6,n:"ç£åŸ",r:8,c:27}, {id:7,n:"å²©ä»£",r:8,c:26},
        {id:8,n:"åŒ—å‡ºç¾½",r:5,c:26}, {id:9,n:"ç¾½å¾Œ",r:6,c:26}, {id:10,n:"ç¾½å‰",r:7,c:26},
        // é—œæ±
        {id:11,n:"ä¸‹é‡",r:9,c:26}, {id:12,n:"ä¸Šé‡",r:9,c:25}, 
        {id:13,n:"åŒ—å¸¸é™¸",r:9,c:27}, {id:14,n:"å¸¸é™¸",r:10,c:27},
        {id:15,n:"æ­¦è—",r:10,c:25}, {id:16,n:"ä¸‹ç¸½",r:10,c:26}, {id:17,n:"ä¸Šç¸½",r:11,c:27}, {id:18,n:"å®‰æˆ¿",r:12,c:27},
        {id:19,n:"ç›¸æ¨¡",r:11,c:25},
        // ç”²ä¿¡è¶Š
        {id:20,n:"è¶Šå¾Œ",r:7,c:24}, {id:21,n:"æ˜¥æ—¥å±±",r:8,c:23}, {id:90,n:"ä½æ¸¡",r:6,c:23},
        {id:22,n:"åŒ—ä¿¡æ¿ƒ",r:9,c:23}, {id:23,n:"å—ä¿¡æ¿ƒ",r:10,c:23},
        {id:24,n:"ç”²æ–",r:10,c:24},
        // åŒ—é™¸
        {id:25,n:"è¶Šä¸­",r:8,c:22}, {id:26,n:"èƒ½ç™»",r:7,c:21}, {id:27,n:"åŠ è³€",r:8,c:21}, {id:28,n:"è¶Šå‰",r:9,c:21}, {id:29,n:"è‹¥å³½",r:9,c:20},
        // æ±æµ·
        {id:30,n:"é§¿æ²³",r:11,c:24}, {id:31,n:"é æ±Ÿ",r:12,c:23}, {id:32,n:"ä¸‰æ²³",r:12,c:22},
        {id:33,n:"å°¾å¼µ",r:11,c:21}, {id:34,n:"ç¾æ¿ƒ",r:10,c:21}, {id:35,n:"é£›é©’",r:9,c:22},
        {id:36,n:"åŒ—ä¼Šå‹¢",r:11,c:20}, {id:37,n:"å—ä¼Šå‹¢",r:12,c:20}, {id:38,n:"å¿—æ‘©",r:13,c:21},
        // è¿‘ç•¿
        {id:39,n:"åŒ—è¿‘æ±Ÿ",r:10,c:20}, {id:40,n:"å—è¿‘æ±Ÿ",r:11,c:19}, {id:41,n:"ä¼Šè³€",r:11,c:20},
        {id:42,n:"å±±åŸ",r:11,c:18}, {id:43,n:"ä¸¹æ³¢",r:10,c:18}, {id:44,n:"ä¸¹å¾Œ",r:9,c:18},
        {id:45,n:"æ”æ´¥",r:11,c:17}, {id:46,n:"æ²³å…§",r:12,c:18}, {id:47,n:"å’Œæ³‰",r:12,c:17},
        {id:48,n:"å¤§å’Œ",r:12,c:19}, {id:49,n:"å‰é‡",r:13,c:19},
        {id:50,n:"ç´€ä¼Š",r:13,c:18}, {id:51,n:"ç†Šé‡",r:14,c:18},
        // ä¸­åœ‹
        {id:52,n:"ä½†é¦¬",r:9,c:16}, {id:53,n:"å› å¹¡",r:9,c:15}, {id:54,n:"ä¼¯è€†",r:9,c:14}, {id:55,n:"å‡ºé›²",r:9,c:13}, {id:56,n:"çŸ³è¦‹",r:10,c:12}, {id:91,n:"éš±å²",r:8,c:13},
        {id:57,n:"æ’­ç£¨",r:11,c:16}, {id:58,n:"ç¾ä½œ",r:10,c:15}, {id:59,n:"å‚™å‰",r:11,c:15}, {id:60,n:"å‚™ä¸­",r:11,c:14}, {id:61,n:"å‚™å¾Œ",r:11,c:13},
        {id:62,n:"å®‰èŠ¸",r:11,c:12}, {id:63,n:"å‘¨é˜²",r:11,c:10}, {id:64,n:"é•·é–€",r:11,c:9},
        // å››åœ‹
        {id:65,n:"æ·¡è·¯",r:12,c:16},
        {id:66,n:"è®šå²",r:13,c:14}, {id:67,n:"é˜¿æ³¢",r:13,c:15},
        {id:68,n:"æ±åœŸä½",r:14,c:14}, {id:69,n:"è¥¿åœŸä½",r:14,c:13},
        {id:70,n:"æ±ä¼Šäºˆ",r:13,c:12}, {id:71,n:"è¥¿ä¼Šäºˆ",r:13,c:11},
        // ä¹å·
        {id:72,n:"è±å‰",r:12,c:8}, {id:73,n:"è±å¾Œ",r:13,c:8},
        {id:74,n:"ç­‘å‰",r:12,c:7}, {id:75,n:"ç­‘å¾Œ",r:13,c:7},
        {id:76,n:"åŒ—è‚¥å‰",r:12,c:6}, {id:77,n:"å—è‚¥å‰",r:13,c:6}, {id:92,n:"å¹³æˆ¶",r:12,c:5}, {id:93,n:"äº”å³¶",r:13,c:4},
        {id:78,n:"åŒ—è‚¥å¾Œ",r:14,c:7}, {id:79,n:"å—è‚¥å¾Œ",r:15,c:7},
        {id:80,n:"æ—¥å‘",r:15,c:8}, {id:81,n:"é£«è‚¥",r:16,c:8},
        {id:82,n:"å¤§éš…",r:17,c:8}, {id:83,n:"è–©æ‘©",r:16,c:6}, {id:95,n:"ç¨®å­å³¶",r:18,c:8},
        // å°é¦¬/å£¹å²
        {id:94,n:"å£¹å²",r:11,c:6}, {id:84,n:"å°é¦¬",r:9,c:6}
    ];

    // 12 å¤§åå®šç¾©
    const CLANS = {
        oda: { n: 'ç¹”ç”°', full: 'ç¹”ç”°ä¿¡é•·', c: 'c-oda', start: 33 },
        takeda: { n: 'æ­¦ç”°', full: 'æ­¦ç”°ä¿¡ç„', c: 'c-takeda', start: 24 },
        uesugi: { n: 'ä¸Šæ‰', full: 'ä¸Šæ‰è¬™ä¿¡', c: 'c-uesugi', start: 21 },
        mori: { n: 'æ¯›åˆ©', full: 'æ¯›åˆ©å…ƒå°±', c: 'c-mori', start: 62 },
        hojo: { n: 'åŒ—æ¢', full: 'åŒ—æ¢æ°åº·', c: 'c-hojo', start: 19 },
        date: { n: 'ä¼Šé”', full: 'ä¼Šé”æ”¿å®—', c: 'c-date', start: 5 },
        shimazu: { n: 'å³¶æ´¥', full: 'å³¶æ´¥ç¾©ä¹…', c: 'c-shimazu', start: 83 },
        chosokabe: { n: 'é•·å®—', full: 'é•·å®—æˆ‘éƒ¨', c: 'c-chosokabe', start: 68 },
        tokugawa: { n: 'å¾·å·', full: 'å¾·å·å®¶åº·', c: 'c-tokugawa', start: 32 },
        imagawa: { n: 'ä»Šå·', full: 'ä»Šå·ç¾©å…ƒ', c: 'c-imagawa', start: 30 },
        // æ–°å¢å‹¢åŠ›
        otomo: { n: 'å¤§å‹', full: 'å¤§å‹å®—éºŸ', c: 'c-otomo', start: 73 },
        miyoshi: { n: 'ä¸‰å¥½', full: 'ä¸‰å¥½é•·æ…¶', c: 'c-miyoshi', start: 45 },
        
        neutral: { n: 'è±ªæ—', full: 'è±ªæ—', c: 'c-neutral', start: -1 }
    };

    const GENERAL_DB = {
        oda: [{n:'ç¹”ç”°ä¿¡é•·',w:99,p:95}, {n:'ç¾½æŸ´ç§€å‰',w:88,p:99}, {n:'æŸ´ç”°å‹å®¶',w:94,p:60}, {n:'æ˜æ™ºå…‰ç§€',w:91,p:94}, {n:'ä¸¹ç¾½é•·ç§€',w:82,p:88}, {n:'å‰ç”°åˆ©å®¶',w:85,p:75}],
        takeda: [{n:'æ­¦ç”°ä¿¡ç„',w:100,p:93}, {n:'å±±ç¸£æ˜Œæ™¯',w:96,p:55}, {n:'çœŸç”°å¹¸æ‘',w:99,p:45}, {n:'é«˜å‚æ˜Œä¿¡',w:89,p:85}, {n:'é¦¬å ´ä¿¡æ˜¥',w:90,p:75}, {n:'å±±æœ¬å‹˜åŠ©',w:85,p:90}],
        uesugi: [{n:'ä¸Šæ‰è¬™ä¿¡',w:100,p:70}, {n:'ç›´æ±Ÿå…¼çºŒ',w:84,p:96}, {n:'æŸ¿å´æ™¯å®¶',w:92,p:40}, {n:'å®‡ä½ç¾',w:88,p:88}, {n:'ç”˜ç²•æ™¯æŒ',w:86,p:60}, {n:'é½‹è—¤æœä¿¡',w:87,p:80}],
        mori: [{n:'æ¯›åˆ©å…ƒå°±',w:97,p:99}, {n:'å°æ—©å·éš†æ™¯',w:89,p:94}, {n:'å‰å·å…ƒæ˜¥',w:95,p:60}, {n:'æ¯›åˆ©è¼å…ƒ',w:70,p:75}, {n:'æ¸…æ°´å®—æ²»',w:82,p:60}, {n:'å®‰åœ‹å¯ºæƒ ç“Š',w:50,p:95}],
        hojo: [{n:'åŒ—æ¢æ°åº·',w:95,p:97}, {n:'åŒ—æ¢ç¶±æˆ',w:96,p:50}, {n:'é¢¨é­”å°å¤ªéƒ',w:88,p:30}, {n:'åŒ—æ¢æ°æ”¿',w:75,p:75}, {n:'åŒ—æ¢æ°ç…§',w:85,p:65}, {n:'å¤§é“å¯ºæ”¿ç¹',w:80,p:85}],
        date: [{n:'ä¼Šé”æ”¿å®—',w:96,p:90}, {n:'ç‰‡å€‰æ™¯ç¶±',w:87,p:95}, {n:'ä¼Šé”æˆå¯¦',w:93,p:55}, {n:'é¬¼åº­ç¶±å…ƒ',w:82,p:85}, {n:'ä¼Šé”è¼å®—',w:75,p:80}, {n:'ç•™å®ˆæ”¿æ™¯',w:80,p:70}],
        shimazu: [{n:'å³¶æ´¥ç¾©ä¹…',w:88,p:94}, {n:'å³¶æ´¥ç¾©å¼˜',w:98,p:55}, {n:'å³¶æ´¥å®¶ä¹…',w:97,p:70}, {n:'å³¶æ´¥æ­²ä¹…',w:86,p:80}, {n:'æ–°ç´å¿ å…ƒ',w:90,p:40}, {n:'å±±ç”°æœ‰ä¿¡',w:85,p:60}],
        chosokabe: [{n:'é•·å®—æˆ‘éƒ¨å…ƒè¦ª',w:95,p:92}, {n:'å‰è‰¯è¦ªè²',w:86,p:75}, {n:'é¦™å®—æˆ‘éƒ¨',w:78,p:88}, {n:'è°·å¿ æ¾„',w:60,p:90}, {n:'å‰ç”°å­è³´',w:60,p:85}, {n:'ä¹…æ­¦è¦ªç›´',w:50,p:80}],
        tokugawa: [{n:'å¾·å·å®¶åº·',w:92,p:98}, {n:'æœ¬å¤šå¿ å‹',w:100,p:30}, {n:'é…’äº•å¿ æ¬¡',w:86,p:88}, {n:'äº•ä¼Šç›´æ”¿',w:94,p:70}, {n:'æ¦ŠåŸåº·æ”¿',w:90,p:85}, {n:'æœéƒ¨åŠè—',w:88,p:40}],
        imagawa: [{n:'ä»Šå·ç¾©å…ƒ',w:82,p:93}, {n:'å¤ªåŸé›ªé½‹',w:89,p:98}, {n:'å²¡éƒ¨å…ƒä¿¡',w:86,p:65}, {n:'æœæ¯”å¥ˆæ³°æœ',w:82,p:60}, {n:'éµœæ®¿é•·ç…§',w:75,p:60}, {n:'æ¾å¹³å…ƒåº·',w:85,p:85}],
        // æ–°å‹¢åŠ›æ­¦å°‡
        otomo: [{n:'å¤§å‹å®—éºŸ',w:80,p:90}, {n:'ç«‹èŠ±é“é›ª',w:98,p:70}, {n:'é«˜æ©‹ç´¹é‹',w:95,p:60}, {n:'ç«‹èŠ±å®—èŒ‚',w:96,p:65}, {n:'è§’éšˆçŸ³å®—',w:60,p:90}, {n:'å‰å¼˜é‘‘ç†',w:82,p:70}],
        miyoshi: [{n:'ä¸‰å¥½é•·æ…¶',w:90,p:95}, {n:'æ¾æ°¸ä¹…ç§€',w:85,p:96}, {n:'ä¸‰å¥½ç¾©è³¢',w:88,p:70}, {n:'åæ²³ä¸€å­˜',w:92,p:40}, {n:'è’æœ¨æ‘é‡',w:80,p:75}, {n:'å²©æˆå‹é€š',w:75,p:60}]
    };

    let state = {
        turn: 1, year: 1560, season: 0,
        player: null, difficulty: 2, actions: 3,
        resources: { gold: 0, food: 0, troops: 0 },
        provinces: {}, generals: [], alliances: {}, selectedProv: -1
    };

    // --- åˆå§‹åŒ– ---
    window.onload = () => {
        const area = document.getElementById('clan-select-area');
        Object.keys(CLANS).forEach(key => {
            if(key === 'neutral') return;
            let div = document.createElement('div');
            div.className = `clan-btn ${CLANS[key].c}`;
            div.innerHTML = `<strong>${CLANS[key].n}</strong><small>${CLANS[key].full}</small>`;
            div.onclick = () => startGame(key);
            area.appendChild(div);
        });
    };

    function startGame(clanKey) {
        state.player = clanKey;
        state.difficulty = parseInt(document.getElementById('difficulty').value);
        state.year = 1560; state.season = 0; state.actions = 3; state.generals = []; state.alliances = {};

        // è³‡æºä¾æ“šåœ°åœ–è¦æ¨¡èˆ‡é›£åº¦
        let baseRes = state.difficulty === 1 ? 2500 : (state.difficulty === 3 ? 1000 : 1500);
        state.resources = { gold: baseRes, food: baseRes, troops: 3000 };

        let gid = 0;
        Object.keys(GENERAL_DB).forEach(k => {
            GENERAL_DB[k].forEach(g => {
                state.generals.push({ id: gid++, name: g.n, w: g.w, p: g.p, owner: k, status: 'free', assignedTo: null });
            });
        });

        initMap();
        updateUI();

        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        log(`éŠæˆ²é–‹å§‹ï¼æ‚¨æ˜¯ ${CLANS[clanKey].full}ã€‚æ–œè§’ç§»å‹•å·²å•Ÿç”¨ã€‚`);
    }

    function initMap() {
        const grid = document.getElementById('map-grid');
        state.provinces = {};

        PROVINCES_DATA.forEach(p => {
            let owner = 'neutral';
            let troops = 1000 + Math.floor(Math.random()*600);
            
            Object.keys(CLANS).forEach(k => {
                if(CLANS[k].start === p.id) {
                    owner = k;
                    troops = (k === state.player) ? 0 : (2500 + state.difficulty*500);
                }
            });

            state.provinces[p.id] = { id: p.id, name: p.n, owner: owner, troops: troops, status: 'direct', generalId: null };
            
            let div = document.createElement('div');
            div.className = `province ${CLANS[owner].c}`;
            div.style.gridRow = p.r; div.style.gridColumn = p.c;
            div.id = `prov-${p.id}`; div.onclick = () => clickProvince(p.id);
            div.innerHTML = `<div class="prov-name">${p.n}</div><div class="prov-info" id="info-${p.id}"></div>`;
            grid.appendChild(div);
        });
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---

    // é—œéµä¿®æ”¹ï¼šé„°å±…åˆ¤æ–· (åŒ…å«æ–œè§’)
    function getNeighbors(pid) {
        let p1 = PROVINCES_DATA.find(x => x.id === pid);
        let list = [];
        PROVINCES_DATA.forEach(p2 => {
            if(p1.id !== p2.id) {
                let dr = Math.abs(p1.r - p2.r);
                let dc = Math.abs(p1.c - p2.c);
                // æ–œè§’ï¼šè¡Œå·®èˆ‡åˆ—å·®å‡ <= 1 ä¸”ä¸ç‚ºè‡ªèº«
                if (dr <= 1 && dc <= 1) {
                    list.push(p2.id);
                }
            }
        });
        return list;
    }

    function doAction(type) {
        if(state.actions <= 0) return alert("è¡Œå‹•åŠ›è€—ç›¡");
        const sel = document.getElementById('general-select');
        if(!sel.value) return alert("ç„¡å¯ç”¨æ­¦å°‡");
        const gen = state.generals.find(g => g.id == sel.value);
        
        let pMod = 1 + gen.p/100, wMod = 1 + gen.w/100, msg = "";
        
        if(type === 'commerce') {
            if(state.resources.food < 50) return alert("ç¼ºç³§");
            state.resources.food -= 50; state.resources.gold += Math.floor(250 * pMod);
            msg = `${gen.name} æ¨‚å¸‚æ¨‚åº§`;
        } else if (type === 'agriculture') {
            if(state.resources.gold < 50) return alert("ç¼ºé‡‘");
            state.resources.gold -= 50; state.resources.food += Math.floor(250 * pMod);
            msg = `${gen.name} æª¢åœ°`;
        } else if (type === 'recruit') {
            if(state.resources.gold < 150 || state.resources.food < 150) return alert("è³‡æºä¸è¶³");
            state.resources.gold -= 150; state.resources.food -= 150; state.resources.troops += Math.floor(300 * wMod);
            msg = `${gen.name} å¾µå…µ`;
        }
        state.actions--; log(msg); updateUI();
    }

    function doDiplomacy() {
        if(state.actions <= 0) return alert("è¡Œå‹•åŠ›è€—ç›¡");
        const target = document.getElementById('diplo-select').value;
        if(!target) return;
        if(state.resources.gold < 600) return alert("è³‡é‡‘ä¸è¶³");
        
        state.resources.gold -= 600; state.actions--;
        if(Math.random() > 0.2 * state.difficulty) {
            state.alliances[target] = 12; log(`<span class="log-good">èˆ‡ ${CLANS[target].n} çµç›ŸæˆåŠŸï¼</span>`);
        } else {
            log(`<span class="log-bad">${CLANS[target].n} æ‹’çµ•çµç›Ÿã€‚</span>`);
        }
        updateUI();
    }

    function clickProvince(pid) {
        const p = state.provinces[pid];
        if(p.owner === state.player) { openManage(pid); return; }
        if(state.alliances[p.owner] > 0) { alert("ç›Ÿå‹"); return; }
        if(state.actions <= 0) { alert("ç„¡è¡Œå‹•åŠ›"); return; }
        if(!isAdjacent(pid, state.player)) { alert("ä¸ç›¸é„° (æ–œè§’å¯)"); return; }
        if(state.resources.food < 100 || state.resources.troops < 500) return alert("è»è³‡ä¸è¶³");

        if(confirm(`æ”»æ‰“ ${p.name}?`)) {
            state.actions--; state.resources.gold -= 50; state.resources.food -= 100;
            const sel = document.getElementById('general-select');
            const gen = state.generals.find(g=>g.id==sel.value) || {name:'æœ¬é™£', w:80};
            battle(state.player, p, state.resources.troops, gen.w, true);
        }
    }

    function battle(atkOwner, defProv, atkTroops, atkWar, isPlayerMain) {
        let defTroops = defProv.troops;
        if(defProv.owner === state.player && defProv.status === 'direct') defTroops = state.resources.troops;

        let atkPwr = atkTroops * (atkWar/100) * (0.8 + Math.random()*0.4);
        let defPwr = defTroops * (0.8 + Math.random()*0.4);
        if(defProv.owner !== 'neutral') defPwr *= 1.2;

        const win = atkPwr > defPwr;
        const loser = defProv.owner;

        if(isPlayerMain) {
            if(win) {
                let loss = Math.floor(defTroops * 0.3);
                state.resources.troops = Math.max(0, state.resources.troops - loss);
                captureProv(defProv, atkOwner);
                log(`<span class="log-good">æ”»é™· ${defProv.name}ï¼</span>`);
            } else {
                let loss = Math.floor(atkTroops * 0.4);
                state.resources.troops = Math.max(0, state.resources.troops - loss);
                defProv.troops -= Math.floor(atkTroops*0.2);
                log(`<span class="log-bad">é€²æ”»å¤±æ•—ï¼Œæå¤± ${loss}ã€‚</span>`);
            }
        } else {
            let loss = Math.floor(Math.min(atkTroops, defTroops) * 0.4);
            if(win) {
                captureProv(defProv, atkOwner);
                defProv.troops = Math.max(500, atkTroops - loss);
                if(atkOwner === state.player) log(`<span class="log-good">å§”ä»»è»æ”»ä¸‹ ${defProv.name}ã€‚</span>`);
                else if(loser === state.player) log(`<span class="log-bad">æ€¥å ±ï¼${defProv.name} æ·ªé™·ã€‚</span>`);
            }
            return win;
        }

        if(win && loser !== 'neutral') checkDestruction(loser, atkOwner);
        updateUI();
    }

    function captureProv(p, newOwner) {
        if(p.generalId !== null) {
            let gen = state.generals.find(g=>g.id===p.generalId);
            if(Math.random() < 0.5) { gen.owner = newOwner; gen.status = 'free'; gen.assignedTo = null; log(`${gen.name} æŠ•é™ï¼`); } 
            else { gen.status = 'free'; gen.assignedTo = null; }
        }
        p.owner = newOwner; p.status = (newOwner === state.player) ? 'direct' : 'auto'; p.generalId = null; p.troops = 0;
    }

    function checkDestruction(loser, winner) {
        if(Object.values(state.provinces).filter(p=>p.owner===loser).length === 0) {
            log(`ã€${CLANS[loser].n}ã€‘æ»…äº¡ã€‚`);
            state.generals.forEach(g => { if(g.owner === loser) { g.owner = winner; g.status='free'; g.assignedTo=null; } });
            if(loser === state.player) {
                document.getElementById('end-title').innerText = "æ•—åŒ—";
                document.getElementById('end-msg').innerText = "å®¶æ—æ»…äº¡ã€‚";
                document.getElementById('end-modal').style.display = 'flex';
            }
        }
    }

    function endTurn() {
        state.actions = 3; state.season++;
        let cost = Math.floor(state.resources.troops / 100 * 4);
        state.resources.food = Math.max(0, state.resources.food - cost);
        
        if(state.season > 3) {
            state.season = 0; state.year++;
            state.resources.gold += 1000; state.resources.food += 1000;
            log(`æ–°å¹´ç¨…æ”¶ã€‚`);
        }

        // å§”ä»»è¡Œå‹•
        Object.values(state.provinces).forEach(p => {
            if(p.owner === state.player && p.status === 'auto' && p.generalId) {
                let gen = state.generals.find(g=>g.id===p.generalId);
                state.resources.gold += Math.floor(gen.p * 0.4);
                state.resources.food += Math.floor(gen.p * 0.4);
                p.troops += Math.floor(gen.w * 0.6);
                
                if(p.troops > 2500) {
                    let targets = getNeighbors(p.id).filter(nid => {
                        let t = state.provinces[nid];
                        return t.owner !== state.player && !state.alliances[t.owner];
                    });
                    if(targets.length > 0) {
                        let t = state.provinces[targets[0]];
                        let def = t.troops;
                        if(t.owner === state.player && t.status === 'direct') def = state.resources.troops;
                        if(p.troops > def * 1.3) {
                            if(battle(state.player, t, p.troops, gen.w, false)) p.troops = 800;
                            else p.troops = Math.floor(p.troops*0.6);
                        }
                    }
                }
            }
        });

        // AI
        aiAction();
        
        if(Object.values(state.provinces).filter(p=>p.owner===state.player).length === PROVINCES_DATA.length) {
            document.getElementById('end-title').innerText = "å¤©ä¸‹çµ±ä¸€";
            document.getElementById('end-msg').innerText = "æ­å–œï¼";
            document.getElementById('end-modal').style.display = 'flex';
        }
        updateUI();
    }

    function aiAction() {
        let ais = [...new Set(Object.values(state.provinces).map(p=>p.owner))].filter(o=>o!=='neutral' && o!==state.player);
        ais.forEach(ai => {
            Object.values(state.provinces).filter(p=>p.owner===ai).forEach(p => p.troops += 120 * state.difficulty);
            if(Math.random() < 0.4) {
                let attackers = Object.values(state.provinces).filter(p=>p.owner===ai && p.troops > 2000);
                if(attackers.length > 0) {
                    let p = attackers[Math.floor(Math.random()*attackers.length)];
                    let neighbors = getNeighbors(p.id);
                    for(let nid of neighbors) {
                        let t = state.provinces[nid];
                        if(t.owner !== ai && !state.alliances[ai]) {
                            let def = t.troops;
                            if(t.owner === state.player && t.status === 'direct') def = state.resources.troops;
                            if(p.troops > def * 1.2) {
                                if(battle(ai, t, p.troops, 80, false)) p.troops = 1000;
                                break;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- UI/Tools ---
    function updateUI() {
        const s = ['æ˜¥','å¤','ç§‹','å†¬'];
        document.getElementById('d-year').innerText = `${state.year} ${s[state.season]}`;
        document.getElementById('d-gold').innerText = state.resources.gold;
        document.getElementById('d-food').innerText = state.resources.food;
        document.getElementById('d-troops').innerText = state.resources.troops;
        document.getElementById('d-ap').innerText = state.actions;
        document.getElementById('d-lands').innerText = Object.values(state.provinces).filter(p=>p.owner===state.player).length;
        
        Object.values(state.provinces).forEach(p => {
            const el = document.getElementById(`prov-${p.id}`);
            el.className = `province ${CLANS[p.owner].c}`;
            el.classList.remove('status-direct','status-auto','status-ally');
            let info = p.troops;
            if(p.owner === state.player) {
                if(p.status === 'direct') { el.classList.add('status-direct'); info = "â˜…ç›´è½„"; }
                else { el.classList.add('status-auto'); info = `â™»${p.generalId?state.generals.find(g=>g.id===p.generalId).name[0]:"ç„¡"} ${p.troops}`; }
            } else if(state.alliances[p.owner]) el.classList.add('status-ally');
            document.getElementById(`info-${p.id}`).innerText = info;
        });
        
        const ms = document.getElementById('general-select'); ms.innerHTML = '';
        state.generals.filter(g=>g.owner===state.player && g.status==='free').forEach(g => {
            let o = document.createElement('option'); o.value = g.id; o.innerText = `${g.name} (çµ±${g.w} æ”¿${g.p})`; ms.appendChild(o);
        });
        const ds = document.getElementById('diplo-select'); ds.innerHTML = '';
        [...new Set(Object.values(state.provinces).map(p=>p.owner))].forEach(c => {
            if(c!==state.player && c!=='neutral' && !state.alliances[c]) {
                let o = document.createElement('option'); o.value = c; o.innerText = CLANS[c].n; ds.appendChild(o);
            }
        });
    }

    function isAdjacent(pid, owner) { return getNeighbors(pid).some(nid => state.provinces[nid].owner === owner); }

    function openManage(pid) {
        state.selectedProv = pid;
        const p = state.provinces[pid];
        document.getElementById('manage-title').innerText = `æ²»ç†ï¼š${p.name}`;
        const sel = document.getElementById('manage-gen-select'); sel.innerHTML = '<option value="-1">-- è§£ä»» --</option>';
        if(p.generalId !== null) {
            let g = state.generals.find(x=>x.id===p.generalId);
            let o = document.createElement('option'); o.value=g.id; o.innerText=`${g.name} (ç¾ä»»)`; o.selected=true; sel.appendChild(o);
        }
        state.generals.filter(g=>g.owner===state.player && g.status==='free').forEach(g => {
            let o = document.createElement('option'); o.value=g.id; o.innerText=`${g.name} (çµ±${g.w})`; sel.appendChild(o);
        });
        document.getElementById('manage-modal').style.display = 'flex';
    }

    function setProvinceState(type) {
        const pid = state.selectedProv, p = state.provinces[pid], gid = parseInt(document.getElementById('manage-gen-select').value);
        if(p.generalId !== null && p.generalId !== gid) { let g = state.generals.find(x=>x.id===p.generalId); g.status='free'; g.assignedTo=null; }
        if(gid !== -1) { let g = state.generals.find(x=>x.id===gid); g.status='assigned'; g.assignedTo=pid; p.generalId=gid; } else { p.generalId=null; }
        p.status = type; 
        if(type==='direct') { p.troops=0; if(p.generalId) { let g=state.generals.find(x=>x.id===p.generalId); g.status='free'; g.assignedTo=null; p.generalId=null; } }
        else if(p.troops===0) p.troops=1000;
        closeModal(); updateUI();
    }
    
    function closeModal() { document.getElementById('manage-modal').style.display = 'none'; }
    function log(t) { const b = document.getElementById('log-box'); b.innerHTML += `<div>${t}</div>`; b.scrollTop = b.scrollHeight; }

</script>
</body>
</html>
