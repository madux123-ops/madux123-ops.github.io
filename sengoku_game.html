<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿¡é•·ä¹‹é‡æœ›ï¼šå¤©ä¸‹å‰µä¸– (å®Œå…¨å¯¦åç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #b71c1c;
            --gold-color: #ffca28;
            --ocean-color: #263238;
        }
        body {
            font-family: 'Microsoft JhengHei', serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0; /* ç§»é™¤å¤–åœç•™ç™½ */
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }
        h1 { margin: 4px 0; font-size: 1.1rem; text-shadow: 2px 2px 2px #000; letter-spacing: 2px; }

        /* éŠæˆ²å®¹å™¨ */
        #game-container { width: 100%; max-width: 1600px; display: none; height: 96vh; }

        /* é–‹å§‹é¸å–® */
        #start-screen {
            background: var(--panel-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.9);
            text-align: center;
            max-width: 1200px;
            width: 98%;
            margin-top: 20px;
            border: 1px solid #444;
            overflow-y: auto;
            max-height: 95vh;
        }
        
        .clan-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            margin-top: 10px; 
        }
        
        .clan-btn {
            padding: 10px; 
            cursor: pointer; 
            color: white; 
            border: 1px solid #555; 
            transition: 0.2s;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            background: #333;
            min-height: 70px;
            border-radius: 4px;
            position: relative;
        }
        .clan-btn:hover { transform: translateY(-3px); border-color: var(--gold-color); filter: brightness(1.2); z-index: 10; }
        
        .tier-badge {
            position: absolute; top: 3px; right: 3px;
            font-size: 0.6rem; padding: 1px 4px; border-radius: 3px;
            font-weight: bold;
        }
        .tier-1 { background: #d32f2f; color: white; }
        .tier-2 { background: #1976d2; color: white; }
        .tier-3 { background: #616161; color: white; }

        /* ä¸Šæ–¹è³‡è¨Šåˆ— */
        .top-bar {
            display: flex; gap: 10px; background: #202020; padding: 4px 15px;
            border-bottom: 3px solid var(--accent-color); justify-content: space-between; align-items: center;
            font-size: 0.85rem;
        }
        .stat-box { text-align: center; min-width: 50px; }
        .stat-label { font-size: 0.6rem; color: #aaa; display: block; }
        .stat-val { font-size: 0.95rem; font-weight: bold; color: var(--gold-color); }
        .ap-box { background: var(--accent-color); padding: 2px 10px; border-radius: 4px; font-weight: bold; color: white; }
        .wounded-box { color: #ef9a9a; font-size: 0.8rem; }

        /* ä¸»éŠæˆ²å€ */
        .main-content { display: grid; grid-template-columns: 1fr 280px; gap: 5px; height: 100%; padding-top: 5px;}
        
        /* åœ°åœ– */
        .map-frame {
            background-color: var(--ocean-color);
            border: 2px solid #444;
            position: relative;
            overflow: auto;
            border-radius: 6px;
        }
        .map-grid {
            display: grid;
            grid-template-columns: repeat(36, minmax(30px, 1fr));
            grid-template-rows: repeat(32, minmax(30px, 1fr));
            gap: 2px;
            padding: 20px;
            /* èª¿æ•´åœ°åœ–ä½ç½®ï¼Œæ¸›å°‘å·¦å´ç©ºç™½ */
            margin-left: -40px; 
            width: 1300px;
            height: 1100px;
        }
        .province {
            border: 1px solid rgba(255,255,255,0.1);
            background: #455a64;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; transition: 0.15s; font-size: 0.6rem;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            border-radius: 2px;
            color: #ccc;
        }
        .province:hover { border-color: #fff; z-index: 100; transform: scale(1.3); box-shadow: 0 0 15px #000;}
        .prov-name { font-weight: bold; text-shadow: 1px 1px 2px #000; pointer-events: none; white-space: nowrap; transform: scale(0.85);}
        .prov-info { font-size: 0.55rem; pointer-events: none; margin-top: 0; color: #fff; text-shadow: 1px 1px 1px #000;}
        .pop-info { font-size: 0.5rem; color: #b0bec5; pointer-events: none; margin-top: -2px; }

        .status-direct { border: 2px solid #fff; z-index: 5; }
        .status-auto { border: 2px solid #66bb6a; z-index: 4; }
        .status-ally { border: 2px dashed #42a5f5; opacity: 0.9; }

        /* çµ±è¨ˆé¢æ¿ (å°å‹åŒ–) */
        .stats-overlay {
            position: absolute; top: 5px; left: 5px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #666; border-radius: 4px;
            padding: 5px;
            width: 160px; 
            max-height: 350px; overflow-y: auto;
            z-index: 1000;
            font-size: 0.65rem; 
            color: #ddd;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.6);
            pointer-events: auto;
        }
        .stats-table { border-collapse: collapse; width: 100%; }
        .stats-table th, .stats-table td { padding: 2px 4px; text-align: right; border-bottom: 1px solid #333; }
        .stats-table th { text-align: center; color: #aaa; font-weight: normal; border-bottom: 1px solid #555; }
        .stats-table td:nth-child(2) { text-align: left; } 

        /* å‹¢åŠ›é¡è‰² */
        .c-oda { background: #d50000; } .c-takeda { background: #e65100; } .c-uesugi { background: #0d47a1; }
        .c-hojo { background: #4a148c; } .c-mori { background: #1b5e20; } .c-shimazu { background: #fbc02d; color:#000; }
        .c-date { background: #263238; border:1px solid #90caf9;} .c-tokugawa { background: #004d40; }
        .c-otomo { background: #5d4037; } .c-miyoshi { background: #827717; color:#000; }
        .c-chosokabe { background: #7b1fa2; } .c-imagawa { background: #3e2723; } .c-amago { background: #b71c1c; border:1px dashed #ff8a80;}
        .c-asakura { background: #01579b; } .c-ukita { background: #f9a825; color:#000; }
        .c-ryuzoji { background: #880e4f; } .c-satake { background: #311b92; } .c-nanbu { background: #006064; }
        .c-mogami { background: #33691e; } .c-azai { background: #bf360c; }
        .c-neutral { background: #546e7a; opacity: 0.7; }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { background: var(--panel-bg); padding: 10px; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; border-left: 1px solid #444; }
        .panel-block { background: #2a2a2a; padding: 8px; border-radius: 4px; border: 1px solid #444; }
        .panel-header { color: #aaa; font-size: 0.8rem; border-bottom: 1px solid #444; margin-bottom: 5px; padding-bottom: 3px; display:flex; justify-content:space-between;}
        .dev-level { color: var(--gold-color); font-weight: bold; }

        button { width: 100%; padding: 8px; margin-bottom: 4px; cursor: pointer; background: #3c3c3c; color: #ddd; border: 1px solid #555; text-align: left; transition: 0.2s; font-size: 0.85rem;}
        button:hover { background: #505050; border-color: #888; }
        .btn-bonus { font-size: 0.65rem; color: #888; float: right; }

        select { width: 100%; padding: 6px; background: #1a1a1a; color: white; border: 1px solid #555; margin-bottom: 5px; outline: none; font-size: 0.85rem;}
        
        .btn-wait { background: #263238; font-weight: bold; text-align: center; height: 40px; margin-top: auto; border-color: #37474f;}
        .btn-wait:hover { background: #37474f; color: #fff;}
        
        #log-box { height: 180px; background: #000; border: 1px solid #444; padding: 6px; font-size: 0.75rem; overflow-y: auto; font-family: 'Consolas', monospace; line-height: 1.4; color: #ccc; }
        .log-bad { color: #ef5350; } .log-good { color: #9ccc65; } .log-sys { color: #4fc3f7; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; }
        .modal-box { background: #2d2d2d; padding: 30px; width: 400px; border: 2px solid var(--gold-color); text-align: center; box-shadow: 0 0 30px #000; }
        .manage-grid { display: flex; gap: 15px; margin-top: 20px; }
        .manage-card { flex: 1; padding: 15px; border: 1px solid #555; cursor: pointer; background: #333; }
        .manage-card:hover { background: #444; border-color: var(--gold-color); }
        .close-btn { background: #444; border: none; text-align: center; margin-top: 20px; padding: 8px 20px; cursor: pointer; color:#fff;}
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>ä¿¡é•·ä¹‹é‡æœ›ï¼šå¤©ä¸‹å‰µä¸–</h1>
        <p style="color:#aaa; font-size:0.9rem; margin-bottom:10px;">148åœ‹å®Œå…¨ç‰ˆ | å¯¦åæ­¦å°‡ | äººå£ç¶“æ¿Ÿ</p>
        <div style="margin-bottom: 10px;">
            <label>AI é›£åº¦ï¼š</label>
            <select id="difficulty" style="width: auto; display:inline-block; padding: 4px;">
                <option value="1">åˆç´š</option>
                <option value="2" selected>ä¸­ç´š</option>
                <option value="3">ä¸Šç´š</option>
            </select>
        </div>
        <div class="clan-grid" id="clan-select-area"></div>
    </div>

    <div id="game-container">
        <div class="top-bar">
            <div class="stat-box"><span class="stat-label">æ™‚é–“</span><div class="stat-val" id="d-year">1560 æ˜¥</div></div>
            <div class="stat-box"><span class="stat-label">è³‡é‡‘</span><div class="stat-val" id="d-gold">0</div></div>
            <div class="stat-box"><span class="stat-label">å…µç³§</span><div class="stat-val" id="d-food">0</div></div>
            <div class="stat-box"><span class="stat-label">ç¾å½¹/å‚·å…µ</span><div class="stat-val"><span id="d-troops">0</span><span class="wounded-box">+(<span id="d-wounded">0</span>)</span></div></div>
            <div class="stat-box"><span class="stat-label">é ˜åœ‹</span><div class="stat-val" id="d-lands">0</div></div>
            <div class="ap-box">è¡Œå‹•åŠ›: <span id="d-ap">3</span></div>
        </div>

        <div class="main-content">
            <div class="map-frame">
                <div id="stats-box" class="stats-overlay"></div>
                <div class="map-grid" id="map-grid"></div>
            </div>

            <div class="control-panel">
                <div class="panel-block">
                    <div class="panel-header">
                        å…§æ”¿ (å•†Lv:<span id="lvl-com" class="dev-level">1</span> è¾²Lv:<span id="lvl-agr" class="dev-level">1</span>)
                    </div>
                    <select id="general-select"></select>
                    <button onclick="doAction('commerce')">ğŸ’° æ¨‚å¸‚æ¨‚åº§ <span class="btn-bonus">é‡‘+ äºº++</span></button>
                    <button onclick="doAction('agriculture')">ğŸŒ¾ æª¢åœ° <span class="btn-bonus">ç³§+ äºº+</span></button>
                    <button onclick="doAction('recruit')">âš”ï¸ å¾µå…µ <span class="btn-bonus">å…µ+ äºº-</span></button>
                    <button onclick="doAction('fortify')">ğŸ”¨ æ™®è«‹ (ä¿®åŸ) <span class="btn-bonus">é˜²+</span></button>
                </div>

                <div class="panel-block">
                    <div class="panel-header">å¤–äº¤è»ç•¥</div>
                    <select id="diplo-select"></select>
                    <button onclick="doDiplomacy()">ğŸ¤ ç· çµåŒç›Ÿ (é‡‘-600)</button>
                </div>

                <button class="btn-wait" onclick="endTurn()">ğŸŒ™ çµæŸå›åˆ</button>
                <div id="log-box"></div>
            </div>
        </div>
    </div>

    <div id="manage-modal" class="modal">
        <div class="modal-box">
            <h3 id="manage-title" style="color:#eee; margin-top:0;">é ˜åœ°ç®¡ç†</h3>
            <p style="font-size:0.8rem; color:#aaa;">å§”ä»»åŸä¸»å°‡è‡ªå‹•å…§æ”¿ã€ä¿®åŸèˆ‡é˜²ç¦¦ã€‚</p>
            <label style="display:block; text-align:left; font-size:0.8rem; color:#888;">åŸä¸»ä»»å‘½:</label>
            <select id="manage-gen-select"></select>
            <div class="manage-grid">
                <div class="manage-card" onclick="setProvinceState('direct')">
                    <strong style="color:#ef5350;">â˜… ç›´è½„</strong><br><span style="font-size:0.75rem;">ç©å®¶æ“æ§ / ä¸­å¤®å¾µå…µ</span>
                </div>
                <div class="manage-card" onclick="setProvinceState('auto')">
                    <strong style="color:#66bb6a;">â™» å§”ä»»</strong><br><span style="font-size:0.75rem;">è‡ªå‹•ç™¼å±• / ç¨ç«‹å®ˆå‚™</span>
                </div>
            </div>
            <button class="close-btn" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div id="end-modal" class="modal">
        <div class="modal-box">
            <h2 id="end-title" style="color: gold;"></h2>
            <p id="end-msg"></p>
            <button class="close-btn" onclick="location.reload()">è¿”å›æ¨™é¡Œ</button>
        </div>
    </div>

<script>
    // 148åœ‹åœ°åœ– (åº§æ¨™ä¿®æ­£ç‰ˆ)
    const PROVINCES_DATA = [
        // åŒ—æµ·é“
        {id:0,n:"è¦å¤·",r:2,c:30}, {id:1,n:"æ¸¡å³¶",r:3,c:29}, {id:97,n:"çŸ³ç‹©",r:3,c:30}, {id:103,n:"æ—¥é«˜",r:3,c:31}, {id:104,n:"åå‹",r:2,c:31},
        // æ±åŒ—
        {id:105,n:"æ´¥è¼•",r:4,c:28}, {id:2,n:"åŒ—é™¸å¥§",r:4,c:29}, {id:106,n:"äºŒæˆ¶",r:5,c:29}, {id:3,n:"é™¸å¥§",r:6,c:29}, 
        {id:4,n:"é™¸ä¸­",r:7,c:29}, {id:5,n:"é™¸å‰",r:8,c:29}, {id:107,n:"è†½æ¾¤",r:7,c:28},
        {id:6,n:"ç£åŸ",r:9,c:29}, {id:7,n:"å²©ä»£",r:9,c:28}, {id:108,n:"æœƒæ´¥",r:9,c:27},
        {id:8,n:"åŒ—å‡ºç¾½",r:5,c:28}, {id:9,n:"ç¾½å¾Œ",r:6,c:28}, {id:10,n:"ç¾½å‰",r:8,c:28}, {id:101,n:"åº„å…§",r:7,c:27}, {id:109,n:"ç±³æ¾¤",r:8,c:27},
        // é—œæ±
        {id:11,n:"ä¸‹é‡",r:10,c:28}, {id:111,n:"é‚£é ˆ",r:10,c:29},
        {id:12,n:"ä¸Šé‡",r:10,c:27}, {id:110,n:"æ²¼ç”°",r:10,c:26},
        {id:13,n:"åŒ—å¸¸é™¸",r:10,c:30}, {id:14,n:"å¸¸é™¸",r:11,c:30},
        {id:15,n:"æ­¦è—",r:11,c:27}, {id:112,n:"æ±Ÿæˆ¶",r:12,c:28}, {id:113,n:"å·è¶Š",r:11,c:28},
        {id:16,n:"ä¸‹ç¸½",r:11,c:29}, {id:17,n:"ä¸Šç¸½",r:12,c:29}, {id:114,n:"ä¹…ç•™é‡Œ",r:12,c:30},
        {id:18,n:"å®‰æˆ¿",r:13,c:29},
        {id:19,n:"ç›¸æ¨¡",r:12,c:27}, {id:115,n:"å°ç”°åŸ",r:13,c:27}, {id:98,n:"ç§©çˆ¶",r:11,c:26},
        // ç”²ä¿¡è¶Š
        {id:20,n:"è¶Šå¾Œ",r:8,c:25}, {id:21,n:"æ˜¥æ—¥å±±",r:9,c:24}, {id:90,n:"ä½æ¸¡",r:7,c:24},
        {id:22,n:"åŒ—ä¿¡æ¿ƒ",r:10,c:25}, {id:116,n:"æ±ä¿¡æ¿ƒ",r:10,c:26}, {id:23,n:"å—ä¿¡æ¿ƒ",r:11,c:25}, {id:117,n:"æœ¨æ›¾",r:11,c:24},
        {id:24,n:"ç”²æ–",r:11,c:26}, {id:118,n:"å¯Œå£«",r:12,c:26},
        // åŒ—é™¸
        {id:25,n:"è¶Šä¸­",r:9,c:23}, {id:119,n:"å¯Œå±±",r:9,c:24},
        {id:26,n:"èƒ½ç™»",r:8,c:22}, {id:120,n:"ä¸ƒå°¾",r:7,c:22},
        {id:27,n:"åŠ è³€",r:9,c:22}, {id:28,n:"è¶Šå‰",r:10,c:22}, {id:29,n:"è‹¥å³½",r:10,c:21},
        // æ±æµ· (åº§æ¨™å„ªåŒ–)
        {id:30,n:"é§¿æ²³",r:13,c:25}, {id:121,n:"æ²¼æ´¥",r:13,c:26},
        {id:31,n:"é æ±Ÿ",r:13,c:24}, {id:122,n:"æ¿±æ¾",r:14,c:24},
        {id:32,n:"ä¸‰æ²³",r:13,c:23}, {id:123,n:"å²¡å´",r:14,c:23},
        {id:33,n:"å°¾å¼µ",r:12,c:22}, {id:34,n:"ç¾æ¿ƒ",r:11,c:22}, {id:35,n:"é£›é©’",r:10,c:23},
        {id:36,n:"åŒ—ä¼Šå‹¢",r:13,c:22}, {id:37,n:"å—ä¼Šå‹¢",r:14,c:22}, {id:38,n:"å¿—æ‘©",r:15,c:22},
        // è¿‘ç•¿ (åº§æ¨™å„ªåŒ–)
        {id:39,n:"åŒ—è¿‘æ±Ÿ",r:11,c:21}, {id:40,n:"å—è¿‘æ±Ÿ",r:12,c:20}, {id:124,n:"å®‰åœŸ",r:11,c:20}, 
        {id:41,n:"ä¼Šè³€",r:12,c:21},
        {id:42,n:"å±±åŸ",r:12,c:19}, {id:125,n:"å‚æœ¬",r:11,c:19},
        {id:43,n:"ä¸¹æ³¢",r:11,c:18}, {id:44,n:"ä¸¹å¾Œ",r:10,c:19}, {id:126,n:"å®®æ´¥",r:9,c:19},
        {id:45,n:"æ”æ´¥",r:12,c:18}, {id:127,n:"çŸ³å±±",r:12,c:17},
        {id:46,n:"æ²³å…§",r:13,c:19}, {id:47,n:"å’Œæ³‰",r:13,c:18}, {id:100,n:"å º",r:13,c:17}, {id:128,n:"å²¸å’Œç”°",r:14,c:17},
        {id:48,n:"å¤§å’Œ",r:13,c:20}, {id:49,n:"å‰é‡",r:14,c:20},
        {id:50,n:"ç´€ä¼Š",r:14,c:19}, {id:51,n:"ç†Šé‡",r:15,c:19},
        // ä¸­åœ‹
        {id:52,n:"ä½†é¦¬",r:10,c:17}, {id:53,n:"å› å¹¡",r:10,c:16}, {id:129,n:"é³¥å–",r:9,c:16},
        {id:54,n:"ä¼¯è€†",r:10,c:15}, {id:130,n:"ç±³å­",r:9,c:15},
        {id:55,n:"å‡ºé›²",r:10,c:14}, {id:56,n:"çŸ³è¦‹",r:11,c:13}, {id:131,n:"æ¿±ç”°",r:10,c:13}, {id:91,n:"éš±å²",r:8,c:14},
        {id:57,n:"æ’­ç£¨",r:11,c:16}, {id:132,n:"å§«è·¯",r:11,c:16},
        {id:58,n:"ç¾ä½œ",r:11,c:15}, {id:59,n:"å‚™å‰",r:12,c:16}, {id:60,n:"å‚™ä¸­",r:12,c:15}, {id:61,n:"å‚™å¾Œ",r:12,c:14},
        {id:62,n:"å®‰èŠ¸",r:12,c:13}, {id:133,n:"å‰ç”°",r:12,c:12},
        {id:63,n:"å‘¨é˜²",r:12,c:11}, {id:134,n:"å±±å£",r:12,c:10},
        {id:64,n:"é•·é–€",r:12,c:9}, {id:135,n:"ä¸‹é—œ",r:11,c:9},
        // å››åœ‹
        {id:65,n:"æ·¡è·¯",r:13,c:16},
        {id:66,n:"è®šå²",r:14,c:15}, {id:136,n:"é«˜æ¾",r:14,c:14},
        {id:67,n:"é˜¿æ³¢",r:14,c:16}, {id:137,n:"å‹ç‘",r:15,c:16},
        {id:68,n:"æ±åœŸä½",r:15,c:15}, {id:69,n:"è¥¿åœŸä½",r:15,c:14}, {id:138,n:"ä¸­æ‘",r:16,c:13},
        {id:70,n:"æ±ä¼Šäºˆ",r:14,c:13}, {id:71,n:"è¥¿ä¼Šäºˆ",r:14,c:12}, {id:139,n:"å®‡å’Œå³¶",r:15,c:12},
        {id:102,n:"èƒ½å³¶",r:13,c:12},
        // ä¹å·
        {id:72,n:"è±å‰",r:13,c:8}, {id:140,n:"å°å€‰",r:12,c:8}, {id:141,n:"ä¸­æ´¥",r:13,c:9},
        {id:73,n:"è±å¾Œ",r:14,c:9}, {id:142,n:"åºœå…§",r:15,c:9},
        {id:74,n:"ç­‘å‰",r:13,c:7}, {id:75,n:"ç­‘å¾Œ",r:14,c:7}, {id:143,n:"æŸ³å·",r:14,c:6},
        {id:76,n:"åŒ—è‚¥å‰",r:13,c:6}, {id:144,n:"ä½è³€",r:13,c:5}, {id:77,n:"å—è‚¥å‰",r:14,c:5}, {id:92,n:"å¹³æˆ¶",r:12,c:5}, {id:93,n:"äº”å³¶",r:13,c:4},
        {id:78,n:"åŒ—è‚¥å¾Œ",r:15,c:7}, {id:79,n:"å—è‚¥å¾Œ",r:16,c:7}, {id:145,n:"äººå‰",r:16,c:8}, {id:99,n:"å¤©è‰",r:15,c:6},
        {id:80,n:"æ—¥å‘",r:16,c:9}, {id:146,n:"ä½åœŸåŸ",r:17,c:9}, {id:81,n:"é£«è‚¥",r:17,c:8},
        {id:82,n:"å¤§éš…",r:18,c:8}, {id:147,n:"è‚ä»˜",r:18,c:9},
        {id:83,n:"è–©æ‘©",r:17,c:6}, {id:95,n:"ç¨®å­å³¶",r:19,c:8},
        // å£¹å²å°é¦¬
        {id:94,n:"å£¹å²",r:12,c:6}, {id:84,n:"å°é¦¬",r:11,c:6}
    ];

    const CLANS = {
        oda: { n: 'ç¹”ç”°', full: 'ç¹”ç”°ä¿¡é•·', c: 'c-oda', t: 1, startProvs: [33, 34, 36] },
        takeda: { n: 'æ­¦ç”°', full: 'æ­¦ç”°ä¿¡ç„', c: 'c-takeda', t: 1, startProvs: [24, 23, 22] },
        uesugi: { n: 'ä¸Šæ‰', full: 'ä¸Šæ‰è¬™ä¿¡', c: 'c-uesugi', t: 1, startProvs: [20, 21, 101] },
        hojo: { n: 'åŒ—æ¢', full: 'åŒ—æ¢æ°åº·', c: 'c-hojo', t: 1, startProvs: [19, 15, 115] },
        mori: { n: 'æ¯›åˆ©', full: 'æ¯›åˆ©å…ƒå°±', c: 'c-mori', t: 1, startProvs: [62, 133, 61] },
        shimazu: { n: 'å³¶æ´¥', full: 'å³¶æ´¥ç¾©ä¹…', c: 'c-shimazu', t: 1, startProvs: [83, 82, 147] },
        date: { n: 'ä¼Šé”', full: 'ä¼Šé”æ”¿å®—', c: 'c-date', t: 2, startProvs: [5, 109] },
        tokugawa: { n: 'å¾·å·', full: 'å¾·å·å®¶åº·', c: 'c-tokugawa', t: 2, startProvs: [32, 123] },
        otomo: { n: 'å¤§å‹', full: 'å¤§å‹å®—éºŸ', c: 'c-otomo', t: 2, startProvs: [73, 142] },
        miyoshi: { n: 'ä¸‰å¥½', full: 'ä¸‰å¥½é•·æ…¶', c: 'c-miyoshi', t: 2, startProvs: [45, 137] },
        chosokabe: { n: 'é•·å®—', full: 'é•·å®—æˆ‘éƒ¨', c: 'c-chosokabe', t: 3, startProvs: [68] },
        imagawa: { n: 'ä»Šå·', full: 'ä»Šå·æ°çœŸ', c: 'c-imagawa', t: 3, startProvs: [30] },
        amago: { n: 'å°¼å­', full: 'å°¼å­æ™´ä¹…', c: 'c-amago', t: 3, startProvs: [55] },
        asakura: { n: 'æœå€‰', full: 'æœå€‰ç¾©æ™¯', c: 'c-asakura', t: 3, startProvs: [28] },
        ukita: { n: 'å®‡å–œå¤š', full: 'å®‡å–œå¤šç›´å®¶', c: 'c-ukita', t: 3, startProvs: [59] },
        ryuzoji: { n: 'é¾é€ å¯º', full: 'é¾é€ å¯ºéš†ä¿¡', c: 'c-ryuzoji', t: 3, startProvs: [144] },
        satake: { n: 'ä½ç«¹', full: 'ä½ç«¹ç¾©é‡', c: 'c-satake', t: 3, startProvs: [14] },
        nanbu: { n: 'å—éƒ¨', full: 'å—éƒ¨æ™´æ”¿', c: 'c-nanbu', t: 3, startProvs: [2] },
        mogami: { n: 'æœ€ä¸Š', full: 'æœ€ä¸Šç¾©å…‰', c: 'c-mogami', t: 3, startProvs: [10] },
        azai: { n: 'æ·ºäº•', full: 'æ·ºäº•é•·æ”¿', c: 'c-azai', t: 3, startProvs: [39] },
        neutral: { n: 'è±ªæ—', full: 'è±ªæ—', c: 'c-neutral', t: 0, startProvs: [] }
    };

    // å®Œæ•´å¯¦åæ­¦å°‡è³‡æ–™åº«
    const REAL_GENERALS = {
        oda: [{n:'ç¹”ç”°ä¿¡é•·',w:99,p:95}, {n:'ç¾½æŸ´ç§€å‰',w:88,p:99}, {n:'æŸ´ç”°å‹å®¶',w:94,p:60}, {n:'æ˜æ™ºå…‰ç§€',w:91,p:94}, {n:'ä¸¹ç¾½é•·ç§€',w:82,p:88}, {n:'å‰ç”°åˆ©å®¶',w:85,p:75}, {n:'ç€§å·ä¸€ç›Š',w:86,p:70}, {n:'ä½ä½æˆæ”¿',w:83,p:50}, {n:'èœ‚é ˆè³€å°å…­',w:80,p:60}, {n:'è’²ç”Ÿæ°é„‰',w:88,p:85}, {n:'æ£®è˜­ä¸¸',w:75,p:60}, {n:'ç¹”ç”°ä¿¡å¿ ',w:82,p:75}, {n:'ç¨»è‘‰ä¸€éµ',w:80,p:70}, {n:'æ± ç”°æ†èˆˆ',w:78,p:65}, {n:'ä½ä¹…é–“ä¿¡ç››',w:70,p:65}],
        takeda: [{n:'æ­¦ç”°ä¿¡ç„',w:100,p:93}, {n:'å±±ç¸£æ˜Œæ™¯',w:96,p:55}, {n:'çœŸç”°å¹¸æ‘',w:99,p:45}, {n:'é«˜å‚æ˜Œä¿¡',w:89,p:85}, {n:'é¦¬å ´ä¿¡æ˜¥',w:90,p:75}, {n:'å±±æœ¬å‹˜åŠ©',w:85,p:90}, {n:'å…§è—¤æ˜Œè±',w:86,p:80}, {n:'æ­¦ç”°å‹è³´',w:84,p:60}, {n:'æ­¦ç”°ä¿¡ç¹',w:88,p:80}, {n:'çœŸç”°æ˜Œå¹¸',w:92,p:96}, {n:'çœŸç”°ä¿¡ä¹‹',w:80,p:88}, {n:'æ¿å£ä¿¡æ–¹',w:82,p:65}, {n:'ç”˜åˆ©è™æ³°',w:83,p:50}, {n:'ä»ç§‘ç››ä¿¡',w:80,p:60}, {n:'åŸè™èƒ¤',w:85,p:40}],
        uesugi: [{n:'ä¸Šæ‰è¬™ä¿¡',w:100,p:70}, {n:'ç›´æ±Ÿå…¼çºŒ',w:84,p:96}, {n:'æŸ¿å´æ™¯å®¶',w:92,p:40}, {n:'å®‡ä½ç¾å®šæ»¿',w:88,p:88}, {n:'ç”˜ç²•æ™¯æŒ',w:86,p:60}, {n:'é½‹è—¤æœä¿¡',w:87,p:80}, {n:'ä¸Šæ‰æ™¯å‹',w:80,p:75}, {n:'æœ¬èŠç¹é•·',w:83,p:50}, {n:'è‰²éƒ¨å‹é•·',w:80,p:65}, {n:'ä¸­æ¢è—¤è³‡',w:78,p:60}, {n:'å®‰ç”°é•·ç§€',w:75,p:55}, {n:'æ²³ç”°é•·è¦ª',w:70,p:80}, {n:'ç›´æ±Ÿæ™¯ç¶±',w:60,p:85}, {n:'é•·å°¾æ”¿æ™¯',w:75,p:70}, {n:'ä¸Šæ‰æ™¯è™',w:82,p:60}],
        hojo: [{n:'åŒ—æ¢æ°åº·',w:95,p:97}, {n:'åŒ—æ¢ç¶±æˆ',w:96,p:50}, {n:'é¢¨é­”å°å¤ªéƒ',w:88,p:30}, {n:'åŒ—æ¢æ°æ”¿',w:75,p:75}, {n:'åŒ—æ¢æ°ç…§',w:85,p:65}, {n:'å¤§é“å¯ºæ”¿ç¹',w:80,p:85}, {n:'æ¾ç”°æ†²ç§€',w:60,p:80}, {n:'å¤šç›®å…ƒå¿ ',w:70,p:85}, {n:'åŒ—æ¢æ°é‚¦',w:82,p:60}, {n:'åŒ—æ¢æ°è¦',w:78,p:88}, {n:'åŒ—æ¢å¹»åºµ',w:50,p:95}, {n:'é å±±ç¶±æ™¯',w:75,p:60}, {n:'ç¬ åŸåº·å‹',w:70,p:55}, {n:'ä¸Šç”°æœç›´',w:72,p:60}, {n:'æˆç”°æ°é•·',w:65,p:75}],
        mori: [{n:'æ¯›åˆ©å…ƒå°±',w:97,p:99}, {n:'å°æ—©å·éš†æ™¯',w:89,p:94}, {n:'å‰å·å…ƒæ˜¥',w:95,p:60}, {n:'æ¯›åˆ©è¼å…ƒ',w:70,p:75}, {n:'æ¸…æ°´å®—æ²»',w:82,p:60}, {n:'å®‰åœ‹å¯ºæƒ ç“Š',w:50,p:95}, {n:'å£ç¾½é€šè‰¯',w:60,p:85}, {n:'ç¦åŸè²ä¿Š',w:75,p:75}, {n:'å‰å·å»£å®¶',w:78,p:80}, {n:'æ¯›åˆ©ç§€åŒ…',w:85,p:50}, {n:'å®æˆ¸éš†å®¶',w:72,p:65}, {n:'å…’ç‰å°±è‹±',w:80,p:50}, {n:'æ‘ä¸Šæ­¦å‰',w:85,p:40}, {n:'ä¹ƒç¾å®—å‹',w:80,p:60}, {n:'æ¡‚å…ƒæ¾„',w:65,p:85}],
        shimazu: [{n:'å³¶æ´¥ç¾©ä¹…',w:88,p:94}, {n:'å³¶æ´¥ç¾©å¼˜',w:98,p:55}, {n:'å³¶æ´¥å®¶ä¹…',w:97,p:70}, {n:'å³¶æ´¥æ­²ä¹…',w:86,p:80}, {n:'æ–°ç´å¿ å…ƒ',w:90,p:40}, {n:'å±±ç”°æœ‰ä¿¡',w:85,p:60}, {n:'ä¸Šäº•è¦ºå…¼',w:50,p:85}, {n:'å³¶æ´¥è±ä¹…',w:92,p:30}, {n:'ä¼Šé›†é™¢å¿ æ£Ÿ',w:60,p:80}, {n:'çŒ¿æ¸¡ä¿¡å…‰',w:80,p:50}, {n:'ç¨®å­å³¶æ™‚å ¯',w:75,p:60}, {n:'è‚ä»˜å…¼çºŒ',w:78,p:55}, {n:'å³¶æ´¥è²´ä¹…',w:85,p:90}, {n:'éŒç”°æ”¿å¹´',w:82,p:60}, {n:'å·ä¸Šä¹…æœ—',w:75,p:65}],
        date: [{n:'ä¼Šé”æ”¿å®—',w:96,p:90}, {n:'ç‰‡å€‰æ™¯ç¶±',w:87,p:95}, {n:'ä¼Šé”æˆå¯¦',w:93,p:55}, {n:'é¬¼åº­ç¶±å…ƒ',w:82,p:85}, {n:'ä¼Šé”è¼å®—',w:75,p:80}, {n:'ç•™å®ˆæ”¿æ™¯',w:80,p:70}, {n:'åŸç”°å®—æ™‚',w:84,p:40}, {n:'ç™½çŸ³å®—å¯¦',w:80,p:60}, {n:'é è—¤åŸºä¿¡',w:50,p:90}, {n:'å¾Œè—¤ä¿¡åº·',w:82,p:50}],
        tokugawa: [{n:'å¾·å·å®¶åº·',w:92,p:98}, {n:'æœ¬å¤šå¿ å‹',w:100,p:30}, {n:'é…’äº•å¿ æ¬¡',w:86,p:88}, {n:'äº•ä¼Šç›´æ”¿',w:94,p:70}, {n:'æ¦ŠåŸåº·æ”¿',w:90,p:85}, {n:'æœéƒ¨åŠè—',w:88,p:40}, {n:'é³¥å±…å…ƒå¿ ',w:82,p:60}, {n:'å¤§ä¹…ä¿å¿ ä¸–',w:78,p:75}, {n:'çŸ³å·æ•¸æ­£',w:65,p:85}, {n:'æœ¬å¤šæ­£ä¿¡',w:40,p:98}],
        otomo: [{n:'å¤§å‹å®—éºŸ',w:80,p:90}, {n:'ç«‹èŠ±é“é›ª',w:98,p:70}, {n:'é«˜æ©‹ç´¹é‹',w:95,p:60}, {n:'ç«‹èŠ±å®—èŒ‚',w:96,p:65}, {n:'è§’éšˆçŸ³å®—',w:60,p:90}, {n:'å‰å¼˜é‘‘ç†',w:82,p:70}, {n:'è‡¼æµé‘‘é€Ÿ',w:65,p:85}, {n:'ä¸€è¬ç”°é‘‘å¯¦',w:70,p:60}, {n:'å¿—è³€è¦ªæ¬¡',w:85,p:50}, {n:'ç”°åŸè¦ªè³¢',w:60,p:75}],
        miyoshi: [{n:'ä¸‰å¥½é•·æ…¶',w:90,p:95}, {n:'æ¾æ°¸ä¹…ç§€',w:85,p:96}, {n:'ä¸‰å¥½ç¾©è³¢',w:88,p:70}, {n:'åæ²³ä¸€å­˜',w:92,p:40}, {n:'å²©æˆå‹é€š',w:75,p:60}, {n:'å®‰å®…å†¬åº·',w:80,p:75}, {n:'ä¸‰å¥½æ”¿åº·',w:78,p:60}, {n:'è’æœ¨æ‘é‡',w:80,p:75}, {n:'é«˜å±±å³è¿‘',w:70,p:80}, {n:'æ± ç”°é•·æ­£',w:65,p:70}],
        chosokabe: [{n:'é•·å®—æˆ‘éƒ¨å…ƒè¦ª',w:95,p:92}, {n:'å‰è‰¯è¦ªè²',w:86,p:75}, {n:'é¦™å®—æˆ‘éƒ¨',w:78,p:88}, {n:'è°·å¿ æ¾„',w:60,p:90}, {n:'å‰ç”°å­è³´',w:60,p:85}, {n:'é•·å®—æˆ‘éƒ¨ä¿¡è¦ª',w:82,p:70}, {n:'ä¹…æ­¦è¦ªç›´',w:50,p:80}, {n:'ç¦ç•™è¦ªæ”¿',w:85,p:40}],
        imagawa: [{n:'ä»Šå·ç¾©å…ƒ',w:82,p:93}, {n:'å¤ªåŸé›ªé½‹',w:89,p:98}, {n:'å²¡éƒ¨å…ƒä¿¡',w:86,p:65}, {n:'æœæ¯”å¥ˆæ³°æœ',w:82,p:60}, {n:'éµœæ®¿é•·ç…§',w:75,p:60}, {n:'æ¾å¹³å…ƒåº·',w:85,p:85}, {n:'é£¯å°¾é€£é¾',w:70,p:60}, {n:'æœæ¯”å¥ˆä¿¡ç½®',w:72,p:65}],
        amago: [{n:'å°¼å­æ™´ä¹…',w:85,p:80}, {n:'å±±ä¸­é¹¿ä¹‹ä»‹',w:94,p:40}, {n:'ç«‹åŸä¹…ç¶±',w:70,p:85}, {n:'å®‡å±±ä¹…å…¼',w:65,p:80}, {n:'å°¼å­å‹ä¹…',w:60,p:70}, {n:'æœ¬åŸå¸¸å…‰',w:80,p:50}, {n:'ç‰›å°¾å¹¸æ¸…',w:70,p:60}, {n:'ä½ä¸–æ¸…å®—',w:65,p:65}],
        asakura: [{n:'æœå€‰ç¾©æ™¯',w:60,p:80}, {n:'æœå€‰å®—æ»´',w:96,p:80}, {n:'çœŸæŸ„ç›´éš†',w:90,p:20}, {n:'æœå€‰æ™¯é¡',w:70,p:60}, {n:'æœå€‰æ™¯å¥',w:75,p:55}, {n:'å‰æ³¢å‰ç¹¼',w:65,p:60}, {n:'é­šä½æ™¯å›º',w:60,p:70}, {n:'å±±å´å‰å®¶',w:72,p:65}],
        ukita: [{n:'å®‡å–œå¤šç›´å®¶',w:85,p:95}, {n:'å®‡å–œå¤šç§€å®¶',w:80,p:75}, {n:'æˆ¶å·ç§€å®‰',w:82,p:60}, {n:'å²¡å®¶åˆ©',w:80,p:55}, {n:'èŠ±æˆ¿æ­£å¹¸',w:75,p:60}, {n:'æ˜çŸ³å…¨ç™»',w:85,p:50}, {n:'é•·èˆ¹è²è¦ª',w:60,p:85}, {n:'å®‡å–œå¤šå¿ å®¶',w:70,p:70}],
        ryuzoji: [{n:'é¾é€ å¯ºéš†ä¿¡',w:90,p:60}, {n:'é‹å³¶ç›´èŒ‚',w:92,p:94}, {n:'å††åŸå¯ºä¿¡èƒ¤',w:82,p:55}, {n:'æœ¨ä¸‹æ˜Œç›´',w:80,p:60}, {n:'ç™¾æ­¦è³¢å…¼',w:85,p:40}, {n:'æˆæ¾ä¿¡å‹',w:84,p:45}, {n:'æ±Ÿé‡Œå£ä¿¡å¸¸',w:83,p:50}, {n:'é¾é€ å¯ºæ”¿å®¶',w:60,p:65}],
        satake: [{n:'ä½ç«¹ç¾©é‡',w:93,p:80}, {n:'ä½ç«¹ç¾©å®£',w:85,p:85}, {n:'æ¶‰æ±Ÿæ”¿å…‰',w:60,p:88}, {n:'å’Œç”°æ˜­ç‚º',w:65,p:80}, {n:'å¤ªç”°è³‡æ­£',w:82,p:75}, {n:'æ¢¶åŸæ”¿æ™¯',w:78,p:60}, {n:'å²¡æœ¬ç¦ªå“²',w:30,p:92}, {n:'çœŸå£æ°å¹¹',w:85,p:20}],
        nanbu: [{n:'å—éƒ¨æ™´æ”¿',w:88,p:85}, {n:'å—éƒ¨ä¿¡ç›´',w:80,p:90}, {n:'åŒ—ä¿¡æ„›',w:75,p:85}, {n:'ä¹æˆ¶æ”¿å¯¦',w:92,p:40}, {n:'æ´¥è¼•ç‚ºä¿¡',w:90,p:90}, {n:'çŸ³å·é«˜ä¿¡',w:80,p:70}, {n:'å¤§æµ¦å®ˆä¿¡',w:75,p:60}, {n:'å…«æˆ¶æ”¿æ¦®',w:70,p:75}],
        mogami: [{n:'æœ€ä¸Šç¾©å…‰',w:92,p:95}, {n:'é®­å»¶ç§€ç¶±',w:88,p:60}, {n:'å¿—æ‘å…‰å®‰',w:85,p:70}, {n:'æ°å®¶å®šç›´',w:60,p:85}, {n:'æ¥¯å²¡æ»¿èŒ‚',w:80,p:65}, {n:'å»¶æ¾¤æ»¿å»¶',w:84,p:50}, {n:'æœ€ä¸Šç¾©å®ˆ',w:70,p:70}, {n:'æ±Ÿå£å…‰æ¸…',w:75,p:60}],
        azai: [{n:'æ·ºäº•é•·æ”¿',w:88,p:80}, {n:'ç£¯é‡å“¡æ˜Œ',w:90,p:50}, {n:'æµ·åŒ—ç¶±è¦ª',w:85,p:80}, {n:'èµ¤å°¾æ¸…ç¶±',w:75,p:85}, {n:'é›¨æ£®æ¸…è²',w:70,p:80}, {n:'é è—¤ç›´ç¶“',w:84,p:70}, {n:'äº¬æ¥µé«˜æ¬¡',w:60,p:75}, {n:'å®®éƒ¨ç¹¼æ½¤',w:75,p:85}]
    };

    let state = {
        turn: 1, year: 1560, season: 0,
        player: null, difficulty: 2, actions: 3,
        resources: { gold: 0, food: 0, troops: 0, wounded: 0 },
        dev: { comm: 1, agri: 1 },
        provinces: {}, generals: [], alliances: {}, selectedProv: -1
    };

    window.onload = () => {
        const area = document.getElementById('clan-select-area');
        Object.keys(CLANS).forEach(key => {
            if(key === 'neutral') return;
            let div = document.createElement('div');
            div.className = `clan-btn ${CLANS[key].c}`;
            let tierName = CLANS[key].t === 1 ? "å¼·åœ‹" : (CLANS[key].t === 2 ? "ä¸­å …" : "å°åœ‹");
            div.innerHTML = `
                <span class="tier-badge tier-${CLANS[key].t}">${tierName}</span>
                <strong>${CLANS[key].n}</strong>
                <small>${CLANS[key].full}</small>
            `;
            div.onclick = () => startGame(key);
            area.appendChild(div);
        });
    };

    function startGame(clanKey) {
        state.player = clanKey;
        state.difficulty = parseInt(document.getElementById('difficulty').value);
        state.year = 1560; state.season = 0; state.actions = 3; state.generals = []; state.alliances = {};
        state.dev = { comm: 1, agri: 1 };

        let tier = CLANS[clanKey].t;
        let baseRes = (tier * 1000) + (state.difficulty === 1 ? 2000 : 1000);
        state.resources = { gold: baseRes, food: baseRes, troops: 3000 + (tier * 1000), wounded: 0 };

        let gid = 0;
        Object.keys(CLANS).forEach(k => {
            if(k === 'neutral') return;
            let gens = REAL_GENERALS[k] || [];
            gens.forEach(g => {
                state.generals.push({ id: gid++, name: g.n, w: g.w, p: g.p, owner: k, status: 'free', assignedTo: null });
            });
        });

        initMap();
        updateUI();
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        log(`éŠæˆ²é–‹å§‹ï¼æ‚¨æ˜¯ ${CLANS[clanKey].full}ã€‚`);
    }

    function initMap() {
        const grid = document.getElementById('map-grid');
        state.provinces = {};

        PROVINCES_DATA.forEach(p => {
            let basePop = 15000 + Math.floor(Math.random()*10000);
            if ([33,34,42,45,46,15,19,100].includes(p.id)) basePop += 8000;

            state.provinces[p.id] = { 
                id: p.id, name: p.n, owner: 'neutral', 
                troops: 1000 + Math.floor(Math.random()*500), 
                status: 'direct', generalId: null, defense: 100, wounded: 0,
                pop: basePop
            };
        });

        Object.keys(CLANS).forEach(k => {
            if(k === 'neutral') return;
            CLANS[k].startProvs.forEach(pid => {
                if(state.provinces[pid]) {
                    state.provinces[pid].owner = k;
                    state.provinces[pid].troops = (k === state.player) ? 0 : (2000 + CLANS[k].t * 500);
                }
            });
        });

        PROVINCES_DATA.forEach(p => {
            let div = document.createElement('div');
            let owner = state.provinces[p.id].owner;
            div.className = `province ${CLANS[owner].c}`;
            div.style.gridRow = p.r; div.style.gridColumn = p.c;
            div.id = `prov-${p.id}`; div.onclick = () => clickProvince(p.id);
            div.innerHTML = `
                <div class="prov-name">${p.n}</div>
                <div class="prov-info" id="info-${p.id}"></div>
                <div class="pop-info" id="pop-${p.id}">ğŸ‘¥${Math.floor(state.provinces[p.id].pop/100)/10}k</div>
            `;
            grid.appendChild(div);
        });
    }

    function getNeighbors(pid) {
        let p1 = PROVINCES_DATA.find(x => x.id === pid);
        let list = [];
        PROVINCES_DATA.forEach(p2 => {
            if(p1.id !== p2.id) {
                let dr = Math.abs(p1.r - p2.r);
                let dc = Math.abs(p1.c - p2.c);
                if (dr <= 1 && dc <= 1) list.push(p2.id);
            }
        });
        return list;
    }

    function doAction(type) {
        if(state.actions <= 0) return alert("è¡Œå‹•åŠ›è€—ç›¡");
        const sel = document.getElementById('general-select');
        if(!sel.value) return alert("ç„¡å¯ç”¨æ­¦å°‡");
        const gen = state.generals.find(g => g.id == sel.value);
        
        let directs = Object.values(state.provinces).filter(p => p.owner === state.player && p.status === 'direct');
        let landCount = directs.length;
        if(landCount === 0 && type !== 'fortify') return alert("ç„¡ç›´è½„é ˜åœ°");

        let landBonus = 1 + (landCount * 0.1); 
        let pMod = (1 + gen.p/100) * landBonus;
        let wMod = (1 + gen.w/100) * landBonus;
        let msg = "";

        if(type === 'commerce') {
            if(state.resources.food < 50) return alert("ç¼ºç³§");
            state.resources.food -= 50; 
            let val = Math.floor(200 * pMod * (1 + state.dev.comm * 0.2));
            state.resources.gold += val;
            state.dev.comm++;
            
            let popGain = Math.floor(300 * pMod);
            directs.forEach(p => p.pop += popGain);

            msg = `${gen.name} æ¨‚å¸‚ï¼Œé‡‘+${val}ï¼Œç›´è½„äººå£+${popGain}`;
        } 
        else if (type === 'agriculture') {
            if(state.resources.gold < 50) return alert("ç¼ºé‡‘");
            state.resources.gold -= 50; 
            let val = Math.floor(200 * pMod * (1 + state.dev.agri * 0.2));
            state.resources.food += val;
            state.dev.agri++;
            
            let popGain = Math.floor(100 * pMod);
            directs.forEach(p => p.pop += popGain);
            
            msg = `${gen.name} æª¢åœ°ï¼Œç³§+${val}ï¼Œç›´è½„äººå£+${popGain}`;
        } 
        else if (type === 'recruit') {
            if(state.resources.gold < 150 || state.resources.food < 150) return alert("è³‡æºä¸è¶³");
            
            let totalAvail = 0;
            directs.forEach(p => { if(p.pop > 5000) totalAvail += (p.pop - 5000); });
            
            if(totalAvail < 500) return alert("ç›´è½„åœ°äººå£æ¯ç«­ï¼ç„¡æ³•å¾µå…µ");

            state.resources.gold -= 150; 
            state.resources.food -= 150; 
            
            let val = Math.floor(300 * wMod);
            val = Math.min(val, totalAvail); 
            
            let deduct = Math.ceil(val / directs.length);
            directs.forEach(p => {
                if(p.pop > 5000) p.pop = Math.max(5000, p.pop - deduct);
            });

            state.resources.troops += val;
            msg = `${gen.name} å¾µå…µ ${val}ï¼Œäººå£æ¸›å°‘ã€‚`;
        } 
        else if (type === 'fortify') {
            if(directs.length === 0) return alert("ç„¡ç›´è½„é ˜åœ°");
            if(state.resources.gold < 100) return alert("ç¼ºé‡‘");
            state.resources.gold -= 100;
            let target = directs[Math.floor(Math.random() * directs.length)];
            target.defense = Math.min(300, target.defense + 20);
            msg = `${gen.name} å° ${target.name} é€²è¡Œæ™®è«‹ï¼Œé˜²ç¦¦+20`;
        }
        state.actions--; log(msg); updateUI();
    }

    function doDiplomacy() {
        if(state.actions <= 0) return alert("è¡Œå‹•åŠ›è€—ç›¡");
        const target = document.getElementById('diplo-select').value;
        if(!target) return;
        if(state.resources.gold < 600) return alert("è³‡é‡‘ä¸è¶³");
        state.resources.gold -= 600; state.actions--;
        if(Math.random() > 0.3) {
            state.alliances[target] = 12; log(`<span class="log-good">èˆ‡ ${CLANS[target].n} çµç›ŸæˆåŠŸï¼</span>`);
        } else {
            log(`<span class="log-bad">${CLANS[target].n} æ‹’çµ•çµç›Ÿã€‚</span>`);
        }
        updateUI();
    }

    function clickProvince(pid) {
        const p = state.provinces[pid];
        if(p.owner === state.player) { openManage(pid); return; }
        if(state.alliances[p.owner] > 0) { alert("ç›Ÿå‹"); return; }
        if(state.actions <= 0) { alert("ç„¡è¡Œå‹•åŠ›"); return; }
        if(!isAdjacent(pid, state.player)) { alert("ä¸ç›¸é„°"); return; }
        if(state.resources.food < 100 || state.resources.troops < 500) return alert("è»è³‡ä¸è¶³");
        if(confirm(`æ”»æ‰“ ${p.name} (é˜²ç¦¦${p.defense})?`)) {
            state.actions--; state.resources.gold -= 50; state.resources.food -= 100;
            const sel = document.getElementById('general-select');
            const gen = state.generals.find(g=>g.id==sel.value) || {name:'æœ¬é™£', w:80};
            battle(state.player, p, state.resources.troops, gen.w, true);
        }
    }

    function battle(atkOwner, defProv, atkTroops, atkWar, isPlayerMain) {
        let defTroops = defProv.troops;
        if(defProv.owner === state.player && defProv.status === 'direct') defTroops = state.resources.troops;
        
        let defFactor = 100 / Math.max(50, defProv.defense);
        let atkPwr = atkTroops * (atkWar/100) * (0.8 + Math.random()*0.4);
        let defPwr = defTroops * (0.8 + Math.random()*0.4);
        if(defProv.owner !== 'neutral') defPwr *= 1.2;

        const win = atkPwr > defPwr;
        const loser = defProv.owner;
        
        let atkLossBase = win ? (defTroops * 0.3) : (atkTroops * 0.4);
        let defLossBase = win ? (defTroops * 0.9) : (atkTroops * 0.2);
        
        let atkLossReal = Math.floor(atkLossBase * (defProv.defense / 100));
        let defLossReal = Math.floor(defLossBase * defFactor);
        
        if(isPlayerMain) {
            state.resources.troops = Math.max(0, state.resources.troops - atkLossReal);
            let wounded = Math.floor(atkLossReal * 0.4);
            state.resources.wounded += wounded;
            
            if(win) {
                captureProv(defProv, atkOwner);
                log(`<span class="log-good">æ”»é™· ${defProv.name}ï¼å‚·å…µ+${wounded}</span>`);
            } else {
                defProv.troops = Math.max(0, defProv.troops - defLossReal);
                log(`<span class="log-bad">æ”»åŸå¤±æ•—ï¼Œæå¤±${atkLossReal}ã€‚</span>`);
            }
        } else {
            if(win) {
                captureProv(defProv, atkOwner);
                defProv.troops = Math.max(500, atkTroops - atkLossReal);
                if(atkOwner === state.player) log(`<span class="log-good">å§”ä»»è»æ”»ä¸‹ ${defProv.name}ã€‚</span>`);
                else if(loser === state.player) log(`<span class="log-bad">æ€¥å ±ï¼${defProv.name} æ·ªé™·ã€‚</span>`);
            }
            return win;
        }
        if(win && loser !== 'neutral') checkDestruction(loser, atkOwner);
        updateUI();
    }

    function captureProv(p, newOwner) {
        if(p.generalId !== null) {
            let gen = state.generals.find(g=>g.id===p.generalId);
            if(Math.random() < 0.2) { 
                gen.owner = newOwner; gen.status = 'free'; gen.assignedTo = null; 
                log(`<span class="log-sys">${gen.name} æ­¸é †ï¼</span>`); 
            } else { 
                gen.status = 'free'; gen.assignedTo = null; 
            }
        }
        p.owner = newOwner; 
        p.status = (newOwner === state.player) ? 'direct' : 'auto'; 
        p.generalId = null; 
        p.troops = 0;
        p.defense = Math.max(50, p.defense - 30);
        p.wounded = 0;
    }

    function checkDestruction(loser, winner) {
        if(Object.values(state.provinces).filter(p=>p.owner===loser).length === 0) {
            log(`ã€${CLANS[loser].n}ã€‘æ»…äº¡ã€‚`);
            state.generals.forEach(g => { if(g.owner === loser) { g.owner = winner; g.status='free'; g.assignedTo=null; } });
            if(loser === state.player) {
                document.getElementById('end-title').innerText = "æ•—åŒ—";
                document.getElementById('end-msg').innerText = "å®¶æ—æ»…äº¡ã€‚";
                document.getElementById('end-modal').style.display = 'flex';
            }
        }
    }

    function updateStats() {
        const box = document.getElementById('stats-box');
        let html = `<table class="stats-table">
            <tr><th style="width:10px">è‰²</th><th>å‹¢åŠ›</th><th>é ˜åœ°</th><th>å…µåŠ›</th><th>äººå£</th></tr>`;
        
        let data = [];
        Object.keys(CLANS).forEach(k => {
            if(k === 'neutral') return;
            let provs = Object.values(state.provinces).filter(p => p.owner === k);
            let lands = provs.length;
            if(lands === 0) return; 

            let gens = state.generals.filter(g => g.owner === k).length;
            let pop = provs.reduce((acc, p) => acc + p.pop, 0);
            
            let troops = 0;
            if(k === state.player) {
                troops = state.resources.troops;
                provs.forEach(p => { if(p.status === 'auto') troops += p.troops; });
            } else {
                troops = provs.reduce((acc, p) => acc + p.troops, 0);
            }

            data.push({ name: CLANS[k].n, l: lands, g: gens, t: troops, p: pop, color: CLANS[k].c });
        });

        data.sort((a, b) => b.l - a.l);

        data.forEach(d => {
            let style = d.name===CLANS[state.player].n ? 'color:#ffca28' : '';
            html += `<tr style="${style}">
                <td><div class="${d.color}" style="width:8px; height:8px; border:1px solid #fff;"></div></td>
                <td>${d.name}</td>
                <td>${d.l}</td>
                <td>${Math.floor(d.t/100)/10}k</td>
                <td>${Math.floor(d.p/1000)}k</td>
            </tr>`;
        });
        html += `</table>`;
        box.innerHTML = html;
    }

    function endTurn() {
        state.actions = 3; state.season++;
        
        if(state.resources.wounded > 0) {
            let recovered = Math.ceil(state.resources.wounded * 0.25);
            state.resources.wounded -= recovered;
            state.resources.troops += recovered;
            log(`<span class="log-sys">å‚·å…µå›å¾©ï¼š${recovered} äººã€‚</span>`);
        }
        
        let cost = Math.floor(state.resources.troops / 100 * 5);
        state.resources.food = Math.max(0, state.resources.food - cost);
        
        Object.values(state.provinces).forEach(p => {
            p.pop = Math.floor(p.pop * 1.005);
        });

        if(state.season > 3) {
            state.season = 0; state.year++;
            state.resources.gold += 1000 + (state.dev.comm * 100); 
            state.resources.food += 1000 + (state.dev.agri * 100);
            log(`æ–°å¹´ç¨…æ”¶ã€‚`);
        }

        Object.values(state.provinces).forEach(p => {
            if(p.owner === state.player && p.status === 'auto' && p.generalId) {
                let gen = state.generals.find(g=>g.id===p.generalId);
                let incomeG = Math.floor(gen.p * 0.5);
                let incomeF = Math.floor(gen.p * 0.5);
                
                if(p.defense < 150 && Math.random() < 0.7) {
                    p.defense += 15;
                    incomeG = Math.max(0, incomeG - 50);
                    log(`<span style="color:#aaa; font-size:0.75rem;">${p.name}ä¿®ç¯‰ (é˜²${p.defense})</span>`);
                }
                
                state.resources.gold += incomeG;
                state.resources.food += incomeF;
                p.troops += Math.floor(gen.w * 0.6);
                if(Math.random() < 0.3) p.pop += 50; 

                if(p.wounded > 0) {
                    let rec = Math.ceil(p.wounded * 0.2);
                    p.wounded -= rec;
                    p.troops += rec;
                }

                if(p.troops > 2500) {
                    let targets = getNeighbors(p.id).filter(nid => {
                        let t = state.provinces[nid];
                        return t.owner !== state.player && !state.alliances[t.owner];
                    });
                    if(targets.length > 0) {
                        let t = state.provinces[targets[0]];
                        let def = t.troops;
                        if(t.owner === state.player && t.status === 'direct') def = state.resources.troops;
                        if(p.troops > def * 1.3) {
                            if(battle(state.player, t, p.troops, gen.w, false)) p.troops = 800;
                            else p.troops = Math.floor(p.troops*0.6);
                        }
                    }
                }
            }
        });

        aiAction();
        
        if(Object.values(state.provinces).filter(p=>p.owner===state.player).length === PROVINCES_DATA.length) {
            document.getElementById('end-title').innerText = "å¤©ä¸‹çµ±ä¸€";
            document.getElementById('end-msg').innerText = "æ­å–œï¼";
            document.getElementById('end-modal').style.display = 'flex';
        }
        updateUI();
    }

    function aiAction() {
        let ais = [...new Set(Object.values(state.provinces).map(p=>p.owner))].filter(o=>o!=='neutral' && o!==state.player);
        ais.forEach(ai => {
            Object.values(state.provinces).filter(p=>p.owner===ai).forEach(p => {
                p.troops += 120 * state.difficulty;
                if(p.defense < 200) p.defense += 5;
                p.pop = Math.floor(p.pop * 1.005);
            });
            if(Math.random() < 0.4) {
                let attackers = Object.values(state.provinces).filter(p=>p.owner===ai && p.troops > 2000);
                if(attackers.length > 0) {
                    let p = attackers[Math.floor(Math.random()*attackers.length)];
                    let neighbors = getNeighbors(p.id);
                    for(let nid of neighbors) {
                        let t = state.provinces[nid];
                        if(t.owner !== ai && !state.alliances[ai]) {
                            let def = t.troops;
                            if(t.owner === state.player && t.status === 'direct') def = state.resources.troops;
                            if(p.troops > def * 1.2) {
                                if(battle(ai, t, p.troops, 80, false)) p.troops = 1000;
                                break;
                            }
                        }
                    }
                }
            }
        });
    }

    function updateUI() {
        const s = ['æ˜¥','å¤','ç§‹','å†¬'];
        document.getElementById('d-year').innerText = `${state.year} ${s[state.season]}`;
        document.getElementById('d-gold').innerText = state.resources.gold;
        document.getElementById('d-food').innerText = state.resources.food;
        document.getElementById('d-troops').innerText = state.resources.troops;
        document.getElementById('d-wounded').innerText = state.resources.wounded;
        document.getElementById('d-ap').innerText = state.actions;
        document.getElementById('d-lands').innerText = Object.values(state.provinces).filter(p=>p.owner===state.player).length;
        document.getElementById('lvl-com').innerText = state.dev.comm;
        document.getElementById('lvl-agr').innerText = state.dev.agri;
        
        Object.values(state.provinces).forEach(p => {
            const el = document.getElementById(`prov-${p.id}`);
            el.className = `province ${CLANS[p.owner].c}`;
            el.classList.remove('status-direct','status-auto','status-ally');
            let info = p.troops;
            let defShield = `ğŸ›¡ï¸${p.defense}`;

            if(p.owner === state.player) {
                if(p.status === 'direct') { el.classList.add('status-direct'); info = `â˜… ${defShield}`; }
                else { 
                    el.classList.add('status-auto'); 
                    let gn = p.generalId ? state.generals.find(g=>g.id===p.generalId).name[0] : "ç„¡";
                    info = `â™»${gn} ${p.troops}`; 
                }
            } else if(state.alliances[p.owner]) {
                el.classList.add('status-ally');
                info = `${p.troops}`;
            } else {
                info = `${p.troops}`;
            }
            document.getElementById(`info-${p.id}`).innerText = info;
            document.getElementById(`pop-${p.id}`).innerText = `ğŸ‘¥${Math.floor(p.pop/100)/10}k`;
            el.title = `é˜²ç¦¦: ${p.defense} | äººå£: ${p.pop}`;
        });
        
        const ms = document.getElementById('general-select'); ms.innerHTML = '';
        state.generals.filter(g=>g.owner===state.player && g.status==='free').forEach(g => {
            let o = document.createElement('option'); o.value = g.id; o.innerText = `${g.name} (çµ±${g.w} æ”¿${g.p})`; ms.appendChild(o);
        });
        const ds = document.getElementById('diplo-select'); ds.innerHTML = '';
        [...new Set(Object.values(state.provinces).map(p=>p.owner))].forEach(c => {
            if(c!==state.player && c!=='neutral' && !state.alliances[c]) {
                let o = document.createElement('option'); o.value = c; o.innerText = CLANS[c].n; ds.appendChild(o);
            }
        });

        updateStats();
    }

    function isAdjacent(pid, owner) { return getNeighbors(pid).some(nid => state.provinces[nid].owner === owner); }

    function openManage(pid) {
        state.selectedProv = pid;
        const p = state.provinces[pid];
        document.getElementById('manage-title').innerText = `æ²»ç†ï¼š${p.name} (é˜²${p.defense} äºº${p.pop})`;
        const sel = document.getElementById('manage-gen-select'); sel.innerHTML = '<option value="-1">-- è§£ä»» --</option>';
        if(p.generalId !== null) {
            let g = state.generals.find(x=>x.id===p.generalId);
            let o = document.createElement('option'); o.value=g.id; o.innerText=`${g.name} (ç¾ä»»)`; o.selected=true; sel.appendChild(o);
        }
        state.generals.filter(g=>g.owner===state.player && g.status==='free').forEach(g => {
            let o = document.createElement('option'); o.value=g.id; o.innerText=`${g.name} (çµ±${g.w})`; sel.appendChild(o);
        });
        document.getElementById('manage-modal').style.display = 'flex';
    }

    function setProvinceState(type) {
        const pid = state.selectedProv, p = state.provinces[pid], gid = parseInt(document.getElementById('manage-gen-select').value);
        if(p.generalId !== null && p.generalId !== gid) { let g = state.generals.find(x=>x.id===p.generalId); g.status='free'; g.assignedTo=null; }
        if(gid !== -1) { let g = state.generals.find(x=>x.id===gid); g.status='assigned'; g.assignedTo=pid; p.generalId=gid; } else { p.generalId=null; }
        p.status = type; 
        if(type==='direct') { p.troops=0; if(p.generalId) { let g=state.generals.find(x=>x.id===p.generalId); g.status='free'; g.assignedTo=null; p.generalId=null; } }
        else if(p.troops===0) p.troops=1000;
        closeModal(); updateUI();
    }
    
    function closeModal() { document.getElementById('manage-modal').style.display = 'none'; }
    function log(t) { const b = document.getElementById('log-box'); b.innerHTML += `<div>${t}</div>`; b.scrollTop = b.scrollHeight; }

</script>
</body>
</html>
